<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: download manager (#65) - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/2ee64c40adc0980199e1e7c234282dbcc9eab88e.html">2ee64c40adc0980199e1e7c234282dbcc9eab88e</a>
<b>parent</b> <a href="../commit/fca2f8a53dfb78551b6a713f7eb2be5f5b9e4980.html">fca2f8a53dfb78551b6a713f7eb2be5f5b9e4980</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat, 17 Jun 2023 11:40:36 +0200

feat: download manager (#65)

* fix: media scanner

* refactor!: media downloader feature

* fix(notifications): sender username

* fix: ffmpeg merge filter

* fix: ffmpeg timestamp

* fix(bridge): sendMessage coroutine

* fix(media_downloader): friendinfo icon

* download manager database

* remove all tasks button

* revert: preview group chat

* add: encryption key throwable

* feat: download manager preview

* feat: preview deleted medias

* message logger database schema

* fix: send media override
changed media duration: int -&gt; long

* refactor: download request

* bitmoji selfie update

* refactor: utils
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/build.gradle</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt</a></td><td> | </td><td class="num">36</td><td><span class="i">+++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt</a></td><td> | </td><td class="num">83</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">118</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt</a></td><td> | </td><td class="num">330</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a></td><td> | </td><td class="num">106</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></td><td> | </td><td class="num">49</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">366</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h23">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt</a></td><td> | </td><td class="num">10</td><td><span class="i"></span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h24">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MapActivity.kt</a></td><td> | </td><td class="num">99</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h25">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt</a></td><td> | </td><td class="num">148</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h26">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">93</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h27">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">94</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h28">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">373</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h29">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">82</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h30">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">243</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></td><td> | </td><td class="num">187</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></td><td> | </td><td class="num">157</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">app/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt</a></td><td> | </td><td class="num">98</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h36">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">93</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">376</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h39">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a></td><td> | </td><td class="num">135</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h40">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">82</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h41">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">243</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h42">app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt</a></td><td> | </td><td class="num">67</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h43">app/src/main/kotlin/me/rhunk/snapenhance/util/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">118</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h44">app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt</a></td><td> | </td><td class="num">41</td><td><span class="i"></span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h45">app/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h46">app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt</a></td><td> | </td><td class="num">91</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h47">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h48">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h49">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">101</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h50">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a></td><td> | </td><td class="num">92</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h51">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h52">app/src/main/res/drawable/action_button_cancel.xml</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h53">app/src/main/res/drawable/action_button_success.xml</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h54">app/src/main/res/drawable/download_manager_item_background.xml</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h55">app/src/main/res/font/avenir_next_medium.ttf</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h56">app/src/main/res/layout/download_manager_activity.xml</a></td><td> | </td><td class="num">61</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h57">app/src/main/res/layout/download_manager_item.xml</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h58">app/src/main/res/values/colors.xml</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h59">app/src/main/res/values/dimens.xml</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h60">app/src/main/res/values/themes.xml</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
</table></pre><pre>61 files changed, 3029 insertions(+), 1694 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/build.gradle.html">app/build.gradle</a> b/<a href="../file/app/build.gradle.html">app/build.gradle</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -95,6 +95,7 @@ task getVersion {
</a> dependencies {
     implementation &#39;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.1&#39;
     implementation &#39;org.jetbrains.kotlin:kotlin-reflect:1.8.21&#39;
<a href="#h0-0-3" id="h0-0-3" class="i">+    implementation &#39;androidx.recyclerview:recyclerview:1.3.0&#39;
</a> 
     compileOnly files(&#39;libs/LSPosed-api-1.0-SNAPSHOT.jar&#39;)
     implementation &#39;com.google.code.gson:gson:2.10.1&#39;
<b>diff --git a/<a id="h1" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -2,6 +2,8 @@
</a> &lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
     xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;
 
<a href="#h1-0-3" id="h1-0-3" class="i">+    &lt;uses-permission android:name=&quot;android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS&quot; /&gt;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+
</a>     &lt;uses-permission android:name=&quot;android.permission.DOWNLOAD_WITHOUT_NOTIFICATION&quot; /&gt;
     &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;
 
<a href="#h1-1" id="h1-1" class="h">@@ -28,21 +30,27 @@
</a> 
         &lt;service
             android:name=&quot;.bridge.service.BridgeService&quot;
<a href="#h1-1-3" id="h1-1-3" class="d">-            android:exported=&quot;true&quot;&gt;
</a><a href="#h1-1-4" id="h1-1-4" class="i">+            android:exported=&quot;true&quot;
</a><a href="#h1-1-5" id="h1-1-5" class="i">+            tools:ignore=&quot;ExportedService&quot;&gt;
</a>         &lt;/service&gt;
 
<a href="#h1-1-8" id="h1-1-8" class="i">+        &lt;receiver android:name=&quot;.download.MediaDownloadReceiver&quot; android:exported=&quot;true&quot;
</a><a href="#h1-1-9" id="h1-1-9" class="i">+            tools:ignore=&quot;ExportedReceiver&quot;&gt;
</a><a href="#h1-1-10" id="h1-1-10" class="i">+            &lt;intent-filter&gt;
</a><a href="#h1-1-11" id="h1-1-11" class="i">+                &lt;action android:name=&quot;me.rhunk.snapenhance.download.MediaDownloadReceiver.DOWNLOAD_ACTION&quot; /&gt;
</a><a href="#h1-1-12" id="h1-1-12" class="i">+            &lt;/intent-filter&gt;
</a><a href="#h1-1-13" id="h1-1-13" class="i">+        &lt;/receiver&gt;
</a><a href="#h1-1-14" id="h1-1-14" class="i">+
</a>         &lt;activity
<a href="#h1-1-16" id="h1-1-16" class="d">-            android:theme=&quot;@android:style/Theme.NoDisplay&quot;
</a><a href="#h1-1-17" id="h1-1-17" class="d">-            android:name=&quot;.bridge.service.MainActivity&quot;
</a><a href="#h1-1-18" id="h1-1-18" class="d">-            android:exported=&quot;true&quot;
</a><a href="#h1-1-19" id="h1-1-19" class="d">-            android:excludeFromRecents=&quot;true&quot;&gt;
</a><a href="#h1-1-20" id="h1-1-20" class="i">+            android:name=&quot;.ui.download.DownloadManagerActivity&quot;
</a><a href="#h1-1-21" id="h1-1-21" class="i">+            android:exported=&quot;true&quot;&gt;
</a>             &lt;intent-filter&gt;
                 &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;
                 &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
             &lt;/intent-filter&gt;
         &lt;/activity&gt;
         &lt;activity
<a href="#h1-1-28" id="h1-1-28" class="d">-            android:name=&quot;.features.impl.ui.menus.MapActivity&quot;
</a><a href="#h1-1-29" id="h1-1-29" class="i">+            android:name=&quot;.ui.map.MapActivity&quot;
</a>             android:exported=&quot;true&quot;
             android:excludeFromRecents=&quot;true&quot; /&gt;
     &lt;/application&gt;
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -5,18 +5,13 @@ object Constants {
</a>     const val SNAPCHAT_PACKAGE_NAME = &quot;com.snapchat.android&quot;
 
     const val VIEW_INJECTED_CODE = 0x7FFFFF02
<a href="#h2-0-3" id="h2-0-3" class="d">-    const val VIEW_DRAWER = 0x7FFFFF03
</a> 
<a href="#h2-0-5" id="h2-0-5" class="d">-    val ARROYO_NOTE_ENCRYPTION_PROTO_PATH = intArrayOf(4, 4, 6, 1, 1)
</a><a href="#h2-0-6" id="h2-0-6" class="d">-    val ARROYO_SNAP_ENCRYPTION_PROTO_PATH = intArrayOf(4, 4, 11, 5, 1, 1)
</a><a href="#h2-0-7" id="h2-0-7" class="d">-    val MESSAGE_SNAP_ENCRYPTION_PROTO_PATH = intArrayOf(11, 5, 1, 1)
</a><a href="#h2-0-8" id="h2-0-8" class="d">-    val MESSAGE_EXTERNAL_MEDIA_ENCRYPTION_PROTO_PATH = intArrayOf(3, 3, 5, 1, 1)
</a><a href="#h2-0-9" id="h2-0-9" class="d">-    val ARROYO_EXTERNAL_MEDIA_ENCRYPTION_PROTO_PATH = intArrayOf(4, 4, 3, 3, 5, 1, 1)
</a><a href="#h2-0-10" id="h2-0-10" class="d">-    val ARROYO_STRING_CHAT_MESSAGE_PROTO = intArrayOf(4, 4, 2, 1)
</a><a href="#h2-0-11" id="h2-0-11" class="i">+    val ARROYO_MEDIA_CONTAINER_PROTO_PATH = intArrayOf(4, 4)
</a><a href="#h2-0-12" id="h2-0-12" class="i">+    val ARROYO_STRING_CHAT_MESSAGE_PROTO = ARROYO_MEDIA_CONTAINER_PROTO_PATH + intArrayOf(2, 1)
</a>     val ARROYO_URL_KEY_PROTO_PATH = intArrayOf(4, 5, 1, 3)
 
<a href="#h2-0-15" id="h2-0-15" class="d">-    const val ARROYO_ENCRYPTION_PROTO_INDEX = 19
</a><a href="#h2-0-16" id="h2-0-16" class="d">-    const val ARROYO_ENCRYPTION_PROTO_INDEX_V2 = 4
</a><a href="#h2-0-17" id="h2-0-17" class="i">+    const val ENCRYPTION_PROTO_INDEX = 19
</a><a href="#h2-0-18" id="h2-0-18" class="i">+    const val ENCRYPTION_PROTO_INDEX_V2 = 4
</a> 
     const val USER_AGENT = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&quot;
 } 
\ No newline at end of file
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -40,7 +40,7 @@ class ModContext {
</a>     val config = ConfigManager(this)
     val actionManager = ActionManager(this)
     val database = DatabaseAccess(this)
<a href="#h3-0-3" id="h3-0-3" class="d">-    val downloadServer = DownloadServer(this)
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    val downloadServer = DownloadServer()
</a>     val messageSender = MessageSender(this)
     val classCache get() = SnapEnhance.classCache
     val resources: Resources get() = androidContext.resources
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -5,7 +5,7 @@ import android.os.Bundle
</a> import me.rhunk.snapenhance.BuildConfig
 import me.rhunk.snapenhance.action.AbstractAction
 import me.rhunk.snapenhance.config.ConfigProperty
<a href="#h4-0-3" id="h4-0-3" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.MapActivity
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import me.rhunk.snapenhance.ui.map.MapActivity
</a> 
 class OpenMap: AbstractAction(&quot;action.open_map&quot;, dependsOnProperty = ConfigProperty.LOCATION_SPOOF) {
     override fun run() {
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -2,6 +2,7 @@ package me.rhunk.snapenhance.bridge
</a> 
 import android.content.ContentValues
 import android.database.sqlite.SQLiteDatabase
<a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a> import java.io.File
 
 class MessageLoggerWrapper(
<a href="#h5-1" id="h5-1" class="h">@@ -12,7 +13,14 @@ class MessageLoggerWrapper(
</a> 
     fun init() {
         database = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
<a href="#h5-1-3" id="h5-1-3" class="d">-        database.execSQL(&quot;CREATE TABLE IF NOT EXISTS messages (id INTEGER PRIMARY KEY, conversation_id VARCHAR, message_id BIGINT, message_data BLOB)&quot;)
</a><a href="#h5-1-4" id="h5-1-4" class="i">+        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h5-1-5" id="h5-1-5" class="i">+            &quot;messages&quot; to listOf(
</a><a href="#h5-1-6" id="h5-1-6" class="i">+                &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h5-1-7" id="h5-1-7" class="i">+                &quot;conversation_id VARCHAR&quot;,
</a><a href="#h5-1-8" id="h5-1-8" class="i">+                &quot;message_id BIGINT&quot;,
</a><a href="#h5-1-9" id="h5-1-9" class="i">+                &quot;message_data BLOB&quot;
</a><a href="#h5-1-10" id="h5-1-10" class="i">+            )
</a><a href="#h5-1-11" id="h5-1-11" class="i">+        ))
</a>     }
 
     fun deleteMessage(conversationId: String, messageId: Long) {
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -13,6 +13,8 @@ import android.os.HandlerThread
</a> import android.os.IBinder
 import android.os.Message
 import android.os.Messenger
<a href="#h6-0-3" id="h6-0-3" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import kotlinx.coroutines.suspendCancellableCoroutine
</a> import me.rhunk.snapenhance.BuildConfig
 import me.rhunk.snapenhance.Logger.xposedLog
 import me.rhunk.snapenhance.bridge.AbstractBridgeClient
<a href="#h6-1" id="h6-1" class="h">@@ -86,29 +88,21 @@ class ServiceBridgeClient: AbstractBridgeClient(), ServiceConnection {
</a>         messageType: BridgeMessageType,
         bridgeMessage: BridgeMessage,
         resultType: KClass&lt;T&gt;? = null
<a href="#h6-1-3" id="h6-1-3" class="d">-    ): T {
</a><a href="#h6-1-4" id="h6-1-4" class="d">-        val response = AtomicReference&lt;BridgeMessage&gt;()
</a><a href="#h6-1-5" id="h6-1-5" class="d">-        val condition = lock.newCondition()
</a><a href="#h6-1-6" id="h6-1-6" class="d">-
</a><a href="#h6-1-7" id="h6-1-7" class="d">-        with(Message.obtain()) {
</a><a href="#h6-1-8" id="h6-1-8" class="d">-            what = messageType.value
</a><a href="#h6-1-9" id="h6-1-9" class="d">-            replyTo = Messenger(object : Handler(handlerThread.looper) {
</a><a href="#h6-1-10" id="h6-1-10" class="d">-                override fun handleMessage(msg: Message) {
</a><a href="#h6-1-11" id="h6-1-11" class="d">-                    response.set(handleResponseMessage(msg))
</a><a href="#h6-1-12" id="h6-1-12" class="d">-                    lock.withLock {
</a><a href="#h6-1-13" id="h6-1-13" class="d">-                        condition.signal()
</a><a href="#h6-1-14" id="h6-1-14" class="i">+    ) = runBlocking {
</a><a href="#h6-1-15" id="h6-1-15" class="i">+        return@runBlocking suspendCancellableCoroutine&lt;T&gt; { continuation -&gt;
</a><a href="#h6-1-16" id="h6-1-16" class="i">+            with(Message.obtain()) {
</a><a href="#h6-1-17" id="h6-1-17" class="i">+                what = messageType.value
</a><a href="#h6-1-18" id="h6-1-18" class="i">+                replyTo = Messenger(object : Handler(handlerThread.looper) {
</a><a href="#h6-1-19" id="h6-1-19" class="i">+                    override fun handleMessage(msg: Message) {
</a><a href="#h6-1-20" id="h6-1-20" class="i">+                        if (continuation.isCompleted) return
</a><a href="#h6-1-21" id="h6-1-21" class="i">+                        continuation.resumeWith(Result.success(handleResponseMessage(msg) as T))
</a>                     }
<a href="#h6-1-23" id="h6-1-23" class="d">-                }
</a><a href="#h6-1-24" id="h6-1-24" class="d">-            })
</a><a href="#h6-1-25" id="h6-1-25" class="d">-            data = Bundle()
</a><a href="#h6-1-26" id="h6-1-26" class="d">-            bridgeMessage.write(data)
</a><a href="#h6-1-27" id="h6-1-27" class="d">-            messenger.send(this)
</a><a href="#h6-1-28" id="h6-1-28" class="d">-        }
</a><a href="#h6-1-29" id="h6-1-29" class="d">-
</a><a href="#h6-1-30" id="h6-1-30" class="d">-        lock.withLock {
</a><a href="#h6-1-31" id="h6-1-31" class="d">-            condition.awaitUninterruptibly()
</a><a href="#h6-1-32" id="h6-1-32" class="i">+                })
</a><a href="#h6-1-33" id="h6-1-33" class="i">+                data = Bundle()
</a><a href="#h6-1-34" id="h6-1-34" class="i">+                bridgeMessage.write(data)
</a><a href="#h6-1-35" id="h6-1-35" class="i">+                messenger.send(this)
</a><a href="#h6-1-36" id="h6-1-36" class="i">+            }
</a>         }
<a href="#h6-1-38" id="h6-1-38" class="d">-        return response.get() as T
</a>     }
 
     override fun createAndReadFile(
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,19 +1,23 @@
</a> package me.rhunk.snapenhance.data
 
<a href="#h7-0-2" id="h7-0-2" class="i">+import java.io.File
</a><a href="#h7-0-3" id="h7-0-3" class="i">+
</a> enum class FileType(
     val fileExtension: String? = null,
<a href="#h7-0-6" id="h7-0-6" class="i">+    val mimeType: String,
</a>     val isVideo: Boolean = false,
     val isImage: Boolean = false,
     val isAudio: Boolean = false
 ) {
<a href="#h7-0-11" id="h7-0-11" class="d">-    GIF(&quot;gif&quot;, false, false, false),
</a><a href="#h7-0-12" id="h7-0-12" class="d">-    PNG(&quot;png&quot;, false, true, false),
</a><a href="#h7-0-13" id="h7-0-13" class="d">-    MP4(&quot;mp4&quot;, true, false, false),
</a><a href="#h7-0-14" id="h7-0-14" class="d">-    MP3(&quot;mp3&quot;, false, false, true),
</a><a href="#h7-0-15" id="h7-0-15" class="d">-    JPG(&quot;jpg&quot;, false, true, false),
</a><a href="#h7-0-16" id="h7-0-16" class="d">-    ZIP(&quot;zip&quot;, false, false, false),
</a><a href="#h7-0-17" id="h7-0-17" class="d">-    WEBP(&quot;webp&quot;, false, true, false),
</a><a href="#h7-0-18" id="h7-0-18" class="d">-    UNKNOWN(&quot;dat&quot;, false, false, false);
</a><a href="#h7-0-19" id="h7-0-19" class="i">+    GIF(&quot;gif&quot;, &quot;image/gif&quot;, false, false, false),
</a><a href="#h7-0-20" id="h7-0-20" class="i">+    PNG(&quot;png&quot;, &quot;image/png&quot;, false, true, false),
</a><a href="#h7-0-21" id="h7-0-21" class="i">+    MP4(&quot;mp4&quot;, &quot;video/mp4&quot;, true, false, false),
</a><a href="#h7-0-22" id="h7-0-22" class="i">+    MP3(&quot;mp3&quot;, &quot;audio/mp3&quot;,false, false, true),
</a><a href="#h7-0-23" id="h7-0-23" class="i">+    JPG(&quot;jpg&quot;, &quot;image/jpg&quot;,false, true, false),
</a><a href="#h7-0-24" id="h7-0-24" class="i">+    ZIP(&quot;zip&quot;, &quot;application/zip&quot;, false, false, false),
</a><a href="#h7-0-25" id="h7-0-25" class="i">+    WEBP(&quot;webp&quot;, &quot;image/webp&quot;, false, true, false),
</a><a href="#h7-0-26" id="h7-0-26" class="i">+    MPD(&quot;mpd&quot;, &quot;text/xml&quot;, false, false, false),
</a><a href="#h7-0-27" id="h7-0-27" class="i">+    UNKNOWN(&quot;dat&quot;, &quot;application/octet-stream&quot;, false, false, false);
</a> 
     companion object {
         private val fileSignatures = HashMap&lt;String, FileType&gt;()
<a href="#h7-1" id="h7-1" class="h">@@ -40,6 +44,14 @@ enum class FileType(
</a>             return result.toString()
         }
 
<a href="#h7-1-3" id="h7-1-3" class="i">+        fun fromFile(file: File): FileType {
</a><a href="#h7-1-4" id="h7-1-4" class="i">+            file.inputStream().use { inputStream -&gt;
</a><a href="#h7-1-5" id="h7-1-5" class="i">+                val buffer = ByteArray(16)
</a><a href="#h7-1-6" id="h7-1-6" class="i">+                inputStream.read(buffer)
</a><a href="#h7-1-7" id="h7-1-7" class="i">+                return fromByteArray(buffer)
</a><a href="#h7-1-8" id="h7-1-8" class="i">+            }
</a><a href="#h7-1-9" id="h7-1-9" class="i">+        }
</a><a href="#h7-1-10" id="h7-1-10" class="i">+
</a>         fun fromByteArray(array: ByteArray): FileType {
             val headerBytes = ByteArray(16)
             System.arraycopy(array, 0, headerBytes, 0, 16)
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -31,7 +31,7 @@ class MessageSender(
</a>             }.toByteArray()
         }
 
<a href="#h8-0-3" id="h8-0-3" class="d">-        val audioNoteProto: (Int) -&gt; ByteArray = { duration -&gt;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+        val audioNoteProto: (Long) -&gt; ByteArray = { duration -&gt;
</a>             ProtoWriter().apply {
                 write(6, 1) {
                     write(1) {
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,82 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+package me.rhunk.snapenhance.download
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+import android.content.Intent
</a><a href="#h9-0-3" id="h9-0-3" class="i">+import android.os.Bundle
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import me.rhunk.snapenhance.BuildConfig
</a><a href="#h9-0-5" id="h9-0-5" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h9-0-6" id="h9-0-6" class="i">+import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h9-0-7" id="h9-0-7" class="i">+import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h9-0-8" id="h9-0-8" class="i">+import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h9-0-9" id="h9-0-9" class="i">+
</a><a href="#h9-0-10" id="h9-0-10" class="i">+class ClientDownloadManager (
</a><a href="#h9-0-11" id="h9-0-11" class="i">+    private val context: ModContext,
</a><a href="#h9-0-12" id="h9-0-12" class="i">+    private val outputPath: String,
</a><a href="#h9-0-13" id="h9-0-13" class="i">+    private val mediaDisplaySource: String?,
</a><a href="#h9-0-14" id="h9-0-14" class="i">+    private val mediaDisplayType: String?,
</a><a href="#h9-0-15" id="h9-0-15" class="i">+    private val iconUrl: String?
</a><a href="#h9-0-16" id="h9-0-16" class="i">+) {
</a><a href="#h9-0-17" id="h9-0-17" class="i">+    private fun sendToBroadcastReceiver(bundle: Bundle) {
</a><a href="#h9-0-18" id="h9-0-18" class="i">+        val intent = Intent()
</a><a href="#h9-0-19" id="h9-0-19" class="i">+        intent.setClassName(BuildConfig.APPLICATION_ID, MediaDownloadReceiver::class.java.name)
</a><a href="#h9-0-20" id="h9-0-20" class="i">+        intent.action = MediaDownloadReceiver.DOWNLOAD_ACTION
</a><a href="#h9-0-21" id="h9-0-21" class="i">+        intent.putExtras(bundle)
</a><a href="#h9-0-22" id="h9-0-22" class="i">+        context.androidContext.sendBroadcast(intent)
</a><a href="#h9-0-23" id="h9-0-23" class="i">+    }
</a><a href="#h9-0-24" id="h9-0-24" class="i">+
</a><a href="#h9-0-25" id="h9-0-25" class="i">+    private fun sendToBroadcastReceiver(
</a><a href="#h9-0-26" id="h9-0-26" class="i">+        request: DownloadRequest,
</a><a href="#h9-0-27" id="h9-0-27" class="i">+        extras: Bundle.() -&gt; Unit = {}
</a><a href="#h9-0-28" id="h9-0-28" class="i">+    ) {
</a><a href="#h9-0-29" id="h9-0-29" class="i">+        sendToBroadcastReceiver(request.toBundle().apply {
</a><a href="#h9-0-30" id="h9-0-30" class="i">+            putString(&quot;outputPath&quot;, outputPath)
</a><a href="#h9-0-31" id="h9-0-31" class="i">+            putString(&quot;mediaDisplaySource&quot;, mediaDisplaySource)
</a><a href="#h9-0-32" id="h9-0-32" class="i">+            putString(&quot;mediaDisplayType&quot;, mediaDisplayType)
</a><a href="#h9-0-33" id="h9-0-33" class="i">+            putString(&quot;iconUrl&quot;, iconUrl)
</a><a href="#h9-0-34" id="h9-0-34" class="i">+        }.apply(extras))
</a><a href="#h9-0-35" id="h9-0-35" class="i">+    }
</a><a href="#h9-0-36" id="h9-0-36" class="i">+
</a><a href="#h9-0-37" id="h9-0-37" class="i">+    fun downloadDashMedia(playlistUrl: String, offsetTime: Long, duration: Long) {
</a><a href="#h9-0-38" id="h9-0-38" class="i">+        sendToBroadcastReceiver(
</a><a href="#h9-0-39" id="h9-0-39" class="i">+            DownloadRequest(
</a><a href="#h9-0-40" id="h9-0-40" class="i">+                inputMedias = arrayOf(playlistUrl),
</a><a href="#h9-0-41" id="h9-0-41" class="i">+                inputTypes = arrayOf(DownloadMediaType.REMOTE_MEDIA.name),
</a><a href="#h9-0-42" id="h9-0-42" class="i">+                flags = DownloadRequest.Flags.IS_DASH_PLAYLIST
</a><a href="#h9-0-43" id="h9-0-43" class="i">+            )
</a><a href="#h9-0-44" id="h9-0-44" class="i">+        ) {
</a><a href="#h9-0-45" id="h9-0-45" class="i">+            putBundle(&quot;dashOptions&quot;, Bundle().apply {
</a><a href="#h9-0-46" id="h9-0-46" class="i">+                putLong(&quot;offsetTime&quot;, offsetTime)
</a><a href="#h9-0-47" id="h9-0-47" class="i">+                putLong(&quot;duration&quot;, duration)
</a><a href="#h9-0-48" id="h9-0-48" class="i">+            })
</a><a href="#h9-0-49" id="h9-0-49" class="i">+        }
</a><a href="#h9-0-50" id="h9-0-50" class="i">+    }
</a><a href="#h9-0-51" id="h9-0-51" class="i">+
</a><a href="#h9-0-52" id="h9-0-52" class="i">+    fun downloadMedia(mediaData: String, mediaType: DownloadMediaType, encryption: MediaEncryptionKeyPair? = null) {
</a><a href="#h9-0-53" id="h9-0-53" class="i">+        sendToBroadcastReceiver(
</a><a href="#h9-0-54" id="h9-0-54" class="i">+            DownloadRequest(
</a><a href="#h9-0-55" id="h9-0-55" class="i">+                inputMedias = arrayOf(mediaData),
</a><a href="#h9-0-56" id="h9-0-56" class="i">+                inputTypes = arrayOf(mediaType.name),
</a><a href="#h9-0-57" id="h9-0-57" class="i">+                mediaEncryption = if (encryption != null) mapOf(mediaData to encryption) else mapOf()
</a><a href="#h9-0-58" id="h9-0-58" class="i">+            )
</a><a href="#h9-0-59" id="h9-0-59" class="i">+        )
</a><a href="#h9-0-60" id="h9-0-60" class="i">+    }
</a><a href="#h9-0-61" id="h9-0-61" class="i">+
</a><a href="#h9-0-62" id="h9-0-62" class="i">+    fun downloadMediaWithOverlay(
</a><a href="#h9-0-63" id="h9-0-63" class="i">+        videoData: String,
</a><a href="#h9-0-64" id="h9-0-64" class="i">+        overlayData: String,
</a><a href="#h9-0-65" id="h9-0-65" class="i">+        videoType: DownloadMediaType = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h9-0-66" id="h9-0-66" class="i">+        overlayType: DownloadMediaType = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h9-0-67" id="h9-0-67" class="i">+        videoEncryption: MediaEncryptionKeyPair? = null,
</a><a href="#h9-0-68" id="h9-0-68" class="i">+        overlayEncryption: MediaEncryptionKeyPair? = null)
</a><a href="#h9-0-69" id="h9-0-69" class="i">+    {
</a><a href="#h9-0-70" id="h9-0-70" class="i">+        val encryptionMap = mutableMapOf&lt;String, MediaEncryptionKeyPair&gt;()
</a><a href="#h9-0-71" id="h9-0-71" class="i">+
</a><a href="#h9-0-72" id="h9-0-72" class="i">+        if (videoEncryption != null) encryptionMap[videoData] = videoEncryption
</a><a href="#h9-0-73" id="h9-0-73" class="i">+        if (overlayEncryption != null) encryptionMap[overlayData] = overlayEncryption
</a><a href="#h9-0-74" id="h9-0-74" class="i">+        sendToBroadcastReceiver(DownloadRequest(
</a><a href="#h9-0-75" id="h9-0-75" class="i">+            inputMedias = arrayOf(videoData, overlayData),
</a><a href="#h9-0-76" id="h9-0-76" class="i">+            inputTypes = arrayOf(videoType.name, overlayType.name),
</a><a href="#h9-0-77" id="h9-0-77" class="i">+            mediaEncryption = encryptionMap,
</a><a href="#h9-0-78" id="h9-0-78" class="i">+            flags = DownloadRequest.Flags.SHOULD_MERGE_OVERLAY
</a><a href="#h9-0-79" id="h9-0-79" class="i">+        ))
</a><a href="#h9-0-80" id="h9-0-80" class="i">+    }
</a><a href="#h9-0-81" id="h9-0-81" class="i">+}</a><a href="#h9-0-82" id="h9-0-82" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,117 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+package me.rhunk.snapenhance.download
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h10-0-3" id="h10-0-3" class="i">+import android.content.Context
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h10-0-5" id="h10-0-5" class="i">+import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h10-0-6" id="h10-0-6" class="i">+import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h10-0-7" id="h10-0-7" class="i">+import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h10-0-8" id="h10-0-8" class="i">+
</a><a href="#h10-0-9" id="h10-0-9" class="i">+class DownloadTaskManager {
</a><a href="#h10-0-10" id="h10-0-10" class="i">+    private lateinit var taskDatabase: SQLiteDatabase
</a><a href="#h10-0-11" id="h10-0-11" class="i">+    private val cachedTasks = mutableMapOf&lt;Int, PendingDownload&gt;()
</a><a href="#h10-0-12" id="h10-0-12" class="i">+
</a><a href="#h10-0-13" id="h10-0-13" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h10-0-14" id="h10-0-14" class="i">+    fun init(context: Context) {
</a><a href="#h10-0-15" id="h10-0-15" class="i">+        if (this::taskDatabase.isInitialized) return
</a><a href="#h10-0-16" id="h10-0-16" class="i">+        taskDatabase = context.openOrCreateDatabase(&quot;download_tasks&quot;, Context.MODE_PRIVATE, null).apply {
</a><a href="#h10-0-17" id="h10-0-17" class="i">+            SQLiteDatabaseHelper.createTablesFromSchema(this, mapOf(
</a><a href="#h10-0-18" id="h10-0-18" class="i">+                &quot;tasks&quot; to listOf(
</a><a href="#h10-0-19" id="h10-0-19" class="i">+                    &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h10-0-20" id="h10-0-20" class="i">+                    &quot;outputPath TEXT&quot;,
</a><a href="#h10-0-21" id="h10-0-21" class="i">+                    &quot;outputFile TEXT&quot;,
</a><a href="#h10-0-22" id="h10-0-22" class="i">+                    &quot;mediaDisplayType TEXT&quot;,
</a><a href="#h10-0-23" id="h10-0-23" class="i">+                    &quot;mediaDisplaySource TEXT&quot;,
</a><a href="#h10-0-24" id="h10-0-24" class="i">+                    &quot;iconUrl TEXT&quot;,
</a><a href="#h10-0-25" id="h10-0-25" class="i">+                    &quot;downloadStage TEXT&quot;
</a><a href="#h10-0-26" id="h10-0-26" class="i">+                )
</a><a href="#h10-0-27" id="h10-0-27" class="i">+            ))
</a><a href="#h10-0-28" id="h10-0-28" class="i">+        }
</a><a href="#h10-0-29" id="h10-0-29" class="i">+    }
</a><a href="#h10-0-30" id="h10-0-30" class="i">+
</a><a href="#h10-0-31" id="h10-0-31" class="i">+    fun addTask(task: PendingDownload): Int {
</a><a href="#h10-0-32" id="h10-0-32" class="i">+        taskDatabase.execSQL(&quot;INSERT INTO tasks (outputPath, outputFile, mediaDisplayType, mediaDisplaySource, iconUrl, downloadStage) VALUES (?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h10-0-33" id="h10-0-33" class="i">+            arrayOf(
</a><a href="#h10-0-34" id="h10-0-34" class="i">+                task.outputPath,
</a><a href="#h10-0-35" id="h10-0-35" class="i">+                task.outputFile,
</a><a href="#h10-0-36" id="h10-0-36" class="i">+                task.mediaDisplayType,
</a><a href="#h10-0-37" id="h10-0-37" class="i">+                task.mediaDisplaySource,
</a><a href="#h10-0-38" id="h10-0-38" class="i">+                task.iconUrl,
</a><a href="#h10-0-39" id="h10-0-39" class="i">+                task.downloadStage.name
</a><a href="#h10-0-40" id="h10-0-40" class="i">+            )
</a><a href="#h10-0-41" id="h10-0-41" class="i">+        )
</a><a href="#h10-0-42" id="h10-0-42" class="i">+        task.id = taskDatabase.rawQuery(&quot;SELECT last_insert_rowid()&quot;, null).use {
</a><a href="#h10-0-43" id="h10-0-43" class="i">+            it.moveToFirst()
</a><a href="#h10-0-44" id="h10-0-44" class="i">+            it.getInt(0)
</a><a href="#h10-0-45" id="h10-0-45" class="i">+        }
</a><a href="#h10-0-46" id="h10-0-46" class="i">+        cachedTasks[task.id] = task
</a><a href="#h10-0-47" id="h10-0-47" class="i">+        return task.id
</a><a href="#h10-0-48" id="h10-0-48" class="i">+    }
</a><a href="#h10-0-49" id="h10-0-49" class="i">+
</a><a href="#h10-0-50" id="h10-0-50" class="i">+    fun updateTask(task: PendingDownload) {
</a><a href="#h10-0-51" id="h10-0-51" class="i">+        taskDatabase.execSQL(&quot;UPDATE tasks SET outputPath = ?, outputFile = ?, mediaDisplayType = ?, mediaDisplaySource = ?, iconUrl = ?, downloadStage = ? WHERE id = ?&quot;,
</a><a href="#h10-0-52" id="h10-0-52" class="i">+            arrayOf(
</a><a href="#h10-0-53" id="h10-0-53" class="i">+                task.outputPath,
</a><a href="#h10-0-54" id="h10-0-54" class="i">+                task.outputFile,
</a><a href="#h10-0-55" id="h10-0-55" class="i">+                task.mediaDisplayType,
</a><a href="#h10-0-56" id="h10-0-56" class="i">+                task.mediaDisplaySource,
</a><a href="#h10-0-57" id="h10-0-57" class="i">+                task.iconUrl,
</a><a href="#h10-0-58" id="h10-0-58" class="i">+                task.downloadStage.name,
</a><a href="#h10-0-59" id="h10-0-59" class="i">+                task.id
</a><a href="#h10-0-60" id="h10-0-60" class="i">+            )
</a><a href="#h10-0-61" id="h10-0-61" class="i">+        )
</a><a href="#h10-0-62" id="h10-0-62" class="i">+        cachedTasks[task.id] = task
</a><a href="#h10-0-63" id="h10-0-63" class="i">+    }
</a><a href="#h10-0-64" id="h10-0-64" class="i">+
</a><a href="#h10-0-65" id="h10-0-65" class="i">+    fun isEmpty(): Boolean {
</a><a href="#h10-0-66" id="h10-0-66" class="i">+        return cachedTasks.isEmpty()
</a><a href="#h10-0-67" id="h10-0-67" class="i">+    }
</a><a href="#h10-0-68" id="h10-0-68" class="i">+
</a><a href="#h10-0-69" id="h10-0-69" class="i">+    private fun removeTask(id: Int) {
</a><a href="#h10-0-70" id="h10-0-70" class="i">+        taskDatabase.execSQL(&quot;DELETE FROM tasks WHERE id = ?&quot;, arrayOf(id))
</a><a href="#h10-0-71" id="h10-0-71" class="i">+        cachedTasks.remove(id)
</a><a href="#h10-0-72" id="h10-0-72" class="i">+    }
</a><a href="#h10-0-73" id="h10-0-73" class="i">+
</a><a href="#h10-0-74" id="h10-0-74" class="i">+    fun removeTask(task: PendingDownload) {
</a><a href="#h10-0-75" id="h10-0-75" class="i">+        removeTask(task.id)
</a><a href="#h10-0-76" id="h10-0-76" class="i">+    }
</a><a href="#h10-0-77" id="h10-0-77" class="i">+
</a><a href="#h10-0-78" id="h10-0-78" class="i">+    fun queryAllTasks(): Map&lt;Int, PendingDownload&gt; {
</a><a href="#h10-0-79" id="h10-0-79" class="i">+        cachedTasks.putAll(queryTasks(
</a><a href="#h10-0-80" id="h10-0-80" class="i">+            from = cachedTasks.values.lastOrNull()?.id ?: Int.MAX_VALUE,
</a><a href="#h10-0-81" id="h10-0-81" class="i">+            amount = 20
</a><a href="#h10-0-82" id="h10-0-82" class="i">+        ))
</a><a href="#h10-0-83" id="h10-0-83" class="i">+        return cachedTasks.toSortedMap(reverseOrder())
</a><a href="#h10-0-84" id="h10-0-84" class="i">+    }
</a><a href="#h10-0-85" id="h10-0-85" class="i">+
</a><a href="#h10-0-86" id="h10-0-86" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h10-0-87" id="h10-0-87" class="i">+    fun queryTasks(from: Int, amount: Int = 20): Map&lt;Int, PendingDownload&gt; {
</a><a href="#h10-0-88" id="h10-0-88" class="i">+        val cursor = taskDatabase.rawQuery(&quot;SELECT * FROM tasks WHERE id &lt; ? ORDER BY id DESC LIMIT ?&quot;, arrayOf(from.toString(), amount.toString()))
</a><a href="#h10-0-89" id="h10-0-89" class="i">+        val result = sortedMapOf&lt;Int, PendingDownload&gt;()
</a><a href="#h10-0-90" id="h10-0-90" class="i">+
</a><a href="#h10-0-91" id="h10-0-91" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h10-0-92" id="h10-0-92" class="i">+            val task = PendingDownload(
</a><a href="#h10-0-93" id="h10-0-93" class="i">+                id = cursor.getInt(cursor.getColumnIndex(&quot;id&quot;)),
</a><a href="#h10-0-94" id="h10-0-94" class="i">+                outputFile = cursor.getString(cursor.getColumnIndex(&quot;outputFile&quot;)),
</a><a href="#h10-0-95" id="h10-0-95" class="i">+                outputPath = cursor.getString(cursor.getColumnIndex(&quot;outputPath&quot;)),
</a><a href="#h10-0-96" id="h10-0-96" class="i">+                mediaDisplayType = cursor.getString(cursor.getColumnIndex(&quot;mediaDisplayType&quot;)),
</a><a href="#h10-0-97" id="h10-0-97" class="i">+                mediaDisplaySource = cursor.getString(cursor.getColumnIndex(&quot;mediaDisplaySource&quot;)),
</a><a href="#h10-0-98" id="h10-0-98" class="i">+                iconUrl = cursor.getString(cursor.getColumnIndex(&quot;iconUrl&quot;))
</a><a href="#h10-0-99" id="h10-0-99" class="i">+            ).apply {
</a><a href="#h10-0-100" id="h10-0-100" class="i">+                downloadStage = DownloadStage.valueOf(cursor.getString(cursor.getColumnIndex(&quot;downloadStage&quot;)))
</a><a href="#h10-0-101" id="h10-0-101" class="i">+                //if downloadStage is not saved, it means the app was killed before the download was finished
</a><a href="#h10-0-102" id="h10-0-102" class="i">+                if (downloadStage != DownloadStage.SAVED) {
</a><a href="#h10-0-103" id="h10-0-103" class="i">+                    downloadStage = DownloadStage.FAILED
</a><a href="#h10-0-104" id="h10-0-104" class="i">+                }
</a><a href="#h10-0-105" id="h10-0-105" class="i">+            }
</a><a href="#h10-0-106" id="h10-0-106" class="i">+            result[task.id] = task
</a><a href="#h10-0-107" id="h10-0-107" class="i">+        }
</a><a href="#h10-0-108" id="h10-0-108" class="i">+        cursor.close()
</a><a href="#h10-0-109" id="h10-0-109" class="i">+        return result.toSortedMap(reverseOrder())
</a><a href="#h10-0-110" id="h10-0-110" class="i">+    }
</a><a href="#h10-0-111" id="h10-0-111" class="i">+
</a><a href="#h10-0-112" id="h10-0-112" class="i">+    fun removeAllTasks() {
</a><a href="#h10-0-113" id="h10-0-113" class="i">+        taskDatabase.execSQL(&quot;DELETE FROM tasks&quot;)
</a><a href="#h10-0-114" id="h10-0-114" class="i">+        cachedTasks.clear()
</a><a href="#h10-0-115" id="h10-0-115" class="i">+    }
</a><a href="#h10-0-116" id="h10-0-116" class="i">+}</a><a href="#h10-0-117" id="h10-0-117" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,329 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.download
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import android.content.BroadcastReceiver
</a><a href="#h11-0-3" id="h11-0-3" class="i">+import android.content.Context
</a><a href="#h11-0-4" id="h11-0-4" class="i">+import android.content.Intent
</a><a href="#h11-0-5" id="h11-0-5" class="i">+import android.media.MediaScannerConnection
</a><a href="#h11-0-6" id="h11-0-6" class="i">+import android.os.Handler
</a><a href="#h11-0-7" id="h11-0-7" class="i">+import android.widget.Toast
</a><a href="#h11-0-8" id="h11-0-8" class="i">+import kotlinx.coroutines.DelicateCoroutinesApi
</a><a href="#h11-0-9" id="h11-0-9" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h11-0-10" id="h11-0-10" class="i">+import kotlinx.coroutines.GlobalScope
</a><a href="#h11-0-11" id="h11-0-11" class="i">+import kotlinx.coroutines.Job
</a><a href="#h11-0-12" id="h11-0-12" class="i">+import kotlinx.coroutines.job
</a><a href="#h11-0-13" id="h11-0-13" class="i">+import kotlinx.coroutines.joinAll
</a><a href="#h11-0-14" id="h11-0-14" class="i">+import kotlinx.coroutines.launch
</a><a href="#h11-0-15" id="h11-0-15" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h11-0-16" id="h11-0-16" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h11-0-17" id="h11-0-17" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h11-0-18" id="h11-0-18" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h11-0-19" id="h11-0-19" class="i">+import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h11-0-20" id="h11-0-20" class="i">+import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h11-0-21" id="h11-0-21" class="i">+import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h11-0-22" id="h11-0-22" class="i">+import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h11-0-23" id="h11-0-23" class="i">+import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h11-0-24" id="h11-0-24" class="i">+import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h11-0-25" id="h11-0-25" class="i">+import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h11-0-26" id="h11-0-26" class="i">+import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h11-0-27" id="h11-0-27" class="i">+import java.io.File
</a><a href="#h11-0-28" id="h11-0-28" class="i">+import java.io.InputStream
</a><a href="#h11-0-29" id="h11-0-29" class="i">+import java.net.HttpURLConnection
</a><a href="#h11-0-30" id="h11-0-30" class="i">+import java.net.URL
</a><a href="#h11-0-31" id="h11-0-31" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h11-0-32" id="h11-0-32" class="i">+import javax.crypto.Cipher
</a><a href="#h11-0-33" id="h11-0-33" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h11-0-34" id="h11-0-34" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h11-0-35" id="h11-0-35" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h11-0-36" id="h11-0-36" class="i">+import javax.xml.parsers.DocumentBuilderFactory
</a><a href="#h11-0-37" id="h11-0-37" class="i">+import javax.xml.transform.TransformerFactory
</a><a href="#h11-0-38" id="h11-0-38" class="i">+import javax.xml.transform.dom.DOMSource
</a><a href="#h11-0-39" id="h11-0-39" class="i">+import javax.xml.transform.stream.StreamResult
</a><a href="#h11-0-40" id="h11-0-40" class="i">+import kotlin.coroutines.coroutineContext
</a><a href="#h11-0-41" id="h11-0-41" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h11-0-42" id="h11-0-42" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h11-0-43" id="h11-0-43" class="i">+
</a><a href="#h11-0-44" id="h11-0-44" class="i">+data class DownloadedFile(
</a><a href="#h11-0-45" id="h11-0-45" class="i">+    val file: File,
</a><a href="#h11-0-46" id="h11-0-46" class="i">+    val fileType: FileType
</a><a href="#h11-0-47" id="h11-0-47" class="i">+)
</a><a href="#h11-0-48" id="h11-0-48" class="i">+
</a><a href="#h11-0-49" id="h11-0-49" class="i">+/**
</a><a href="#h11-0-50" id="h11-0-50" class="i">+ * MediaDownloadReceiver handles the download of media files
</a><a href="#h11-0-51" id="h11-0-51" class="i">+ */
</a><a href="#h11-0-52" id="h11-0-52" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h11-0-53" id="h11-0-53" class="i">+class MediaDownloadReceiver : BroadcastReceiver() {
</a><a href="#h11-0-54" id="h11-0-54" class="i">+    companion object {
</a><a href="#h11-0-55" id="h11-0-55" class="i">+        val downloadTaskManager = DownloadTaskManager()
</a><a href="#h11-0-56" id="h11-0-56" class="i">+        const val DOWNLOAD_ACTION = &quot;me.rhunk.snapenhance.download.MediaDownloadReceiver.DOWNLOAD_ACTION&quot;
</a><a href="#h11-0-57" id="h11-0-57" class="i">+    }
</a><a href="#h11-0-58" id="h11-0-58" class="i">+
</a><a href="#h11-0-59" id="h11-0-59" class="i">+    private lateinit var context: Context
</a><a href="#h11-0-60" id="h11-0-60" class="i">+
</a><a href="#h11-0-61" id="h11-0-61" class="i">+    private fun runOnUIThread(block: () -&gt; Unit) {
</a><a href="#h11-0-62" id="h11-0-62" class="i">+        Handler(context.mainLooper).post(block)
</a><a href="#h11-0-63" id="h11-0-63" class="i">+    }
</a><a href="#h11-0-64" id="h11-0-64" class="i">+
</a><a href="#h11-0-65" id="h11-0-65" class="i">+    private fun shortToast(text: String) {
</a><a href="#h11-0-66" id="h11-0-66" class="i">+        runOnUIThread {
</a><a href="#h11-0-67" id="h11-0-67" class="i">+            Toast.makeText(context, text, Toast.LENGTH_SHORT).show()
</a><a href="#h11-0-68" id="h11-0-68" class="i">+        }
</a><a href="#h11-0-69" id="h11-0-69" class="i">+    }
</a><a href="#h11-0-70" id="h11-0-70" class="i">+
</a><a href="#h11-0-71" id="h11-0-71" class="i">+    private fun longToast(text: String) {
</a><a href="#h11-0-72" id="h11-0-72" class="i">+        runOnUIThread {
</a><a href="#h11-0-73" id="h11-0-73" class="i">+            Toast.makeText(context, text, Toast.LENGTH_LONG).show()
</a><a href="#h11-0-74" id="h11-0-74" class="i">+        }
</a><a href="#h11-0-75" id="h11-0-75" class="i">+    }
</a><a href="#h11-0-76" id="h11-0-76" class="i">+
</a><a href="#h11-0-77" id="h11-0-77" class="i">+    private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
</a><a href="#h11-0-78" id="h11-0-78" class="i">+        val files = mutableListOf&lt;File&gt;()
</a><a href="#h11-0-79" id="h11-0-79" class="i">+        val zipInputStream = ZipInputStream(inputStream)
</a><a href="#h11-0-80" id="h11-0-80" class="i">+        var entry = zipInputStream.nextEntry
</a><a href="#h11-0-81" id="h11-0-81" class="i">+
</a><a href="#h11-0-82" id="h11-0-82" class="i">+        while (entry != null) {
</a><a href="#h11-0-83" id="h11-0-83" class="i">+            createMediaTempFile().also { file -&gt;
</a><a href="#h11-0-84" id="h11-0-84" class="i">+                file.outputStream().use { outputStream -&gt;
</a><a href="#h11-0-85" id="h11-0-85" class="i">+                    zipInputStream.copyTo(outputStream)
</a><a href="#h11-0-86" id="h11-0-86" class="i">+                }
</a><a href="#h11-0-87" id="h11-0-87" class="i">+                files += file
</a><a href="#h11-0-88" id="h11-0-88" class="i">+            }
</a><a href="#h11-0-89" id="h11-0-89" class="i">+            entry = zipInputStream.nextEntry
</a><a href="#h11-0-90" id="h11-0-90" class="i">+        }
</a><a href="#h11-0-91" id="h11-0-91" class="i">+
</a><a href="#h11-0-92" id="h11-0-92" class="i">+        return files
</a><a href="#h11-0-93" id="h11-0-93" class="i">+    }
</a><a href="#h11-0-94" id="h11-0-94" class="i">+
</a><a href="#h11-0-95" id="h11-0-95" class="i">+    private fun decryptInputStream(inputStream: InputStream, encryption: MediaEncryptionKeyPair): InputStream {
</a><a href="#h11-0-96" id="h11-0-96" class="i">+        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h11-0-97" id="h11-0-97" class="i">+        val key = Base64.UrlSafe.decode(encryption.key)
</a><a href="#h11-0-98" id="h11-0-98" class="i">+        val iv = Base64.UrlSafe.decode(encryption.iv)
</a><a href="#h11-0-99" id="h11-0-99" class="i">+        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h11-0-100" id="h11-0-100" class="i">+        return CipherInputStream(inputStream, cipher)
</a><a href="#h11-0-101" id="h11-0-101" class="i">+    }
</a><a href="#h11-0-102" id="h11-0-102" class="i">+
</a><a href="#h11-0-103" id="h11-0-103" class="i">+    private fun createNeededDirectories(file: File): File {
</a><a href="#h11-0-104" id="h11-0-104" class="i">+        val directory = file.parentFile ?: return file
</a><a href="#h11-0-105" id="h11-0-105" class="i">+        if (!directory.exists()) {
</a><a href="#h11-0-106" id="h11-0-106" class="i">+            directory.mkdirs()
</a><a href="#h11-0-107" id="h11-0-107" class="i">+        }
</a><a href="#h11-0-108" id="h11-0-108" class="i">+        return file
</a><a href="#h11-0-109" id="h11-0-109" class="i">+    }
</a><a href="#h11-0-110" id="h11-0-110" class="i">+
</a><a href="#h11-0-111" id="h11-0-111" class="i">+    private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
</a><a href="#h11-0-112" id="h11-0-112" class="i">+        if (coroutineContext.job.isCancelled) return
</a><a href="#h11-0-113" id="h11-0-113" class="i">+
</a><a href="#h11-0-114" id="h11-0-114" class="i">+        runCatching {
</a><a href="#h11-0-115" id="h11-0-115" class="i">+            val fileType = FileType.fromFile(inputFile)
</a><a href="#h11-0-116" id="h11-0-116" class="i">+            val outputFile = File(pendingDownload.outputPath + &quot;.&quot; + fileType.fileExtension).also { createNeededDirectories(it) }
</a><a href="#h11-0-117" id="h11-0-117" class="i">+            inputFile.copyTo(outputFile, overwrite = true)
</a><a href="#h11-0-118" id="h11-0-118" class="i">+
</a><a href="#h11-0-119" id="h11-0-119" class="i">+            MediaScannerConnection.scanFile(context, arrayOf(outputFile.absolutePath), null, null)
</a><a href="#h11-0-120" id="h11-0-120" class="i">+
</a><a href="#h11-0-121" id="h11-0-121" class="i">+            //print the path of the saved media
</a><a href="#h11-0-122" id="h11-0-122" class="i">+            val parentName = outputFile.parentFile?.parentFile?.absolutePath?.let {
</a><a href="#h11-0-123" id="h11-0-123" class="i">+                if (!it.endsWith(&quot;/&quot;)) &quot;$it/&quot; else it
</a><a href="#h11-0-124" id="h11-0-124" class="i">+            }
</a><a href="#h11-0-125" id="h11-0-125" class="i">+
</a><a href="#h11-0-126" id="h11-0-126" class="i">+            longToast(&quot;Saved media to ${outputFile.absolutePath.replace(parentName ?: &quot;&quot;, &quot;&quot;)}&quot;)
</a><a href="#h11-0-127" id="h11-0-127" class="i">+
</a><a href="#h11-0-128" id="h11-0-128" class="i">+            pendingDownload.outputFile = outputFile.absolutePath
</a><a href="#h11-0-129" id="h11-0-129" class="i">+            pendingDownload.downloadStage = DownloadStage.SAVED
</a><a href="#h11-0-130" id="h11-0-130" class="i">+        }.onFailure {
</a><a href="#h11-0-131" id="h11-0-131" class="i">+            Logger.error(&quot;Failed to save media to gallery&quot;, it)
</a><a href="#h11-0-132" id="h11-0-132" class="i">+            longToast(&quot;Failed to save media to gallery&quot;)
</a><a href="#h11-0-133" id="h11-0-133" class="i">+            pendingDownload.downloadStage = DownloadStage.FAILED
</a><a href="#h11-0-134" id="h11-0-134" class="i">+        }
</a><a href="#h11-0-135" id="h11-0-135" class="i">+    }
</a><a href="#h11-0-136" id="h11-0-136" class="i">+
</a><a href="#h11-0-137" id="h11-0-137" class="i">+    private fun createMediaTempFile(): File {
</a><a href="#h11-0-138" id="h11-0-138" class="i">+        return File.createTempFile(&quot;media&quot;, &quot;.tmp&quot;)
</a><a href="#h11-0-139" id="h11-0-139" class="i">+    }
</a><a href="#h11-0-140" id="h11-0-140" class="i">+
</a><a href="#h11-0-141" id="h11-0-141" class="i">+    private fun downloadInputMedias(downloadRequest: DownloadRequest) = runBlocking {
</a><a href="#h11-0-142" id="h11-0-142" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h11-0-143" id="h11-0-143" class="i">+        val downloadedMedias = mutableMapOf&lt;InputMedia, File&gt;()
</a><a href="#h11-0-144" id="h11-0-144" class="i">+
</a><a href="#h11-0-145" id="h11-0-145" class="i">+        downloadRequest.getInputMedias().forEach { inputMedia -&gt;
</a><a href="#h11-0-146" id="h11-0-146" class="i">+            fun handleInputStream(inputStream: InputStream) {
</a><a href="#h11-0-147" id="h11-0-147" class="i">+                createMediaTempFile().apply {
</a><a href="#h11-0-148" id="h11-0-148" class="i">+                    if (inputMedia.encryption != null) {
</a><a href="#h11-0-149" id="h11-0-149" class="i">+                        decryptInputStream(inputStream, inputMedia.encryption).use { decryptedInputStream -&gt;
</a><a href="#h11-0-150" id="h11-0-150" class="i">+                            decryptedInputStream.copyTo(outputStream())
</a><a href="#h11-0-151" id="h11-0-151" class="i">+                        }
</a><a href="#h11-0-152" id="h11-0-152" class="i">+                    } else {
</a><a href="#h11-0-153" id="h11-0-153" class="i">+                        inputStream.copyTo(outputStream())
</a><a href="#h11-0-154" id="h11-0-154" class="i">+                    }
</a><a href="#h11-0-155" id="h11-0-155" class="i">+                }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h11-0-156" id="h11-0-156" class="i">+            }
</a><a href="#h11-0-157" id="h11-0-157" class="i">+
</a><a href="#h11-0-158" id="h11-0-158" class="i">+            launch {
</a><a href="#h11-0-159" id="h11-0-159" class="i">+                when (inputMedia.type) {
</a><a href="#h11-0-160" id="h11-0-160" class="i">+                    DownloadMediaType.PROTO_MEDIA -&gt; {
</a><a href="#h11-0-161" id="h11-0-161" class="i">+                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content))?.let { inputStream -&gt;
</a><a href="#h11-0-162" id="h11-0-162" class="i">+                            handleInputStream(inputStream)
</a><a href="#h11-0-163" id="h11-0-163" class="i">+                        }
</a><a href="#h11-0-164" id="h11-0-164" class="i">+                    }
</a><a href="#h11-0-165" id="h11-0-165" class="i">+                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h11-0-166" id="h11-0-166" class="i">+                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h11-0-167" id="h11-0-167" class="i">+                        createMediaTempFile().apply {
</a><a href="#h11-0-168" id="h11-0-168" class="i">+                            writeBytes(decoded)
</a><a href="#h11-0-169" id="h11-0-169" class="i">+                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h11-0-170" id="h11-0-170" class="i">+                    }
</a><a href="#h11-0-171" id="h11-0-171" class="i">+                    DownloadMediaType.REMOTE_MEDIA -&gt; {
</a><a href="#h11-0-172" id="h11-0-172" class="i">+                        with(URL(inputMedia.content).openConnection() as HttpURLConnection) {
</a><a href="#h11-0-173" id="h11-0-173" class="i">+                            requestMethod = &quot;GET&quot;
</a><a href="#h11-0-174" id="h11-0-174" class="i">+                            setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h11-0-175" id="h11-0-175" class="i">+                            connect()
</a><a href="#h11-0-176" id="h11-0-176" class="i">+                            handleInputStream(inputStream)
</a><a href="#h11-0-177" id="h11-0-177" class="i">+                        }
</a><a href="#h11-0-178" id="h11-0-178" class="i">+                    }
</a><a href="#h11-0-179" id="h11-0-179" class="i">+                    else -&gt; {
</a><a href="#h11-0-180" id="h11-0-180" class="i">+                        downloadedMedias[inputMedia] = File(inputMedia.content)
</a><a href="#h11-0-181" id="h11-0-181" class="i">+                    }
</a><a href="#h11-0-182" id="h11-0-182" class="i">+                }
</a><a href="#h11-0-183" id="h11-0-183" class="i">+            }.also { jobs.add(it) }
</a><a href="#h11-0-184" id="h11-0-184" class="i">+        }
</a><a href="#h11-0-185" id="h11-0-185" class="i">+
</a><a href="#h11-0-186" id="h11-0-186" class="i">+        jobs.joinAll()
</a><a href="#h11-0-187" id="h11-0-187" class="i">+        downloadedMedias
</a><a href="#h11-0-188" id="h11-0-188" class="i">+    }
</a><a href="#h11-0-189" id="h11-0-189" class="i">+
</a><a href="#h11-0-190" id="h11-0-190" class="i">+    private suspend fun downloadRemoteMedia(pendingDownloadObject:  PendingDownload, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h11-0-191" id="h11-0-191" class="i">+        downloadRequest.getInputMedias().first().let { inputMedia -&gt;
</a><a href="#h11-0-192" id="h11-0-192" class="i">+            val mediaType = downloadRequest.getInputType(0)!!
</a><a href="#h11-0-193" id="h11-0-193" class="i">+            val media = downloadedMedias[inputMedia]!!
</a><a href="#h11-0-194" id="h11-0-194" class="i">+
</a><a href="#h11-0-195" id="h11-0-195" class="i">+            if (!downloadRequest.isDashPlaylist) {
</a><a href="#h11-0-196" id="h11-0-196" class="i">+                saveMediaToGallery(media.file, pendingDownloadObject)
</a><a href="#h11-0-197" id="h11-0-197" class="i">+                media.file.delete()
</a><a href="#h11-0-198" id="h11-0-198" class="i">+                return
</a><a href="#h11-0-199" id="h11-0-199" class="i">+            }
</a><a href="#h11-0-200" id="h11-0-200" class="i">+
</a><a href="#h11-0-201" id="h11-0-201" class="i">+            assert(mediaType == DownloadMediaType.REMOTE_MEDIA)
</a><a href="#h11-0-202" id="h11-0-202" class="i">+
</a><a href="#h11-0-203" id="h11-0-203" class="i">+            val playlistXml = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(media.file)
</a><a href="#h11-0-204" id="h11-0-204" class="i">+            val baseUrlNodeList = playlistXml.getElementsByTagName(&quot;BaseURL&quot;)
</a><a href="#h11-0-205" id="h11-0-205" class="i">+            for (i in 0 until baseUrlNodeList.length) {
</a><a href="#h11-0-206" id="h11-0-206" class="i">+                val baseUrlNode = baseUrlNodeList.item(i)
</a><a href="#h11-0-207" id="h11-0-207" class="i">+                val baseUrl = baseUrlNode.textContent
</a><a href="#h11-0-208" id="h11-0-208" class="i">+                baseUrlNode.textContent = &quot;${RemoteMediaResolver.CF_ST_CDN_D}$baseUrl&quot;
</a><a href="#h11-0-209" id="h11-0-209" class="i">+            }
</a><a href="#h11-0-210" id="h11-0-210" class="i">+
</a><a href="#h11-0-211" id="h11-0-211" class="i">+            val dashOptions = downloadRequest.getDashOptions()!!
</a><a href="#h11-0-212" id="h11-0-212" class="i">+
</a><a href="#h11-0-213" id="h11-0-213" class="i">+            val dashPlaylistFile = renameFromFileType(media.file, FileType.MPD)
</a><a href="#h11-0-214" id="h11-0-214" class="i">+            val xmlData = dashPlaylistFile.outputStream()
</a><a href="#h11-0-215" id="h11-0-215" class="i">+            TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
</a><a href="#h11-0-216" id="h11-0-216" class="i">+
</a><a href="#h11-0-217" id="h11-0-217" class="i">+            longToast(&quot;Downloading dash media...&quot;)
</a><a href="#h11-0-218" id="h11-0-218" class="i">+            val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
</a><a href="#h11-0-219" id="h11-0-219" class="i">+            runCatching {
</a><a href="#h11-0-220" id="h11-0-220" class="i">+                MediaDownloaderHelper.downloadDashChapterFile(
</a><a href="#h11-0-221" id="h11-0-221" class="i">+                    dashPlaylist = dashPlaylistFile,
</a><a href="#h11-0-222" id="h11-0-222" class="i">+                    output = outputFile,
</a><a href="#h11-0-223" id="h11-0-223" class="i">+                    startTime = dashOptions.offsetTime,
</a><a href="#h11-0-224" id="h11-0-224" class="i">+                    duration = dashOptions.duration)
</a><a href="#h11-0-225" id="h11-0-225" class="i">+                saveMediaToGallery(outputFile, pendingDownloadObject)
</a><a href="#h11-0-226" id="h11-0-226" class="i">+            }.onFailure {
</a><a href="#h11-0-227" id="h11-0-227" class="i">+                if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h11-0-228" id="h11-0-228" class="i">+                Logger.error(&quot;failed to download dash media&quot;, it)
</a><a href="#h11-0-229" id="h11-0-229" class="i">+                longToast(&quot;Failed to download dash media: ${it.message}&quot;)
</a><a href="#h11-0-230" id="h11-0-230" class="i">+                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h11-0-231" id="h11-0-231" class="i">+            }
</a><a href="#h11-0-232" id="h11-0-232" class="i">+
</a><a href="#h11-0-233" id="h11-0-233" class="i">+            dashPlaylistFile.delete()
</a><a href="#h11-0-234" id="h11-0-234" class="i">+            outputFile.delete()
</a><a href="#h11-0-235" id="h11-0-235" class="i">+            media.file.delete()
</a><a href="#h11-0-236" id="h11-0-236" class="i">+        }
</a><a href="#h11-0-237" id="h11-0-237" class="i">+    }
</a><a href="#h11-0-238" id="h11-0-238" class="i">+
</a><a href="#h11-0-239" id="h11-0-239" class="i">+    private fun renameFromFileType(file: File, fileType: FileType): File {
</a><a href="#h11-0-240" id="h11-0-240" class="i">+        val newFile = File(file.parentFile, file.nameWithoutExtension + &quot;.&quot; + fileType.fileExtension)
</a><a href="#h11-0-241" id="h11-0-241" class="i">+        file.renameTo(newFile)
</a><a href="#h11-0-242" id="h11-0-242" class="i">+        return newFile
</a><a href="#h11-0-243" id="h11-0-243" class="i">+    }
</a><a href="#h11-0-244" id="h11-0-244" class="i">+
</a><a href="#h11-0-245" id="h11-0-245" class="i">+    @OptIn(DelicateCoroutinesApi::class)
</a><a href="#h11-0-246" id="h11-0-246" class="i">+    override fun onReceive(context: Context, intent: Intent) {
</a><a href="#h11-0-247" id="h11-0-247" class="i">+        if (intent.action != DOWNLOAD_ACTION) return
</a><a href="#h11-0-248" id="h11-0-248" class="i">+        this.context = context
</a><a href="#h11-0-249" id="h11-0-249" class="i">+        downloadTaskManager.init(context)
</a><a href="#h11-0-250" id="h11-0-250" class="i">+
</a><a href="#h11-0-251" id="h11-0-251" class="i">+        val downloadRequest = DownloadRequest.fromBundle(intent.extras!!)
</a><a href="#h11-0-252" id="h11-0-252" class="i">+
</a><a href="#h11-0-253" id="h11-0-253" class="i">+        GlobalScope.launch(Dispatchers.IO) {
</a><a href="#h11-0-254" id="h11-0-254" class="i">+            val pendingDownloadObject = PendingDownload.fromBundle(intent.extras!!)
</a><a href="#h11-0-255" id="h11-0-255" class="i">+
</a><a href="#h11-0-256" id="h11-0-256" class="i">+            downloadTaskManager.addTask(pendingDownloadObject)
</a><a href="#h11-0-257" id="h11-0-257" class="i">+            pendingDownloadObject.apply {
</a><a href="#h11-0-258" id="h11-0-258" class="i">+                job = coroutineContext.job
</a><a href="#h11-0-259" id="h11-0-259" class="i">+                downloadStage = DownloadStage.DOWNLOADING
</a><a href="#h11-0-260" id="h11-0-260" class="i">+            }
</a><a href="#h11-0-261" id="h11-0-261" class="i">+
</a><a href="#h11-0-262" id="h11-0-262" class="i">+            runCatching {
</a><a href="#h11-0-263" id="h11-0-263" class="i">+                //first download all input medias into cache
</a><a href="#h11-0-264" id="h11-0-264" class="i">+                val downloadedMedias = downloadInputMedias(downloadRequest).map {
</a><a href="#h11-0-265" id="h11-0-265" class="i">+                    it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
</a><a href="#h11-0-266" id="h11-0-266" class="i">+                }.toMap().toMutableMap()
</a><a href="#h11-0-267" id="h11-0-267" class="i">+
</a><a href="#h11-0-268" id="h11-0-268" class="i">+                var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
</a><a href="#h11-0-269" id="h11-0-269" class="i">+
</a><a href="#h11-0-270" id="h11-0-270" class="i">+                //if there is a zip file, extract it and replace the downloaded media with the extracted ones
</a><a href="#h11-0-271" id="h11-0-271" class="i">+                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { entry -&gt;
</a><a href="#h11-0-272" id="h11-0-272" class="i">+                    val extractedMedias = extractZip(entry.file.inputStream()).map {
</a><a href="#h11-0-273" id="h11-0-273" class="i">+                        InputMedia(
</a><a href="#h11-0-274" id="h11-0-274" class="i">+                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h11-0-275" id="h11-0-275" class="i">+                            content = it.absolutePath
</a><a href="#h11-0-276" id="h11-0-276" class="i">+                        ) to DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h11-0-277" id="h11-0-277" class="i">+                    }
</a><a href="#h11-0-278" id="h11-0-278" class="i">+
</a><a href="#h11-0-279" id="h11-0-279" class="i">+                    downloadedMedias.values.removeIf {
</a><a href="#h11-0-280" id="h11-0-280" class="i">+                        it.file.delete()
</a><a href="#h11-0-281" id="h11-0-281" class="i">+                        true
</a><a href="#h11-0-282" id="h11-0-282" class="i">+                    }
</a><a href="#h11-0-283" id="h11-0-283" class="i">+
</a><a href="#h11-0-284" id="h11-0-284" class="i">+                    downloadedMedias.putAll(extractedMedias)
</a><a href="#h11-0-285" id="h11-0-285" class="i">+                    shouldMergeOverlay = true
</a><a href="#h11-0-286" id="h11-0-286" class="i">+                }
</a><a href="#h11-0-287" id="h11-0-287" class="i">+
</a><a href="#h11-0-288" id="h11-0-288" class="i">+                if (shouldMergeOverlay) {
</a><a href="#h11-0-289" id="h11-0-289" class="i">+                    assert(downloadedMedias.size == 2)
</a><a href="#h11-0-290" id="h11-0-290" class="i">+                    val media = downloadedMedias.values.first { it.fileType.isVideo }
</a><a href="#h11-0-291" id="h11-0-291" class="i">+                    val overlayMedia = downloadedMedias.values.first { it.fileType.isImage }
</a><a href="#h11-0-292" id="h11-0-292" class="i">+
</a><a href="#h11-0-293" id="h11-0-293" class="i">+                    val renamedMedia = renameFromFileType(media.file, media.fileType)
</a><a href="#h11-0-294" id="h11-0-294" class="i">+                    val renamedOverlayMedia = renameFromFileType(overlayMedia.file, overlayMedia.fileType)
</a><a href="#h11-0-295" id="h11-0-295" class="i">+                    val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
</a><a href="#h11-0-296" id="h11-0-296" class="i">+                    runCatching {
</a><a href="#h11-0-297" id="h11-0-297" class="i">+                        longToast(&quot;Merging overlay...&quot;)
</a><a href="#h11-0-298" id="h11-0-298" class="i">+                        pendingDownloadObject.downloadStage = DownloadStage.MERGING
</a><a href="#h11-0-299" id="h11-0-299" class="i">+
</a><a href="#h11-0-300" id="h11-0-300" class="i">+                        MediaDownloaderHelper.mergeOverlayFile(
</a><a href="#h11-0-301" id="h11-0-301" class="i">+                            media = renamedMedia,
</a><a href="#h11-0-302" id="h11-0-302" class="i">+                            overlay = renamedOverlayMedia,
</a><a href="#h11-0-303" id="h11-0-303" class="i">+                            output = mergedOverlay
</a><a href="#h11-0-304" id="h11-0-304" class="i">+                        )
</a><a href="#h11-0-305" id="h11-0-305" class="i">+
</a><a href="#h11-0-306" id="h11-0-306" class="i">+                        saveMediaToGallery(mergedOverlay, pendingDownloadObject)
</a><a href="#h11-0-307" id="h11-0-307" class="i">+                    }.onFailure {
</a><a href="#h11-0-308" id="h11-0-308" class="i">+                        if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h11-0-309" id="h11-0-309" class="i">+                        Logger.error(&quot;failed to merge overlay&quot;, it)
</a><a href="#h11-0-310" id="h11-0-310" class="i">+                        longToast(&quot;Failed to merge overlay: ${it.message}&quot;)
</a><a href="#h11-0-311" id="h11-0-311" class="i">+                        pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h11-0-312" id="h11-0-312" class="i">+                    }
</a><a href="#h11-0-313" id="h11-0-313" class="i">+
</a><a href="#h11-0-314" id="h11-0-314" class="i">+                    mergedOverlay.delete()
</a><a href="#h11-0-315" id="h11-0-315" class="i">+                    renamedOverlayMedia.delete()
</a><a href="#h11-0-316" id="h11-0-316" class="i">+                    renamedMedia.delete()
</a><a href="#h11-0-317" id="h11-0-317" class="i">+                    return@launch
</a><a href="#h11-0-318" id="h11-0-318" class="i">+                }
</a><a href="#h11-0-319" id="h11-0-319" class="i">+
</a><a href="#h11-0-320" id="h11-0-320" class="i">+                downloadRemoteMedia(pendingDownloadObject, downloadedMedias, downloadRequest)
</a><a href="#h11-0-321" id="h11-0-321" class="i">+            }.onFailure {
</a><a href="#h11-0-322" id="h11-0-322" class="i">+                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h11-0-323" id="h11-0-323" class="i">+                Logger.error(&quot;failed to download media&quot;, it)
</a><a href="#h11-0-324" id="h11-0-324" class="i">+                longToast(&quot;Failed to download media: ${it.message}&quot;)
</a><a href="#h11-0-325" id="h11-0-325" class="i">+            }
</a><a href="#h11-0-326" id="h11-0-326" class="i">+        }
</a><a href="#h11-0-327" id="h11-0-327" class="i">+    }
</a><a href="#h11-0-328" id="h11-0-328" class="i">+}</a><a href="#h11-0-329" id="h11-0-329" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,105 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+import android.os.Bundle
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h12-0-4" id="h12-0-4" class="i">+
</a><a href="#h12-0-5" id="h12-0-5" class="i">+
</a><a href="#h12-0-6" id="h12-0-6" class="i">+data class DashOptions(val offsetTime: Long, val duration: Long?)
</a><a href="#h12-0-7" id="h12-0-7" class="i">+data class InputMedia(
</a><a href="#h12-0-8" id="h12-0-8" class="i">+    val content: String,
</a><a href="#h12-0-9" id="h12-0-9" class="i">+    val type: DownloadMediaType,
</a><a href="#h12-0-10" id="h12-0-10" class="i">+    val encryption: MediaEncryptionKeyPair? = null
</a><a href="#h12-0-11" id="h12-0-11" class="i">+)
</a><a href="#h12-0-12" id="h12-0-12" class="i">+
</a><a href="#h12-0-13" id="h12-0-13" class="i">+class DownloadRequest(
</a><a href="#h12-0-14" id="h12-0-14" class="i">+    private val outputPath: String = &quot;&quot;,
</a><a href="#h12-0-15" id="h12-0-15" class="i">+    private val inputMedias: Array&lt;String&gt;,
</a><a href="#h12-0-16" id="h12-0-16" class="i">+    private val inputTypes: Array&lt;String&gt;,
</a><a href="#h12-0-17" id="h12-0-17" class="i">+    private val mediaEncryption: Map&lt;String, MediaEncryptionKeyPair&gt; = emptyMap(),
</a><a href="#h12-0-18" id="h12-0-18" class="i">+    private val flags: Int = 0,
</a><a href="#h12-0-19" id="h12-0-19" class="i">+    private val dashOptions: Map&lt;String, String?&gt;? = null,
</a><a href="#h12-0-20" id="h12-0-20" class="i">+    private val mediaDisplaySource: String? = null,
</a><a href="#h12-0-21" id="h12-0-21" class="i">+    private val mediaDisplayType: String? = null
</a><a href="#h12-0-22" id="h12-0-22" class="i">+) {
</a><a href="#h12-0-23" id="h12-0-23" class="i">+    companion object {
</a><a href="#h12-0-24" id="h12-0-24" class="i">+        fun fromBundle(bundle: Bundle): DownloadRequest {
</a><a href="#h12-0-25" id="h12-0-25" class="i">+            return DownloadRequest(
</a><a href="#h12-0-26" id="h12-0-26" class="i">+                outputPath = bundle.getString(&quot;outputPath&quot;)!!,
</a><a href="#h12-0-27" id="h12-0-27" class="i">+                mediaDisplaySource = bundle.getString(&quot;mediaDisplaySource&quot;),
</a><a href="#h12-0-28" id="h12-0-28" class="i">+                mediaDisplayType = bundle.getString(&quot;mediaDisplayType&quot;),
</a><a href="#h12-0-29" id="h12-0-29" class="i">+                inputMedias = bundle.getStringArray(&quot;inputMedias&quot;)!!,
</a><a href="#h12-0-30" id="h12-0-30" class="i">+                inputTypes = bundle.getStringArray(&quot;inputTypes&quot;)!!,
</a><a href="#h12-0-31" id="h12-0-31" class="i">+                mediaEncryption = bundle.getStringArray(&quot;mediaEncryption&quot;)?.associate { entry -&gt;
</a><a href="#h12-0-32" id="h12-0-32" class="i">+                    entry.split(&quot;|&quot;).let {
</a><a href="#h12-0-33" id="h12-0-33" class="i">+                        it[0] to MediaEncryptionKeyPair(it[1], it[2])
</a><a href="#h12-0-34" id="h12-0-34" class="i">+                    }
</a><a href="#h12-0-35" id="h12-0-35" class="i">+                } ?: emptyMap(),
</a><a href="#h12-0-36" id="h12-0-36" class="i">+                dashOptions = bundle.getBundle(&quot;dashOptions&quot;)?.let { options -&gt;
</a><a href="#h12-0-37" id="h12-0-37" class="i">+                    options.keySet().associateWith { key -&gt;
</a><a href="#h12-0-38" id="h12-0-38" class="i">+                        options.getString(key)
</a><a href="#h12-0-39" id="h12-0-39" class="i">+                    }
</a><a href="#h12-0-40" id="h12-0-40" class="i">+                },
</a><a href="#h12-0-41" id="h12-0-41" class="i">+                flags = bundle.getInt(&quot;flags&quot;, 0)
</a><a href="#h12-0-42" id="h12-0-42" class="i">+            )
</a><a href="#h12-0-43" id="h12-0-43" class="i">+        }
</a><a href="#h12-0-44" id="h12-0-44" class="i">+    }
</a><a href="#h12-0-45" id="h12-0-45" class="i">+
</a><a href="#h12-0-46" id="h12-0-46" class="i">+    fun toBundle(): Bundle {
</a><a href="#h12-0-47" id="h12-0-47" class="i">+        return Bundle().apply {
</a><a href="#h12-0-48" id="h12-0-48" class="i">+            putString(&quot;outputPath&quot;, outputPath)
</a><a href="#h12-0-49" id="h12-0-49" class="i">+            putString(&quot;mediaDisplaySource&quot;, mediaDisplaySource)
</a><a href="#h12-0-50" id="h12-0-50" class="i">+            putString(&quot;mediaDisplayType&quot;, mediaDisplayType)
</a><a href="#h12-0-51" id="h12-0-51" class="i">+            putStringArray(&quot;inputMedias&quot;, inputMedias)
</a><a href="#h12-0-52" id="h12-0-52" class="i">+            putStringArray(&quot;inputTypes&quot;, inputTypes)
</a><a href="#h12-0-53" id="h12-0-53" class="i">+            putStringArray(&quot;mediaEncryption&quot;, mediaEncryption.map { entry -&gt;
</a><a href="#h12-0-54" id="h12-0-54" class="i">+                &quot;${entry.key}|${entry.value.key}|${entry.value.iv}&quot;
</a><a href="#h12-0-55" id="h12-0-55" class="i">+            }.toTypedArray())
</a><a href="#h12-0-56" id="h12-0-56" class="i">+            putBundle(&quot;dashOptions&quot;, dashOptions?.let { bundle -&gt;
</a><a href="#h12-0-57" id="h12-0-57" class="i">+                Bundle().apply {
</a><a href="#h12-0-58" id="h12-0-58" class="i">+                    bundle.forEach { (key, value) -&gt;
</a><a href="#h12-0-59" id="h12-0-59" class="i">+                        putString(key, value)
</a><a href="#h12-0-60" id="h12-0-60" class="i">+                    }
</a><a href="#h12-0-61" id="h12-0-61" class="i">+                }
</a><a href="#h12-0-62" id="h12-0-62" class="i">+            })
</a><a href="#h12-0-63" id="h12-0-63" class="i">+            putInt(&quot;flags&quot;, flags)
</a><a href="#h12-0-64" id="h12-0-64" class="i">+        }
</a><a href="#h12-0-65" id="h12-0-65" class="i">+    }
</a><a href="#h12-0-66" id="h12-0-66" class="i">+
</a><a href="#h12-0-67" id="h12-0-67" class="i">+    object Flags {
</a><a href="#h12-0-68" id="h12-0-68" class="i">+        const val SHOULD_MERGE_OVERLAY = 1
</a><a href="#h12-0-69" id="h12-0-69" class="i">+        const val IS_DASH_PLAYLIST = 2
</a><a href="#h12-0-70" id="h12-0-70" class="i">+    }
</a><a href="#h12-0-71" id="h12-0-71" class="i">+
</a><a href="#h12-0-72" id="h12-0-72" class="i">+    val isDashPlaylist: Boolean
</a><a href="#h12-0-73" id="h12-0-73" class="i">+        get() = flags and Flags.IS_DASH_PLAYLIST != 0
</a><a href="#h12-0-74" id="h12-0-74" class="i">+
</a><a href="#h12-0-75" id="h12-0-75" class="i">+    val shouldMergeOverlay: Boolean
</a><a href="#h12-0-76" id="h12-0-76" class="i">+        get() = flags and Flags.SHOULD_MERGE_OVERLAY != 0
</a><a href="#h12-0-77" id="h12-0-77" class="i">+
</a><a href="#h12-0-78" id="h12-0-78" class="i">+    fun getDashOptions(): DashOptions? {
</a><a href="#h12-0-79" id="h12-0-79" class="i">+        return dashOptions?.let {
</a><a href="#h12-0-80" id="h12-0-80" class="i">+            DashOptions(
</a><a href="#h12-0-81" id="h12-0-81" class="i">+                offsetTime = it[&quot;offsetTime&quot;]?.toLong() ?: 0,
</a><a href="#h12-0-82" id="h12-0-82" class="i">+                duration = it[&quot;duration&quot;]?.toLong()
</a><a href="#h12-0-83" id="h12-0-83" class="i">+            )
</a><a href="#h12-0-84" id="h12-0-84" class="i">+        }
</a><a href="#h12-0-85" id="h12-0-85" class="i">+    }
</a><a href="#h12-0-86" id="h12-0-86" class="i">+
</a><a href="#h12-0-87" id="h12-0-87" class="i">+    fun getInputMedia(index: Int): String? {
</a><a href="#h12-0-88" id="h12-0-88" class="i">+        return inputMedias.getOrNull(index)
</a><a href="#h12-0-89" id="h12-0-89" class="i">+    }
</a><a href="#h12-0-90" id="h12-0-90" class="i">+
</a><a href="#h12-0-91" id="h12-0-91" class="i">+    fun getInputMedias(): List&lt;InputMedia&gt; {
</a><a href="#h12-0-92" id="h12-0-92" class="i">+        return inputMedias.mapIndexed { index, uri -&gt;
</a><a href="#h12-0-93" id="h12-0-93" class="i">+            InputMedia(
</a><a href="#h12-0-94" id="h12-0-94" class="i">+                content = uri,
</a><a href="#h12-0-95" id="h12-0-95" class="i">+                type = DownloadMediaType.valueOf(inputTypes[index]),
</a><a href="#h12-0-96" id="h12-0-96" class="i">+                encryption = mediaEncryption.getOrDefault(uri, null)
</a><a href="#h12-0-97" id="h12-0-97" class="i">+            )
</a><a href="#h12-0-98" id="h12-0-98" class="i">+        }
</a><a href="#h12-0-99" id="h12-0-99" class="i">+    }
</a><a href="#h12-0-100" id="h12-0-100" class="i">+
</a><a href="#h12-0-101" id="h12-0-101" class="i">+    fun getInputType(index: Int): DownloadMediaType? {
</a><a href="#h12-0-102" id="h12-0-102" class="i">+        return inputTypes.getOrNull(index)?.let { DownloadMediaType.valueOf(it) }
</a><a href="#h12-0-103" id="h12-0-103" class="i">+    }
</a><a href="#h12-0-104" id="h12-0-104" class="i">+}</a><a href="#h12-0-105" id="h12-0-105" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+@file:OptIn(ExperimentalEncodingApi::class)
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h13-0-3" id="h13-0-3" class="i">+
</a><a href="#h13-0-4" id="h13-0-4" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.media.EncryptionWrapper
</a><a href="#h13-0-5" id="h13-0-5" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h13-0-6" id="h13-0-6" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h13-0-7" id="h13-0-7" class="i">+
</a><a href="#h13-0-8" id="h13-0-8" class="i">+// key and iv are base64 encoded
</a><a href="#h13-0-9" id="h13-0-9" class="i">+data class MediaEncryptionKeyPair(
</a><a href="#h13-0-10" id="h13-0-10" class="i">+    val key: String,
</a><a href="#h13-0-11" id="h13-0-11" class="i">+    val iv: String
</a><a href="#h13-0-12" id="h13-0-12" class="i">+)
</a><a href="#h13-0-13" id="h13-0-13" class="i">+
</a><a href="#h13-0-14" id="h13-0-14" class="i">+fun Pair&lt;ByteArray, ByteArray&gt;.toKeyPair(): MediaEncryptionKeyPair {
</a><a href="#h13-0-15" id="h13-0-15" class="i">+    return MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.first), Base64.UrlSafe.encode(this.second))
</a><a href="#h13-0-16" id="h13-0-16" class="i">+}
</a><a href="#h13-0-17" id="h13-0-17" class="i">+
</a><a href="#h13-0-18" id="h13-0-18" class="i">+fun EncryptionWrapper.toKeyPair(): MediaEncryptionKeyPair {
</a><a href="#h13-0-19" id="h13-0-19" class="i">+    return MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.keySpec), Base64.UrlSafe.encode(this.ivKeyParameterSpec))
</a><a href="#h13-0-20" id="h13-0-20" class="i">+}</a><a href="#h13-0-21" id="h13-0-21" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,49 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import android.os.Bundle
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import kotlinx.coroutines.Job
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import me.rhunk.snapenhance.download.MediaDownloadReceiver
</a><a href="#h14-0-5" id="h14-0-5" class="i">+import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h14-0-6" id="h14-0-6" class="i">+
</a><a href="#h14-0-7" id="h14-0-7" class="i">+data class PendingDownload(
</a><a href="#h14-0-8" id="h14-0-8" class="i">+    var outputFile: String? = null,
</a><a href="#h14-0-9" id="h14-0-9" class="i">+    var job: Job? = null,
</a><a href="#h14-0-10" id="h14-0-10" class="i">+
</a><a href="#h14-0-11" id="h14-0-11" class="i">+    var id: Int = 0,
</a><a href="#h14-0-12" id="h14-0-12" class="i">+    val outputPath: String,
</a><a href="#h14-0-13" id="h14-0-13" class="i">+    val mediaDisplayType: String?,
</a><a href="#h14-0-14" id="h14-0-14" class="i">+    val mediaDisplaySource: String?,
</a><a href="#h14-0-15" id="h14-0-15" class="i">+    val iconUrl: String?
</a><a href="#h14-0-16" id="h14-0-16" class="i">+) {
</a><a href="#h14-0-17" id="h14-0-17" class="i">+    companion object {
</a><a href="#h14-0-18" id="h14-0-18" class="i">+        fun fromBundle(bundle: Bundle): PendingDownload {
</a><a href="#h14-0-19" id="h14-0-19" class="i">+            return PendingDownload(
</a><a href="#h14-0-20" id="h14-0-20" class="i">+                outputPath = bundle.getString(&quot;outputPath&quot;)!!,
</a><a href="#h14-0-21" id="h14-0-21" class="i">+                mediaDisplayType = bundle.getString(&quot;mediaDisplayType&quot;),
</a><a href="#h14-0-22" id="h14-0-22" class="i">+                mediaDisplaySource = bundle.getString(&quot;mediaDisplaySource&quot;),
</a><a href="#h14-0-23" id="h14-0-23" class="i">+                iconUrl = bundle.getString(&quot;iconUrl&quot;)
</a><a href="#h14-0-24" id="h14-0-24" class="i">+            )
</a><a href="#h14-0-25" id="h14-0-25" class="i">+        }
</a><a href="#h14-0-26" id="h14-0-26" class="i">+    }
</a><a href="#h14-0-27" id="h14-0-27" class="i">+
</a><a href="#h14-0-28" id="h14-0-28" class="i">+    var changeListener = { _: DownloadStage, _: DownloadStage -&gt; }
</a><a href="#h14-0-29" id="h14-0-29" class="i">+    private var _stage: DownloadStage = DownloadStage.PENDING
</a><a href="#h14-0-30" id="h14-0-30" class="i">+    var downloadStage: DownloadStage
</a><a href="#h14-0-31" id="h14-0-31" class="i">+        get() = synchronized(this) {
</a><a href="#h14-0-32" id="h14-0-32" class="i">+            _stage
</a><a href="#h14-0-33" id="h14-0-33" class="i">+        }
</a><a href="#h14-0-34" id="h14-0-34" class="i">+        set(value) = synchronized(this) {
</a><a href="#h14-0-35" id="h14-0-35" class="i">+            changeListener(_stage, value)
</a><a href="#h14-0-36" id="h14-0-36" class="i">+            _stage = value
</a><a href="#h14-0-37" id="h14-0-37" class="i">+            MediaDownloadReceiver.downloadTaskManager.updateTask(this)
</a><a href="#h14-0-38" id="h14-0-38" class="i">+        }
</a><a href="#h14-0-39" id="h14-0-39" class="i">+
</a><a href="#h14-0-40" id="h14-0-40" class="i">+    fun isJobActive(): Boolean {
</a><a href="#h14-0-41" id="h14-0-41" class="i">+        return job?.isActive ?: false
</a><a href="#h14-0-42" id="h14-0-42" class="i">+    }
</a><a href="#h14-0-43" id="h14-0-43" class="i">+
</a><a href="#h14-0-44" id="h14-0-44" class="i">+    fun cancel() {
</a><a href="#h14-0-45" id="h14-0-45" class="i">+        job?.cancel()
</a><a href="#h14-0-46" id="h14-0-46" class="i">+        downloadStage = DownloadStage.CANCELLED
</a><a href="#h14-0-47" id="h14-0-47" class="i">+    }
</a><a href="#h14-0-48" id="h14-0-48" class="i">+}
</a><b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.download.enums
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+import android.net.Uri
</a><a href="#h15-0-3" id="h15-0-3" class="i">+
</a><a href="#h15-0-4" id="h15-0-4" class="i">+enum class DownloadMediaType {
</a><a href="#h15-0-5" id="h15-0-5" class="i">+    PROTO_MEDIA,
</a><a href="#h15-0-6" id="h15-0-6" class="i">+    DIRECT_MEDIA,
</a><a href="#h15-0-7" id="h15-0-7" class="i">+    REMOTE_MEDIA,
</a><a href="#h15-0-8" id="h15-0-8" class="i">+    LOCAL_MEDIA;
</a><a href="#h15-0-9" id="h15-0-9" class="i">+
</a><a href="#h15-0-10" id="h15-0-10" class="i">+    companion object {
</a><a href="#h15-0-11" id="h15-0-11" class="i">+        fun fromUri(uri: Uri): DownloadMediaType {
</a><a href="#h15-0-12" id="h15-0-12" class="i">+            return when (uri.scheme) {
</a><a href="#h15-0-13" id="h15-0-13" class="i">+                &quot;proto&quot; -&gt; PROTO_MEDIA
</a><a href="#h15-0-14" id="h15-0-14" class="i">+                &quot;direct&quot; -&gt; DIRECT_MEDIA
</a><a href="#h15-0-15" id="h15-0-15" class="i">+                &quot;http&quot;, &quot;https&quot; -&gt; REMOTE_MEDIA
</a><a href="#h15-0-16" id="h15-0-16" class="i">+                &quot;file&quot; -&gt; LOCAL_MEDIA
</a><a href="#h15-0-17" id="h15-0-17" class="i">+                else -&gt; throw IllegalArgumentException(&quot;Unknown uri scheme: ${uri.scheme}&quot;)
</a><a href="#h15-0-18" id="h15-0-18" class="i">+            }
</a><a href="#h15-0-19" id="h15-0-19" class="i">+        }
</a><a href="#h15-0-20" id="h15-0-20" class="i">+    }
</a><a href="#h15-0-21" id="h15-0-21" class="i">+}</a><a href="#h15-0-22" id="h15-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+package me.rhunk.snapenhance.download.enums
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+enum class DownloadStage(
</a><a href="#h16-0-3" id="h16-0-3" class="i">+    val isFinalStage: Boolean = false,
</a><a href="#h16-0-4" id="h16-0-4" class="i">+) {
</a><a href="#h16-0-5" id="h16-0-5" class="i">+    PENDING(false),
</a><a href="#h16-0-6" id="h16-0-6" class="i">+    DOWNLOADING(false),
</a><a href="#h16-0-7" id="h16-0-7" class="i">+    MERGING(false),
</a><a href="#h16-0-8" id="h16-0-8" class="i">+    DOWNLOADED(true),
</a><a href="#h16-0-9" id="h16-0-9" class="i">+    SAVED(true),
</a><a href="#h16-0-10" id="h16-0-10" class="i">+    MERGE_FAILED(true),
</a><a href="#h16-0-11" id="h16-0-11" class="i">+    FAILED(true),
</a><a href="#h16-0-12" id="h16-0-12" class="i">+    CANCELLED(true)
</a><a href="#h16-0-13" id="h16-0-13" class="i">+}</a><a href="#h16-0-14" id="h16-0-14" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -6,10 +6,13 @@ import me.rhunk.snapenhance.features.Feature
</a> import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h17-0-3" id="h17-0-3" class="i">+import me.rhunk.snapenhance.hook.hook
</a><a href="#h17-0-4" id="h17-0-4" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a> 
 class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_ASYNC or FeatureLoadParams.INIT_SYNC) {
     lateinit var conversationManager: Any
 
<a href="#h17-0-9" id="h17-0-9" class="i">+    var openedConversationUUID: SnapUUID? = null
</a>     var lastOpenedConversationUUID: SnapUUID? = null
     var lastFetchConversationUserUUID: SnapUUID? = null
     var lastFetchConversationUUID: SnapUUID? = null
<a href="#h17-1" id="h17-1" class="h">@@ -22,24 +25,22 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>     }
 
     override fun onActivityCreate() {
<a href="#h17-1-3" id="h17-1-3" class="i">+        context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;GetOneOnOneConversationIdsCallback&quot;).hook(&quot;onSuccess&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h17-1-4" id="h17-1-4" class="i">+            val userIdToConversation = (param.arg&lt;ArrayList&lt;*&gt;&gt;(0))
</a><a href="#h17-1-5" id="h17-1-5" class="i">+                .takeIf { it.isNotEmpty() }
</a><a href="#h17-1-6" id="h17-1-6" class="i">+                ?.get(0) ?: return@hook
</a><a href="#h17-1-7" id="h17-1-7" class="i">+
</a><a href="#h17-1-8" id="h17-1-8" class="i">+            lastFetchConversationUUID = SnapUUID(userIdToConversation.getObjectField(&quot;mConversationId&quot;))
</a><a href="#h17-1-9" id="h17-1-9" class="i">+            lastFetchConversationUserUUID = SnapUUID(userIdToConversation.getObjectField(&quot;mUserId&quot;))
</a><a href="#h17-1-10" id="h17-1-10" class="i">+        }
</a><a href="#h17-1-11" id="h17-1-11" class="i">+
</a>         with(context.classCache.conversationManager) {
             Hooker.hook(this, &quot;enterConversation&quot;, HookStage.BEFORE) {
<a href="#h17-1-14" id="h17-1-14" class="d">-                lastOpenedConversationUUID = SnapUUID(it.arg(0))
</a><a href="#h17-1-15" id="h17-1-15" class="d">-            }
</a><a href="#h17-1-16" id="h17-1-16" class="d">-
</a><a href="#h17-1-17" id="h17-1-17" class="d">-            Hooker.hook(this, &quot;getOneOnOneConversationIds&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h17-1-18" id="h17-1-18" class="d">-                val conversationIds: List&lt;Any&gt; = param.arg(0)
</a><a href="#h17-1-19" id="h17-1-19" class="d">-                if (conversationIds.isNotEmpty()) {
</a><a href="#h17-1-20" id="h17-1-20" class="d">-                    lastFetchConversationUserUUID = SnapUUID(conversationIds[0])
</a><a href="#h17-1-21" id="h17-1-21" class="d">-                }
</a><a href="#h17-1-22" id="h17-1-22" class="i">+                openedConversationUUID = SnapUUID(it.arg(0))
</a>             }
 
             Hooker.hook(this, &quot;exitConversation&quot;, HookStage.BEFORE) {
<a href="#h17-1-26" id="h17-1-26" class="d">-                lastOpenedConversationUUID = null
</a><a href="#h17-1-27" id="h17-1-27" class="d">-            }
</a><a href="#h17-1-28" id="h17-1-28" class="d">-
</a><a href="#h17-1-29" id="h17-1-29" class="d">-            Hooker.hook(this, &quot;fetchConversation&quot;, HookStage.BEFORE) {
</a><a href="#h17-1-30" id="h17-1-30" class="d">-                lastFetchConversationUUID = SnapUUID(it.arg(0))
</a><a href="#h17-1-31" id="h17-1-31" class="i">+                openedConversationUUID = null
</a>             }
         }
 
<a href="#h17-2" id="h17-2" class="h">@@ -54,7 +55,7 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a> 
         //get last opened snap for media downloader
         Hooker.hook(context.classCache.snapManager, &quot;onSnapInteraction&quot;, HookStage.BEFORE) { param -&gt;
<a href="#h17-2-3" id="h17-2-3" class="d">-            lastOpenedConversationUUID = SnapUUID(param.arg(1))
</a><a href="#h17-2-4" id="h17-2-4" class="i">+            openedConversationUUID = SnapUUID(param.arg(1))
</a>             lastFocusedMessageId = param.arg(2)
         }
 
<b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -3,11 +3,11 @@ package me.rhunk.snapenhance.features.impl.downloader
</a> import android.app.AlertDialog
 import android.content.DialogInterface
 import android.graphics.Bitmap
<a href="#h18-0-3" id="h18-0-3" class="d">-import android.media.MediaScannerConnection
</a><a href="#h18-0-4" id="h18-0-4" class="i">+import android.graphics.BitmapFactory
</a> import android.net.Uri
 import android.widget.ImageView
 import com.arthenica.ffmpegkit.FFmpegKit
<a href="#h18-0-8" id="h18-0-8" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h18-0-9" id="h18-0-9" class="i">+import kotlinx.coroutines.runBlocking
</a> import me.rhunk.snapenhance.Constants.ARROYO_URL_KEY_PROTO_PATH
 import me.rhunk.snapenhance.Logger.xposedLog
 import me.rhunk.snapenhance.config.ConfigProperty
<a href="#h18-1" id="h18-1" class="h">@@ -18,6 +18,10 @@ import me.rhunk.snapenhance.data.wrapper.impl.media.dash.LongformVideoPlaylistIt
</a> import me.rhunk.snapenhance.data.wrapper.impl.media.dash.SnapPlaylistItem
 import me.rhunk.snapenhance.data.wrapper.impl.media.opera.Layer
 import me.rhunk.snapenhance.data.wrapper.impl.media.opera.ParamMap
<a href="#h18-1-3" id="h18-1-3" class="i">+import me.rhunk.snapenhance.database.objects.FriendInfo
</a><a href="#h18-1-4" id="h18-1-4" class="i">+import me.rhunk.snapenhance.download.ClientDownloadManager
</a><a href="#h18-1-5" id="h18-1-5" class="i">+import me.rhunk.snapenhance.download.data.toKeyPair
</a><a href="#h18-1-6" id="h18-1-6" class="i">+import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h18-2" id="h18-2" class="h">@@ -25,33 +29,23 @@ import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a> import me.rhunk.snapenhance.hook.HookAdapter
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h18-2-3" id="h18-2-3" class="d">-import me.rhunk.snapenhance.util.EncryptionUtils
</a><a href="#h18-2-4" id="h18-2-4" class="d">-import me.rhunk.snapenhance.util.MediaDownloaderHelper
</a><a href="#h18-2-5" id="h18-2-5" class="d">-import me.rhunk.snapenhance.util.MediaType
</a><a href="#h18-2-6" id="h18-2-6" class="d">-import me.rhunk.snapenhance.util.PreviewUtils
</a><a href="#h18-2-7" id="h18-2-7" class="d">-import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h18-2-8" id="h18-2-8" class="i">+import me.rhunk.snapenhance.util.snap.EncryptionHelper
</a><a href="#h18-2-9" id="h18-2-9" class="i">+import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h18-2-10" id="h18-2-10" class="i">+import me.rhunk.snapenhance.util.snap.MediaType
</a><a href="#h18-2-11" id="h18-2-11" class="i">+import me.rhunk.snapenhance.util.snap.PreviewUtils
</a> import me.rhunk.snapenhance.util.getObjectField
 import me.rhunk.snapenhance.util.protobuf.ProtoReader
<a href="#h18-2-14" id="h18-2-14" class="d">-import java.io.ByteArrayOutputStream
</a><a href="#h18-2-15" id="h18-2-15" class="i">+import me.rhunk.snapenhance.util.snap.BitmojiSelfie
</a> import java.io.File
<a href="#h18-2-17" id="h18-2-17" class="d">-import java.io.FileOutputStream
</a><a href="#h18-2-18" id="h18-2-18" class="d">-import java.io.InputStream
</a><a href="#h18-2-19" id="h18-2-19" class="d">-import java.net.HttpURLConnection
</a><a href="#h18-2-20" id="h18-2-20" class="d">-import java.net.URL
</a> import java.nio.file.Paths
 import java.text.SimpleDateFormat
<a href="#h18-2-23" id="h18-2-23" class="d">-import java.util.Arrays
</a> import java.util.Locale
<a href="#h18-2-25" id="h18-2-25" class="d">-import java.util.concurrent.atomic.AtomicReference
</a><a href="#h18-2-26" id="h18-2-26" class="d">-import javax.crypto.Cipher
</a><a href="#h18-2-27" id="h18-2-27" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h18-2-28" id="h18-2-28" class="d">-import javax.xml.parsers.DocumentBuilderFactory
</a><a href="#h18-2-29" id="h18-2-29" class="d">-import javax.xml.transform.TransformerFactory
</a><a href="#h18-2-30" id="h18-2-30" class="d">-import javax.xml.transform.dom.DOMSource
</a><a href="#h18-2-31" id="h18-2-31" class="d">-import javax.xml.transform.stream.StreamResult
</a><a href="#h18-2-32" id="h18-2-32" class="i">+import kotlin.coroutines.suspendCoroutine
</a><a href="#h18-2-33" id="h18-2-33" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h18-2-34" id="h18-2-34" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a> import kotlin.io.path.inputStream
 
<a href="#h18-2-37" id="h18-2-37" class="d">-
</a><a href="#h18-2-38" id="h18-2-38" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a> class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
     private var lastSeenMediaInfoMap: MutableMap&lt;MediaType, MediaInfo&gt;? = null
     private var lastSeenMapParams: ParamMap? = null
<a href="#h18-3" id="h18-3" class="h">@@ -59,12 +53,38 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         runCatching { FFmpegKit.execute(&quot;-version&quot;) }.isSuccess
     }
 
<a href="#h18-3-3" id="h18-3-3" class="i">+    private fun provideClientDownloadManager(
</a><a href="#h18-3-4" id="h18-3-4" class="i">+        pathSuffix: String,
</a><a href="#h18-3-5" id="h18-3-5" class="i">+        mediaDisplaySource: String? = null,
</a><a href="#h18-3-6" id="h18-3-6" class="i">+        mediaDisplayType: String? = null,
</a><a href="#h18-3-7" id="h18-3-7" class="i">+        friendInfo: FriendInfo? = null
</a><a href="#h18-3-8" id="h18-3-8" class="i">+    ): ClientDownloadManager {
</a><a href="#h18-3-9" id="h18-3-9" class="i">+        val iconUrl = friendInfo?.takeIf {
</a><a href="#h18-3-10" id="h18-3-10" class="i">+            it.bitmojiAvatarId != null &amp;&amp; it.bitmojiSelfieId != null
</a><a href="#h18-3-11" id="h18-3-11" class="i">+        }?.let {
</a><a href="#h18-3-12" id="h18-3-12" class="i">+            BitmojiSelfie.getBitmojiSelfie(it.bitmojiSelfieId!!, it.bitmojiAvatarId!!, BitmojiSelfie.BitmojiSelfieType.THREE_D)
</a><a href="#h18-3-13" id="h18-3-13" class="i">+        }
</a><a href="#h18-3-14" id="h18-3-14" class="i">+
</a><a href="#h18-3-15" id="h18-3-15" class="i">+        val outputPath = File(
</a><a href="#h18-3-16" id="h18-3-16" class="i">+            context.config.string(ConfigProperty.SAVE_FOLDER),
</a><a href="#h18-3-17" id="h18-3-17" class="i">+            createNewFilePath(pathSuffix.hashCode(), pathSuffix)
</a><a href="#h18-3-18" id="h18-3-18" class="i">+        ).absolutePath
</a><a href="#h18-3-19" id="h18-3-19" class="i">+
</a><a href="#h18-3-20" id="h18-3-20" class="i">+        return ClientDownloadManager(
</a><a href="#h18-3-21" id="h18-3-21" class="i">+            context = context,
</a><a href="#h18-3-22" id="h18-3-22" class="i">+            mediaDisplaySource = mediaDisplaySource,
</a><a href="#h18-3-23" id="h18-3-23" class="i">+            mediaDisplayType = mediaDisplayType,
</a><a href="#h18-3-24" id="h18-3-24" class="i">+            iconUrl = iconUrl,
</a><a href="#h18-3-25" id="h18-3-25" class="i">+            outputPath = outputPath
</a><a href="#h18-3-26" id="h18-3-26" class="i">+        )
</a><a href="#h18-3-27" id="h18-3-27" class="i">+    }
</a><a href="#h18-3-28" id="h18-3-28" class="i">+
</a>     private fun canMergeOverlay(): Boolean {
         if (context.config.options(ConfigProperty.DOWNLOAD_OPTIONS)[&quot;merge_overlay&quot;] == false) return false
         return isFFmpegPresent
     }
 
<a href="#h18-3-34" id="h18-3-34" class="d">-    private fun createNewFilePath(hash: Int, author: String, fileType: FileType): String {
</a><a href="#h18-3-35" id="h18-3-35" class="i">+    private fun createNewFilePath(hash: Int, pathPrefix: String): String {
</a>         val hexHash = Integer.toHexString(hash)
         val downloadOptions = context.config.options(ConfigProperty.DOWNLOAD_OPTIONS)
 
<a href="#h18-4" id="h18-4" class="h">@@ -81,13 +101,13 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         }
 
         if (downloadOptions[&quot;format_user_folder&quot;] == true) {
<a href="#h18-4-3" id="h18-4-3" class="d">-            finalPath.append(author).append(&quot;/&quot;)
</a><a href="#h18-4-4" id="h18-4-4" class="i">+            finalPath.append(pathPrefix).append(&quot;/&quot;)
</a>         }
         if (downloadOptions[&quot;format_hash&quot;] == true) {
             appendFileName(hexHash)
         }
         if (downloadOptions[&quot;format_username&quot;] == true) {
<a href="#h18-4-10" id="h18-4-10" class="d">-            appendFileName(author)
</a><a href="#h18-4-11" id="h18-4-11" class="i">+            appendFileName(pathPrefix)
</a>         }
         if (downloadOptions[&quot;format_date_time&quot;] == true) {
             appendFileName(currentDateTime)
<a href="#h18-5" id="h18-5" class="h">@@ -95,79 +115,9 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a> 
         if (finalPath.isEmpty()) finalPath.append(hexHash)
 
<a href="#h18-5-3" id="h18-5-3" class="d">-        return finalPath.toString() + &quot;.&quot; + fileType.fileExtension
</a><a href="#h18-5-4" id="h18-5-4" class="i">+        return finalPath.toString()
</a>     }
 
<a href="#h18-5-7" id="h18-5-7" class="d">-    private fun downloadFile(outputFile: File, content: ByteArray): Boolean {
</a><a href="#h18-5-8" id="h18-5-8" class="d">-        val onDownloadComplete = {
</a><a href="#h18-5-9" id="h18-5-9" class="d">-                context.shortToast(
</a><a href="#h18-5-10" id="h18-5-10" class="d">-                    &quot;Saved to &quot; + outputFile.absolutePath.replace(context.config.string(ConfigProperty.SAVE_FOLDER), &quot;&quot;)
</a><a href="#h18-5-11" id="h18-5-11" class="d">-                        .substring(1)
</a><a href="#h18-5-12" id="h18-5-12" class="d">-                )
</a><a href="#h18-5-13" id="h18-5-13" class="d">-            }
</a><a href="#h18-5-14" id="h18-5-14" class="d">-        if (!context.config.bool(ConfigProperty.USE_DOWNLOAD_MANAGER)) {
</a><a href="#h18-5-15" id="h18-5-15" class="d">-            try {
</a><a href="#h18-5-16" id="h18-5-16" class="d">-                val fos = FileOutputStream(outputFile)
</a><a href="#h18-5-17" id="h18-5-17" class="d">-                fos.write(content)
</a><a href="#h18-5-18" id="h18-5-18" class="d">-                fos.close()
</a><a href="#h18-5-19" id="h18-5-19" class="d">-                MediaScannerConnection.scanFile(
</a><a href="#h18-5-20" id="h18-5-20" class="d">-                    context.androidContext,
</a><a href="#h18-5-21" id="h18-5-21" class="d">-                    arrayOf(outputFile.absolutePath),
</a><a href="#h18-5-22" id="h18-5-22" class="d">-                    null,
</a><a href="#h18-5-23" id="h18-5-23" class="d">-                    null
</a><a href="#h18-5-24" id="h18-5-24" class="d">-                )
</a><a href="#h18-5-25" id="h18-5-25" class="d">-                onDownloadComplete()
</a><a href="#h18-5-26" id="h18-5-26" class="d">-            } catch (e: Throwable) {
</a><a href="#h18-5-27" id="h18-5-27" class="d">-                xposedLog(e)
</a><a href="#h18-5-28" id="h18-5-28" class="d">-                context.longToast(&quot;Failed to save file: &quot; + e.message)
</a><a href="#h18-5-29" id="h18-5-29" class="d">-                return false
</a><a href="#h18-5-30" id="h18-5-30" class="d">-            }
</a><a href="#h18-5-31" id="h18-5-31" class="d">-            return true
</a><a href="#h18-5-32" id="h18-5-32" class="d">-        }
</a><a href="#h18-5-33" id="h18-5-33" class="d">-        context.downloadServer.startFileDownload(outputFile, content) { result -&gt;
</a><a href="#h18-5-34" id="h18-5-34" class="d">-            if (result) {
</a><a href="#h18-5-35" id="h18-5-35" class="d">-                onDownloadComplete()
</a><a href="#h18-5-36" id="h18-5-36" class="d">-                return@startFileDownload
</a><a href="#h18-5-37" id="h18-5-37" class="d">-            }
</a><a href="#h18-5-38" id="h18-5-38" class="d">-            context.longToast(&quot;Failed to save file. Check logs for more info.&quot;)
</a><a href="#h18-5-39" id="h18-5-39" class="d">-        }
</a><a href="#h18-5-40" id="h18-5-40" class="d">-        return true
</a><a href="#h18-5-41" id="h18-5-41" class="d">-    }
</a><a href="#h18-5-42" id="h18-5-42" class="d">-    private fun queryMediaData(mediaInfo: MediaInfo): ByteArray {
</a><a href="#h18-5-43" id="h18-5-43" class="d">-        val mediaUri = Uri.parse(mediaInfo.uri)
</a><a href="#h18-5-44" id="h18-5-44" class="d">-        val mediaInputStream = AtomicReference&lt;InputStream&gt;()
</a><a href="#h18-5-45" id="h18-5-45" class="d">-        if (mediaUri.scheme == &quot;file&quot;) {
</a><a href="#h18-5-46" id="h18-5-46" class="d">-            mediaInputStream.set(Paths.get(mediaUri.path).inputStream())
</a><a href="#h18-5-47" id="h18-5-47" class="d">-        } else {
</a><a href="#h18-5-48" id="h18-5-48" class="d">-            val url = URL(mediaUri.toString())
</a><a href="#h18-5-49" id="h18-5-49" class="d">-            val connection = url.openConnection() as HttpURLConnection
</a><a href="#h18-5-50" id="h18-5-50" class="d">-            connection.requestMethod = &quot;GET&quot;
</a><a href="#h18-5-51" id="h18-5-51" class="d">-            connection.setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h18-5-52" id="h18-5-52" class="d">-            connection.connect()
</a><a href="#h18-5-53" id="h18-5-53" class="d">-            mediaInputStream.set(connection.inputStream)
</a><a href="#h18-5-54" id="h18-5-54" class="d">-        }
</a><a href="#h18-5-55" id="h18-5-55" class="d">-        mediaInfo.encryption?.let { encryption -&gt;
</a><a href="#h18-5-56" id="h18-5-56" class="d">-            mediaInputStream.set(CipherInputStream(mediaInputStream.get(), encryption.newCipher(Cipher.DECRYPT_MODE)))
</a><a href="#h18-5-57" id="h18-5-57" class="d">-        }
</a><a href="#h18-5-58" id="h18-5-58" class="d">-        return mediaInputStream.get().readBytes()
</a><a href="#h18-5-59" id="h18-5-59" class="d">-    }
</a><a href="#h18-5-60" id="h18-5-60" class="d">-
</a><a href="#h18-5-61" id="h18-5-61" class="d">-    private fun createNeededDirectories(file: File): File {
</a><a href="#h18-5-62" id="h18-5-62" class="d">-        val directory = file.parentFile ?: return file
</a><a href="#h18-5-63" id="h18-5-63" class="d">-        if (!directory.exists()) {
</a><a href="#h18-5-64" id="h18-5-64" class="d">-            directory.mkdirs()
</a><a href="#h18-5-65" id="h18-5-65" class="d">-        }
</a><a href="#h18-5-66" id="h18-5-66" class="d">-        return file
</a><a href="#h18-5-67" id="h18-5-67" class="d">-    }
</a><a href="#h18-5-68" id="h18-5-68" class="d">-
</a><a href="#h18-5-69" id="h18-5-69" class="d">-    private fun isFileExists(hash: Int, author: String, fileType: FileType): Boolean {
</a><a href="#h18-5-70" id="h18-5-70" class="d">-        val fileName: String = createNewFilePath(hash, author, fileType)
</a><a href="#h18-5-71" id="h18-5-71" class="d">-        val outputFile: File =
</a><a href="#h18-5-72" id="h18-5-72" class="d">-            createNeededDirectories(File(context.config.string(ConfigProperty.SAVE_FOLDER), fileName))
</a><a href="#h18-5-73" id="h18-5-73" class="d">-        return outputFile.exists()
</a><a href="#h18-5-74" id="h18-5-74" class="d">-    }
</a><a href="#h18-5-75" id="h18-5-75" class="d">-
</a><a href="#h18-5-76" id="h18-5-76" class="d">-
</a>     /*
      * Download the last seen media
      */
<a href="#h18-6" id="h18-6" class="h">@@ -178,41 +128,46 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         }
     }
 
<a href="#h18-6-3" id="h18-6-3" class="d">-    private fun downloadOperaMedia(mediaInfoMap: Map&lt;MediaType, MediaInfo&gt;, author: String) {
</a><a href="#h18-6-4" id="h18-6-4" class="d">-        if (mediaInfoMap.isEmpty()) return
</a><a href="#h18-6-5" id="h18-6-5" class="d">-        val originalMediaInfo = mediaInfoMap[MediaType.ORIGINAL]!!
</a><a href="#h18-6-6" id="h18-6-6" class="d">-        if (mediaInfoMap.containsKey(MediaType.OVERLAY)) {
</a><a href="#h18-6-7" id="h18-6-7" class="d">-            context.shortToast(&quot;Downloading split snap&quot;)
</a><a href="#h18-6-8" id="h18-6-8" class="d">-        }
</a><a href="#h18-6-9" id="h18-6-9" class="d">-        var mediaContent: ByteArray? = queryMediaData(originalMediaInfo)
</a><a href="#h18-6-10" id="h18-6-10" class="d">-        val hash = Arrays.hashCode(mediaContent)
</a><a href="#h18-6-11" id="h18-6-11" class="d">-        if (mediaInfoMap.containsKey(MediaType.OVERLAY)) {
</a><a href="#h18-6-12" id="h18-6-12" class="d">-            //prevent converting the same media twice
</a><a href="#h18-6-13" id="h18-6-13" class="d">-            if (isFileExists(hash, author, FileType.fromByteArray(mediaContent!!))) {
</a><a href="#h18-6-14" id="h18-6-14" class="d">-                context.shortToast(&quot;Media already exists&quot;)
</a><a href="#h18-6-15" id="h18-6-15" class="d">-                return
</a><a href="#h18-6-16" id="h18-6-16" class="i">+    private fun handleLocalReferences(path: String) = runBlocking {
</a><a href="#h18-6-17" id="h18-6-17" class="i">+        Uri.parse(path).let { uri -&gt;
</a><a href="#h18-6-18" id="h18-6-18" class="i">+            if (uri.scheme == &quot;file&quot;) {
</a><a href="#h18-6-19" id="h18-6-19" class="i">+                return@let suspendCoroutine&lt;String&gt; { continuation -&gt;
</a><a href="#h18-6-20" id="h18-6-20" class="i">+                    context.downloadServer.ensureServerStarted {
</a><a href="#h18-6-21" id="h18-6-21" class="i">+                        val url = putDownloadableContent(Paths.get(uri.path).inputStream())
</a><a href="#h18-6-22" id="h18-6-22" class="i">+                        continuation.resumeWith(Result.success(url))
</a><a href="#h18-6-23" id="h18-6-23" class="i">+                    }
</a><a href="#h18-6-24" id="h18-6-24" class="i">+                }
</a>             }
<a href="#h18-6-26" id="h18-6-26" class="d">-            val overlayMediaInfo = mediaInfoMap[MediaType.OVERLAY]!!
</a><a href="#h18-6-27" id="h18-6-27" class="d">-            val overlayContent: ByteArray = queryMediaData(overlayMediaInfo)
</a><a href="#h18-6-28" id="h18-6-28" class="d">-            mediaContent = MediaDownloaderHelper.mergeOverlay(mediaContent, overlayContent, false)
</a><a href="#h18-6-29" id="h18-6-29" class="i">+            path
</a>         }
<a href="#h18-6-31" id="h18-6-31" class="d">-        val fileType = FileType.fromByteArray(mediaContent!!)
</a><a href="#h18-6-32" id="h18-6-32" class="d">-        downloadMediaContent(mediaContent, hash, author, fileType)
</a>     }
 
<a href="#h18-6-35" id="h18-6-35" class="d">-    private fun downloadMediaContent(
</a><a href="#h18-6-36" id="h18-6-36" class="d">-        data: ByteArray,
</a><a href="#h18-6-37" id="h18-6-37" class="d">-        hash: Int,
</a><a href="#h18-6-38" id="h18-6-38" class="d">-        messageAuthor: String,
</a><a href="#h18-6-39" id="h18-6-39" class="d">-        fileType: FileType
</a><a href="#h18-6-40" id="h18-6-40" class="d">-    ): Boolean {
</a><a href="#h18-6-41" id="h18-6-41" class="d">-        val fileName: String = createNewFilePath(hash, messageAuthor, fileType) ?: return false
</a><a href="#h18-6-42" id="h18-6-42" class="d">-        val outputFile: File = createNeededDirectories(File(context.config.string(ConfigProperty.SAVE_FOLDER), fileName))
</a><a href="#h18-6-43" id="h18-6-43" class="d">-        if (outputFile.exists()) {
</a><a href="#h18-6-44" id="h18-6-44" class="d">-            context.shortToast(&quot;Media already exists&quot;)
</a><a href="#h18-6-45" id="h18-6-45" class="d">-            return false
</a><a href="#h18-6-46" id="h18-6-46" class="i">+    private fun downloadOperaMedia(clientDownloadManager: ClientDownloadManager, mediaInfoMap: Map&lt;MediaType, MediaInfo&gt;) {
</a><a href="#h18-6-47" id="h18-6-47" class="i">+        if (mediaInfoMap.isEmpty()) return
</a><a href="#h18-6-48" id="h18-6-48" class="i">+
</a><a href="#h18-6-49" id="h18-6-49" class="i">+        val originalMediaInfo = mediaInfoMap[MediaType.ORIGINAL]!!
</a><a href="#h18-6-50" id="h18-6-50" class="i">+        val overlay = mediaInfoMap[MediaType.OVERLAY]
</a><a href="#h18-6-51" id="h18-6-51" class="i">+
</a><a href="#h18-6-52" id="h18-6-52" class="i">+        val originalMediaInfoReference = handleLocalReferences(originalMediaInfo.uri)
</a><a href="#h18-6-53" id="h18-6-53" class="i">+        val overlayReference = overlay?.let { handleLocalReferences(it.uri) }
</a><a href="#h18-6-54" id="h18-6-54" class="i">+
</a><a href="#h18-6-55" id="h18-6-55" class="i">+        overlay?.let {
</a><a href="#h18-6-56" id="h18-6-56" class="i">+            clientDownloadManager.downloadMediaWithOverlay(
</a><a href="#h18-6-57" id="h18-6-57" class="i">+                originalMediaInfoReference,
</a><a href="#h18-6-58" id="h18-6-58" class="i">+                overlayReference!!,
</a><a href="#h18-6-59" id="h18-6-59" class="i">+                DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
</a><a href="#h18-6-60" id="h18-6-60" class="i">+                DownloadMediaType.fromUri(Uri.parse(overlayReference)),
</a><a href="#h18-6-61" id="h18-6-61" class="i">+                videoEncryption = originalMediaInfo.encryption?.toKeyPair(),
</a><a href="#h18-6-62" id="h18-6-62" class="i">+                overlayEncryption = overlay.encryption?.toKeyPair()
</a><a href="#h18-6-63" id="h18-6-63" class="i">+            )
</a><a href="#h18-6-64" id="h18-6-64" class="i">+            return
</a>         }
<a href="#h18-6-66" id="h18-6-66" class="d">-        return downloadFile(outputFile, data)
</a><a href="#h18-6-67" id="h18-6-67" class="i">+
</a><a href="#h18-6-68" id="h18-6-68" class="i">+        clientDownloadManager.downloadMedia(
</a><a href="#h18-6-69" id="h18-6-69" class="i">+            originalMediaInfoReference,
</a><a href="#h18-6-70" id="h18-6-70" class="i">+            DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
</a><a href="#h18-6-71" id="h18-6-71" class="i">+            originalMediaInfo.encryption?.toKeyPair()
</a><a href="#h18-6-72" id="h18-6-72" class="i">+        )
</a>     }
 
     /**
<a href="#h18-7" id="h18-7" class="h">@@ -236,8 +191,9 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                 return
             }
 
<a href="#h18-7-3" id="h18-7-3" class="d">-            val author = context.database.getFriendInfo(senderId)!!.usernameForSorting!!
</a><a href="#h18-7-4" id="h18-7-4" class="d">-            downloadOperaMedia(mediaInfoMap, author)
</a><a href="#h18-7-5" id="h18-7-5" class="i">+            val author = context.database.getFriendInfo(senderId) ?: return
</a><a href="#h18-7-6" id="h18-7-6" class="i">+            val authorUsername = author.usernameForSorting!!
</a><a href="#h18-7-7" id="h18-7-7" class="i">+            downloadOperaMedia(provideClientDownloadManager(authorUsername, authorUsername, &quot;Chat Media&quot;, friendInfo = author), mediaInfoMap)
</a>             return
         }
 
<a href="#h18-8" id="h18-8" class="h">@@ -250,9 +206,10 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                 storyIdStartIndex,
                 playlistGroup.indexOf(&quot;,&quot;, storyIdStartIndex)
             )
<a href="#h18-8-3" id="h18-8-3" class="d">-            val author = context.database.getFriendInfo(if (storyUserId == &quot;null&quot;) context.database.getMyUserId()!! else storyUserId)
</a><a href="#h18-8-4" id="h18-8-4" class="i">+            val author = context.database.getFriendInfo(if (storyUserId == &quot;null&quot;) context.database.getMyUserId()!! else storyUserId) ?: return
</a><a href="#h18-8-5" id="h18-8-5" class="i">+            val authorName = author.usernameForSorting!!
</a> 
<a href="#h18-8-7" id="h18-8-7" class="d">-            downloadOperaMedia(mediaInfoMap, author!!.usernameForSorting!!)
</a><a href="#h18-8-8" id="h18-8-8" class="i">+            downloadOperaMedia(provideClientDownloadManager(authorName, authorName, &quot;Story&quot;, friendInfo = author), mediaInfoMap, )
</a>             return
         }
 
<a href="#h18-9" id="h18-9" class="h">@@ -264,13 +221,13 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             val userDisplayName = (if (paramMap.containsKey(&quot;USER_DISPLAY_NAME&quot;)) paramMap[&quot;USER_DISPLAY_NAME&quot;].toString() else &quot;&quot;).replace(
                     &quot;[^\\x00-\\x7F]&quot;.toRegex(),
                     &quot;&quot;)
<a href="#h18-9-3" id="h18-9-3" class="d">-            downloadOperaMedia(mediaInfoMap, &quot;Public-Stories/$userDisplayName&quot;)
</a><a href="#h18-9-4" id="h18-9-4" class="i">+            downloadOperaMedia(provideClientDownloadManager(&quot;Public-Stories/$userDisplayName&quot;, userDisplayName, &quot;Public Story&quot;), mediaInfoMap)
</a>             return
         }
 
         //spotlight
         if (snapSource == &quot;SINGLE_SNAP_STORY&quot; &amp;&amp; (forceDownload || canAutoDownload(&quot;spotlight&quot;))) {
<a href="#h18-9-10" id="h18-9-10" class="d">-            downloadOperaMedia(mediaInfoMap, &quot;Spotlight&quot;)
</a><a href="#h18-9-11" id="h18-9-11" class="i">+            downloadOperaMedia(provideClientDownloadManager(&quot;Spotlight&quot;, mediaDisplayType = &quot;Spotlight&quot;, mediaDisplaySource = paramMap[&quot;TIME_STAMP&quot;].toString()), mediaInfoMap)
</a>             return
         }
 
<a href="#h18-10" id="h18-10" class="h">@@ -302,24 +259,12 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a> 
             //get the mpd playlist and append the cdn url to baseurl nodes
             val playlistUrl = paramMap[&quot;MEDIA_ID&quot;].toString().let { it.substring(it.indexOf(&quot;https://cf-st.sc-cdn.net&quot;)) }
<a href="#h18-10-3" id="h18-10-3" class="d">-            val playlistXml = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(URL(playlistUrl).openStream())
</a><a href="#h18-10-4" id="h18-10-4" class="d">-            val baseUrlNodeList = playlistXml.getElementsByTagName(&quot;BaseURL&quot;)
</a><a href="#h18-10-5" id="h18-10-5" class="d">-            for (i in 0 until baseUrlNodeList.length) {
</a><a href="#h18-10-6" id="h18-10-6" class="d">-                val baseUrlNode = baseUrlNodeList.item(i)
</a><a href="#h18-10-7" id="h18-10-7" class="d">-                val baseUrl = baseUrlNode.textContent
</a><a href="#h18-10-8" id="h18-10-8" class="d">-                baseUrlNode.textContent = &quot;${RemoteMediaResolver.CF_ST_CDN_D}$baseUrl&quot;
</a><a href="#h18-10-9" id="h18-10-9" class="d">-            }
</a><a href="#h18-10-10" id="h18-10-10" class="d">-
</a><a href="#h18-10-11" id="h18-10-11" class="d">-            val xmlData = ByteArrayOutputStream()
</a><a href="#h18-10-12" id="h18-10-12" class="d">-            TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
</a><a href="#h18-10-13" id="h18-10-13" class="d">-            runCatching {
</a><a href="#h18-10-14" id="h18-10-14" class="d">-                context.shortToast(&quot;Downloading dash media. This might take a while...&quot;)
</a><a href="#h18-10-15" id="h18-10-15" class="d">-                val downloadedMedia = MediaDownloaderHelper.downloadDashChapter(xmlData.toByteArray().toString(Charsets.UTF_8), snapChapterTimestamp, duration)
</a><a href="#h18-10-16" id="h18-10-16" class="d">-                downloadMediaContent(downloadedMedia, downloadedMedia.contentHashCode(), &quot;Pro-Stories/${storyName}&quot;, FileType.fromByteArray(downloadedMedia))
</a><a href="#h18-10-17" id="h18-10-17" class="d">-            }.onFailure {
</a><a href="#h18-10-18" id="h18-10-18" class="d">-                context.longToast(&quot;Failed to download media: ${it.message}&quot;)
</a><a href="#h18-10-19" id="h18-10-19" class="d">-                xposedLog(it)
</a><a href="#h18-10-20" id="h18-10-20" class="d">-            }
</a><a href="#h18-10-21" id="h18-10-21" class="i">+            val clientDownloadManager = provideClientDownloadManager(&quot;Pro-Stories/${storyName}&quot;, storyName, &quot;Pro Story&quot;)
</a><a href="#h18-10-22" id="h18-10-22" class="i">+            clientDownloadManager.downloadDashMedia(
</a><a href="#h18-10-23" id="h18-10-23" class="i">+                playlistUrl,
</a><a href="#h18-10-24" id="h18-10-24" class="i">+                snapChapterTimestamp,
</a><a href="#h18-10-25" id="h18-10-25" class="i">+                duration
</a><a href="#h18-10-26" id="h18-10-26" class="i">+            )
</a>         }
     }
 
<a href="#h18-11" id="h18-11" class="h">@@ -383,60 +328,103 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>     fun onMessageActionMenu(isPreviewMode: Boolean) {
         //check if the message was focused in a conversation
         val messaging = context.feature(Messaging::class)
<a href="#h18-11-3" id="h18-11-3" class="d">-        if (messaging.lastOpenedConversationUUID == null) return
</a><a href="#h18-11-4" id="h18-11-4" class="i">+        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h18-11-5" id="h18-11-5" class="i">+
</a><a href="#h18-11-6" id="h18-11-6" class="i">+        if (messaging.openedConversationUUID == null) return
</a>         val message = context.database.getConversationMessageFromId(messaging.lastFocusedMessageId) ?: return
 
         //get the message author
<a href="#h18-11-10" id="h18-11-10" class="d">-        val messageAuthor: String = context.database.getFriendInfo(message.sender_id!!)!!.usernameForSorting!!
</a><a href="#h18-11-11" id="h18-11-11" class="i">+        val friendInfo: FriendInfo = context.database.getFriendInfo(message.sender_id!!)!!
</a><a href="#h18-11-12" id="h18-11-12" class="i">+        val authorName = friendInfo.usernameForSorting!!
</a><a href="#h18-11-13" id="h18-11-13" class="i">+
</a><a href="#h18-11-14" id="h18-11-14" class="i">+        var messageContent = message.message_content!!
</a><a href="#h18-11-15" id="h18-11-15" class="i">+        var isArroyoMessage = true
</a><a href="#h18-11-16" id="h18-11-16" class="i">+        var deletedMediaReference: ByteArray? = null
</a> 
         //check if the messageId
<a href="#h18-11-19" id="h18-11-19" class="d">-        val contentType: ContentType = ContentType.fromId(message.content_type)
</a><a href="#h18-11-20" id="h18-11-20" class="d">-        if (context.feature(MessageLogger::class).isMessageRemoved(message.client_message_id.toLong())) {
</a><a href="#h18-11-21" id="h18-11-21" class="d">-            context.shortToast(&quot;Preview/Download are not yet available for deleted messages&quot;)
</a><a href="#h18-11-22" id="h18-11-22" class="d">-            return
</a><a href="#h18-11-23" id="h18-11-23" class="i">+        var contentType: ContentType = ContentType.fromId(message.content_type)
</a><a href="#h18-11-24" id="h18-11-24" class="i">+
</a><a href="#h18-11-25" id="h18-11-25" class="i">+        if (messageLogger.isMessageRemoved(message.client_message_id.toLong())) {
</a><a href="#h18-11-26" id="h18-11-26" class="i">+            val messageObject = messageLogger.getMessageObject(message.client_conversation_id!!, message.client_message_id.toLong()) ?: throw Exception(&quot;Message not found in database&quot;)
</a><a href="#h18-11-27" id="h18-11-27" class="i">+            isArroyoMessage = false
</a><a href="#h18-11-28" id="h18-11-28" class="i">+            val messageContentObject = messageObject.getAsJsonObject(&quot;mMessageContent&quot;)
</a><a href="#h18-11-29" id="h18-11-29" class="i">+
</a><a href="#h18-11-30" id="h18-11-30" class="i">+            messageContent = messageContentObject
</a><a href="#h18-11-31" id="h18-11-31" class="i">+                .getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h18-11-32" id="h18-11-32" class="i">+                .map { it.asByte }
</a><a href="#h18-11-33" id="h18-11-33" class="i">+                .toByteArray()
</a><a href="#h18-11-34" id="h18-11-34" class="i">+
</a><a href="#h18-11-35" id="h18-11-35" class="i">+            contentType = ContentType.valueOf(messageContentObject
</a><a href="#h18-11-36" id="h18-11-36" class="i">+                .getAsJsonPrimitive(&quot;mContentType&quot;).asString
</a><a href="#h18-11-37" id="h18-11-37" class="i">+            )
</a><a href="#h18-11-38" id="h18-11-38" class="i">+
</a><a href="#h18-11-39" id="h18-11-39" class="i">+            deletedMediaReference = messageContentObject.getAsJsonArray(&quot;mRemoteMediaReferences&quot;)
</a><a href="#h18-11-40" id="h18-11-40" class="i">+                .map { it.asJsonObject.getAsJsonArray(&quot;mMediaReferences&quot;) }
</a><a href="#h18-11-41" id="h18-11-41" class="i">+                .flatten().let {  reference -&gt;
</a><a href="#h18-11-42" id="h18-11-42" class="i">+                    if (reference.isEmpty()) return@let null
</a><a href="#h18-11-43" id="h18-11-43" class="i">+                    reference[0].asJsonObject.getAsJsonArray(&quot;mContentObject&quot;).map { it.asByte }.toByteArray()
</a><a href="#h18-11-44" id="h18-11-44" class="i">+                }
</a>         }
<a href="#h18-11-46" id="h18-11-46" class="i">+
</a>         if (contentType != ContentType.NOTE &amp;&amp;
             contentType != ContentType.SNAP &amp;&amp;
             contentType != ContentType.EXTERNAL_MEDIA) {
             context.shortToast(&quot;Unsupported content type $contentType&quot;)
             return
         }
<a href="#h18-11-53" id="h18-11-53" class="d">-        val messageReader = ProtoReader(message.message_content!!)
</a><a href="#h18-11-54" id="h18-11-54" class="d">-        val urlProto: ByteArray = messageReader.getByteArray(*ARROYO_URL_KEY_PROTO_PATH)!!
</a><a href="#h18-11-55" id="h18-11-55" class="d">-
</a><a href="#h18-11-56" id="h18-11-56" class="d">-        //download the message content
</a><a href="#h18-11-57" id="h18-11-57" class="d">-        try {
</a><a href="#h18-11-58" id="h18-11-58" class="d">-            val downloadedMedia = MediaDownloaderHelper.downloadMediaFromReference(urlProto, canMergeOverlay(), isPreviewMode) {
</a><a href="#h18-11-59" id="h18-11-59" class="d">-                EncryptionUtils.decryptInputStreamFromArroyo(it, contentType, messageReader)
</a><a href="#h18-11-60" id="h18-11-60" class="d">-            }[MediaType.ORIGINAL] ?: throw Exception(&quot;Failed to download media&quot;)
</a><a href="#h18-11-61" id="h18-11-61" class="d">-            val fileType = FileType.fromByteArray(downloadedMedia)
</a><a href="#h18-11-62" id="h18-11-62" class="d">-
</a><a href="#h18-11-63" id="h18-11-63" class="d">-            if (isPreviewMode) {
</a><a href="#h18-11-64" id="h18-11-64" class="d">-                runCatching {
</a><a href="#h18-11-65" id="h18-11-65" class="d">-                    val bitmap: Bitmap? = PreviewUtils.createPreview(downloadedMedia, fileType.isVideo)
</a><a href="#h18-11-66" id="h18-11-66" class="d">-                    if (bitmap == null) {
</a><a href="#h18-11-67" id="h18-11-67" class="d">-                        context.shortToast(&quot;Failed to create preview&quot;)
</a><a href="#h18-11-68" id="h18-11-68" class="d">-                        return
</a><a href="#h18-11-69" id="h18-11-69" class="d">-                    }
</a><a href="#h18-11-70" id="h18-11-70" class="d">-                    val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h18-11-71" id="h18-11-71" class="d">-                    builder.setTitle(&quot;Preview&quot;)
</a><a href="#h18-11-72" id="h18-11-72" class="d">-                    val imageView = ImageView(builder.context)
</a><a href="#h18-11-73" id="h18-11-73" class="d">-                    imageView.setImageBitmap(bitmap)
</a><a href="#h18-11-74" id="h18-11-74" class="d">-                    builder.setView(imageView)
</a><a href="#h18-11-75" id="h18-11-75" class="d">-                    builder.setPositiveButton(
</a><a href="#h18-11-76" id="h18-11-76" class="d">-                        &quot;Close&quot;
</a><a href="#h18-11-77" id="h18-11-77" class="d">-                    ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h18-11-78" id="h18-11-78" class="d">-                    context.runOnUiThread { builder.show() }
</a><a href="#h18-11-79" id="h18-11-79" class="d">-                }.onFailure {
</a><a href="#h18-11-80" id="h18-11-80" class="d">-                    context.shortToast(&quot;Failed to create preview: $it&quot;)
</a><a href="#h18-11-81" id="h18-11-81" class="d">-                    xposedLog(it)
</a><a href="#h18-11-82" id="h18-11-82" class="d">-                }
</a><a href="#h18-11-83" id="h18-11-83" class="i">+
</a><a href="#h18-11-84" id="h18-11-84" class="i">+        val messageReader = ProtoReader(messageContent)
</a><a href="#h18-11-85" id="h18-11-85" class="i">+        val urlProto: ByteArray = if (isArroyoMessage) {
</a><a href="#h18-11-86" id="h18-11-86" class="i">+            messageReader.getByteArray(*ARROYO_URL_KEY_PROTO_PATH)!!
</a><a href="#h18-11-87" id="h18-11-87" class="i">+        } else {
</a><a href="#h18-11-88" id="h18-11-88" class="i">+            deletedMediaReference!!
</a><a href="#h18-11-89" id="h18-11-89" class="i">+        }
</a><a href="#h18-11-90" id="h18-11-90" class="i">+
</a><a href="#h18-11-91" id="h18-11-91" class="i">+        runCatching {
</a><a href="#h18-11-92" id="h18-11-92" class="i">+            if (!isPreviewMode) {
</a><a href="#h18-11-93" id="h18-11-93" class="i">+                val encryptionKeys = EncryptionHelper.getEncryptionKeys(contentType, messageReader, isArroyo = isArroyoMessage)
</a><a href="#h18-11-94" id="h18-11-94" class="i">+                provideClientDownloadManager(authorName, authorName, &quot;Chat Media&quot;, friendInfo = friendInfo).downloadMedia(
</a><a href="#h18-11-95" id="h18-11-95" class="i">+                    Base64.UrlSafe.encode(urlProto),
</a><a href="#h18-11-96" id="h18-11-96" class="i">+                    DownloadMediaType.PROTO_MEDIA,
</a><a href="#h18-11-97" id="h18-11-97" class="i">+                    encryption = encryptionKeys?.toKeyPair()
</a><a href="#h18-11-98" id="h18-11-98" class="i">+                )
</a>                 return
             }
<a href="#h18-11-101" id="h18-11-101" class="d">-            downloadMediaContent(downloadedMedia, downloadedMedia.contentHashCode(), messageAuthor, fileType)
</a><a href="#h18-11-102" id="h18-11-102" class="d">-        } catch (e: Throwable) {
</a><a href="#h18-11-103" id="h18-11-103" class="d">-            context.longToast(&quot;Failed to download &quot; + e.message)
</a><a href="#h18-11-104" id="h18-11-104" class="d">-            xposedLog(e)
</a><a href="#h18-11-105" id="h18-11-105" class="i">+
</a><a href="#h18-11-106" id="h18-11-106" class="i">+            val downloadedMediaList = MediaDownloaderHelper.downloadMediaFromReference(urlProto) {
</a><a href="#h18-11-107" id="h18-11-107" class="i">+                EncryptionHelper.decryptInputStream(it, contentType, messageReader, isArroyo = isArroyoMessage)
</a><a href="#h18-11-108" id="h18-11-108" class="i">+            }
</a><a href="#h18-11-109" id="h18-11-109" class="i">+
</a><a href="#h18-11-110" id="h18-11-110" class="i">+            runCatching {
</a><a href="#h18-11-111" id="h18-11-111" class="i">+                val originalMedia = downloadedMediaList[MediaType.ORIGINAL] ?: return
</a><a href="#h18-11-112" id="h18-11-112" class="i">+                val overlay = downloadedMediaList[MediaType.OVERLAY]
</a><a href="#h18-11-113" id="h18-11-113" class="i">+
</a><a href="#h18-11-114" id="h18-11-114" class="i">+                var bitmap: Bitmap? = PreviewUtils.createPreview(originalMedia, isVideo = FileType.fromByteArray(originalMedia).isVideo)
</a><a href="#h18-11-115" id="h18-11-115" class="i">+
</a><a href="#h18-11-116" id="h18-11-116" class="i">+                if (bitmap == null) {
</a><a href="#h18-11-117" id="h18-11-117" class="i">+                    context.shortToast(&quot;Failed to create preview&quot;)
</a><a href="#h18-11-118" id="h18-11-118" class="i">+                    return
</a><a href="#h18-11-119" id="h18-11-119" class="i">+                }
</a><a href="#h18-11-120" id="h18-11-120" class="i">+
</a><a href="#h18-11-121" id="h18-11-121" class="i">+                overlay?.let {
</a><a href="#h18-11-122" id="h18-11-122" class="i">+                    bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h18-11-123" id="h18-11-123" class="i">+                }
</a><a href="#h18-11-124" id="h18-11-124" class="i">+
</a><a href="#h18-11-125" id="h18-11-125" class="i">+                with(AlertDialog.Builder(context.mainActivity)) {
</a><a href="#h18-11-126" id="h18-11-126" class="i">+                    setTitle(&quot;Preview&quot;)
</a><a href="#h18-11-127" id="h18-11-127" class="i">+                    setView(ImageView(context).apply {
</a><a href="#h18-11-128" id="h18-11-128" class="i">+                        setImageBitmap(bitmap)
</a><a href="#h18-11-129" id="h18-11-129" class="i">+                    })
</a><a href="#h18-11-130" id="h18-11-130" class="i">+                    setPositiveButton(&quot;Close&quot;) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h18-11-131" id="h18-11-131" class="i">+                    this@MediaDownloader.context.runOnUiThread { show() }
</a><a href="#h18-11-132" id="h18-11-132" class="i">+                }
</a><a href="#h18-11-133" id="h18-11-133" class="i">+            }.onFailure {
</a><a href="#h18-11-134" id="h18-11-134" class="i">+                context.shortToast(&quot;Failed to create preview: $it&quot;)
</a><a href="#h18-11-135" id="h18-11-135" class="i">+                xposedLog(it)
</a><a href="#h18-11-136" id="h18-11-136" class="i">+            }
</a><a href="#h18-11-137" id="h18-11-137" class="i">+        }.onFailure {
</a><a href="#h18-11-138" id="h18-11-138" class="i">+            context.longToast(&quot;Failed to download &quot; + it.message)
</a><a href="#h18-11-139" id="h18-11-139" class="i">+            xposedLog(it)
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -37,6 +37,15 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         context.bridgeClient.deleteMessageLoggerMessage(conversationId, messageId)
     }
 
<a href="#h19-0-3" id="h19-0-3" class="i">+    fun getMessageObject(conversationId: String, messageId: Long): JsonObject? {
</a><a href="#h19-0-4" id="h19-0-4" class="i">+        if (deletedMessageCache.containsKey(messageId)) {
</a><a href="#h19-0-5" id="h19-0-5" class="i">+            return deletedMessageCache[messageId]
</a><a href="#h19-0-6" id="h19-0-6" class="i">+        }
</a><a href="#h19-0-7" id="h19-0-7" class="i">+        return context.bridgeClient.getMessageLoggerMessage(conversationId, messageId)?.let {
</a><a href="#h19-0-8" id="h19-0-8" class="i">+            JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
</a><a href="#h19-0-9" id="h19-0-9" class="i">+        }
</a><a href="#h19-0-10" id="h19-0-10" class="i">+    }
</a><a href="#h19-0-11" id="h19-0-11" class="i">+
</a>     @OptIn(ExperimentalTime::class)
     override fun asyncOnActivityCreate() {
         ConfigProperty.MESSAGE_LOGGER.valueContainer.addPropertyChangeListener {
<b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -69,8 +69,8 @@ class AutoSave : Feature(&quot;Auto Save&quot;, loadParams = FeatureLoadParams.ACTIVITY_CR
</a>         if (context.config.options(ConfigProperty.AUTO_SAVE_MESSAGES).none { it.value }) return false
 
         with(context.feature(Messaging::class)) {
<a href="#h20-0-3" id="h20-0-3" class="d">-            if (lastOpenedConversationUUID == null) return@canSave false
</a><a href="#h20-0-4" id="h20-0-4" class="d">-            val conversation = lastOpenedConversationUUID.toString()
</a><a href="#h20-0-5" id="h20-0-5" class="i">+            if (openedConversationUUID == null) return@canSave false
</a><a href="#h20-0-6" id="h20-0-6" class="i">+            val conversation = openedConversationUUID.toString()
</a>             if (context.feature(StealthMode::class).isStealth(conversation)) return@canSave false
             if (context.feature(AntiAutoSave::class).isConversationIgnored(conversation)) return@canSave false
         }
<a href="#h20-1" id="h20-1" class="h">@@ -120,7 +120,7 @@ class AutoSave : Feature(&quot;Auto Save&quot;, loadParams = FeatureLoadParams.ACTIVITY_CR
</a>             val callback = CallbackBuilder(fetchConversationWithMessagesCallbackClass).build()
             runCatching {
                 fetchConversationWithMessagesPaginatedMethod.invoke(
<a href="#h20-1-3" id="h20-1-3" class="d">-                    messaging.conversationManager, messaging.lastOpenedConversationUUID!!.instanceNonNull(),
</a><a href="#h20-1-4" id="h20-1-4" class="i">+                    messaging.conversationManager, messaging.openedConversationUUID!!.instanceNonNull(),
</a>                     Long.MAX_VALUE,
                     3,
                     callback
<b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -40,7 +40,7 @@ class GalleryMediaSendOverride : Feature(&quot;Gallery Media Send Override&quot;, loadPara
</a>                 }
                 &quot;NOTE&quot; -&gt; {
                     localMessageContent.contentType = ContentType.NOTE
<a href="#h21-0-3" id="h21-0-3" class="d">-                    val mediaDuration = messageProtoReader.getInt(3, 3, 5, 1, 1, 15) ?: 0
</a><a href="#h21-0-4" id="h21-0-4" class="i">+                    val mediaDuration = messageProtoReader.getLong(3, 3, 5, 1, 1, 15) ?: 0
</a>                     localMessageContent.content = MessageSender.audioNoteProto(mediaDuration)
                 }
             }
<b>diff --git a/<a id="h22" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -7,6 +7,7 @@ import android.app.RemoteInput
</a> import android.content.Context
 import android.content.Intent
 import android.graphics.Bitmap
<a href="#h22-0-3" id="h22-0-3" class="i">+import android.graphics.BitmapFactory
</a> import android.os.Bundle
 import android.os.UserHandle
 import de.robv.android.xposed.XposedBridge
<a href="#h22-1" id="h22-1" class="h">@@ -24,10 +25,10 @@ import me.rhunk.snapenhance.features.impl.Messaging
</a> import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.util.CallbackBuilder
<a href="#h22-1-3" id="h22-1-3" class="d">-import me.rhunk.snapenhance.util.EncryptionUtils
</a><a href="#h22-1-4" id="h22-1-4" class="d">-import me.rhunk.snapenhance.util.MediaDownloaderHelper
</a><a href="#h22-1-5" id="h22-1-5" class="d">-import me.rhunk.snapenhance.util.MediaType
</a><a href="#h22-1-6" id="h22-1-6" class="d">-import me.rhunk.snapenhance.util.PreviewUtils
</a><a href="#h22-1-7" id="h22-1-7" class="i">+import me.rhunk.snapenhance.util.snap.EncryptionHelper
</a><a href="#h22-1-8" id="h22-1-8" class="i">+import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h22-1-9" id="h22-1-9" class="i">+import me.rhunk.snapenhance.util.snap.MediaType
</a><a href="#h22-1-10" id="h22-1-10" class="i">+import me.rhunk.snapenhance.util.snap.PreviewUtils
</a> import me.rhunk.snapenhance.util.protobuf.ProtoReader
 
 class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
<a href="#h22-2" id="h22-2" class="h">@@ -161,7 +162,11 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a> 
         notificationDataQueue.entries.onEach { (messageId, notificationData) -&gt;
             val snapMessage = messages.firstOrNull { message -&gt; message.orderKey == messageId } ?: return
<a href="#h22-2-3" id="h22-2-3" class="d">-            val senderUsername = context.database.getFriendInfo(snapMessage.senderId.toString())?.displayName ?: throw Throwable(&quot;Cant find senderId of message $snapMessage&quot;)
</a><a href="#h22-2-4" id="h22-2-4" class="i">+            val senderUsername by lazy {
</a><a href="#h22-2-5" id="h22-2-5" class="i">+                context.database.getFriendInfo(snapMessage.senderId.toString())?.let {
</a><a href="#h22-2-6" id="h22-2-6" class="i">+                    it.displayName ?: it.username
</a><a href="#h22-2-7" id="h22-2-7" class="i">+                }
</a><a href="#h22-2-8" id="h22-2-8" class="i">+            }
</a> 
             val contentType = snapMessage.messageContent.contentType
             val contentData = snapMessage.messageContent.content
<a href="#h22-3" id="h22-3" class="h">@@ -192,21 +197,17 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                         val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
                         val mediaType = MediaReferenceType.valueOf(media.asJsonObject[&quot;mMediaType&quot;].asString)
                         runCatching {
<a href="#h22-3-3" id="h22-3-3" class="d">-                            //download the media
</a><a href="#h22-3-4" id="h22-3-4" class="d">-                            val mediaInfo = ProtoReader(contentData).let {
</a><a href="#h22-3-5" id="h22-3-5" class="d">-                                if (contentType == ContentType.EXTERNAL_MEDIA)
</a><a href="#h22-3-6" id="h22-3-6" class="d">-                                    return@let it.readPath(*Constants.MESSAGE_EXTERNAL_MEDIA_ENCRYPTION_PROTO_PATH)
</a><a href="#h22-3-7" id="h22-3-7" class="d">-                                else
</a><a href="#h22-3-8" id="h22-3-8" class="d">-                                    return@let it.readPath(*Constants.MESSAGE_SNAP_ENCRYPTION_PROTO_PATH)
</a><a href="#h22-3-9" id="h22-3-9" class="d">-                            }?: return@runCatching
</a><a href="#h22-3-10" id="h22-3-10" class="d">-
</a><a href="#h22-3-11" id="h22-3-11" class="d">-                            val downloadedMedia = MediaDownloaderHelper.downloadMediaFromReference(protoMediaReference, mergeOverlay = false, isPreviewMode = false) {
</a><a href="#h22-3-12" id="h22-3-12" class="d">-                                if (mediaInfo.exists(Constants.ARROYO_ENCRYPTION_PROTO_INDEX))
</a><a href="#h22-3-13" id="h22-3-13" class="d">-                                    EncryptionUtils.decryptInputStream(it, false, mediaInfo, Constants.ARROYO_ENCRYPTION_PROTO_INDEX)
</a><a href="#h22-3-14" id="h22-3-14" class="d">-                                else it
</a><a href="#h22-3-15" id="h22-3-15" class="d">-                            }[MediaType.ORIGINAL] ?: throw Throwable(&quot;Failed to download media&quot;)
</a><a href="#h22-3-16" id="h22-3-16" class="d">-
</a><a href="#h22-3-17" id="h22-3-17" class="d">-                            val bitmapPreview = PreviewUtils.createPreview(downloadedMedia, mediaType.name.contains(&quot;VIDEO&quot;))!!
</a><a href="#h22-3-18" id="h22-3-18" class="i">+                            val messageReader = ProtoReader(contentData)
</a><a href="#h22-3-19" id="h22-3-19" class="i">+                            val downloadedMediaList = MediaDownloaderHelper.downloadMediaFromReference(protoMediaReference) {
</a><a href="#h22-3-20" id="h22-3-20" class="i">+                                EncryptionHelper.decryptInputStream(it, contentType, messageReader, isArroyo = false)
</a><a href="#h22-3-21" id="h22-3-21" class="i">+                            }
</a><a href="#h22-3-22" id="h22-3-22" class="i">+
</a><a href="#h22-3-23" id="h22-3-23" class="i">+                            var bitmapPreview = PreviewUtils.createPreview(downloadedMediaList[MediaType.ORIGINAL]!!, mediaType.name.contains(&quot;VIDEO&quot;))!!
</a><a href="#h22-3-24" id="h22-3-24" class="i">+
</a><a href="#h22-3-25" id="h22-3-25" class="i">+                            downloadedMediaList[MediaType.OVERLAY]?.let {
</a><a href="#h22-3-26" id="h22-3-26" class="i">+                                bitmapPreview = PreviewUtils.mergeBitmapOverlay(bitmapPreview, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h22-3-27" id="h22-3-27" class="i">+                            }
</a><a href="#h22-3-28" id="h22-3-28" class="i">+
</a>                             val notificationBuilder = XposedHelpers.newInstance(
                                 Notification.Builder::class.java,
                                 context.androidContext,
<b>diff --git a/<a id="h23" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -1,9 +0,0 @@
</a><a href="#h23-0-0" id="h23-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui.menus
</a><a href="#h23-0-1" id="h23-0-1" class="d">-
</a><a href="#h23-0-2" id="h23-0-2" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h23-0-3" id="h23-0-3" class="d">-
</a><a href="#h23-0-4" id="h23-0-4" class="d">-abstract class AbstractMenu() {
</a><a href="#h23-0-5" id="h23-0-5" class="d">-    lateinit var context: ModContext
</a><a href="#h23-0-6" id="h23-0-6" class="d">-
</a><a href="#h23-0-7" id="h23-0-7" class="d">-    open fun init() {}
</a><a href="#h23-0-8" id="h23-0-8" class="d">-}</a><a href="#h23-0-9" id="h23-0-9" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h24" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MapActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MapActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MapActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MapActivity.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,99 +0,0 @@
</a><a href="#h24-0-0" id="h24-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui.menus
</a><a href="#h24-0-1" id="h24-0-1" class="d">-
</a><a href="#h24-0-2" id="h24-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h24-0-3" id="h24-0-3" class="d">-import android.app.Activity
</a><a href="#h24-0-4" id="h24-0-4" class="d">-import android.app.AlertDialog
</a><a href="#h24-0-5" id="h24-0-5" class="d">-import android.content.Context
</a><a href="#h24-0-6" id="h24-0-6" class="d">-import android.os.Bundle
</a><a href="#h24-0-7" id="h24-0-7" class="d">-import android.view.MotionEvent
</a><a href="#h24-0-8" id="h24-0-8" class="d">-import android.widget.Button
</a><a href="#h24-0-9" id="h24-0-9" class="d">-import android.widget.EditText
</a><a href="#h24-0-10" id="h24-0-10" class="d">-import me.rhunk.snapenhance.R
</a><a href="#h24-0-11" id="h24-0-11" class="d">-import org.osmdroid.config.Configuration
</a><a href="#h24-0-12" id="h24-0-12" class="d">-import org.osmdroid.tileprovider.tilesource.TileSourceFactory
</a><a href="#h24-0-13" id="h24-0-13" class="d">-import org.osmdroid.util.GeoPoint
</a><a href="#h24-0-14" id="h24-0-14" class="d">-import org.osmdroid.views.MapView
</a><a href="#h24-0-15" id="h24-0-15" class="d">-import org.osmdroid.views.Projection
</a><a href="#h24-0-16" id="h24-0-16" class="d">-import org.osmdroid.views.overlay.Marker
</a><a href="#h24-0-17" id="h24-0-17" class="d">-import org.osmdroid.views.overlay.Overlay
</a><a href="#h24-0-18" id="h24-0-18" class="d">-
</a><a href="#h24-0-19" id="h24-0-19" class="d">-
</a><a href="#h24-0-20" id="h24-0-20" class="d">-//TODO: Implement correctly
</a><a href="#h24-0-21" id="h24-0-21" class="d">-class MapActivity : Activity() {
</a><a href="#h24-0-22" id="h24-0-22" class="d">-
</a><a href="#h24-0-23" id="h24-0-23" class="d">-    private lateinit var mapView: MapView
</a><a href="#h24-0-24" id="h24-0-24" class="d">-
</a><a href="#h24-0-25" id="h24-0-25" class="d">-    @SuppressLint(&quot;MissingInflatedId&quot;, &quot;ResourceType&quot;)
</a><a href="#h24-0-26" id="h24-0-26" class="d">-    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h24-0-27" id="h24-0-27" class="d">-        super.onCreate(savedInstanceState)
</a><a href="#h24-0-28" id="h24-0-28" class="d">-
</a><a href="#h24-0-29" id="h24-0-29" class="d">-        val contextBundle = intent.extras?.getBundle(&quot;location&quot;) ?: return
</a><a href="#h24-0-30" id="h24-0-30" class="d">-        val locationLatitude = contextBundle.getDouble(&quot;latitude&quot;)
</a><a href="#h24-0-31" id="h24-0-31" class="d">-        val locationLongitude = contextBundle.getDouble(&quot;longitude&quot;)
</a><a href="#h24-0-32" id="h24-0-32" class="d">-
</a><a href="#h24-0-33" id="h24-0-33" class="d">-        Configuration.getInstance().load(applicationContext, getSharedPreferences(&quot;osmdroid&quot;, Context.MODE_PRIVATE))
</a><a href="#h24-0-34" id="h24-0-34" class="d">-
</a><a href="#h24-0-35" id="h24-0-35" class="d">-        setContentView(R.layout.map)
</a><a href="#h24-0-36" id="h24-0-36" class="d">-
</a><a href="#h24-0-37" id="h24-0-37" class="d">-        mapView = findViewById(R.id.mapView)
</a><a href="#h24-0-38" id="h24-0-38" class="d">-        mapView.setMultiTouchControls(true);
</a><a href="#h24-0-39" id="h24-0-39" class="d">-        mapView.setTileSource(TileSourceFactory.MAPNIK)
</a><a href="#h24-0-40" id="h24-0-40" class="d">-
</a><a href="#h24-0-41" id="h24-0-41" class="d">-        val startPoint = GeoPoint(locationLatitude, locationLongitude)
</a><a href="#h24-0-42" id="h24-0-42" class="d">-        mapView.controller.setZoom(10.0)
</a><a href="#h24-0-43" id="h24-0-43" class="d">-        mapView.controller.setCenter(startPoint)
</a><a href="#h24-0-44" id="h24-0-44" class="d">-
</a><a href="#h24-0-45" id="h24-0-45" class="d">-        val marker = Marker(mapView)
</a><a href="#h24-0-46" id="h24-0-46" class="d">-        marker.isDraggable = true
</a><a href="#h24-0-47" id="h24-0-47" class="d">-        marker.position = startPoint
</a><a href="#h24-0-48" id="h24-0-48" class="d">-        marker.setAnchor(Marker.ANCHOR_CENTER, Marker.ANCHOR_BOTTOM)
</a><a href="#h24-0-49" id="h24-0-49" class="d">-
</a><a href="#h24-0-50" id="h24-0-50" class="d">-        mapView.overlays.add(object: Overlay() {
</a><a href="#h24-0-51" id="h24-0-51" class="d">-            override fun onSingleTapConfirmed(e: MotionEvent?, mapView: MapView?): Boolean {
</a><a href="#h24-0-52" id="h24-0-52" class="d">-                val proj: Projection = mapView!!.projection
</a><a href="#h24-0-53" id="h24-0-53" class="d">-                val loc = proj.fromPixels(e!!.x.toInt(), e.y.toInt()) as GeoPoint
</a><a href="#h24-0-54" id="h24-0-54" class="d">-                marker.position = loc
</a><a href="#h24-0-55" id="h24-0-55" class="d">-                mapView.invalidate()
</a><a href="#h24-0-56" id="h24-0-56" class="d">-                return true
</a><a href="#h24-0-57" id="h24-0-57" class="d">-            }
</a><a href="#h24-0-58" id="h24-0-58" class="d">-        })
</a><a href="#h24-0-59" id="h24-0-59" class="d">-
</a><a href="#h24-0-60" id="h24-0-60" class="d">-        mapView.overlays.add(marker)
</a><a href="#h24-0-61" id="h24-0-61" class="d">-
</a><a href="#h24-0-62" id="h24-0-62" class="d">-        val applyButton = findViewById&lt;Button&gt;(R.id.apply_location_button)
</a><a href="#h24-0-63" id="h24-0-63" class="d">-        applyButton.setOnClickListener {
</a><a href="#h24-0-64" id="h24-0-64" class="d">-            val bundle = Bundle()
</a><a href="#h24-0-65" id="h24-0-65" class="d">-            bundle.putFloat(&quot;latitude&quot;, marker.position.latitude.toFloat())
</a><a href="#h24-0-66" id="h24-0-66" class="d">-            bundle.putFloat(&quot;longitude&quot;, marker.position.longitude.toFloat())
</a><a href="#h24-0-67" id="h24-0-67" class="d">-            setResult(RESULT_OK, intent.putExtra(&quot;location&quot;, bundle))
</a><a href="#h24-0-68" id="h24-0-68" class="d">-            finish()
</a><a href="#h24-0-69" id="h24-0-69" class="d">-        }
</a><a href="#h24-0-70" id="h24-0-70" class="d">-
</a><a href="#h24-0-71" id="h24-0-71" class="d">-        val setPreciseLocationButton = findViewById&lt;Button&gt;(R.id.set_precise_location_button)
</a><a href="#h24-0-72" id="h24-0-72" class="d">-
</a><a href="#h24-0-73" id="h24-0-73" class="d">-        setPreciseLocationButton.setOnClickListener {
</a><a href="#h24-0-74" id="h24-0-74" class="d">-            val locationDialog = layoutInflater.inflate(R.layout.precise_location_dialog, null)
</a><a href="#h24-0-75" id="h24-0-75" class="d">-            val dialogLatitude = locationDialog.findViewById&lt;EditText&gt;(R.id.dialog_latitude).also { it.setText(marker.position.latitude.toString()) }
</a><a href="#h24-0-76" id="h24-0-76" class="d">-            val dialogLongitude = locationDialog.findViewById&lt;EditText&gt;(R.id.dialog_longitude).also { it.setText(marker.position.longitude.toString()) }
</a><a href="#h24-0-77" id="h24-0-77" class="d">-
</a><a href="#h24-0-78" id="h24-0-78" class="d">-            AlertDialog.Builder(this)
</a><a href="#h24-0-79" id="h24-0-79" class="d">-                .setView(locationDialog)
</a><a href="#h24-0-80" id="h24-0-80" class="d">-                .setTitle(&quot;Set a precise location&quot;)
</a><a href="#h24-0-81" id="h24-0-81" class="d">-                .setPositiveButton(&quot;Set&quot;) { _, _ -&gt;
</a><a href="#h24-0-82" id="h24-0-82" class="d">-                    val latitude = dialogLatitude.text.toString().toDoubleOrNull()
</a><a href="#h24-0-83" id="h24-0-83" class="d">-                    val longitude = dialogLongitude.text.toString().toDoubleOrNull()
</a><a href="#h24-0-84" id="h24-0-84" class="d">-                    if (latitude != null &amp;&amp; longitude != null) {
</a><a href="#h24-0-85" id="h24-0-85" class="d">-                        val preciseLocation = GeoPoint(latitude, longitude)
</a><a href="#h24-0-86" id="h24-0-86" class="d">-                        mapView.controller.setCenter(preciseLocation)
</a><a href="#h24-0-87" id="h24-0-87" class="d">-                        marker.position = preciseLocation
</a><a href="#h24-0-88" id="h24-0-88" class="d">-                        mapView.invalidate()
</a><a href="#h24-0-89" id="h24-0-89" class="d">-                    }
</a><a href="#h24-0-90" id="h24-0-90" class="d">-                }.setNegativeButton(&quot;Cancel&quot;) { _, _ -&gt; }.show()
</a><a href="#h24-0-91" id="h24-0-91" class="d">-        }
</a><a href="#h24-0-92" id="h24-0-92" class="d">-    }
</a><a href="#h24-0-93" id="h24-0-93" class="d">-
</a><a href="#h24-0-94" id="h24-0-94" class="d">-    override fun onDestroy() {
</a><a href="#h24-0-95" id="h24-0-95" class="d">-        super.onDestroy()
</a><a href="#h24-0-96" id="h24-0-96" class="d">-        mapView.onDetach()
</a><a href="#h24-0-97" id="h24-0-97" class="d">-    }
</a><a href="#h24-0-98" id="h24-0-98" class="d">-}
</a><b>diff --git a/<a id="h25" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,147 +0,0 @@
</a><a href="#h25-0-0" id="h25-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui.menus
</a><a href="#h25-0-1" id="h25-0-1" class="d">-
</a><a href="#h25-0-2" id="h25-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h25-0-3" id="h25-0-3" class="d">-import android.view.Gravity
</a><a href="#h25-0-4" id="h25-0-4" class="d">-import android.view.View
</a><a href="#h25-0-5" id="h25-0-5" class="d">-import android.view.ViewGroup
</a><a href="#h25-0-6" id="h25-0-6" class="d">-import android.widget.FrameLayout
</a><a href="#h25-0-7" id="h25-0-7" class="d">-import android.widget.LinearLayout
</a><a href="#h25-0-8" id="h25-0-8" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h25-0-9" id="h25-0-9" class="d">-import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h25-0-10" id="h25-0-10" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h25-0-11" id="h25-0-11" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h25-0-12" id="h25-0-12" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h25-0-13" id="h25-0-13" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.impl.ChatActionMenu
</a><a href="#h25-0-14" id="h25-0-14" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.impl.FriendFeedInfoMenu
</a><a href="#h25-0-15" id="h25-0-15" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.impl.OperaContextActionMenu
</a><a href="#h25-0-16" id="h25-0-16" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.impl.SettingsMenu
</a><a href="#h25-0-17" id="h25-0-17" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h25-0-18" id="h25-0-18" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h25-0-19" id="h25-0-19" class="d">-import java.lang.reflect.Modifier
</a><a href="#h25-0-20" id="h25-0-20" class="d">-
</a><a href="#h25-0-21" id="h25-0-21" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h25-0-22" id="h25-0-22" class="d">-class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h25-0-23" id="h25-0-23" class="d">-    private val friendFeedInfoMenu = FriendFeedInfoMenu()
</a><a href="#h25-0-24" id="h25-0-24" class="d">-    private val operaContextActionMenu = OperaContextActionMenu()
</a><a href="#h25-0-25" id="h25-0-25" class="d">-    private val chatActionMenu = ChatActionMenu()
</a><a href="#h25-0-26" id="h25-0-26" class="d">-    private val settingMenu = SettingsMenu()
</a><a href="#h25-0-27" id="h25-0-27" class="d">-
</a><a href="#h25-0-28" id="h25-0-28" class="d">-    private val newChatString by lazy {
</a><a href="#h25-0-29" id="h25-0-29" class="d">-        context.resources.getString(context.resources.getIdentifier(&quot;new_chat&quot;, &quot;string&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h25-0-30" id="h25-0-30" class="d">-    }
</a><a href="#h25-0-31" id="h25-0-31" class="d">-
</a><a href="#h25-0-32" id="h25-0-32" class="d">-    private fun wasInjectedView(view: View): Boolean {
</a><a href="#h25-0-33" id="h25-0-33" class="d">-        if (view.getTag(Constants.VIEW_INJECTED_CODE) != null) return true
</a><a href="#h25-0-34" id="h25-0-34" class="d">-        view.setTag(Constants.VIEW_INJECTED_CODE, true)
</a><a href="#h25-0-35" id="h25-0-35" class="d">-        return false
</a><a href="#h25-0-36" id="h25-0-36" class="d">-    }
</a><a href="#h25-0-37" id="h25-0-37" class="d">-
</a><a href="#h25-0-38" id="h25-0-38" class="d">-    @SuppressLint(&quot;ResourceType&quot;)
</a><a href="#h25-0-39" id="h25-0-39" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h25-0-40" id="h25-0-40" class="d">-        friendFeedInfoMenu.context = context
</a><a href="#h25-0-41" id="h25-0-41" class="d">-        operaContextActionMenu.context = context
</a><a href="#h25-0-42" id="h25-0-42" class="d">-        chatActionMenu.context = context
</a><a href="#h25-0-43" id="h25-0-43" class="d">-        settingMenu.context = context
</a><a href="#h25-0-44" id="h25-0-44" class="d">-
</a><a href="#h25-0-45" id="h25-0-45" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h25-0-46" id="h25-0-46" class="d">-
</a><a href="#h25-0-47" id="h25-0-47" class="d">-        val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h25-0-48" id="h25-0-48" class="d">-        val actionSheetContainer = context.resources.getIdentifier(&quot;action_sheet_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h25-0-49" id="h25-0-49" class="d">-        val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h25-0-50" id="h25-0-50" class="d">-
</a><a href="#h25-0-51" id="h25-0-51" class="d">-        val addViewMethod = ViewGroup::class.java.getMethod(
</a><a href="#h25-0-52" id="h25-0-52" class="d">-            &quot;addView&quot;,
</a><a href="#h25-0-53" id="h25-0-53" class="d">-            View::class.java,
</a><a href="#h25-0-54" id="h25-0-54" class="d">-            Int::class.javaPrimitiveType,
</a><a href="#h25-0-55" id="h25-0-55" class="d">-            ViewGroup.LayoutParams::class.java
</a><a href="#h25-0-56" id="h25-0-56" class="d">-        )
</a><a href="#h25-0-57" id="h25-0-57" class="d">-
</a><a href="#h25-0-58" id="h25-0-58" class="d">-        Hooker.hook(addViewMethod, HookStage.BEFORE) { param -&gt;
</a><a href="#h25-0-59" id="h25-0-59" class="d">-            val viewGroup: ViewGroup = param.thisObject()
</a><a href="#h25-0-60" id="h25-0-60" class="d">-            val originalAddView: (View) -&gt; Unit = {
</a><a href="#h25-0-61" id="h25-0-61" class="d">-                param.invokeOriginal(arrayOf(it, -1,
</a><a href="#h25-0-62" id="h25-0-62" class="d">-                    FrameLayout.LayoutParams(
</a><a href="#h25-0-63" id="h25-0-63" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h25-0-64" id="h25-0-64" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h25-0-65" id="h25-0-65" class="d">-                    ))
</a><a href="#h25-0-66" id="h25-0-66" class="d">-                )
</a><a href="#h25-0-67" id="h25-0-67" class="d">-            }
</a><a href="#h25-0-68" id="h25-0-68" class="d">-
</a><a href="#h25-0-69" id="h25-0-69" class="d">-            val childView: View = param.arg(0)
</a><a href="#h25-0-70" id="h25-0-70" class="d">-            operaContextActionMenu.inject(viewGroup, childView)
</a><a href="#h25-0-71" id="h25-0-71" class="d">-
</a><a href="#h25-0-72" id="h25-0-72" class="d">-            //download in chat snaps and notes from the chat action menu
</a><a href="#h25-0-73" id="h25-0-73" class="d">-            if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;)) {
</a><a href="#h25-0-74" id="h25-0-74" class="d">-                if (viewGroup.parent == null || viewGroup.parent.parent == null) return@hook
</a><a href="#h25-0-75" id="h25-0-75" class="d">-                chatActionMenu.inject(viewGroup)
</a><a href="#h25-0-76" id="h25-0-76" class="d">-                return@hook
</a><a href="#h25-0-77" id="h25-0-77" class="d">-            }
</a><a href="#h25-0-78" id="h25-0-78" class="d">-
</a><a href="#h25-0-79" id="h25-0-79" class="d">-            //inject in group chat menus
</a><a href="#h25-0-80" id="h25-0-80" class="d">-            if (viewGroup.id == actionSheetContainer &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFetchConversationUserUUID == null) {
</a><a href="#h25-0-81" id="h25-0-81" class="d">-                val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h25-0-82" id="h25-0-82" class="d">-                    orientation = LinearLayout.VERTICAL
</a><a href="#h25-0-83" id="h25-0-83" class="d">-                    gravity = Gravity.BOTTOM
</a><a href="#h25-0-84" id="h25-0-84" class="d">-                    layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h25-0-85" id="h25-0-85" class="d">-                    addView(childView)
</a><a href="#h25-0-86" id="h25-0-86" class="d">-                }
</a><a href="#h25-0-87" id="h25-0-87" class="d">-
</a><a href="#h25-0-88" id="h25-0-88" class="d">-                Hooker.ephemeralHook(context.classCache.conversationManager, &quot;fetchConversation&quot;, HookStage.AFTER) {
</a><a href="#h25-0-89" id="h25-0-89" class="d">-                    if (wasInjectedView(injectedLayout)) return@ephemeralHook
</a><a href="#h25-0-90" id="h25-0-90" class="d">-
</a><a href="#h25-0-91" id="h25-0-91" class="d">-                    context.runOnUiThread {
</a><a href="#h25-0-92" id="h25-0-92" class="d">-                        val viewList = mutableListOf&lt;View&gt;()
</a><a href="#h25-0-93" id="h25-0-93" class="d">-                        friendFeedInfoMenu.inject(injectedLayout) { view -&gt;
</a><a href="#h25-0-94" id="h25-0-94" class="d">-                            view.layoutParams = LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h25-0-95" id="h25-0-95" class="d">-                                setMargins(0, 10, 0, 10)
</a><a href="#h25-0-96" id="h25-0-96" class="d">-                            }
</a><a href="#h25-0-97" id="h25-0-97" class="d">-                            viewList.add(view)
</a><a href="#h25-0-98" id="h25-0-98" class="d">-                        }
</a><a href="#h25-0-99" id="h25-0-99" class="d">-                        viewList.reversed().forEach { injectedLayout.addView(it, 0) }
</a><a href="#h25-0-100" id="h25-0-100" class="d">-                    }
</a><a href="#h25-0-101" id="h25-0-101" class="d">-                }
</a><a href="#h25-0-102" id="h25-0-102" class="d">-
</a><a href="#h25-0-103" id="h25-0-103" class="d">-                param.setArg(0, injectedLayout)
</a><a href="#h25-0-104" id="h25-0-104" class="d">-            }
</a><a href="#h25-0-105" id="h25-0-105" class="d">-
</a><a href="#h25-0-106" id="h25-0-106" class="d">-            if (viewGroup is LinearLayout &amp;&amp; viewGroup.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h25-0-107" id="h25-0-107" class="d">-                val itemStringInterface by lazy {
</a><a href="#h25-0-108" id="h25-0-108" class="d">-                    childView.javaClass.declaredFields.filter {
</a><a href="#h25-0-109" id="h25-0-109" class="d">-                        !it.type.isPrimitive &amp;&amp; Modifier.isAbstract(it.type.modifiers)
</a><a href="#h25-0-110" id="h25-0-110" class="d">-                    }.map {
</a><a href="#h25-0-111" id="h25-0-111" class="d">-                        runCatching {
</a><a href="#h25-0-112" id="h25-0-112" class="d">-                            it.isAccessible = true
</a><a href="#h25-0-113" id="h25-0-113" class="d">-                            it[childView]
</a><a href="#h25-0-114" id="h25-0-114" class="d">-                        }.getOrNull()
</a><a href="#h25-0-115" id="h25-0-115" class="d">-                    }.firstOrNull()
</a><a href="#h25-0-116" id="h25-0-116" class="d">-                }
</a><a href="#h25-0-117" id="h25-0-117" class="d">-
</a><a href="#h25-0-118" id="h25-0-118" class="d">-                //the 3 dot button shows a menu which contains the first item as a Plain object
</a><a href="#h25-0-119" id="h25-0-119" class="d">-                if (viewGroup.getChildCount() == 0 &amp;&amp; itemStringInterface != null &amp;&amp; itemStringInterface.toString().startsWith(&quot;Plain(primaryText=$newChatString&quot;)) {
</a><a href="#h25-0-120" id="h25-0-120" class="d">-                    settingMenu.inject(viewGroup, originalAddView)
</a><a href="#h25-0-121" id="h25-0-121" class="d">-                    viewGroup.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h25-0-122" id="h25-0-122" class="d">-                        override fun onViewAttachedToWindow(v: View) {}
</a><a href="#h25-0-123" id="h25-0-123" class="d">-                        override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h25-0-124" id="h25-0-124" class="d">-                            context.config.writeConfig()
</a><a href="#h25-0-125" id="h25-0-125" class="d">-                        }
</a><a href="#h25-0-126" id="h25-0-126" class="d">-                    })
</a><a href="#h25-0-127" id="h25-0-127" class="d">-                    return@hook
</a><a href="#h25-0-128" id="h25-0-128" class="d">-                }
</a><a href="#h25-0-129" id="h25-0-129" class="d">-                if (messaging.lastFetchConversationUserUUID == null) return@hook
</a><a href="#h25-0-130" id="h25-0-130" class="d">-
</a><a href="#h25-0-131" id="h25-0-131" class="d">-                //filter by the slot index
</a><a href="#h25-0-132" id="h25-0-132" class="d">-                if (viewGroup.getChildCount() != context.config.int(ConfigProperty.MENU_SLOT_ID)) return@hook
</a><a href="#h25-0-133" id="h25-0-133" class="d">-                friendFeedInfoMenu.inject(viewGroup, originalAddView)
</a><a href="#h25-0-134" id="h25-0-134" class="d">-
</a><a href="#h25-0-135" id="h25-0-135" class="d">-                viewGroup.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h25-0-136" id="h25-0-136" class="d">-                    override fun onViewAttachedToWindow(v: View) {}
</a><a href="#h25-0-137" id="h25-0-137" class="d">-                    override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h25-0-138" id="h25-0-138" class="d">-                        messaging.lastFetchConversationUserUUID = null
</a><a href="#h25-0-139" id="h25-0-139" class="d">-                    }
</a><a href="#h25-0-140" id="h25-0-140" class="d">-                })
</a><a href="#h25-0-141" id="h25-0-141" class="d">-            }
</a><a href="#h25-0-142" id="h25-0-142" class="d">-
</a><a href="#h25-0-143" id="h25-0-143" class="d">-        }
</a><a href="#h25-0-144" id="h25-0-144" class="d">-    }
</a><a href="#h25-0-145" id="h25-0-145" class="d">-
</a><a href="#h25-0-146" id="h25-0-146" class="d">-}</a><a href="#h25-0-147" id="h25-0-147" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h26" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,93 +0,0 @@
</a><a href="#h26-0-0" id="h26-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui.menus
</a><a href="#h26-0-1" id="h26-0-1" class="d">-
</a><a href="#h26-0-2" id="h26-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h26-0-3" id="h26-0-3" class="d">-import android.content.res.ColorStateList
</a><a href="#h26-0-4" id="h26-0-4" class="d">-import android.graphics.Color
</a><a href="#h26-0-5" id="h26-0-5" class="d">-import android.graphics.drawable.ColorDrawable
</a><a href="#h26-0-6" id="h26-0-6" class="d">-import android.graphics.drawable.Drawable
</a><a href="#h26-0-7" id="h26-0-7" class="d">-import android.graphics.drawable.ShapeDrawable
</a><a href="#h26-0-8" id="h26-0-8" class="d">-import android.graphics.drawable.StateListDrawable
</a><a href="#h26-0-9" id="h26-0-9" class="d">-import android.view.Gravity
</a><a href="#h26-0-10" id="h26-0-10" class="d">-import android.view.View
</a><a href="#h26-0-11" id="h26-0-11" class="d">-import android.widget.Switch
</a><a href="#h26-0-12" id="h26-0-12" class="d">-import android.widget.TextView
</a><a href="#h26-0-13" id="h26-0-13" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h26-0-14" id="h26-0-14" class="d">-
</a><a href="#h26-0-15" id="h26-0-15" class="d">-object ViewAppearanceHelper {
</a><a href="#h26-0-16" id="h26-0-16" class="d">-    @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;, &quot;DiscouragedApi&quot;,
</a><a href="#h26-0-17" id="h26-0-17" class="d">-        &quot;ClickableViewAccessibility&quot;
</a><a href="#h26-0-18" id="h26-0-18" class="d">-    )
</a><a href="#h26-0-19" id="h26-0-19" class="d">-    private var sigColorTextPrimary: Int = 0
</a><a href="#h26-0-20" id="h26-0-20" class="d">-    private var sigColorBackgroundSurface: Int = 0
</a><a href="#h26-0-21" id="h26-0-21" class="d">-
</a><a href="#h26-0-22" id="h26-0-22" class="d">-    private fun createRoundedBackground(color: Int, hasRadius: Boolean): Drawable {
</a><a href="#h26-0-23" id="h26-0-23" class="d">-        if (!hasRadius) return ColorDrawable(color)
</a><a href="#h26-0-24" id="h26-0-24" class="d">-        //FIXME: hardcoded radius
</a><a href="#h26-0-25" id="h26-0-25" class="d">-        return ShapeDrawable().apply {
</a><a href="#h26-0-26" id="h26-0-26" class="d">-            paint.color = color
</a><a href="#h26-0-27" id="h26-0-27" class="d">-            shape = android.graphics.drawable.shapes.RoundRectShape(
</a><a href="#h26-0-28" id="h26-0-28" class="d">-                floatArrayOf(20f, 20f, 20f, 20f, 20f, 20f, 20f, 20f),
</a><a href="#h26-0-29" id="h26-0-29" class="d">-                null,
</a><a href="#h26-0-30" id="h26-0-30" class="d">-                null
</a><a href="#h26-0-31" id="h26-0-31" class="d">-            )
</a><a href="#h26-0-32" id="h26-0-32" class="d">-        }
</a><a href="#h26-0-33" id="h26-0-33" class="d">-    }
</a><a href="#h26-0-34" id="h26-0-34" class="d">-
</a><a href="#h26-0-35" id="h26-0-35" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h26-0-36" id="h26-0-36" class="d">-    fun applyTheme(component: View, componentWidth: Int? = null, hasRadius: Boolean = false) {
</a><a href="#h26-0-37" id="h26-0-37" class="d">-        val resources = component.context.resources
</a><a href="#h26-0-38" id="h26-0-38" class="d">-        if (sigColorBackgroundSurface == 0 || sigColorTextPrimary == 0) {
</a><a href="#h26-0-39" id="h26-0-39" class="d">-            with(component.context.theme) {
</a><a href="#h26-0-40" id="h26-0-40" class="d">-                sigColorTextPrimary = obtainStyledAttributes(
</a><a href="#h26-0-41" id="h26-0-41" class="d">-                    intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h26-0-42" id="h26-0-42" class="d">-                ).getColor(0, 0)
</a><a href="#h26-0-43" id="h26-0-43" class="d">-
</a><a href="#h26-0-44" id="h26-0-44" class="d">-                sigColorBackgroundSurface = obtainStyledAttributes(
</a><a href="#h26-0-45" id="h26-0-45" class="d">-                    intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h26-0-46" id="h26-0-46" class="d">-                ).getColor(0, 0)
</a><a href="#h26-0-47" id="h26-0-47" class="d">-            }
</a><a href="#h26-0-48" id="h26-0-48" class="d">-        }
</a><a href="#h26-0-49" id="h26-0-49" class="d">-
</a><a href="#h26-0-50" id="h26-0-50" class="d">-        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;, &quot;com.snapchat.android&quot;)
</a><a href="#h26-0-51" id="h26-0-51" class="d">-        val scalingFactor = resources.displayMetrics.densityDpi.toDouble() / 400
</a><a href="#h26-0-52" id="h26-0-52" class="d">-
</a><a href="#h26-0-53" id="h26-0-53" class="d">-        with(component) {
</a><a href="#h26-0-54" id="h26-0-54" class="d">-            if (this is TextView) {
</a><a href="#h26-0-55" id="h26-0-55" class="d">-                setTextColor(sigColorTextPrimary)
</a><a href="#h26-0-56" id="h26-0-56" class="d">-                setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h26-0-57" id="h26-0-57" class="d">-                gravity = Gravity.CENTER_VERTICAL
</a><a href="#h26-0-58" id="h26-0-58" class="d">-                componentWidth?.let { width = it}
</a><a href="#h26-0-59" id="h26-0-59" class="d">-                height = (150 * scalingFactor).toInt()
</a><a href="#h26-0-60" id="h26-0-60" class="d">-                isAllCaps = false
</a><a href="#h26-0-61" id="h26-0-61" class="d">-                textSize = 16f
</a><a href="#h26-0-62" id="h26-0-62" class="d">-                typeface = resources.getFont(snapchatFontResId)
</a><a href="#h26-0-63" id="h26-0-63" class="d">-                outlineProvider = null
</a><a href="#h26-0-64" id="h26-0-64" class="d">-                setPadding((40 * scalingFactor).toInt(), 0, (40 * scalingFactor).toInt(), 0)
</a><a href="#h26-0-65" id="h26-0-65" class="d">-            }
</a><a href="#h26-0-66" id="h26-0-66" class="d">-            background = StateListDrawable().apply {
</a><a href="#h26-0-67" id="h26-0-67" class="d">-                addState(intArrayOf(), createRoundedBackground(color = sigColorBackgroundSurface, hasRadius))
</a><a href="#h26-0-68" id="h26-0-68" class="d">-                addState(intArrayOf(android.R.attr.state_pressed), createRoundedBackground(color = 0x5395026, hasRadius))
</a><a href="#h26-0-69" id="h26-0-69" class="d">-            }
</a><a href="#h26-0-70" id="h26-0-70" class="d">-        }
</a><a href="#h26-0-71" id="h26-0-71" class="d">-
</a><a href="#h26-0-72" id="h26-0-72" class="d">-        if (component is Switch) {
</a><a href="#h26-0-73" id="h26-0-73" class="d">-            with(resources) {
</a><a href="#h26-0-74" id="h26-0-74" class="d">-                component.switchMinWidth = getDimension(getIdentifier(&quot;v11_switch_min_width&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME)).toInt()
</a><a href="#h26-0-75" id="h26-0-75" class="d">-            }
</a><a href="#h26-0-76" id="h26-0-76" class="d">-            component.trackTintList = ColorStateList(
</a><a href="#h26-0-77" id="h26-0-77" class="d">-                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h26-0-78" id="h26-0-78" class="d">-                ), intArrayOf(
</a><a href="#h26-0-79" id="h26-0-79" class="d">-                    Color.parseColor(&quot;#1d1d1d&quot;),
</a><a href="#h26-0-80" id="h26-0-80" class="d">-                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h26-0-81" id="h26-0-81" class="d">-                )
</a><a href="#h26-0-82" id="h26-0-82" class="d">-            )
</a><a href="#h26-0-83" id="h26-0-83" class="d">-            component.thumbTintList = ColorStateList(
</a><a href="#h26-0-84" id="h26-0-84" class="d">-                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h26-0-85" id="h26-0-85" class="d">-                ), intArrayOf(
</a><a href="#h26-0-86" id="h26-0-86" class="d">-                    Color.parseColor(&quot;#F5F5F5&quot;),
</a><a href="#h26-0-87" id="h26-0-87" class="d">-                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h26-0-88" id="h26-0-88" class="d">-                )
</a><a href="#h26-0-89" id="h26-0-89" class="d">-            )
</a><a href="#h26-0-90" id="h26-0-90" class="d">-        }
</a><a href="#h26-0-91" id="h26-0-91" class="d">-    }
</a><a href="#h26-0-92" id="h26-0-92" class="d">-}
</a><b>diff --git a/<a id="h27" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -1,94 +0,0 @@
</a><a href="#h27-0-0" id="h27-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui.menus.impl
</a><a href="#h27-0-1" id="h27-0-1" class="d">-
</a><a href="#h27-0-2" id="h27-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h27-0-3" id="h27-0-3" class="d">-import android.os.SystemClock
</a><a href="#h27-0-4" id="h27-0-4" class="d">-import android.view.MotionEvent
</a><a href="#h27-0-5" id="h27-0-5" class="d">-import android.view.View
</a><a href="#h27-0-6" id="h27-0-6" class="d">-import android.view.ViewGroup
</a><a href="#h27-0-7" id="h27-0-7" class="d">-import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h27-0-8" id="h27-0-8" class="d">-import android.widget.Button
</a><a href="#h27-0-9" id="h27-0-9" class="d">-import me.rhunk.snapenhance.Constants.VIEW_INJECTED_CODE
</a><a href="#h27-0-10" id="h27-0-10" class="d">-import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h27-0-11" id="h27-0-11" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h27-0-12" id="h27-0-12" class="d">-import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h27-0-13" id="h27-0-13" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.AbstractMenu
</a><a href="#h27-0-14" id="h27-0-14" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.ViewAppearanceHelper
</a><a href="#h27-0-15" id="h27-0-15" class="d">-
</a><a href="#h27-0-16" id="h27-0-16" class="d">-
</a><a href="#h27-0-17" id="h27-0-17" class="d">-class ChatActionMenu : AbstractMenu() {
</a><a href="#h27-0-18" id="h27-0-18" class="d">-    private fun wasInjectedView(view: View): Boolean {
</a><a href="#h27-0-19" id="h27-0-19" class="d">-        if (view.getTag(VIEW_INJECTED_CODE) != null) return true
</a><a href="#h27-0-20" id="h27-0-20" class="d">-        view.setTag(VIEW_INJECTED_CODE, true)
</a><a href="#h27-0-21" id="h27-0-21" class="d">-        return false
</a><a href="#h27-0-22" id="h27-0-22" class="d">-    }
</a><a href="#h27-0-23" id="h27-0-23" class="d">-
</a><a href="#h27-0-24" id="h27-0-24" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h27-0-25" id="h27-0-25" class="d">-    fun inject(viewGroup: ViewGroup) {
</a><a href="#h27-0-26" id="h27-0-26" class="d">-        val parent = viewGroup.parent.parent as ViewGroup
</a><a href="#h27-0-27" id="h27-0-27" class="d">-        if (wasInjectedView(parent)) return
</a><a href="#h27-0-28" id="h27-0-28" class="d">-        //close the action menu using a touch event
</a><a href="#h27-0-29" id="h27-0-29" class="d">-        val closeActionMenu = {
</a><a href="#h27-0-30" id="h27-0-30" class="d">-            viewGroup.dispatchTouchEvent(
</a><a href="#h27-0-31" id="h27-0-31" class="d">-                MotionEvent.obtain(
</a><a href="#h27-0-32" id="h27-0-32" class="d">-                    SystemClock.uptimeMillis(),
</a><a href="#h27-0-33" id="h27-0-33" class="d">-                    SystemClock.uptimeMillis(),
</a><a href="#h27-0-34" id="h27-0-34" class="d">-                    MotionEvent.ACTION_DOWN,
</a><a href="#h27-0-35" id="h27-0-35" class="d">-                    0f,
</a><a href="#h27-0-36" id="h27-0-36" class="d">-                    0f,
</a><a href="#h27-0-37" id="h27-0-37" class="d">-                    0
</a><a href="#h27-0-38" id="h27-0-38" class="d">-                )
</a><a href="#h27-0-39" id="h27-0-39" class="d">-            )
</a><a href="#h27-0-40" id="h27-0-40" class="d">-        }
</a><a href="#h27-0-41" id="h27-0-41" class="d">-
</a><a href="#h27-0-42" id="h27-0-42" class="d">-        val injectButton = { button: Button -&gt;
</a><a href="#h27-0-43" id="h27-0-43" class="d">-            ViewAppearanceHelper.applyTheme(button, parent.width, hasRadius = true)
</a><a href="#h27-0-44" id="h27-0-44" class="d">-
</a><a href="#h27-0-45" id="h27-0-45" class="d">-            with(button) {
</a><a href="#h27-0-46" id="h27-0-46" class="d">-                layoutParams = MarginLayoutParams(
</a><a href="#h27-0-47" id="h27-0-47" class="d">-                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h27-0-48" id="h27-0-48" class="d">-                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h27-0-49" id="h27-0-49" class="d">-                ).apply {
</a><a href="#h27-0-50" id="h27-0-50" class="d">-                    setMargins(40, 0, 40, 15)
</a><a href="#h27-0-51" id="h27-0-51" class="d">-                }
</a><a href="#h27-0-52" id="h27-0-52" class="d">-                parent.addView(this)
</a><a href="#h27-0-53" id="h27-0-53" class="d">-            }
</a><a href="#h27-0-54" id="h27-0-54" class="d">-        }
</a><a href="#h27-0-55" id="h27-0-55" class="d">-
</a><a href="#h27-0-56" id="h27-0-56" class="d">-        if (context.config.bool(ConfigProperty.CHAT_DOWNLOAD_CONTEXT_MENU)) {
</a><a href="#h27-0-57" id="h27-0-57" class="d">-            injectButton(Button(viewGroup.context).apply {
</a><a href="#h27-0-58" id="h27-0-58" class="d">-                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.preview_button&quot;)
</a><a href="#h27-0-59" id="h27-0-59" class="d">-                setOnClickListener {
</a><a href="#h27-0-60" id="h27-0-60" class="d">-                    closeActionMenu()
</a><a href="#h27-0-61" id="h27-0-61" class="d">-                    this@ChatActionMenu.context.executeAsync { this@ChatActionMenu.context.feature(MediaDownloader::class).onMessageActionMenu(true) }
</a><a href="#h27-0-62" id="h27-0-62" class="d">-                }
</a><a href="#h27-0-63" id="h27-0-63" class="d">-            })
</a><a href="#h27-0-64" id="h27-0-64" class="d">-
</a><a href="#h27-0-65" id="h27-0-65" class="d">-            injectButton(Button(viewGroup.context).apply {
</a><a href="#h27-0-66" id="h27-0-66" class="d">-                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.download_button&quot;)
</a><a href="#h27-0-67" id="h27-0-67" class="d">-                setOnClickListener {
</a><a href="#h27-0-68" id="h27-0-68" class="d">-                    closeActionMenu()
</a><a href="#h27-0-69" id="h27-0-69" class="d">-                    this@ChatActionMenu.context.executeAsync {
</a><a href="#h27-0-70" id="h27-0-70" class="d">-                        this@ChatActionMenu.context.feature(
</a><a href="#h27-0-71" id="h27-0-71" class="d">-                            MediaDownloader::class
</a><a href="#h27-0-72" id="h27-0-72" class="d">-                        ).onMessageActionMenu(false)
</a><a href="#h27-0-73" id="h27-0-73" class="d">-                    }
</a><a href="#h27-0-74" id="h27-0-74" class="d">-                }
</a><a href="#h27-0-75" id="h27-0-75" class="d">-            })
</a><a href="#h27-0-76" id="h27-0-76" class="d">-        }
</a><a href="#h27-0-77" id="h27-0-77" class="d">-
</a><a href="#h27-0-78" id="h27-0-78" class="d">-        //delete logged message button
</a><a href="#h27-0-79" id="h27-0-79" class="d">-        if (context.config.bool(ConfigProperty.MESSAGE_LOGGER)) {
</a><a href="#h27-0-80" id="h27-0-80" class="d">-            injectButton(Button(viewGroup.context).apply {
</a><a href="#h27-0-81" id="h27-0-81" class="d">-                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.delete_logged_message_button&quot;)
</a><a href="#h27-0-82" id="h27-0-82" class="d">-                setOnClickListener {
</a><a href="#h27-0-83" id="h27-0-83" class="d">-                    closeActionMenu()
</a><a href="#h27-0-84" id="h27-0-84" class="d">-                    this@ChatActionMenu.context.executeAsync {
</a><a href="#h27-0-85" id="h27-0-85" class="d">-                        with(this@ChatActionMenu.context.feature(Messaging::class)) {
</a><a href="#h27-0-86" id="h27-0-86" class="d">-                            context.feature(me.rhunk.snapenhance.features.impl.spying.MessageLogger::class).deleteMessage(lastOpenedConversationUUID.toString(), lastFocusedMessageId)
</a><a href="#h27-0-87" id="h27-0-87" class="d">-                        }
</a><a href="#h27-0-88" id="h27-0-88" class="d">-                    }
</a><a href="#h27-0-89" id="h27-0-89" class="d">-                }
</a><a href="#h27-0-90" id="h27-0-90" class="d">-            })
</a><a href="#h27-0-91" id="h27-0-91" class="d">-        }
</a><a href="#h27-0-92" id="h27-0-92" class="d">-    }
</a><a href="#h27-0-93" id="h27-0-93" class="d">-}
</a><b>diff --git a/<a id="h28" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -1,372 +0,0 @@
</a><a href="#h28-0-0" id="h28-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui.menus.impl
</a><a href="#h28-0-1" id="h28-0-1" class="d">-
</a><a href="#h28-0-2" id="h28-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h28-0-3" id="h28-0-3" class="d">-import android.app.AlertDialog
</a><a href="#h28-0-4" id="h28-0-4" class="d">-import android.content.Context
</a><a href="#h28-0-5" id="h28-0-5" class="d">-import android.content.DialogInterface
</a><a href="#h28-0-6" id="h28-0-6" class="d">-import android.content.res.Resources
</a><a href="#h28-0-7" id="h28-0-7" class="d">-import android.graphics.Bitmap
</a><a href="#h28-0-8" id="h28-0-8" class="d">-import android.graphics.BitmapFactory
</a><a href="#h28-0-9" id="h28-0-9" class="d">-import android.graphics.Canvas
</a><a href="#h28-0-10" id="h28-0-10" class="d">-import android.graphics.Color
</a><a href="#h28-0-11" id="h28-0-11" class="d">-import android.graphics.Paint
</a><a href="#h28-0-12" id="h28-0-12" class="d">-import android.graphics.drawable.BitmapDrawable
</a><a href="#h28-0-13" id="h28-0-13" class="d">-import android.graphics.drawable.Drawable
</a><a href="#h28-0-14" id="h28-0-14" class="d">-import android.view.Gravity
</a><a href="#h28-0-15" id="h28-0-15" class="d">-import android.view.MotionEvent
</a><a href="#h28-0-16" id="h28-0-16" class="d">-import android.view.View
</a><a href="#h28-0-17" id="h28-0-17" class="d">-import android.view.ViewGroup
</a><a href="#h28-0-18" id="h28-0-18" class="d">-import android.widget.Button
</a><a href="#h28-0-19" id="h28-0-19" class="d">-import android.widget.CompoundButton
</a><a href="#h28-0-20" id="h28-0-20" class="d">-import android.widget.LinearLayout
</a><a href="#h28-0-21" id="h28-0-21" class="d">-import android.widget.Switch
</a><a href="#h28-0-22" id="h28-0-22" class="d">-import android.widget.Toast
</a><a href="#h28-0-23" id="h28-0-23" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h28-0-24" id="h28-0-24" class="d">-import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h28-0-25" id="h28-0-25" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h28-0-26" id="h28-0-26" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.FriendActionButton
</a><a href="#h28-0-27" id="h28-0-27" class="d">-import me.rhunk.snapenhance.database.objects.ConversationMessage
</a><a href="#h28-0-28" id="h28-0-28" class="d">-import me.rhunk.snapenhance.database.objects.FriendInfo
</a><a href="#h28-0-29" id="h28-0-29" class="d">-import me.rhunk.snapenhance.database.objects.UserConversationLink
</a><a href="#h28-0-30" id="h28-0-30" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h28-0-31" id="h28-0-31" class="d">-import me.rhunk.snapenhance.features.impl.downloader.AntiAutoDownload
</a><a href="#h28-0-32" id="h28-0-32" class="d">-import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a><a href="#h28-0-33" id="h28-0-33" class="d">-import me.rhunk.snapenhance.features.impl.tweaks.AntiAutoSave
</a><a href="#h28-0-34" id="h28-0-34" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.AbstractMenu
</a><a href="#h28-0-35" id="h28-0-35" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.ViewAppearanceHelper
</a><a href="#h28-0-36" id="h28-0-36" class="d">-import java.net.HttpURLConnection
</a><a href="#h28-0-37" id="h28-0-37" class="d">-import java.net.URL
</a><a href="#h28-0-38" id="h28-0-38" class="d">-import java.text.DateFormat
</a><a href="#h28-0-39" id="h28-0-39" class="d">-import java.text.SimpleDateFormat
</a><a href="#h28-0-40" id="h28-0-40" class="d">-import java.util.Calendar
</a><a href="#h28-0-41" id="h28-0-41" class="d">-import java.util.Date
</a><a href="#h28-0-42" id="h28-0-42" class="d">-import java.util.Locale
</a><a href="#h28-0-43" id="h28-0-43" class="d">-
</a><a href="#h28-0-44" id="h28-0-44" class="d">-class FriendFeedInfoMenu : AbstractMenu() {
</a><a href="#h28-0-45" id="h28-0-45" class="d">-    private fun getImageDrawable(url: String): Drawable {
</a><a href="#h28-0-46" id="h28-0-46" class="d">-        val connection = URL(url).openConnection() as HttpURLConnection
</a><a href="#h28-0-47" id="h28-0-47" class="d">-        connection.connect()
</a><a href="#h28-0-48" id="h28-0-48" class="d">-        val input = connection.inputStream
</a><a href="#h28-0-49" id="h28-0-49" class="d">-        return BitmapDrawable(Resources.getSystem(), BitmapFactory.decodeStream(input))
</a><a href="#h28-0-50" id="h28-0-50" class="d">-    }
</a><a href="#h28-0-51" id="h28-0-51" class="d">-
</a><a href="#h28-0-52" id="h28-0-52" class="d">-    private fun formatDate(timestamp: Long): String? {
</a><a href="#h28-0-53" id="h28-0-53" class="d">-        return SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(timestamp))
</a><a href="#h28-0-54" id="h28-0-54" class="d">-    }
</a><a href="#h28-0-55" id="h28-0-55" class="d">-
</a><a href="#h28-0-56" id="h28-0-56" class="d">-    private fun showProfileInfo(profile: FriendInfo) {
</a><a href="#h28-0-57" id="h28-0-57" class="d">-        var icon: Drawable? = null
</a><a href="#h28-0-58" id="h28-0-58" class="d">-        try {
</a><a href="#h28-0-59" id="h28-0-59" class="d">-            if (profile.bitmojiSelfieId != null &amp;&amp; profile.bitmojiAvatarId != null) {
</a><a href="#h28-0-60" id="h28-0-60" class="d">-                icon = getImageDrawable(
</a><a href="#h28-0-61" id="h28-0-61" class="d">-                    &quot;https://sdk.bitmoji.com/render/panel/&quot; + profile.bitmojiSelfieId
</a><a href="#h28-0-62" id="h28-0-62" class="d">-                        .toString() + &quot;-&quot; + profile.bitmojiAvatarId
</a><a href="#h28-0-63" id="h28-0-63" class="d">-                        .toString() + &quot;-v1.webp?transparent=1&amp;scale=0&quot;
</a><a href="#h28-0-64" id="h28-0-64" class="d">-                )
</a><a href="#h28-0-65" id="h28-0-65" class="d">-            }
</a><a href="#h28-0-66" id="h28-0-66" class="d">-        } catch (e: Throwable) {
</a><a href="#h28-0-67" id="h28-0-67" class="d">-            Logger.xposedLog(e)
</a><a href="#h28-0-68" id="h28-0-68" class="d">-        }
</a><a href="#h28-0-69" id="h28-0-69" class="d">-        val finalIcon = icon
</a><a href="#h28-0-70" id="h28-0-70" class="d">-        context.runOnUiThread {
</a><a href="#h28-0-71" id="h28-0-71" class="d">-            val addedTimestamp: Long = profile.addedTimestamp.coerceAtLeast(profile.reverseAddedTimestamp)
</a><a href="#h28-0-72" id="h28-0-72" class="d">-            val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h28-0-73" id="h28-0-73" class="d">-            builder.setIcon(finalIcon)
</a><a href="#h28-0-74" id="h28-0-74" class="d">-            builder.setTitle(profile.displayName)
</a><a href="#h28-0-75" id="h28-0-75" class="d">-
</a><a href="#h28-0-76" id="h28-0-76" class="d">-            val birthday = Calendar.getInstance()
</a><a href="#h28-0-77" id="h28-0-77" class="d">-            birthday[Calendar.MONTH] = (profile.birthday shr 32).toInt() - 1
</a><a href="#h28-0-78" id="h28-0-78" class="d">-            val message: String = &quot;&quot;&quot;
</a><a href="#h28-0-79" id="h28-0-79" class="d">-                ${context.translation.get(&quot;profile_info.username&quot;)}: ${profile.username}
</a><a href="#h28-0-80" id="h28-0-80" class="d">-                ${context.translation.get(&quot;profile_info.display_name&quot;)}: ${profile.displayName}
</a><a href="#h28-0-81" id="h28-0-81" class="d">-                ${context.translation.get(&quot;profile_info.added_date&quot;)}: ${formatDate(addedTimestamp)}
</a><a href="#h28-0-82" id="h28-0-82" class="d">-                ${birthday.getDisplayName(
</a><a href="#h28-0-83" id="h28-0-83" class="d">-                    Calendar.MONTH,
</a><a href="#h28-0-84" id="h28-0-84" class="d">-                    Calendar.LONG,
</a><a href="#h28-0-85" id="h28-0-85" class="d">-                    context.translation.locale
</a><a href="#h28-0-86" id="h28-0-86" class="d">-                )?.let {
</a><a href="#h28-0-87" id="h28-0-87" class="d">-                    context.translation.get(&quot;profile_info.birthday&quot;)
</a><a href="#h28-0-88" id="h28-0-88" class="d">-                        .replace(&quot;{month}&quot;, it)
</a><a href="#h28-0-89" id="h28-0-89" class="d">-                        .replace(&quot;{day}&quot;, profile.birthday.toInt().toString())
</a><a href="#h28-0-90" id="h28-0-90" class="d">-                }
</a><a href="#h28-0-91" id="h28-0-91" class="d">-            }
</a><a href="#h28-0-92" id="h28-0-92" class="d">-            &quot;&quot;&quot;.trimIndent()
</a><a href="#h28-0-93" id="h28-0-93" class="d">-            builder.setMessage(message)
</a><a href="#h28-0-94" id="h28-0-94" class="d">-            builder.setPositiveButton(
</a><a href="#h28-0-95" id="h28-0-95" class="d">-                &quot;OK&quot;
</a><a href="#h28-0-96" id="h28-0-96" class="d">-            ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h28-0-97" id="h28-0-97" class="d">-            builder.show()
</a><a href="#h28-0-98" id="h28-0-98" class="d">-        }
</a><a href="#h28-0-99" id="h28-0-99" class="d">-    }
</a><a href="#h28-0-100" id="h28-0-100" class="d">-
</a><a href="#h28-0-101" id="h28-0-101" class="d">-    private fun showPreview(userId: String?, conversationId: String, androidCtx: Context?) {
</a><a href="#h28-0-102" id="h28-0-102" class="d">-        //query message
</a><a href="#h28-0-103" id="h28-0-103" class="d">-        val messages: List&lt;ConversationMessage&gt;? = context.database.getMessagesFromConversationId(
</a><a href="#h28-0-104" id="h28-0-104" class="d">-            conversationId,
</a><a href="#h28-0-105" id="h28-0-105" class="d">-            context.config.int(ConfigProperty.MESSAGE_PREVIEW_LENGTH)
</a><a href="#h28-0-106" id="h28-0-106" class="d">-        )?.reversed()
</a><a href="#h28-0-107" id="h28-0-107" class="d">-
</a><a href="#h28-0-108" id="h28-0-108" class="d">-        if (messages.isNullOrEmpty()) {
</a><a href="#h28-0-109" id="h28-0-109" class="d">-            Toast.makeText(androidCtx, &quot;No messages found&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h28-0-110" id="h28-0-110" class="d">-            return
</a><a href="#h28-0-111" id="h28-0-111" class="d">-        }
</a><a href="#h28-0-112" id="h28-0-112" class="d">-        val participants: Map&lt;String, FriendInfo&gt; = context.database.getConversationParticipants(conversationId)!!
</a><a href="#h28-0-113" id="h28-0-113" class="d">-            .map { context.database.getFriendInfo(it)!! }
</a><a href="#h28-0-114" id="h28-0-114" class="d">-            .associateBy { it.userId!! }
</a><a href="#h28-0-115" id="h28-0-115" class="d">-        
</a><a href="#h28-0-116" id="h28-0-116" class="d">-        val messageBuilder = StringBuilder()
</a><a href="#h28-0-117" id="h28-0-117" class="d">-
</a><a href="#h28-0-118" id="h28-0-118" class="d">-        messages.forEach{ message: ConversationMessage -&gt;
</a><a href="#h28-0-119" id="h28-0-119" class="d">-            val sender: FriendInfo? = participants[message.sender_id]
</a><a href="#h28-0-120" id="h28-0-120" class="d">-
</a><a href="#h28-0-121" id="h28-0-121" class="d">-            var messageString: String = message.getMessageAsString() ?: ContentType.fromId(message.content_type).name
</a><a href="#h28-0-122" id="h28-0-122" class="d">-
</a><a href="#h28-0-123" id="h28-0-123" class="d">-            if (message.content_type == ContentType.SNAP.id) {
</a><a href="#h28-0-124" id="h28-0-124" class="d">-                val readTimeStamp: Long = message.read_timestamp
</a><a href="#h28-0-125" id="h28-0-125" class="d">-                messageString = &quot;\uD83D\uDFE5&quot; //red square
</a><a href="#h28-0-126" id="h28-0-126" class="d">-                if (readTimeStamp &gt; 0) {
</a><a href="#h28-0-127" id="h28-0-127" class="d">-                    messageString += &quot; \uD83D\uDC40 &quot; //eyes
</a><a href="#h28-0-128" id="h28-0-128" class="d">-                    messageString += DateFormat.getDateTimeInstance(
</a><a href="#h28-0-129" id="h28-0-129" class="d">-                        DateFormat.SHORT,
</a><a href="#h28-0-130" id="h28-0-130" class="d">-                        DateFormat.SHORT
</a><a href="#h28-0-131" id="h28-0-131" class="d">-                    ).format(Date(readTimeStamp))
</a><a href="#h28-0-132" id="h28-0-132" class="d">-                }
</a><a href="#h28-0-133" id="h28-0-133" class="d">-            }
</a><a href="#h28-0-134" id="h28-0-134" class="d">-
</a><a href="#h28-0-135" id="h28-0-135" class="d">-            var displayUsername = sender?.displayName ?: sender?.usernameForSorting?: context.translation.get(&quot;conversation_preview.unknown_user&quot;)
</a><a href="#h28-0-136" id="h28-0-136" class="d">-
</a><a href="#h28-0-137" id="h28-0-137" class="d">-            if (displayUsername.length &gt; 12) {
</a><a href="#h28-0-138" id="h28-0-138" class="d">-                displayUsername = displayUsername.substring(0, 13) + &quot;... &quot;
</a><a href="#h28-0-139" id="h28-0-139" class="d">-            }
</a><a href="#h28-0-140" id="h28-0-140" class="d">-
</a><a href="#h28-0-141" id="h28-0-141" class="d">-            messageBuilder.append(displayUsername).append(&quot;: &quot;).append(messageString).append(&quot;\n&quot;)
</a><a href="#h28-0-142" id="h28-0-142" class="d">-        }
</a><a href="#h28-0-143" id="h28-0-143" class="d">-
</a><a href="#h28-0-144" id="h28-0-144" class="d">-        val targetPerson: FriendInfo? =
</a><a href="#h28-0-145" id="h28-0-145" class="d">-            if (userId == null) null else participants[userId]
</a><a href="#h28-0-146" id="h28-0-146" class="d">-
</a><a href="#h28-0-147" id="h28-0-147" class="d">-        targetPerson?.streakExpirationTimestamp?.takeIf { it &gt; 0 }?.let {
</a><a href="#h28-0-148" id="h28-0-148" class="d">-            val timeSecondDiff = ((it - System.currentTimeMillis()) / 1000 / 60).toInt()
</a><a href="#h28-0-149" id="h28-0-149" class="d">-            messageBuilder.append(&quot;\n\n&quot;)
</a><a href="#h28-0-150" id="h28-0-150" class="d">-                .append(&quot;\uD83D\uDD25 &quot;) //fire emoji
</a><a href="#h28-0-151" id="h28-0-151" class="d">-                .append(context.translation.get(&quot;conversation_preview.streak_expiration&quot;).format(
</a><a href="#h28-0-152" id="h28-0-152" class="d">-                    timeSecondDiff / 60 / 24,
</a><a href="#h28-0-153" id="h28-0-153" class="d">-                    timeSecondDiff / 60 % 24,
</a><a href="#h28-0-154" id="h28-0-154" class="d">-                    timeSecondDiff % 60
</a><a href="#h28-0-155" id="h28-0-155" class="d">-                ))
</a><a href="#h28-0-156" id="h28-0-156" class="d">-        }
</a><a href="#h28-0-157" id="h28-0-157" class="d">-
</a><a href="#h28-0-158" id="h28-0-158" class="d">-        //alert dialog
</a><a href="#h28-0-159" id="h28-0-159" class="d">-        val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h28-0-160" id="h28-0-160" class="d">-        builder.setTitle(context.translation.get(&quot;conversation_preview.title&quot;))
</a><a href="#h28-0-161" id="h28-0-161" class="d">-        builder.setMessage(messageBuilder.toString())
</a><a href="#h28-0-162" id="h28-0-162" class="d">-        builder.setPositiveButton(
</a><a href="#h28-0-163" id="h28-0-163" class="d">-            &quot;OK&quot;
</a><a href="#h28-0-164" id="h28-0-164" class="d">-        ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h28-0-165" id="h28-0-165" class="d">-        targetPerson?.let {
</a><a href="#h28-0-166" id="h28-0-166" class="d">-            builder.setNegativeButton(context.translation.get(&quot;modal_option.profile_info&quot;)) {_, _ -&gt;
</a><a href="#h28-0-167" id="h28-0-167" class="d">-                context.executeAsync {
</a><a href="#h28-0-168" id="h28-0-168" class="d">-                    showProfileInfo(it)
</a><a href="#h28-0-169" id="h28-0-169" class="d">-                }
</a><a href="#h28-0-170" id="h28-0-170" class="d">-            }
</a><a href="#h28-0-171" id="h28-0-171" class="d">-        }
</a><a href="#h28-0-172" id="h28-0-172" class="d">-        builder.show()
</a><a href="#h28-0-173" id="h28-0-173" class="d">-    }
</a><a href="#h28-0-174" id="h28-0-174" class="d">-
</a><a href="#h28-0-175" id="h28-0-175" class="d">-    private fun createEmojiDrawable(text: String, width: Int, height: Int, textSize: Float, disabled: Boolean = false): Drawable {
</a><a href="#h28-0-176" id="h28-0-176" class="d">-        val bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888)
</a><a href="#h28-0-177" id="h28-0-177" class="d">-        val canvas = Canvas(bitmap)
</a><a href="#h28-0-178" id="h28-0-178" class="d">-        val paint = Paint()
</a><a href="#h28-0-179" id="h28-0-179" class="d">-        paint.textSize = textSize
</a><a href="#h28-0-180" id="h28-0-180" class="d">-        paint.color = Color.BLACK
</a><a href="#h28-0-181" id="h28-0-181" class="d">-        paint.textAlign = Paint.Align.CENTER
</a><a href="#h28-0-182" id="h28-0-182" class="d">-        canvas.drawText(text, width / 2f, height.toFloat() - paint.descent(), paint)
</a><a href="#h28-0-183" id="h28-0-183" class="d">-        if (disabled) {
</a><a href="#h28-0-184" id="h28-0-184" class="d">-            paint.color = Color.RED
</a><a href="#h28-0-185" id="h28-0-185" class="d">-            paint.strokeWidth = 5f
</a><a href="#h28-0-186" id="h28-0-186" class="d">-            canvas.drawLine(0f, 0f, width.toFloat(), height.toFloat(), paint)
</a><a href="#h28-0-187" id="h28-0-187" class="d">-        }
</a><a href="#h28-0-188" id="h28-0-188" class="d">-        return BitmapDrawable(context.resources, bitmap)
</a><a href="#h28-0-189" id="h28-0-189" class="d">-    }
</a><a href="#h28-0-190" id="h28-0-190" class="d">-
</a><a href="#h28-0-191" id="h28-0-191" class="d">-    private fun getCurrentConversationId(): Pair&lt;String, String?&gt; {
</a><a href="#h28-0-192" id="h28-0-192" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h28-0-193" id="h28-0-193" class="d">-        val focusedConversationTargetUser: String? = messaging.lastFetchConversationUserUUID?.toString()
</a><a href="#h28-0-194" id="h28-0-194" class="d">-
</a><a href="#h28-0-195" id="h28-0-195" class="d">-        val conversationId = if (messaging.lastFetchConversationUUID == null &amp;&amp; focusedConversationTargetUser != null) {
</a><a href="#h28-0-196" id="h28-0-196" class="d">-            val conversation: UserConversationLink = context.database.getDMConversationIdFromUserId(focusedConversationTargetUser) ?: throw IllegalStateException(&quot;No conversation found&quot;)
</a><a href="#h28-0-197" id="h28-0-197" class="d">-            conversation.client_conversation_id!!.trim().lowercase()
</a><a href="#h28-0-198" id="h28-0-198" class="d">-        } else {
</a><a href="#h28-0-199" id="h28-0-199" class="d">-            messaging.lastFetchConversationUUID.toString()
</a><a href="#h28-0-200" id="h28-0-200" class="d">-        }
</a><a href="#h28-0-201" id="h28-0-201" class="d">-
</a><a href="#h28-0-202" id="h28-0-202" class="d">-        return Pair(conversationId, focusedConversationTargetUser)
</a><a href="#h28-0-203" id="h28-0-203" class="d">-    }
</a><a href="#h28-0-204" id="h28-0-204" class="d">-
</a><a href="#h28-0-205" id="h28-0-205" class="d">-    private fun createToggleFeature(viewConsumer: ((View) -&gt; Unit), text: String, isChecked: () -&gt; Boolean, toggle: (Boolean) -&gt; Unit) {
</a><a href="#h28-0-206" id="h28-0-206" class="d">-        val switch = Switch(context.androidContext)
</a><a href="#h28-0-207" id="h28-0-207" class="d">-        switch.text = context.translation.get(text)
</a><a href="#h28-0-208" id="h28-0-208" class="d">-        switch.isChecked = isChecked()
</a><a href="#h28-0-209" id="h28-0-209" class="d">-        ViewAppearanceHelper.applyTheme(switch)
</a><a href="#h28-0-210" id="h28-0-210" class="d">-        switch.setOnCheckedChangeListener { _: CompoundButton?, checked: Boolean -&gt;
</a><a href="#h28-0-211" id="h28-0-211" class="d">-            toggle(checked)
</a><a href="#h28-0-212" id="h28-0-212" class="d">-        }
</a><a href="#h28-0-213" id="h28-0-213" class="d">-        viewConsumer(switch)
</a><a href="#h28-0-214" id="h28-0-214" class="d">-    }
</a><a href="#h28-0-215" id="h28-0-215" class="d">-
</a><a href="#h28-0-216" id="h28-0-216" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;, &quot;UseSwitchCompatOrMaterialCode&quot;, &quot;DefaultLocale&quot;, &quot;InflateParams&quot;,
</a><a href="#h28-0-217" id="h28-0-217" class="d">-        &quot;DiscouragedApi&quot;, &quot;ClickableViewAccessibility&quot;
</a><a href="#h28-0-218" id="h28-0-218" class="d">-    )
</a><a href="#h28-0-219" id="h28-0-219" class="d">-    fun inject(viewModel: View, viewConsumer: ((View) -&gt; Unit)) {
</a><a href="#h28-0-220" id="h28-0-220" class="d">-        val modContext = context
</a><a href="#h28-0-221" id="h28-0-221" class="d">-
</a><a href="#h28-0-222" id="h28-0-222" class="d">-        val friendFeedMenuOptions = context.config.options(ConfigProperty.FRIEND_FEED_MENU_BUTTONS)
</a><a href="#h28-0-223" id="h28-0-223" class="d">-        if (friendFeedMenuOptions.none { it.value }) return
</a><a href="#h28-0-224" id="h28-0-224" class="d">-
</a><a href="#h28-0-225" id="h28-0-225" class="d">-        val (conversationId, targetUser) = getCurrentConversationId()
</a><a href="#h28-0-226" id="h28-0-226" class="d">-
</a><a href="#h28-0-227" id="h28-0-227" class="d">-        if (!context.config.bool(ConfigProperty.ENABLE_FRIEND_FEED_MENU_BAR)) {
</a><a href="#h28-0-228" id="h28-0-228" class="d">-            //preview button
</a><a href="#h28-0-229" id="h28-0-229" class="d">-            val previewButton = Button(viewModel.context).apply {
</a><a href="#h28-0-230" id="h28-0-230" class="d">-                text = modContext.translation.get(&quot;friend_menu_option.preview&quot;)
</a><a href="#h28-0-231" id="h28-0-231" class="d">-                ViewAppearanceHelper.applyTheme(this, viewModel.width)
</a><a href="#h28-0-232" id="h28-0-232" class="d">-                setOnClickListener {
</a><a href="#h28-0-233" id="h28-0-233" class="d">-                    showPreview(
</a><a href="#h28-0-234" id="h28-0-234" class="d">-                        targetUser,
</a><a href="#h28-0-235" id="h28-0-235" class="d">-                        conversationId,
</a><a href="#h28-0-236" id="h28-0-236" class="d">-                        context
</a><a href="#h28-0-237" id="h28-0-237" class="d">-                    )
</a><a href="#h28-0-238" id="h28-0-238" class="d">-                }
</a><a href="#h28-0-239" id="h28-0-239" class="d">-            }
</a><a href="#h28-0-240" id="h28-0-240" class="d">-
</a><a href="#h28-0-241" id="h28-0-241" class="d">-            //stealth switch
</a><a href="#h28-0-242" id="h28-0-242" class="d">-            val stealthSwitch = Switch(viewModel.context).apply {
</a><a href="#h28-0-243" id="h28-0-243" class="d">-                text = modContext.translation.get(&quot;friend_menu_option.stealth_mode&quot;)
</a><a href="#h28-0-244" id="h28-0-244" class="d">-                isChecked = modContext.feature(StealthMode::class).isStealth(conversationId)
</a><a href="#h28-0-245" id="h28-0-245" class="d">-                ViewAppearanceHelper.applyTheme(this)
</a><a href="#h28-0-246" id="h28-0-246" class="d">-                setOnCheckedChangeListener { _: CompoundButton?, isChecked: Boolean -&gt;
</a><a href="#h28-0-247" id="h28-0-247" class="d">-                    modContext.feature(StealthMode::class).setStealth(
</a><a href="#h28-0-248" id="h28-0-248" class="d">-                        conversationId,
</a><a href="#h28-0-249" id="h28-0-249" class="d">-                        isChecked
</a><a href="#h28-0-250" id="h28-0-250" class="d">-                    )
</a><a href="#h28-0-251" id="h28-0-251" class="d">-                }
</a><a href="#h28-0-252" id="h28-0-252" class="d">-            }
</a><a href="#h28-0-253" id="h28-0-253" class="d">-
</a><a href="#h28-0-254" id="h28-0-254" class="d">-            if (friendFeedMenuOptions[&quot;anti_auto_save&quot;] == true) {
</a><a href="#h28-0-255" id="h28-0-255" class="d">-                createToggleFeature(viewConsumer,
</a><a href="#h28-0-256" id="h28-0-256" class="d">-                    &quot;friend_menu_option.anti_auto_save&quot;,
</a><a href="#h28-0-257" id="h28-0-257" class="d">-                    { context.feature(AntiAutoSave::class).isConversationIgnored(conversationId) },
</a><a href="#h28-0-258" id="h28-0-258" class="d">-                    { context.feature(AntiAutoSave::class).setConversationIgnored(conversationId, it) }
</a><a href="#h28-0-259" id="h28-0-259" class="d">-                )
</a><a href="#h28-0-260" id="h28-0-260" class="d">-            }
</a><a href="#h28-0-261" id="h28-0-261" class="d">-
</a><a href="#h28-0-262" id="h28-0-262" class="d">-            run {
</a><a href="#h28-0-263" id="h28-0-263" class="d">-                val userId = context.database.getFriendFeedInfoByConversationId(conversationId)?.friendUserId ?: return@run
</a><a href="#h28-0-264" id="h28-0-264" class="d">-                if (friendFeedMenuOptions[&quot;auto_download_blacklist&quot;] == true) {
</a><a href="#h28-0-265" id="h28-0-265" class="d">-                    createToggleFeature(viewConsumer,
</a><a href="#h28-0-266" id="h28-0-266" class="d">-                        &quot;friend_menu_option.auto_download_blacklist&quot;,
</a><a href="#h28-0-267" id="h28-0-267" class="d">-                        { context.feature(AntiAutoDownload::class).isUserIgnored(userId) },
</a><a href="#h28-0-268" id="h28-0-268" class="d">-                        { context.feature(AntiAutoDownload::class).setUserIgnored(userId, it) }
</a><a href="#h28-0-269" id="h28-0-269" class="d">-                    )
</a><a href="#h28-0-270" id="h28-0-270" class="d">-                }
</a><a href="#h28-0-271" id="h28-0-271" class="d">-            }
</a><a href="#h28-0-272" id="h28-0-272" class="d">-
</a><a href="#h28-0-273" id="h28-0-273" class="d">-            if (friendFeedMenuOptions[&quot;stealth_mode&quot;] == true) {
</a><a href="#h28-0-274" id="h28-0-274" class="d">-                viewConsumer(stealthSwitch)
</a><a href="#h28-0-275" id="h28-0-275" class="d">-            }
</a><a href="#h28-0-276" id="h28-0-276" class="d">-            if (friendFeedMenuOptions[&quot;conversation_info&quot;] == true) {
</a><a href="#h28-0-277" id="h28-0-277" class="d">-                viewConsumer(previewButton)
</a><a href="#h28-0-278" id="h28-0-278" class="d">-            }
</a><a href="#h28-0-279" id="h28-0-279" class="d">-            return
</a><a href="#h28-0-280" id="h28-0-280" class="d">-        }
</a><a href="#h28-0-281" id="h28-0-281" class="d">-
</a><a href="#h28-0-282" id="h28-0-282" class="d">-        val menuButtonBar = LinearLayout(viewModel.context).apply {
</a><a href="#h28-0-283" id="h28-0-283" class="d">-            layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT)
</a><a href="#h28-0-284" id="h28-0-284" class="d">-            orientation = LinearLayout.HORIZONTAL
</a><a href="#h28-0-285" id="h28-0-285" class="d">-            gravity = Gravity.CENTER
</a><a href="#h28-0-286" id="h28-0-286" class="d">-        }
</a><a href="#h28-0-287" id="h28-0-287" class="d">-
</a><a href="#h28-0-288" id="h28-0-288" class="d">-        fun createActionButton(icon: String, isDisabled: Boolean? = null, onClick: (Boolean) -&gt; Unit) {
</a><a href="#h28-0-289" id="h28-0-289" class="d">-            //FIXME: hardcoded values
</a><a href="#h28-0-290" id="h28-0-290" class="d">-            menuButtonBar.addView(LinearLayout(viewModel.context).apply {
</a><a href="#h28-0-291" id="h28-0-291" class="d">-                layoutParams = LinearLayout.LayoutParams(0, ViewGroup.LayoutParams.MATCH_PARENT, 1f)
</a><a href="#h28-0-292" id="h28-0-292" class="d">-                gravity = Gravity.CENTER
</a><a href="#h28-0-293" id="h28-0-293" class="d">-                isClickable = false
</a><a href="#h28-0-294" id="h28-0-294" class="d">-
</a><a href="#h28-0-295" id="h28-0-295" class="d">-                var isLineThrough = isDisabled ?: false
</a><a href="#h28-0-296" id="h28-0-296" class="d">-                FriendActionButton.new(viewModel.context).apply {
</a><a href="#h28-0-297" id="h28-0-297" class="d">-                    fun setLineThrough(value: Boolean) {
</a><a href="#h28-0-298" id="h28-0-298" class="d">-                        setIconDrawable(createEmojiDrawable(icon, 60, 60, 50f, if (isDisabled == null) false else value))
</a><a href="#h28-0-299" id="h28-0-299" class="d">-                    }
</a><a href="#h28-0-300" id="h28-0-300" class="d">-                    setLineThrough(isLineThrough)
</a><a href="#h28-0-301" id="h28-0-301" class="d">-                    (instanceNonNull() as View).apply {
</a><a href="#h28-0-302" id="h28-0-302" class="d">-                        layoutParams = LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h28-0-303" id="h28-0-303" class="d">-                            setMargins(0, 40, 0, 40)
</a><a href="#h28-0-304" id="h28-0-304" class="d">-                        }
</a><a href="#h28-0-305" id="h28-0-305" class="d">-                        setOnTouchListener { _, event -&gt;
</a><a href="#h28-0-306" id="h28-0-306" class="d">-                            if (event.action == MotionEvent.ACTION_UP) {
</a><a href="#h28-0-307" id="h28-0-307" class="d">-                                isLineThrough = !isLineThrough
</a><a href="#h28-0-308" id="h28-0-308" class="d">-                                onClick(isLineThrough)
</a><a href="#h28-0-309" id="h28-0-309" class="d">-                                setLineThrough(isLineThrough)
</a><a href="#h28-0-310" id="h28-0-310" class="d">-                            }
</a><a href="#h28-0-311" id="h28-0-311" class="d">-                            false
</a><a href="#h28-0-312" id="h28-0-312" class="d">-                        }
</a><a href="#h28-0-313" id="h28-0-313" class="d">-                    }
</a><a href="#h28-0-314" id="h28-0-314" class="d">-
</a><a href="#h28-0-315" id="h28-0-315" class="d">-                }.also { addView(it.instanceNonNull() as View) }
</a><a href="#h28-0-316" id="h28-0-316" class="d">-
</a><a href="#h28-0-317" id="h28-0-317" class="d">-            })
</a><a href="#h28-0-318" id="h28-0-318" class="d">-        }
</a><a href="#h28-0-319" id="h28-0-319" class="d">-
</a><a href="#h28-0-320" id="h28-0-320" class="d">-        if (friendFeedMenuOptions[&quot;auto_download_blacklist&quot;] == true) {
</a><a href="#h28-0-321" id="h28-0-321" class="d">-            run {
</a><a href="#h28-0-322" id="h28-0-322" class="d">-                val userId =
</a><a href="#h28-0-323" id="h28-0-323" class="d">-                    context.database.getFriendFeedInfoByConversationId(conversationId)?.friendUserId
</a><a href="#h28-0-324" id="h28-0-324" class="d">-                        ?: return@run
</a><a href="#h28-0-325" id="h28-0-325" class="d">-                createActionButton(
</a><a href="#h28-0-326" id="h28-0-326" class="d">-                    &quot;\u2B07\uFE0F&quot;,
</a><a href="#h28-0-327" id="h28-0-327" class="d">-                    isDisabled = !context.feature(AntiAutoDownload::class).isUserIgnored(userId)
</a><a href="#h28-0-328" id="h28-0-328" class="d">-                ) {
</a><a href="#h28-0-329" id="h28-0-329" class="d">-                    context.feature(AntiAutoDownload::class).setUserIgnored(userId, !it)
</a><a href="#h28-0-330" id="h28-0-330" class="d">-                }
</a><a href="#h28-0-331" id="h28-0-331" class="d">-            }
</a><a href="#h28-0-332" id="h28-0-332" class="d">-        }
</a><a href="#h28-0-333" id="h28-0-333" class="d">-
</a><a href="#h28-0-334" id="h28-0-334" class="d">-        if (friendFeedMenuOptions[&quot;anti_auto_save&quot;] == true) {
</a><a href="#h28-0-335" id="h28-0-335" class="d">-            //diskette
</a><a href="#h28-0-336" id="h28-0-336" class="d">-            createActionButton(&quot;\uD83D\uDCAC&quot;,
</a><a href="#h28-0-337" id="h28-0-337" class="d">-                isDisabled = !context.feature(AntiAutoSave::class)
</a><a href="#h28-0-338" id="h28-0-338" class="d">-                    .isConversationIgnored(conversationId)
</a><a href="#h28-0-339" id="h28-0-339" class="d">-            ) {
</a><a href="#h28-0-340" id="h28-0-340" class="d">-                context.feature(AntiAutoSave::class).setConversationIgnored(conversationId, !it)
</a><a href="#h28-0-341" id="h28-0-341" class="d">-            }
</a><a href="#h28-0-342" id="h28-0-342" class="d">-        }
</a><a href="#h28-0-343" id="h28-0-343" class="d">-
</a><a href="#h28-0-344" id="h28-0-344" class="d">-
</a><a href="#h28-0-345" id="h28-0-345" class="d">-        if (friendFeedMenuOptions[&quot;stealth_mode&quot;] == true) {
</a><a href="#h28-0-346" id="h28-0-346" class="d">-            //eyes
</a><a href="#h28-0-347" id="h28-0-347" class="d">-            createActionButton(
</a><a href="#h28-0-348" id="h28-0-348" class="d">-                &quot;\uD83D\uDC7B&quot;,
</a><a href="#h28-0-349" id="h28-0-349" class="d">-                isDisabled = !context.feature(StealthMode::class).isStealth(conversationId)
</a><a href="#h28-0-350" id="h28-0-350" class="d">-            ) { isChecked -&gt;
</a><a href="#h28-0-351" id="h28-0-351" class="d">-                context.feature(StealthMode::class).setStealth(
</a><a href="#h28-0-352" id="h28-0-352" class="d">-                    conversationId,
</a><a href="#h28-0-353" id="h28-0-353" class="d">-                    !isChecked
</a><a href="#h28-0-354" id="h28-0-354" class="d">-                )
</a><a href="#h28-0-355" id="h28-0-355" class="d">-            }
</a><a href="#h28-0-356" id="h28-0-356" class="d">-        }
</a><a href="#h28-0-357" id="h28-0-357" class="d">-
</a><a href="#h28-0-358" id="h28-0-358" class="d">-        if (friendFeedMenuOptions[&quot;conversation_info&quot;] == true) {
</a><a href="#h28-0-359" id="h28-0-359" class="d">-            //user
</a><a href="#h28-0-360" id="h28-0-360" class="d">-            createActionButton(&quot;\uD83D\uDC64&quot;) {
</a><a href="#h28-0-361" id="h28-0-361" class="d">-                showPreview(
</a><a href="#h28-0-362" id="h28-0-362" class="d">-                    targetUser,
</a><a href="#h28-0-363" id="h28-0-363" class="d">-                    conversationId,
</a><a href="#h28-0-364" id="h28-0-364" class="d">-                    viewModel.context
</a><a href="#h28-0-365" id="h28-0-365" class="d">-                )
</a><a href="#h28-0-366" id="h28-0-366" class="d">-            }
</a><a href="#h28-0-367" id="h28-0-367" class="d">-        }
</a><a href="#h28-0-368" id="h28-0-368" class="d">-
</a><a href="#h28-0-369" id="h28-0-369" class="d">-        viewConsumer(menuButtonBar)
</a><a href="#h28-0-370" id="h28-0-370" class="d">-    }
</a><a href="#h28-0-371" id="h28-0-371" class="d">-}</a><a href="#h28-0-372" id="h28-0-372" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h29" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -1,82 +0,0 @@
</a><a href="#h29-0-0" id="h29-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui.menus.impl
</a><a href="#h29-0-1" id="h29-0-1" class="d">-
</a><a href="#h29-0-2" id="h29-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h29-0-3" id="h29-0-3" class="d">-import android.view.Gravity
</a><a href="#h29-0-4" id="h29-0-4" class="d">-import android.view.View
</a><a href="#h29-0-5" id="h29-0-5" class="d">-import android.view.ViewGroup
</a><a href="#h29-0-6" id="h29-0-6" class="d">-import android.widget.Button
</a><a href="#h29-0-7" id="h29-0-7" class="d">-import android.widget.LinearLayout
</a><a href="#h29-0-8" id="h29-0-8" class="d">-import android.widget.ScrollView
</a><a href="#h29-0-9" id="h29-0-9" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h29-0-10" id="h29-0-10" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h29-0-11" id="h29-0-11" class="d">-import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h29-0-12" id="h29-0-12" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.AbstractMenu
</a><a href="#h29-0-13" id="h29-0-13" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.ViewAppearanceHelper.applyTheme
</a><a href="#h29-0-14" id="h29-0-14" class="d">-
</a><a href="#h29-0-15" id="h29-0-15" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h29-0-16" id="h29-0-16" class="d">-class OperaContextActionMenu : AbstractMenu() {
</a><a href="#h29-0-17" id="h29-0-17" class="d">-    private val contextCardsScrollView by lazy {
</a><a href="#h29-0-18" id="h29-0-18" class="d">-        context.resources.getIdentifier(&quot;context_cards_scroll_view&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h29-0-19" id="h29-0-19" class="d">-    }
</a><a href="#h29-0-20" id="h29-0-20" class="d">-
</a><a href="#h29-0-21" id="h29-0-21" class="d">-    /*
</a><a href="#h29-0-22" id="h29-0-22" class="d">-    LinearLayout :
</a><a href="#h29-0-23" id="h29-0-23" class="d">-        - LinearLayout:
</a><a href="#h29-0-24" id="h29-0-24" class="d">-            - SnapFontTextView
</a><a href="#h29-0-25" id="h29-0-25" class="d">-            - ImageView
</a><a href="#h29-0-26" id="h29-0-26" class="d">-        - LinearLayout:
</a><a href="#h29-0-27" id="h29-0-27" class="d">-            - SnapFontTextView
</a><a href="#h29-0-28" id="h29-0-28" class="d">-            - ImageView
</a><a href="#h29-0-29" id="h29-0-29" class="d">-        - LinearLayout:
</a><a href="#h29-0-30" id="h29-0-30" class="d">-            - SnapFontTextView
</a><a href="#h29-0-31" id="h29-0-31" class="d">-            - ImageView
</a><a href="#h29-0-32" id="h29-0-32" class="d">-     */
</a><a href="#h29-0-33" id="h29-0-33" class="d">-    private fun isViewGroupButtonMenuContainer(viewGroup: ViewGroup): Boolean {
</a><a href="#h29-0-34" id="h29-0-34" class="d">-        if (viewGroup !is LinearLayout) return false
</a><a href="#h29-0-35" id="h29-0-35" class="d">-        val children = ArrayList&lt;View&gt;()
</a><a href="#h29-0-36" id="h29-0-36" class="d">-        for (i in 0 until viewGroup.getChildCount())
</a><a href="#h29-0-37" id="h29-0-37" class="d">-            children.add(viewGroup.getChildAt(i))
</a><a href="#h29-0-38" id="h29-0-38" class="d">-        return if (children.any { view: View? -&gt; view !is LinearLayout })
</a><a href="#h29-0-39" id="h29-0-39" class="d">-            false
</a><a href="#h29-0-40" id="h29-0-40" class="d">-        else children.map { view: View -&gt; view as LinearLayout }
</a><a href="#h29-0-41" id="h29-0-41" class="d">-            .any { linearLayout: LinearLayout -&gt;
</a><a href="#h29-0-42" id="h29-0-42" class="d">-                val viewChildren = ArrayList&lt;View&gt;()
</a><a href="#h29-0-43" id="h29-0-43" class="d">-                for (i in 0 until linearLayout.childCount) viewChildren.add(
</a><a href="#h29-0-44" id="h29-0-44" class="d">-                    linearLayout.getChildAt(
</a><a href="#h29-0-45" id="h29-0-45" class="d">-                        i
</a><a href="#h29-0-46" id="h29-0-46" class="d">-                    )
</a><a href="#h29-0-47" id="h29-0-47" class="d">-                )
</a><a href="#h29-0-48" id="h29-0-48" class="d">-                viewChildren.any { viewChild: View -&gt;
</a><a href="#h29-0-49" id="h29-0-49" class="d">-                    viewChild.javaClass.name.endsWith(&quot;SnapFontTextView&quot;)
</a><a href="#h29-0-50" id="h29-0-50" class="d">-                }
</a><a href="#h29-0-51" id="h29-0-51" class="d">-            }
</a><a href="#h29-0-52" id="h29-0-52" class="d">-    }
</a><a href="#h29-0-53" id="h29-0-53" class="d">-
</a><a href="#h29-0-54" id="h29-0-54" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h29-0-55" id="h29-0-55" class="d">-    fun inject(viewGroup: ViewGroup, childView: View) {
</a><a href="#h29-0-56" id="h29-0-56" class="d">-        try {
</a><a href="#h29-0-57" id="h29-0-57" class="d">-            if (viewGroup.parent !is ScrollView) return
</a><a href="#h29-0-58" id="h29-0-58" class="d">-            val parent = viewGroup.parent as ScrollView
</a><a href="#h29-0-59" id="h29-0-59" class="d">-            if (parent.id != contextCardsScrollView) return
</a><a href="#h29-0-60" id="h29-0-60" class="d">-            if (childView !is LinearLayout) return
</a><a href="#h29-0-61" id="h29-0-61" class="d">-            if (!isViewGroupButtonMenuContainer(childView as ViewGroup)) return
</a><a href="#h29-0-62" id="h29-0-62" class="d">-
</a><a href="#h29-0-63" id="h29-0-63" class="d">-            val linearLayout = LinearLayout(childView.getContext())
</a><a href="#h29-0-64" id="h29-0-64" class="d">-            linearLayout.orientation = LinearLayout.VERTICAL
</a><a href="#h29-0-65" id="h29-0-65" class="d">-            linearLayout.gravity = Gravity.CENTER
</a><a href="#h29-0-66" id="h29-0-66" class="d">-            linearLayout.layoutParams =
</a><a href="#h29-0-67" id="h29-0-67" class="d">-                LinearLayout.LayoutParams(
</a><a href="#h29-0-68" id="h29-0-68" class="d">-                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h29-0-69" id="h29-0-69" class="d">-                    ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h29-0-70" id="h29-0-70" class="d">-                )
</a><a href="#h29-0-71" id="h29-0-71" class="d">-            val button = Button(childView.getContext())
</a><a href="#h29-0-72" id="h29-0-72" class="d">-            button.text = context.translation.get(&quot;opera_context_menu.download&quot;)
</a><a href="#h29-0-73" id="h29-0-73" class="d">-            button.setOnClickListener { context.feature(MediaDownloader::class).downloadLastOperaMediaAsync() }
</a><a href="#h29-0-74" id="h29-0-74" class="d">-            applyTheme(button)
</a><a href="#h29-0-75" id="h29-0-75" class="d">-            linearLayout.addView(button)
</a><a href="#h29-0-76" id="h29-0-76" class="d">-            (childView as ViewGroup).addView(linearLayout, 0)
</a><a href="#h29-0-77" id="h29-0-77" class="d">-        } catch (e: Throwable) {
</a><a href="#h29-0-78" id="h29-0-78" class="d">-            Logger.xposedLog(e)
</a><a href="#h29-0-79" id="h29-0-79" class="d">-        }
</a><a href="#h29-0-80" id="h29-0-80" class="d">-    }
</a><a href="#h29-0-81" id="h29-0-81" class="d">-}
</a><b>diff --git a/<a id="h30" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -1,242 +0,0 @@
</a><a href="#h30-0-0" id="h30-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui.menus.impl
</a><a href="#h30-0-1" id="h30-0-1" class="d">-
</a><a href="#h30-0-2" id="h30-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h30-0-3" id="h30-0-3" class="d">-import android.app.AlertDialog
</a><a href="#h30-0-4" id="h30-0-4" class="d">-import android.graphics.Color
</a><a href="#h30-0-5" id="h30-0-5" class="d">-import android.graphics.Typeface
</a><a href="#h30-0-6" id="h30-0-6" class="d">-import android.text.InputType
</a><a href="#h30-0-7" id="h30-0-7" class="d">-import android.view.View
</a><a href="#h30-0-8" id="h30-0-8" class="d">-import android.widget.Button
</a><a href="#h30-0-9" id="h30-0-9" class="d">-import android.widget.EditText
</a><a href="#h30-0-10" id="h30-0-10" class="d">-import android.widget.LinearLayout
</a><a href="#h30-0-11" id="h30-0-11" class="d">-import android.widget.Switch
</a><a href="#h30-0-12" id="h30-0-12" class="d">-import android.widget.TextView
</a><a href="#h30-0-13" id="h30-0-13" class="d">-import me.rhunk.snapenhance.BuildConfig
</a><a href="#h30-0-14" id="h30-0-14" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h30-0-15" id="h30-0-15" class="d">-import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h30-0-16" id="h30-0-16" class="d">-import me.rhunk.snapenhance.config.impl.ConfigIntegerValue
</a><a href="#h30-0-17" id="h30-0-17" class="d">-import me.rhunk.snapenhance.config.impl.ConfigStateListValue
</a><a href="#h30-0-18" id="h30-0-18" class="d">-import me.rhunk.snapenhance.config.impl.ConfigStateSelection
</a><a href="#h30-0-19" id="h30-0-19" class="d">-import me.rhunk.snapenhance.config.impl.ConfigStateValue
</a><a href="#h30-0-20" id="h30-0-20" class="d">-import me.rhunk.snapenhance.config.impl.ConfigStringValue
</a><a href="#h30-0-21" id="h30-0-21" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.AbstractMenu
</a><a href="#h30-0-22" id="h30-0-22" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.ViewAppearanceHelper
</a><a href="#h30-0-23" id="h30-0-23" class="d">-
</a><a href="#h30-0-24" id="h30-0-24" class="d">-class SettingsMenu : AbstractMenu() {
</a><a href="#h30-0-25" id="h30-0-25" class="d">-    @SuppressLint(&quot;ClickableViewAccessibility&quot;)
</a><a href="#h30-0-26" id="h30-0-26" class="d">-    private fun createCategoryTitle(key: String): TextView {
</a><a href="#h30-0-27" id="h30-0-27" class="d">-        val categoryText = TextView(context.androidContext)
</a><a href="#h30-0-28" id="h30-0-28" class="d">-        categoryText.text = context.translation.get(key)
</a><a href="#h30-0-29" id="h30-0-29" class="d">-        ViewAppearanceHelper.applyTheme(categoryText)
</a><a href="#h30-0-30" id="h30-0-30" class="d">-        categoryText.textSize = 20f
</a><a href="#h30-0-31" id="h30-0-31" class="d">-        categoryText.typeface = categoryText.typeface?.let { Typeface.create(it, Typeface.BOLD) }
</a><a href="#h30-0-32" id="h30-0-32" class="d">-        categoryText.setOnTouchListener { _, _ -&gt; true }
</a><a href="#h30-0-33" id="h30-0-33" class="d">-        return categoryText
</a><a href="#h30-0-34" id="h30-0-34" class="d">-    }
</a><a href="#h30-0-35" id="h30-0-35" class="d">-
</a><a href="#h30-0-36" id="h30-0-36" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h30-0-37" id="h30-0-37" class="d">-    private fun createPropertyView(property: ConfigProperty): View {
</a><a href="#h30-0-38" id="h30-0-38" class="d">-        val propertyName = context.translation.get(property.nameKey)
</a><a href="#h30-0-39" id="h30-0-39" class="d">-        val updateButtonText: (TextView, String) -&gt; Unit = { textView, text -&gt;
</a><a href="#h30-0-40" id="h30-0-40" class="d">-            textView.text = &quot;$propertyName${if (text.isEmpty()) &quot;&quot; else &quot;: $text&quot;}&quot;
</a><a href="#h30-0-41" id="h30-0-41" class="d">-        }
</a><a href="#h30-0-42" id="h30-0-42" class="d">-
</a><a href="#h30-0-43" id="h30-0-43" class="d">-        val updateLocalizedText: (TextView, String) -&gt; Unit = { textView, value -&gt;
</a><a href="#h30-0-44" id="h30-0-44" class="d">-            updateButtonText(textView, value.let {
</a><a href="#h30-0-45" id="h30-0-45" class="d">-                if (it.isEmpty()) {
</a><a href="#h30-0-46" id="h30-0-46" class="d">-                    &quot;(empty)&quot;
</a><a href="#h30-0-47" id="h30-0-47" class="d">-                }
</a><a href="#h30-0-48" id="h30-0-48" class="d">-                else {
</a><a href="#h30-0-49" id="h30-0-49" class="d">-                    if (property.disableValueLocalization) {
</a><a href="#h30-0-50" id="h30-0-50" class="d">-                        it
</a><a href="#h30-0-51" id="h30-0-51" class="d">-                    } else {
</a><a href="#h30-0-52" id="h30-0-52" class="d">-                        context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it)
</a><a href="#h30-0-53" id="h30-0-53" class="d">-                    }
</a><a href="#h30-0-54" id="h30-0-54" class="d">-                }
</a><a href="#h30-0-55" id="h30-0-55" class="d">-            })
</a><a href="#h30-0-56" id="h30-0-56" class="d">-        }
</a><a href="#h30-0-57" id="h30-0-57" class="d">-
</a><a href="#h30-0-58" id="h30-0-58" class="d">-        val textEditor: ((String) -&gt; Unit) -&gt; Unit = { updateValue -&gt;
</a><a href="#h30-0-59" id="h30-0-59" class="d">-            val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h30-0-60" id="h30-0-60" class="d">-            builder.setTitle(propertyName)
</a><a href="#h30-0-61" id="h30-0-61" class="d">-
</a><a href="#h30-0-62" id="h30-0-62" class="d">-            val input = EditText(context.androidContext)
</a><a href="#h30-0-63" id="h30-0-63" class="d">-            input.inputType = InputType.TYPE_CLASS_TEXT
</a><a href="#h30-0-64" id="h30-0-64" class="d">-            input.setText(property.valueContainer.value().toString())
</a><a href="#h30-0-65" id="h30-0-65" class="d">-
</a><a href="#h30-0-66" id="h30-0-66" class="d">-            builder.setView(input)
</a><a href="#h30-0-67" id="h30-0-67" class="d">-            builder.setPositiveButton(&quot;OK&quot;) { _, _ -&gt;
</a><a href="#h30-0-68" id="h30-0-68" class="d">-                updateValue(input.text.toString())
</a><a href="#h30-0-69" id="h30-0-69" class="d">-            }
</a><a href="#h30-0-70" id="h30-0-70" class="d">-
</a><a href="#h30-0-71" id="h30-0-71" class="d">-            builder.setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.cancel() }
</a><a href="#h30-0-72" id="h30-0-72" class="d">-            builder.show()
</a><a href="#h30-0-73" id="h30-0-73" class="d">-        }
</a><a href="#h30-0-74" id="h30-0-74" class="d">-
</a><a href="#h30-0-75" id="h30-0-75" class="d">-        val resultView: View = when (property.valueContainer) {
</a><a href="#h30-0-76" id="h30-0-76" class="d">-            is ConfigStringValue -&gt; {
</a><a href="#h30-0-77" id="h30-0-77" class="d">-                val textView = TextView(context.androidContext)
</a><a href="#h30-0-78" id="h30-0-78" class="d">-                updateButtonText(textView, property.valueContainer.let {
</a><a href="#h30-0-79" id="h30-0-79" class="d">-                    if (it.isHidden) it.hiddenValue()
</a><a href="#h30-0-80" id="h30-0-80" class="d">-                    else it.value()
</a><a href="#h30-0-81" id="h30-0-81" class="d">-                })
</a><a href="#h30-0-82" id="h30-0-82" class="d">-                ViewAppearanceHelper.applyTheme(textView)
</a><a href="#h30-0-83" id="h30-0-83" class="d">-                textView.setOnClickListener {
</a><a href="#h30-0-84" id="h30-0-84" class="d">-                    textEditor { value -&gt;
</a><a href="#h30-0-85" id="h30-0-85" class="d">-                        property.valueContainer.writeFrom(value)
</a><a href="#h30-0-86" id="h30-0-86" class="d">-                        updateButtonText(textView, property.valueContainer.let {
</a><a href="#h30-0-87" id="h30-0-87" class="d">-                            if (it.isHidden) it.hiddenValue()
</a><a href="#h30-0-88" id="h30-0-88" class="d">-                            else it.value()
</a><a href="#h30-0-89" id="h30-0-89" class="d">-                        })
</a><a href="#h30-0-90" id="h30-0-90" class="d">-                    }
</a><a href="#h30-0-91" id="h30-0-91" class="d">-                }
</a><a href="#h30-0-92" id="h30-0-92" class="d">-                textView
</a><a href="#h30-0-93" id="h30-0-93" class="d">-            }
</a><a href="#h30-0-94" id="h30-0-94" class="d">-            is ConfigIntegerValue -&gt; {
</a><a href="#h30-0-95" id="h30-0-95" class="d">-                val button = Button(context.androidContext)
</a><a href="#h30-0-96" id="h30-0-96" class="d">-                updateButtonText(button, property.valueContainer.value().toString())
</a><a href="#h30-0-97" id="h30-0-97" class="d">-                button.setOnClickListener {
</a><a href="#h30-0-98" id="h30-0-98" class="d">-                    textEditor { value -&gt;
</a><a href="#h30-0-99" id="h30-0-99" class="d">-                        runCatching {
</a><a href="#h30-0-100" id="h30-0-100" class="d">-                            property.valueContainer.writeFrom(value)
</a><a href="#h30-0-101" id="h30-0-101" class="d">-                            updateButtonText(button, value)
</a><a href="#h30-0-102" id="h30-0-102" class="d">-                        }.onFailure {
</a><a href="#h30-0-103" id="h30-0-103" class="d">-                            context.shortToast(&quot;Invalid value&quot;)
</a><a href="#h30-0-104" id="h30-0-104" class="d">-                        }
</a><a href="#h30-0-105" id="h30-0-105" class="d">-                    }
</a><a href="#h30-0-106" id="h30-0-106" class="d">-                }
</a><a href="#h30-0-107" id="h30-0-107" class="d">-                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h30-0-108" id="h30-0-108" class="d">-                button
</a><a href="#h30-0-109" id="h30-0-109" class="d">-            }
</a><a href="#h30-0-110" id="h30-0-110" class="d">-            is ConfigStateValue -&gt; {
</a><a href="#h30-0-111" id="h30-0-111" class="d">-                val switch = Switch(context.androidContext)
</a><a href="#h30-0-112" id="h30-0-112" class="d">-                switch.text = propertyName
</a><a href="#h30-0-113" id="h30-0-113" class="d">-                switch.isChecked = property.valueContainer.value()
</a><a href="#h30-0-114" id="h30-0-114" class="d">-                switch.setOnCheckedChangeListener { _, isChecked -&gt;
</a><a href="#h30-0-115" id="h30-0-115" class="d">-                    property.valueContainer.writeFrom(isChecked.toString())
</a><a href="#h30-0-116" id="h30-0-116" class="d">-                }
</a><a href="#h30-0-117" id="h30-0-117" class="d">-                ViewAppearanceHelper.applyTheme(switch)
</a><a href="#h30-0-118" id="h30-0-118" class="d">-                switch
</a><a href="#h30-0-119" id="h30-0-119" class="d">-            }
</a><a href="#h30-0-120" id="h30-0-120" class="d">-            is ConfigStateSelection -&gt; {
</a><a href="#h30-0-121" id="h30-0-121" class="d">-                val button = Button(context.androidContext)
</a><a href="#h30-0-122" id="h30-0-122" class="d">-                updateLocalizedText(button, property.valueContainer.value())
</a><a href="#h30-0-123" id="h30-0-123" class="d">-
</a><a href="#h30-0-124" id="h30-0-124" class="d">-                button.setOnClickListener {_ -&gt;
</a><a href="#h30-0-125" id="h30-0-125" class="d">-                    val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h30-0-126" id="h30-0-126" class="d">-                    builder.setTitle(propertyName)
</a><a href="#h30-0-127" id="h30-0-127" class="d">-
</a><a href="#h30-0-128" id="h30-0-128" class="d">-                    builder.setSingleChoiceItems(
</a><a href="#h30-0-129" id="h30-0-129" class="d">-                        property.valueContainer.keys().toTypedArray().map {
</a><a href="#h30-0-130" id="h30-0-130" class="d">-                            if (property.disableValueLocalization) it
</a><a href="#h30-0-131" id="h30-0-131" class="d">-                            else context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it)
</a><a href="#h30-0-132" id="h30-0-132" class="d">-                        }.toTypedArray(),
</a><a href="#h30-0-133" id="h30-0-133" class="d">-                        property.valueContainer.keys().indexOf(property.valueContainer.value())
</a><a href="#h30-0-134" id="h30-0-134" class="d">-                    ) { _, which -&gt;
</a><a href="#h30-0-135" id="h30-0-135" class="d">-                        property.valueContainer.writeFrom(property.valueContainer.keys()[which])
</a><a href="#h30-0-136" id="h30-0-136" class="d">-                    }
</a><a href="#h30-0-137" id="h30-0-137" class="d">-
</a><a href="#h30-0-138" id="h30-0-138" class="d">-                    builder.setPositiveButton(&quot;OK&quot;) { _, _ -&gt;
</a><a href="#h30-0-139" id="h30-0-139" class="d">-                        updateLocalizedText(button, property.valueContainer.value())
</a><a href="#h30-0-140" id="h30-0-140" class="d">-                    }
</a><a href="#h30-0-141" id="h30-0-141" class="d">-
</a><a href="#h30-0-142" id="h30-0-142" class="d">-                    builder.show()
</a><a href="#h30-0-143" id="h30-0-143" class="d">-                }
</a><a href="#h30-0-144" id="h30-0-144" class="d">-                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h30-0-145" id="h30-0-145" class="d">-                button
</a><a href="#h30-0-146" id="h30-0-146" class="d">-            }
</a><a href="#h30-0-147" id="h30-0-147" class="d">-            is ConfigStateListValue -&gt; {
</a><a href="#h30-0-148" id="h30-0-148" class="d">-                val button = Button(context.androidContext)
</a><a href="#h30-0-149" id="h30-0-149" class="d">-                updateButtonText(button, &quot;(${property.valueContainer.value().count { it.value }})&quot;)
</a><a href="#h30-0-150" id="h30-0-150" class="d">-
</a><a href="#h30-0-151" id="h30-0-151" class="d">-                button.setOnClickListener {_ -&gt;
</a><a href="#h30-0-152" id="h30-0-152" class="d">-                    val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h30-0-153" id="h30-0-153" class="d">-                    builder.setTitle(propertyName)
</a><a href="#h30-0-154" id="h30-0-154" class="d">-
</a><a href="#h30-0-155" id="h30-0-155" class="d">-                    val sortedStates = property.valueContainer.value().toSortedMap()
</a><a href="#h30-0-156" id="h30-0-156" class="d">-
</a><a href="#h30-0-157" id="h30-0-157" class="d">-                    builder.setMultiChoiceItems(
</a><a href="#h30-0-158" id="h30-0-158" class="d">-                        sortedStates.toSortedMap().map {
</a><a href="#h30-0-159" id="h30-0-159" class="d">-                            if (property.disableValueLocalization) it.key
</a><a href="#h30-0-160" id="h30-0-160" class="d">-                            else context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it.key)
</a><a href="#h30-0-161" id="h30-0-161" class="d">-                        }.toTypedArray(),
</a><a href="#h30-0-162" id="h30-0-162" class="d">-                        sortedStates.map { it.value }.toBooleanArray()
</a><a href="#h30-0-163" id="h30-0-163" class="d">-                    ) { _, which, isChecked -&gt;
</a><a href="#h30-0-164" id="h30-0-164" class="d">-                        sortedStates.keys.toList()[which].let { key -&gt;
</a><a href="#h30-0-165" id="h30-0-165" class="d">-                            property.valueContainer.setKey(key, isChecked)
</a><a href="#h30-0-166" id="h30-0-166" class="d">-                        }
</a><a href="#h30-0-167" id="h30-0-167" class="d">-                    }
</a><a href="#h30-0-168" id="h30-0-168" class="d">-
</a><a href="#h30-0-169" id="h30-0-169" class="d">-                    builder.setPositiveButton(&quot;OK&quot;) { _, _ -&gt;
</a><a href="#h30-0-170" id="h30-0-170" class="d">-                        updateButtonText(button, &quot;(${property.valueContainer.value().count { it.value }})&quot;)
</a><a href="#h30-0-171" id="h30-0-171" class="d">-                    }
</a><a href="#h30-0-172" id="h30-0-172" class="d">-
</a><a href="#h30-0-173" id="h30-0-173" class="d">-                    builder.show()
</a><a href="#h30-0-174" id="h30-0-174" class="d">-                }
</a><a href="#h30-0-175" id="h30-0-175" class="d">-                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h30-0-176" id="h30-0-176" class="d">-                button
</a><a href="#h30-0-177" id="h30-0-177" class="d">-            }
</a><a href="#h30-0-178" id="h30-0-178" class="d">-            else -&gt; {
</a><a href="#h30-0-179" id="h30-0-179" class="d">-                TextView(context.androidContext)
</a><a href="#h30-0-180" id="h30-0-180" class="d">-            }
</a><a href="#h30-0-181" id="h30-0-181" class="d">-        }
</a><a href="#h30-0-182" id="h30-0-182" class="d">-        return resultView
</a><a href="#h30-0-183" id="h30-0-183" class="d">-    }
</a><a href="#h30-0-184" id="h30-0-184" class="d">-
</a><a href="#h30-0-185" id="h30-0-185" class="d">-    private fun newSeparator(thickness: Int, color: Int = Color.BLACK): View {
</a><a href="#h30-0-186" id="h30-0-186" class="d">-        return LinearLayout(context.mainActivity).apply {
</a><a href="#h30-0-187" id="h30-0-187" class="d">-            setPadding(0, 0, 0, thickness)
</a><a href="#h30-0-188" id="h30-0-188" class="d">-            setBackgroundColor(color)
</a><a href="#h30-0-189" id="h30-0-189" class="d">-        }
</a><a href="#h30-0-190" id="h30-0-190" class="d">-    }
</a><a href="#h30-0-191" id="h30-0-191" class="d">-
</a><a href="#h30-0-192" id="h30-0-192" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h30-0-193" id="h30-0-193" class="d">-    @Suppress(&quot;deprecation&quot;)
</a><a href="#h30-0-194" id="h30-0-194" class="d">-    fun inject(viewModel: View, addView: (View) -&gt; Unit) {
</a><a href="#h30-0-195" id="h30-0-195" class="d">-        val packageInfo = viewModel.context.packageManager.getPackageInfo(Constants.SNAPCHAT_PACKAGE_NAME, 0)
</a><a href="#h30-0-196" id="h30-0-196" class="d">-        val versionTextBuilder = StringBuilder()
</a><a href="#h30-0-197" id="h30-0-197" class="d">-        versionTextBuilder.append(&quot;SnapEnhance &quot;).append(BuildConfig.VERSION_NAME)
</a><a href="#h30-0-198" id="h30-0-198" class="d">-            .append(&quot; by rhunk&quot;)
</a><a href="#h30-0-199" id="h30-0-199" class="d">-        if (BuildConfig.DEBUG) {
</a><a href="#h30-0-200" id="h30-0-200" class="d">-            versionTextBuilder.append(&quot;\n&quot;).append(&quot;Snapchat &quot;).append(packageInfo.versionName)
</a><a href="#h30-0-201" id="h30-0-201" class="d">-                .append(&quot; (&quot;).append(packageInfo.longVersionCode).append(&quot;)&quot;)
</a><a href="#h30-0-202" id="h30-0-202" class="d">-        }
</a><a href="#h30-0-203" id="h30-0-203" class="d">-        val titleText = TextView(viewModel.context)
</a><a href="#h30-0-204" id="h30-0-204" class="d">-        titleText.text = versionTextBuilder.toString()
</a><a href="#h30-0-205" id="h30-0-205" class="d">-        ViewAppearanceHelper.applyTheme(titleText)
</a><a href="#h30-0-206" id="h30-0-206" class="d">-        titleText.textSize = 18f
</a><a href="#h30-0-207" id="h30-0-207" class="d">-        titleText.minHeight = 80 * versionTextBuilder.chars().filter { ch: Int -&gt; ch == &#39;\n&#39;.code }
</a><a href="#h30-0-208" id="h30-0-208" class="d">-                .count().coerceAtLeast(2).toInt()
</a><a href="#h30-0-209" id="h30-0-209" class="d">-        addView(titleText)
</a><a href="#h30-0-210" id="h30-0-210" class="d">-
</a><a href="#h30-0-211" id="h30-0-211" class="d">-        val actions = context.actionManager.getActions().map {
</a><a href="#h30-0-212" id="h30-0-212" class="d">-            Pair(it) {
</a><a href="#h30-0-213" id="h30-0-213" class="d">-                val button = Button(viewModel.context)
</a><a href="#h30-0-214" id="h30-0-214" class="d">-                button.text = context.translation.get(it.nameKey)
</a><a href="#h30-0-215" id="h30-0-215" class="d">-                button.setOnClickListener { _ -&gt;
</a><a href="#h30-0-216" id="h30-0-216" class="d">-                    it.run()
</a><a href="#h30-0-217" id="h30-0-217" class="d">-                }
</a><a href="#h30-0-218" id="h30-0-218" class="d">-                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h30-0-219" id="h30-0-219" class="d">-                button
</a><a href="#h30-0-220" id="h30-0-220" class="d">-            }
</a><a href="#h30-0-221" id="h30-0-221" class="d">-        }
</a><a href="#h30-0-222" id="h30-0-222" class="d">-
</a><a href="#h30-0-223" id="h30-0-223" class="d">-        context.config.entries().groupBy {
</a><a href="#h30-0-224" id="h30-0-224" class="d">-            it.key.category
</a><a href="#h30-0-225" id="h30-0-225" class="d">-        }.forEach { (category, value) -&gt;
</a><a href="#h30-0-226" id="h30-0-226" class="d">-            addView(createCategoryTitle(category.key))
</a><a href="#h30-0-227" id="h30-0-227" class="d">-            value.filter { it.key.shouldAppearInSettings }.forEach { (property, _) -&gt;
</a><a href="#h30-0-228" id="h30-0-228" class="d">-                addView(createPropertyView(property))
</a><a href="#h30-0-229" id="h30-0-229" class="d">-                actions.find { pair -&gt; pair.first.dependsOnProperty == property}?.let { pair -&gt;
</a><a href="#h30-0-230" id="h30-0-230" class="d">-                    addView(pair.second())
</a><a href="#h30-0-231" id="h30-0-231" class="d">-                }
</a><a href="#h30-0-232" id="h30-0-232" class="d">-            }
</a><a href="#h30-0-233" id="h30-0-233" class="d">-        }
</a><a href="#h30-0-234" id="h30-0-234" class="d">-
</a><a href="#h30-0-235" id="h30-0-235" class="d">-        actions.filter { it.first.dependsOnProperty == null }.forEach {
</a><a href="#h30-0-236" id="h30-0-236" class="d">-            addView(it.second())
</a><a href="#h30-0-237" id="h30-0-237" class="d">-        }
</a><a href="#h30-0-238" id="h30-0-238" class="d">-
</a><a href="#h30-0-239" id="h30-0-239" class="d">-        addView(newSeparator(3, Color.parseColor(&quot;#f5f5f5&quot;)))
</a><a href="#h30-0-240" id="h30-0-240" class="d">-    }
</a><a href="#h30-0-241" id="h30-0-241" class="d">-}</a><a href="#h30-0-242" id="h30-0-242" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h31" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -31,7 +31,7 @@ import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a> import me.rhunk.snapenhance.features.impl.tweaks.CameraTweaks
 import me.rhunk.snapenhance.features.impl.ui.PinConversations
 import me.rhunk.snapenhance.features.impl.ui.UITweaks
<a href="#h31-0-3" id="h31-0-3" class="d">-import me.rhunk.snapenhance.features.impl.ui.menus.MenuViewInjector
</a><a href="#h31-0-4" id="h31-0-4" class="i">+import me.rhunk.snapenhance.ui.menu.impl.MenuViewInjector
</a> import me.rhunk.snapenhance.manager.Manager
 import java.util.concurrent.Executors
 import kotlin.reflect.KClass
<b>diff --git a/<a id="h32" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,186 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+package me.rhunk.snapenhance.ui.download
</a><a href="#h32-0-1" id="h32-0-1" class="i">+
</a><a href="#h32-0-2" id="h32-0-2" class="i">+import android.content.Intent
</a><a href="#h32-0-3" id="h32-0-3" class="i">+import android.graphics.Bitmap
</a><a href="#h32-0-4" id="h32-0-4" class="i">+import android.graphics.BitmapFactory
</a><a href="#h32-0-5" id="h32-0-5" class="i">+import android.net.Uri
</a><a href="#h32-0-6" id="h32-0-6" class="i">+import android.os.Handler
</a><a href="#h32-0-7" id="h32-0-7" class="i">+import android.view.LayoutInflater
</a><a href="#h32-0-8" id="h32-0-8" class="i">+import android.view.View
</a><a href="#h32-0-9" id="h32-0-9" class="i">+import android.view.ViewGroup
</a><a href="#h32-0-10" id="h32-0-10" class="i">+import android.widget.Button
</a><a href="#h32-0-11" id="h32-0-11" class="i">+import android.widget.ImageView
</a><a href="#h32-0-12" id="h32-0-12" class="i">+import android.widget.TextView
</a><a href="#h32-0-13" id="h32-0-13" class="i">+import android.widget.Toast
</a><a href="#h32-0-14" id="h32-0-14" class="i">+import androidx.core.graphics.drawable.RoundedBitmapDrawableFactory
</a><a href="#h32-0-15" id="h32-0-15" class="i">+import androidx.recyclerview.widget.RecyclerView
</a><a href="#h32-0-16" id="h32-0-16" class="i">+import androidx.recyclerview.widget.RecyclerView.Adapter
</a><a href="#h32-0-17" id="h32-0-17" class="i">+import kotlinx.coroutines.DelicateCoroutinesApi
</a><a href="#h32-0-18" id="h32-0-18" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h32-0-19" id="h32-0-19" class="i">+import kotlinx.coroutines.GlobalScope
</a><a href="#h32-0-20" id="h32-0-20" class="i">+import kotlinx.coroutines.Job
</a><a href="#h32-0-21" id="h32-0-21" class="i">+import kotlinx.coroutines.job
</a><a href="#h32-0-22" id="h32-0-22" class="i">+import kotlinx.coroutines.launch
</a><a href="#h32-0-23" id="h32-0-23" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h32-0-24" id="h32-0-24" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h32-0-25" id="h32-0-25" class="i">+import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h32-0-26" id="h32-0-26" class="i">+import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h32-0-27" id="h32-0-27" class="i">+import me.rhunk.snapenhance.util.snap.PreviewUtils
</a><a href="#h32-0-28" id="h32-0-28" class="i">+import java.io.File
</a><a href="#h32-0-29" id="h32-0-29" class="i">+import java.net.URL
</a><a href="#h32-0-30" id="h32-0-30" class="i">+import kotlin.concurrent.thread
</a><a href="#h32-0-31" id="h32-0-31" class="i">+
</a><a href="#h32-0-32" id="h32-0-32" class="i">+class DownloadListAdapter(
</a><a href="#h32-0-33" id="h32-0-33" class="i">+    private val downloadList: MutableList&lt;PendingDownload&gt;
</a><a href="#h32-0-34" id="h32-0-34" class="i">+): Adapter&lt;DownloadListAdapter.ViewHolder&gt;() {
</a><a href="#h32-0-35" id="h32-0-35" class="i">+    private val previewJobs = mutableMapOf&lt;Int, Job&gt;()
</a><a href="#h32-0-36" id="h32-0-36" class="i">+
</a><a href="#h32-0-37" id="h32-0-37" class="i">+    inner class ViewHolder(val view: View) : RecyclerView.ViewHolder(view) {
</a><a href="#h32-0-38" id="h32-0-38" class="i">+        val bitmojiIcon: ImageView = view.findViewById(R.id.bitmoji_icon)
</a><a href="#h32-0-39" id="h32-0-39" class="i">+        val title: TextView = view.findViewById(R.id.item_title)
</a><a href="#h32-0-40" id="h32-0-40" class="i">+        val subtitle: TextView = view.findViewById(R.id.item_subtitle)
</a><a href="#h32-0-41" id="h32-0-41" class="i">+        val status: TextView = view.findViewById(R.id.item_status)
</a><a href="#h32-0-42" id="h32-0-42" class="i">+        val actionButton: Button = view.findViewById(R.id.item_action_button)
</a><a href="#h32-0-43" id="h32-0-43" class="i">+        val radius by lazy {
</a><a href="#h32-0-44" id="h32-0-44" class="i">+            view.context.resources.getDimensionPixelSize(R.dimen.download_manager_item_preview_radius)
</a><a href="#h32-0-45" id="h32-0-45" class="i">+        }
</a><a href="#h32-0-46" id="h32-0-46" class="i">+        val viewWidth by lazy {
</a><a href="#h32-0-47" id="h32-0-47" class="i">+            view.resources.displayMetrics.widthPixels
</a><a href="#h32-0-48" id="h32-0-48" class="i">+        }
</a><a href="#h32-0-49" id="h32-0-49" class="i">+        val viewHeight by lazy {
</a><a href="#h32-0-50" id="h32-0-50" class="i">+            view.layoutParams.height
</a><a href="#h32-0-51" id="h32-0-51" class="i">+        }
</a><a href="#h32-0-52" id="h32-0-52" class="i">+    }
</a><a href="#h32-0-53" id="h32-0-53" class="i">+
</a><a href="#h32-0-54" id="h32-0-54" class="i">+    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
</a><a href="#h32-0-55" id="h32-0-55" class="i">+        return ViewHolder(LayoutInflater.from(parent.context).inflate(R.layout.download_manager_item, parent, false))
</a><a href="#h32-0-56" id="h32-0-56" class="i">+    }
</a><a href="#h32-0-57" id="h32-0-57" class="i">+
</a><a href="#h32-0-58" id="h32-0-58" class="i">+    override fun onViewRecycled(holder: ViewHolder) {
</a><a href="#h32-0-59" id="h32-0-59" class="i">+        val download = downloadList.getOrNull(holder.bindingAdapterPosition) ?: return
</a><a href="#h32-0-60" id="h32-0-60" class="i">+
</a><a href="#h32-0-61" id="h32-0-61" class="i">+        previewJobs[holder.hashCode()]?.let {
</a><a href="#h32-0-62" id="h32-0-62" class="i">+            it.cancel()
</a><a href="#h32-0-63" id="h32-0-63" class="i">+            previewJobs.remove(holder.hashCode())
</a><a href="#h32-0-64" id="h32-0-64" class="i">+        }
</a><a href="#h32-0-65" id="h32-0-65" class="i">+    }
</a><a href="#h32-0-66" id="h32-0-66" class="i">+
</a><a href="#h32-0-67" id="h32-0-67" class="i">+    override fun getItemCount(): Int {
</a><a href="#h32-0-68" id="h32-0-68" class="i">+        return downloadList.size
</a><a href="#h32-0-69" id="h32-0-69" class="i">+    }
</a><a href="#h32-0-70" id="h32-0-70" class="i">+
</a><a href="#h32-0-71" id="h32-0-71" class="i">+    @OptIn(DelicateCoroutinesApi::class)
</a><a href="#h32-0-72" id="h32-0-72" class="i">+    private fun handlePreview(download: PendingDownload, holder: ViewHolder) {
</a><a href="#h32-0-73" id="h32-0-73" class="i">+        download.outputFile?.let { File(it) }?.takeIf { it.exists() }?.let {
</a><a href="#h32-0-74" id="h32-0-74" class="i">+            GlobalScope.launch(Dispatchers.IO) {
</a><a href="#h32-0-75" id="h32-0-75" class="i">+                val previewBitmap = PreviewUtils.createPreviewFromFile(it, 1F)?.let { preview -&gt;
</a><a href="#h32-0-76" id="h32-0-76" class="i">+                    val offsetY = (preview.height / 2 - holder.viewHeight / 2).coerceAtLeast(0)
</a><a href="#h32-0-77" id="h32-0-77" class="i">+
</a><a href="#h32-0-78" id="h32-0-78" class="i">+                    Bitmap.createScaledBitmap(
</a><a href="#h32-0-79" id="h32-0-79" class="i">+                        Bitmap.createBitmap(preview, 0, offsetY,
</a><a href="#h32-0-80" id="h32-0-80" class="i">+                            preview.width.coerceAtMost(holder.viewWidth),
</a><a href="#h32-0-81" id="h32-0-81" class="i">+                            preview.height.coerceAtMost(holder.viewHeight)
</a><a href="#h32-0-82" id="h32-0-82" class="i">+                        ),
</a><a href="#h32-0-83" id="h32-0-83" class="i">+                        holder.viewWidth,
</a><a href="#h32-0-84" id="h32-0-84" class="i">+                        holder.viewHeight,
</a><a href="#h32-0-85" id="h32-0-85" class="i">+                        false
</a><a href="#h32-0-86" id="h32-0-86" class="i">+                    )
</a><a href="#h32-0-87" id="h32-0-87" class="i">+                }?: return@launch
</a><a href="#h32-0-88" id="h32-0-88" class="i">+
</a><a href="#h32-0-89" id="h32-0-89" class="i">+                if (coroutineContext.job.isCancelled) return@launch
</a><a href="#h32-0-90" id="h32-0-90" class="i">+                Handler(holder.view.context.mainLooper).post {
</a><a href="#h32-0-91" id="h32-0-91" class="i">+                    holder.view.background = RoundedBitmapDrawableFactory.create(holder.view.context.resources, previewBitmap).also {
</a><a href="#h32-0-92" id="h32-0-92" class="i">+                        it.cornerRadius = holder.radius.toFloat()
</a><a href="#h32-0-93" id="h32-0-93" class="i">+                    }
</a><a href="#h32-0-94" id="h32-0-94" class="i">+                }
</a><a href="#h32-0-95" id="h32-0-95" class="i">+            }.also { job -&gt;
</a><a href="#h32-0-96" id="h32-0-96" class="i">+                previewJobs[holder.hashCode()] = job
</a><a href="#h32-0-97" id="h32-0-97" class="i">+            }
</a><a href="#h32-0-98" id="h32-0-98" class="i">+        }
</a><a href="#h32-0-99" id="h32-0-99" class="i">+    }
</a><a href="#h32-0-100" id="h32-0-100" class="i">+
</a><a href="#h32-0-101" id="h32-0-101" class="i">+    private fun updateViewHolder(download: PendingDownload, holder: ViewHolder) {
</a><a href="#h32-0-102" id="h32-0-102" class="i">+        holder.status.text = download.downloadStage.toString()
</a><a href="#h32-0-103" id="h32-0-103" class="i">+        holder.view.background = holder.view.context.getDrawable(R.drawable.download_manager_item_background)
</a><a href="#h32-0-104" id="h32-0-104" class="i">+
</a><a href="#h32-0-105" id="h32-0-105" class="i">+        handlePreview(download, holder)
</a><a href="#h32-0-106" id="h32-0-106" class="i">+
</a><a href="#h32-0-107" id="h32-0-107" class="i">+        val isSaved = download.downloadStage == DownloadStage.SAVED
</a><a href="#h32-0-108" id="h32-0-108" class="i">+        //if the download is in progress, the user can cancel it
</a><a href="#h32-0-109" id="h32-0-109" class="i">+        val canInteract = if (download.job != null) !download.downloadStage.isFinalStage || isSaved
</a><a href="#h32-0-110" id="h32-0-110" class="i">+        else isSaved
</a><a href="#h32-0-111" id="h32-0-111" class="i">+
</a><a href="#h32-0-112" id="h32-0-112" class="i">+        holder.status.visibility = if (isSaved) View.GONE else View.VISIBLE
</a><a href="#h32-0-113" id="h32-0-113" class="i">+
</a><a href="#h32-0-114" id="h32-0-114" class="i">+        with(holder.actionButton) {
</a><a href="#h32-0-115" id="h32-0-115" class="i">+            isEnabled = canInteract
</a><a href="#h32-0-116" id="h32-0-116" class="i">+            alpha = if (canInteract) 1f else 0.5f
</a><a href="#h32-0-117" id="h32-0-117" class="i">+            background = context.getDrawable(if (isSaved) R.drawable.action_button_success else R.drawable.action_button_cancel)
</a><a href="#h32-0-118" id="h32-0-118" class="i">+            setTextColor(context.getColor(if (isSaved) R.color.successColor else R.color.actionBarColor))
</a><a href="#h32-0-119" id="h32-0-119" class="i">+            text = if (isSaved) &quot;Open&quot; else &quot;Cancel&quot;
</a><a href="#h32-0-120" id="h32-0-120" class="i">+        }
</a><a href="#h32-0-121" id="h32-0-121" class="i">+    }
</a><a href="#h32-0-122" id="h32-0-122" class="i">+
</a><a href="#h32-0-123" id="h32-0-123" class="i">+    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
</a><a href="#h32-0-124" id="h32-0-124" class="i">+        val pendingDownload = downloadList[position]
</a><a href="#h32-0-125" id="h32-0-125" class="i">+
</a><a href="#h32-0-126" id="h32-0-126" class="i">+        pendingDownload.changeListener = { _, _ -&gt;
</a><a href="#h32-0-127" id="h32-0-127" class="i">+            Handler(holder.view.context.mainLooper).post {
</a><a href="#h32-0-128" id="h32-0-128" class="i">+                updateViewHolder(pendingDownload, holder)
</a><a href="#h32-0-129" id="h32-0-129" class="i">+                notifyItemChanged(position)
</a><a href="#h32-0-130" id="h32-0-130" class="i">+            }
</a><a href="#h32-0-131" id="h32-0-131" class="i">+        }
</a><a href="#h32-0-132" id="h32-0-132" class="i">+
</a><a href="#h32-0-133" id="h32-0-133" class="i">+        holder.bitmojiIcon.visibility = View.GONE
</a><a href="#h32-0-134" id="h32-0-134" class="i">+
</a><a href="#h32-0-135" id="h32-0-135" class="i">+        pendingDownload.iconUrl?.let { url -&gt;
</a><a href="#h32-0-136" id="h32-0-136" class="i">+            thread(start = true) {
</a><a href="#h32-0-137" id="h32-0-137" class="i">+                runCatching {
</a><a href="#h32-0-138" id="h32-0-138" class="i">+                    val iconBitmap = URL(url).openStream().use {
</a><a href="#h32-0-139" id="h32-0-139" class="i">+                        BitmapFactory.decodeStream(it)
</a><a href="#h32-0-140" id="h32-0-140" class="i">+                    }
</a><a href="#h32-0-141" id="h32-0-141" class="i">+                    Handler(holder.view.context.mainLooper).post {
</a><a href="#h32-0-142" id="h32-0-142" class="i">+                        holder.bitmojiIcon.setImageBitmap(iconBitmap)
</a><a href="#h32-0-143" id="h32-0-143" class="i">+                        holder.bitmojiIcon.visibility = View.VISIBLE
</a><a href="#h32-0-144" id="h32-0-144" class="i">+                    }
</a><a href="#h32-0-145" id="h32-0-145" class="i">+                }
</a><a href="#h32-0-146" id="h32-0-146" class="i">+            }
</a><a href="#h32-0-147" id="h32-0-147" class="i">+        }
</a><a href="#h32-0-148" id="h32-0-148" class="i">+
</a><a href="#h32-0-149" id="h32-0-149" class="i">+        holder.title.visibility = View.GONE
</a><a href="#h32-0-150" id="h32-0-150" class="i">+        holder.subtitle.visibility = View.GONE
</a><a href="#h32-0-151" id="h32-0-151" class="i">+
</a><a href="#h32-0-152" id="h32-0-152" class="i">+        pendingDownload.mediaDisplayType?.let {
</a><a href="#h32-0-153" id="h32-0-153" class="i">+            holder.title.text = it
</a><a href="#h32-0-154" id="h32-0-154" class="i">+            holder.title.visibility = View.VISIBLE
</a><a href="#h32-0-155" id="h32-0-155" class="i">+        }
</a><a href="#h32-0-156" id="h32-0-156" class="i">+
</a><a href="#h32-0-157" id="h32-0-157" class="i">+        pendingDownload.mediaDisplaySource?.let {
</a><a href="#h32-0-158" id="h32-0-158" class="i">+            holder.subtitle.text = it
</a><a href="#h32-0-159" id="h32-0-159" class="i">+            holder.subtitle.visibility = View.VISIBLE
</a><a href="#h32-0-160" id="h32-0-160" class="i">+        }
</a><a href="#h32-0-161" id="h32-0-161" class="i">+
</a><a href="#h32-0-162" id="h32-0-162" class="i">+        holder.actionButton.setOnClickListener {
</a><a href="#h32-0-163" id="h32-0-163" class="i">+            if (pendingDownload.downloadStage != DownloadStage.SAVED) {
</a><a href="#h32-0-164" id="h32-0-164" class="i">+                pendingDownload.cancel()
</a><a href="#h32-0-165" id="h32-0-165" class="i">+                pendingDownload.downloadStage = DownloadStage.CANCELLED
</a><a href="#h32-0-166" id="h32-0-166" class="i">+                updateViewHolder(pendingDownload, holder)
</a><a href="#h32-0-167" id="h32-0-167" class="i">+                notifyItemChanged(position);
</a><a href="#h32-0-168" id="h32-0-168" class="i">+                return@setOnClickListener
</a><a href="#h32-0-169" id="h32-0-169" class="i">+            }
</a><a href="#h32-0-170" id="h32-0-170" class="i">+
</a><a href="#h32-0-171" id="h32-0-171" class="i">+            pendingDownload.outputFile?.let {
</a><a href="#h32-0-172" id="h32-0-172" class="i">+                val file = File(it)
</a><a href="#h32-0-173" id="h32-0-173" class="i">+                if (!file.exists()) {
</a><a href="#h32-0-174" id="h32-0-174" class="i">+                    Toast.makeText(holder.view.context, &quot;File does not exist&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h32-0-175" id="h32-0-175" class="i">+                    return@setOnClickListener
</a><a href="#h32-0-176" id="h32-0-176" class="i">+                }
</a><a href="#h32-0-177" id="h32-0-177" class="i">+                val intent = Intent(Intent.ACTION_VIEW)
</a><a href="#h32-0-178" id="h32-0-178" class="i">+                intent.setDataAndType(Uri.parse(it), FileType.fromFile(File(it)).mimeType)
</a><a href="#h32-0-179" id="h32-0-179" class="i">+                holder.view.context.startActivity(intent)
</a><a href="#h32-0-180" id="h32-0-180" class="i">+            }
</a><a href="#h32-0-181" id="h32-0-181" class="i">+        }
</a><a href="#h32-0-182" id="h32-0-182" class="i">+
</a><a href="#h32-0-183" id="h32-0-183" class="i">+        updateViewHolder(pendingDownload, holder)
</a><a href="#h32-0-184" id="h32-0-184" class="i">+    }
</a><a href="#h32-0-185" id="h32-0-185" class="i">+}</a><a href="#h32-0-186" id="h32-0-186" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h33" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,156 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+package me.rhunk.snapenhance.ui.download
</a><a href="#h33-0-1" id="h33-0-1" class="i">+
</a><a href="#h33-0-2" id="h33-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h33-0-3" id="h33-0-3" class="i">+import android.app.Activity
</a><a href="#h33-0-4" id="h33-0-4" class="i">+import android.content.Context
</a><a href="#h33-0-5" id="h33-0-5" class="i">+import android.content.Intent
</a><a href="#h33-0-6" id="h33-0-6" class="i">+import android.graphics.drawable.ColorDrawable
</a><a href="#h33-0-7" id="h33-0-7" class="i">+import android.net.Uri
</a><a href="#h33-0-8" id="h33-0-8" class="i">+import android.os.Bundle
</a><a href="#h33-0-9" id="h33-0-9" class="i">+import android.os.PowerManager
</a><a href="#h33-0-10" id="h33-0-10" class="i">+import android.provider.Settings
</a><a href="#h33-0-11" id="h33-0-11" class="i">+import android.view.View
</a><a href="#h33-0-12" id="h33-0-12" class="i">+import android.widget.Button
</a><a href="#h33-0-13" id="h33-0-13" class="i">+import androidx.recyclerview.widget.ItemTouchHelper
</a><a href="#h33-0-14" id="h33-0-14" class="i">+import androidx.recyclerview.widget.RecyclerView
</a><a href="#h33-0-15" id="h33-0-15" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h33-0-16" id="h33-0-16" class="i">+import me.rhunk.snapenhance.download.MediaDownloadReceiver
</a><a href="#h33-0-17" id="h33-0-17" class="i">+import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h33-0-18" id="h33-0-18" class="i">+
</a><a href="#h33-0-19" id="h33-0-19" class="i">+class DownloadManagerActivity : Activity() {
</a><a href="#h33-0-20" id="h33-0-20" class="i">+    private val fetchedDownloadTasks = mutableListOf&lt;PendingDownload&gt;()
</a><a href="#h33-0-21" id="h33-0-21" class="i">+
</a><a href="#h33-0-22" id="h33-0-22" class="i">+    private val preferences by lazy {
</a><a href="#h33-0-23" id="h33-0-23" class="i">+        getSharedPreferences(&quot;settings&quot;, Context.MODE_PRIVATE)
</a><a href="#h33-0-24" id="h33-0-24" class="i">+    }
</a><a href="#h33-0-25" id="h33-0-25" class="i">+
</a><a href="#h33-0-26" id="h33-0-26" class="i">+    private fun updateNoDownloadText() {
</a><a href="#h33-0-27" id="h33-0-27" class="i">+        findViewById&lt;View&gt;(R.id.no_download_title).let {
</a><a href="#h33-0-28" id="h33-0-28" class="i">+            it.visibility = if (fetchedDownloadTasks.isEmpty()) View.VISIBLE else View.GONE
</a><a href="#h33-0-29" id="h33-0-29" class="i">+        }
</a><a href="#h33-0-30" id="h33-0-30" class="i">+    }
</a><a href="#h33-0-31" id="h33-0-31" class="i">+
</a><a href="#h33-0-32" id="h33-0-32" class="i">+    @SuppressLint(&quot;BatteryLife&quot;, &quot;NotifyDataSetChanged&quot;)
</a><a href="#h33-0-33" id="h33-0-33" class="i">+    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h33-0-34" id="h33-0-34" class="i">+        super.onCreate(savedInstanceState)
</a><a href="#h33-0-35" id="h33-0-35" class="i">+        val downloadTaskManager = MediaDownloadReceiver.downloadTaskManager.also { it.init(this) }
</a><a href="#h33-0-36" id="h33-0-36" class="i">+
</a><a href="#h33-0-37" id="h33-0-37" class="i">+        actionBar?.apply {
</a><a href="#h33-0-38" id="h33-0-38" class="i">+            title = &quot;Download Manager&quot;
</a><a href="#h33-0-39" id="h33-0-39" class="i">+            setBackgroundDrawable(ColorDrawable(getColor(R.color.actionBarColor)))
</a><a href="#h33-0-40" id="h33-0-40" class="i">+        }
</a><a href="#h33-0-41" id="h33-0-41" class="i">+        setContentView(R.layout.download_manager_activity)
</a><a href="#h33-0-42" id="h33-0-42" class="i">+
</a><a href="#h33-0-43" id="h33-0-43" class="i">+        fetchedDownloadTasks.addAll(downloadTaskManager.queryAllTasks().values)
</a><a href="#h33-0-44" id="h33-0-44" class="i">+
</a><a href="#h33-0-45" id="h33-0-45" class="i">+
</a><a href="#h33-0-46" id="h33-0-46" class="i">+        with(findViewById&lt;RecyclerView&gt;(R.id.download_list)) {
</a><a href="#h33-0-47" id="h33-0-47" class="i">+            adapter = DownloadListAdapter(fetchedDownloadTasks).apply {
</a><a href="#h33-0-48" id="h33-0-48" class="i">+                registerAdapterDataObserver(object : RecyclerView.AdapterDataObserver() {
</a><a href="#h33-0-49" id="h33-0-49" class="i">+                    override fun onItemRangeRemoved(positionStart: Int, itemCount: Int) {
</a><a href="#h33-0-50" id="h33-0-50" class="i">+                        updateNoDownloadText()
</a><a href="#h33-0-51" id="h33-0-51" class="i">+                    }
</a><a href="#h33-0-52" id="h33-0-52" class="i">+                })
</a><a href="#h33-0-53" id="h33-0-53" class="i">+            }
</a><a href="#h33-0-54" id="h33-0-54" class="i">+
</a><a href="#h33-0-55" id="h33-0-55" class="i">+            layoutManager = androidx.recyclerview.widget.LinearLayoutManager(this@DownloadManagerActivity)
</a><a href="#h33-0-56" id="h33-0-56" class="i">+
</a><a href="#h33-0-57" id="h33-0-57" class="i">+            ItemTouchHelper(object : ItemTouchHelper.SimpleCallback(0, ItemTouchHelper.LEFT or ItemTouchHelper.RIGHT) {
</a><a href="#h33-0-58" id="h33-0-58" class="i">+                override fun getMovementFlags(
</a><a href="#h33-0-59" id="h33-0-59" class="i">+                    recyclerView: RecyclerView,
</a><a href="#h33-0-60" id="h33-0-60" class="i">+                    viewHolder: RecyclerView.ViewHolder
</a><a href="#h33-0-61" id="h33-0-61" class="i">+                ): Int {
</a><a href="#h33-0-62" id="h33-0-62" class="i">+                    val download = fetchedDownloadTasks[viewHolder.absoluteAdapterPosition]
</a><a href="#h33-0-63" id="h33-0-63" class="i">+                    return if (download.isJobActive()) {
</a><a href="#h33-0-64" id="h33-0-64" class="i">+                        0
</a><a href="#h33-0-65" id="h33-0-65" class="i">+                    } else {
</a><a href="#h33-0-66" id="h33-0-66" class="i">+                        super.getMovementFlags(recyclerView, viewHolder)
</a><a href="#h33-0-67" id="h33-0-67" class="i">+                    }
</a><a href="#h33-0-68" id="h33-0-68" class="i">+                }
</a><a href="#h33-0-69" id="h33-0-69" class="i">+
</a><a href="#h33-0-70" id="h33-0-70" class="i">+                override fun onMove(
</a><a href="#h33-0-71" id="h33-0-71" class="i">+                    recyclerView: RecyclerView,
</a><a href="#h33-0-72" id="h33-0-72" class="i">+                    viewHolder: RecyclerView.ViewHolder,
</a><a href="#h33-0-73" id="h33-0-73" class="i">+                    target: RecyclerView.ViewHolder
</a><a href="#h33-0-74" id="h33-0-74" class="i">+                ): Boolean {
</a><a href="#h33-0-75" id="h33-0-75" class="i">+                    return false
</a><a href="#h33-0-76" id="h33-0-76" class="i">+                }
</a><a href="#h33-0-77" id="h33-0-77" class="i">+
</a><a href="#h33-0-78" id="h33-0-78" class="i">+                @SuppressLint(&quot;NotifyDataSetChanged&quot;)
</a><a href="#h33-0-79" id="h33-0-79" class="i">+                override fun onSwiped(viewHolder: RecyclerView.ViewHolder, direction: Int) {
</a><a href="#h33-0-80" id="h33-0-80" class="i">+                    fetchedDownloadTasks.removeAt(viewHolder.absoluteAdapterPosition).let {
</a><a href="#h33-0-81" id="h33-0-81" class="i">+                        downloadTaskManager.removeTask(it)
</a><a href="#h33-0-82" id="h33-0-82" class="i">+                    }
</a><a href="#h33-0-83" id="h33-0-83" class="i">+                    adapter?.notifyItemRemoved(viewHolder.absoluteAdapterPosition)
</a><a href="#h33-0-84" id="h33-0-84" class="i">+                }
</a><a href="#h33-0-85" id="h33-0-85" class="i">+            }).attachToRecyclerView(this)
</a><a href="#h33-0-86" id="h33-0-86" class="i">+
</a><a href="#h33-0-87" id="h33-0-87" class="i">+            var isLoading = false
</a><a href="#h33-0-88" id="h33-0-88" class="i">+
</a><a href="#h33-0-89" id="h33-0-89" class="i">+            addOnScrollListener(object : RecyclerView.OnScrollListener() {
</a><a href="#h33-0-90" id="h33-0-90" class="i">+                override fun onScrollStateChanged(recyclerView: RecyclerView, newState: Int) {
</a><a href="#h33-0-91" id="h33-0-91" class="i">+                    val layoutManager = recyclerView.layoutManager as androidx.recyclerview.widget.LinearLayoutManager
</a><a href="#h33-0-92" id="h33-0-92" class="i">+                    val lastVisibleItemPosition = layoutManager.findLastVisibleItemPosition()
</a><a href="#h33-0-93" id="h33-0-93" class="i">+
</a><a href="#h33-0-94" id="h33-0-94" class="i">+                    if (lastVisibleItemPosition == RecyclerView.NO_POSITION) {
</a><a href="#h33-0-95" id="h33-0-95" class="i">+                        return
</a><a href="#h33-0-96" id="h33-0-96" class="i">+                    }
</a><a href="#h33-0-97" id="h33-0-97" class="i">+
</a><a href="#h33-0-98" id="h33-0-98" class="i">+                    if (lastVisibleItemPosition == fetchedDownloadTasks.size - 1 &amp;&amp; !isLoading) {
</a><a href="#h33-0-99" id="h33-0-99" class="i">+                        isLoading = true
</a><a href="#h33-0-100" id="h33-0-100" class="i">+
</a><a href="#h33-0-101" id="h33-0-101" class="i">+                        downloadTaskManager.queryTasks(fetchedDownloadTasks.last().id).forEach {
</a><a href="#h33-0-102" id="h33-0-102" class="i">+                            fetchedDownloadTasks.add(it.value)
</a><a href="#h33-0-103" id="h33-0-103" class="i">+                            adapter?.notifyItemInserted(fetchedDownloadTasks.size - 1)
</a><a href="#h33-0-104" id="h33-0-104" class="i">+                        }
</a><a href="#h33-0-105" id="h33-0-105" class="i">+
</a><a href="#h33-0-106" id="h33-0-106" class="i">+                        isLoading = false
</a><a href="#h33-0-107" id="h33-0-107" class="i">+                    }
</a><a href="#h33-0-108" id="h33-0-108" class="i">+                }
</a><a href="#h33-0-109" id="h33-0-109" class="i">+            })
</a><a href="#h33-0-110" id="h33-0-110" class="i">+
</a><a href="#h33-0-111" id="h33-0-111" class="i">+            with(this@DownloadManagerActivity.findViewById&lt;Button&gt;(R.id.remove_all_button)) {
</a><a href="#h33-0-112" id="h33-0-112" class="i">+                setOnClickListener {
</a><a href="#h33-0-113" id="h33-0-113" class="i">+                    downloadTaskManager.removeAllTasks()
</a><a href="#h33-0-114" id="h33-0-114" class="i">+                    fetchedDownloadTasks.removeIf {
</a><a href="#h33-0-115" id="h33-0-115" class="i">+                        if (it.isJobActive()) it.cancel()
</a><a href="#h33-0-116" id="h33-0-116" class="i">+                        true
</a><a href="#h33-0-117" id="h33-0-117" class="i">+                    }
</a><a href="#h33-0-118" id="h33-0-118" class="i">+                    adapter?.notifyDataSetChanged()
</a><a href="#h33-0-119" id="h33-0-119" class="i">+                    updateNoDownloadText()
</a><a href="#h33-0-120" id="h33-0-120" class="i">+                }
</a><a href="#h33-0-121" id="h33-0-121" class="i">+            }
</a><a href="#h33-0-122" id="h33-0-122" class="i">+        }
</a><a href="#h33-0-123" id="h33-0-123" class="i">+
</a><a href="#h33-0-124" id="h33-0-124" class="i">+        updateNoDownloadText()
</a><a href="#h33-0-125" id="h33-0-125" class="i">+
</a><a href="#h33-0-126" id="h33-0-126" class="i">+        if (preferences.getBoolean(&quot;ask_battery_optimisations&quot;, true)) {
</a><a href="#h33-0-127" id="h33-0-127" class="i">+            val pm = getSystemService(Context.POWER_SERVICE) as PowerManager
</a><a href="#h33-0-128" id="h33-0-128" class="i">+            if (!pm.isIgnoringBatteryOptimizations(packageName)) {
</a><a href="#h33-0-129" id="h33-0-129" class="i">+                with(Intent()) {
</a><a href="#h33-0-130" id="h33-0-130" class="i">+                    action = Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS
</a><a href="#h33-0-131" id="h33-0-131" class="i">+                    data = Uri.parse(&quot;package:$packageName&quot;)
</a><a href="#h33-0-132" id="h33-0-132" class="i">+                    startActivityForResult(this, 1)
</a><a href="#h33-0-133" id="h33-0-133" class="i">+                }
</a><a href="#h33-0-134" id="h33-0-134" class="i">+            }
</a><a href="#h33-0-135" id="h33-0-135" class="i">+        }
</a><a href="#h33-0-136" id="h33-0-136" class="i">+    }
</a><a href="#h33-0-137" id="h33-0-137" class="i">+
</a><a href="#h33-0-138" id="h33-0-138" class="i">+    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
</a><a href="#h33-0-139" id="h33-0-139" class="i">+        if (requestCode == 1) {
</a><a href="#h33-0-140" id="h33-0-140" class="i">+            preferences.edit().putBoolean(&quot;ask_battery_optimisations&quot;, false).apply()
</a><a href="#h33-0-141" id="h33-0-141" class="i">+        }
</a><a href="#h33-0-142" id="h33-0-142" class="i">+    }
</a><a href="#h33-0-143" id="h33-0-143" class="i">+
</a><a href="#h33-0-144" id="h33-0-144" class="i">+    @SuppressLint(&quot;NotifyDataSetChanged&quot;)
</a><a href="#h33-0-145" id="h33-0-145" class="i">+    override fun onResume() {
</a><a href="#h33-0-146" id="h33-0-146" class="i">+        super.onResume()
</a><a href="#h33-0-147" id="h33-0-147" class="i">+        fetchedDownloadTasks.clear()
</a><a href="#h33-0-148" id="h33-0-148" class="i">+        fetchedDownloadTasks.addAll(MediaDownloadReceiver.downloadTaskManager.queryAllTasks().values)
</a><a href="#h33-0-149" id="h33-0-149" class="i">+
</a><a href="#h33-0-150" id="h33-0-150" class="i">+        with(findViewById&lt;RecyclerView&gt;(R.id.download_list)) {
</a><a href="#h33-0-151" id="h33-0-151" class="i">+            adapter?.notifyDataSetChanged()
</a><a href="#h33-0-152" id="h33-0-152" class="i">+        }
</a><a href="#h33-0-153" id="h33-0-153" class="i">+        updateNoDownloadText()
</a><a href="#h33-0-154" id="h33-0-154" class="i">+    }
</a><a href="#h33-0-155" id="h33-0-155" class="i">+}</a><a href="#h33-0-156" id="h33-0-156" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h34" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,98 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+package me.rhunk.snapenhance.ui.map
</a><a href="#h34-0-1" id="h34-0-1" class="i">+
</a><a href="#h34-0-2" id="h34-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h34-0-3" id="h34-0-3" class="i">+import android.app.Activity
</a><a href="#h34-0-4" id="h34-0-4" class="i">+import android.app.AlertDialog
</a><a href="#h34-0-5" id="h34-0-5" class="i">+import android.content.Context
</a><a href="#h34-0-6" id="h34-0-6" class="i">+import android.os.Bundle
</a><a href="#h34-0-7" id="h34-0-7" class="i">+import android.view.MotionEvent
</a><a href="#h34-0-8" id="h34-0-8" class="i">+import android.widget.Button
</a><a href="#h34-0-9" id="h34-0-9" class="i">+import android.widget.EditText
</a><a href="#h34-0-10" id="h34-0-10" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h34-0-11" id="h34-0-11" class="i">+import org.osmdroid.config.Configuration
</a><a href="#h34-0-12" id="h34-0-12" class="i">+import org.osmdroid.tileprovider.tilesource.TileSourceFactory
</a><a href="#h34-0-13" id="h34-0-13" class="i">+import org.osmdroid.util.GeoPoint
</a><a href="#h34-0-14" id="h34-0-14" class="i">+import org.osmdroid.views.MapView
</a><a href="#h34-0-15" id="h34-0-15" class="i">+import org.osmdroid.views.Projection
</a><a href="#h34-0-16" id="h34-0-16" class="i">+import org.osmdroid.views.overlay.Marker
</a><a href="#h34-0-17" id="h34-0-17" class="i">+import org.osmdroid.views.overlay.Overlay
</a><a href="#h34-0-18" id="h34-0-18" class="i">+
</a><a href="#h34-0-19" id="h34-0-19" class="i">+
</a><a href="#h34-0-20" id="h34-0-20" class="i">+class MapActivity : Activity() {
</a><a href="#h34-0-21" id="h34-0-21" class="i">+
</a><a href="#h34-0-22" id="h34-0-22" class="i">+    private lateinit var mapView: MapView
</a><a href="#h34-0-23" id="h34-0-23" class="i">+
</a><a href="#h34-0-24" id="h34-0-24" class="i">+    @SuppressLint(&quot;MissingInflatedId&quot;, &quot;ResourceType&quot;)
</a><a href="#h34-0-25" id="h34-0-25" class="i">+    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h34-0-26" id="h34-0-26" class="i">+        super.onCreate(savedInstanceState)
</a><a href="#h34-0-27" id="h34-0-27" class="i">+
</a><a href="#h34-0-28" id="h34-0-28" class="i">+        val contextBundle = intent.extras?.getBundle(&quot;location&quot;) ?: return
</a><a href="#h34-0-29" id="h34-0-29" class="i">+        val locationLatitude = contextBundle.getDouble(&quot;latitude&quot;)
</a><a href="#h34-0-30" id="h34-0-30" class="i">+        val locationLongitude = contextBundle.getDouble(&quot;longitude&quot;)
</a><a href="#h34-0-31" id="h34-0-31" class="i">+
</a><a href="#h34-0-32" id="h34-0-32" class="i">+        Configuration.getInstance().load(applicationContext, getSharedPreferences(&quot;osmdroid&quot;, Context.MODE_PRIVATE))
</a><a href="#h34-0-33" id="h34-0-33" class="i">+
</a><a href="#h34-0-34" id="h34-0-34" class="i">+        setContentView(R.layout.map)
</a><a href="#h34-0-35" id="h34-0-35" class="i">+
</a><a href="#h34-0-36" id="h34-0-36" class="i">+        mapView = findViewById(R.id.mapView)
</a><a href="#h34-0-37" id="h34-0-37" class="i">+        mapView.setMultiTouchControls(true);
</a><a href="#h34-0-38" id="h34-0-38" class="i">+        mapView.setTileSource(TileSourceFactory.MAPNIK)
</a><a href="#h34-0-39" id="h34-0-39" class="i">+
</a><a href="#h34-0-40" id="h34-0-40" class="i">+        val startPoint = GeoPoint(locationLatitude, locationLongitude)
</a><a href="#h34-0-41" id="h34-0-41" class="i">+        mapView.controller.setZoom(10.0)
</a><a href="#h34-0-42" id="h34-0-42" class="i">+        mapView.controller.setCenter(startPoint)
</a><a href="#h34-0-43" id="h34-0-43" class="i">+
</a><a href="#h34-0-44" id="h34-0-44" class="i">+        val marker = Marker(mapView)
</a><a href="#h34-0-45" id="h34-0-45" class="i">+        marker.isDraggable = true
</a><a href="#h34-0-46" id="h34-0-46" class="i">+        marker.position = startPoint
</a><a href="#h34-0-47" id="h34-0-47" class="i">+        marker.setAnchor(Marker.ANCHOR_CENTER, Marker.ANCHOR_BOTTOM)
</a><a href="#h34-0-48" id="h34-0-48" class="i">+
</a><a href="#h34-0-49" id="h34-0-49" class="i">+        mapView.overlays.add(object: Overlay() {
</a><a href="#h34-0-50" id="h34-0-50" class="i">+            override fun onSingleTapConfirmed(e: MotionEvent?, mapView: MapView?): Boolean {
</a><a href="#h34-0-51" id="h34-0-51" class="i">+                val proj: Projection = mapView!!.projection
</a><a href="#h34-0-52" id="h34-0-52" class="i">+                val loc = proj.fromPixels(e!!.x.toInt(), e.y.toInt()) as GeoPoint
</a><a href="#h34-0-53" id="h34-0-53" class="i">+                marker.position = loc
</a><a href="#h34-0-54" id="h34-0-54" class="i">+                mapView.invalidate()
</a><a href="#h34-0-55" id="h34-0-55" class="i">+                return true
</a><a href="#h34-0-56" id="h34-0-56" class="i">+            }
</a><a href="#h34-0-57" id="h34-0-57" class="i">+        })
</a><a href="#h34-0-58" id="h34-0-58" class="i">+
</a><a href="#h34-0-59" id="h34-0-59" class="i">+        mapView.overlays.add(marker)
</a><a href="#h34-0-60" id="h34-0-60" class="i">+
</a><a href="#h34-0-61" id="h34-0-61" class="i">+        val applyButton = findViewById&lt;Button&gt;(R.id.apply_location_button)
</a><a href="#h34-0-62" id="h34-0-62" class="i">+        applyButton.setOnClickListener {
</a><a href="#h34-0-63" id="h34-0-63" class="i">+            val bundle = Bundle()
</a><a href="#h34-0-64" id="h34-0-64" class="i">+            bundle.putFloat(&quot;latitude&quot;, marker.position.latitude.toFloat())
</a><a href="#h34-0-65" id="h34-0-65" class="i">+            bundle.putFloat(&quot;longitude&quot;, marker.position.longitude.toFloat())
</a><a href="#h34-0-66" id="h34-0-66" class="i">+            setResult(RESULT_OK, intent.putExtra(&quot;location&quot;, bundle))
</a><a href="#h34-0-67" id="h34-0-67" class="i">+            finish()
</a><a href="#h34-0-68" id="h34-0-68" class="i">+        }
</a><a href="#h34-0-69" id="h34-0-69" class="i">+
</a><a href="#h34-0-70" id="h34-0-70" class="i">+        val setPreciseLocationButton = findViewById&lt;Button&gt;(R.id.set_precise_location_button)
</a><a href="#h34-0-71" id="h34-0-71" class="i">+
</a><a href="#h34-0-72" id="h34-0-72" class="i">+        setPreciseLocationButton.setOnClickListener {
</a><a href="#h34-0-73" id="h34-0-73" class="i">+            val locationDialog = layoutInflater.inflate(R.layout.precise_location_dialog, null)
</a><a href="#h34-0-74" id="h34-0-74" class="i">+            val dialogLatitude = locationDialog.findViewById&lt;EditText&gt;(R.id.dialog_latitude).also { it.setText(marker.position.latitude.toString()) }
</a><a href="#h34-0-75" id="h34-0-75" class="i">+            val dialogLongitude = locationDialog.findViewById&lt;EditText&gt;(R.id.dialog_longitude).also { it.setText(marker.position.longitude.toString()) }
</a><a href="#h34-0-76" id="h34-0-76" class="i">+
</a><a href="#h34-0-77" id="h34-0-77" class="i">+            AlertDialog.Builder(this)
</a><a href="#h34-0-78" id="h34-0-78" class="i">+                .setView(locationDialog)
</a><a href="#h34-0-79" id="h34-0-79" class="i">+                .setTitle(&quot;Set a precise location&quot;)
</a><a href="#h34-0-80" id="h34-0-80" class="i">+                .setPositiveButton(&quot;Set&quot;) { _, _ -&gt;
</a><a href="#h34-0-81" id="h34-0-81" class="i">+                    val latitude = dialogLatitude.text.toString().toDoubleOrNull()
</a><a href="#h34-0-82" id="h34-0-82" class="i">+                    val longitude = dialogLongitude.text.toString().toDoubleOrNull()
</a><a href="#h34-0-83" id="h34-0-83" class="i">+                    if (latitude != null &amp;&amp; longitude != null) {
</a><a href="#h34-0-84" id="h34-0-84" class="i">+                        val preciseLocation = GeoPoint(latitude, longitude)
</a><a href="#h34-0-85" id="h34-0-85" class="i">+                        mapView.controller.setCenter(preciseLocation)
</a><a href="#h34-0-86" id="h34-0-86" class="i">+                        marker.position = preciseLocation
</a><a href="#h34-0-87" id="h34-0-87" class="i">+                        mapView.invalidate()
</a><a href="#h34-0-88" id="h34-0-88" class="i">+                    }
</a><a href="#h34-0-89" id="h34-0-89" class="i">+                }.setNegativeButton(&quot;Cancel&quot;) { _, _ -&gt; }.show()
</a><a href="#h34-0-90" id="h34-0-90" class="i">+        }
</a><a href="#h34-0-91" id="h34-0-91" class="i">+    }
</a><a href="#h34-0-92" id="h34-0-92" class="i">+
</a><a href="#h34-0-93" id="h34-0-93" class="i">+    override fun onDestroy() {
</a><a href="#h34-0-94" id="h34-0-94" class="i">+        super.onDestroy()
</a><a href="#h34-0-95" id="h34-0-95" class="i">+        mapView.onDetach()
</a><a href="#h34-0-96" id="h34-0-96" class="i">+    }
</a><a href="#h34-0-97" id="h34-0-97" class="i">+}
</a><b>diff --git a/<a id="h35" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+package me.rhunk.snapenhance.ui.menu
</a><a href="#h35-0-1" id="h35-0-1" class="i">+
</a><a href="#h35-0-2" id="h35-0-2" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h35-0-3" id="h35-0-3" class="i">+
</a><a href="#h35-0-4" id="h35-0-4" class="i">+abstract class AbstractMenu() {
</a><a href="#h35-0-5" id="h35-0-5" class="i">+    lateinit var context: ModContext
</a><a href="#h35-0-6" id="h35-0-6" class="i">+
</a><a href="#h35-0-7" id="h35-0-7" class="i">+    open fun init() {}
</a><a href="#h35-0-8" id="h35-0-8" class="i">+}</a><a href="#h35-0-9" id="h35-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h36" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -0,0 +1,93 @@
</a><a href="#h36-0-0" id="h36-0-0" class="i">+package me.rhunk.snapenhance.ui.menu
</a><a href="#h36-0-1" id="h36-0-1" class="i">+
</a><a href="#h36-0-2" id="h36-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h36-0-3" id="h36-0-3" class="i">+import android.content.res.ColorStateList
</a><a href="#h36-0-4" id="h36-0-4" class="i">+import android.graphics.Color
</a><a href="#h36-0-5" id="h36-0-5" class="i">+import android.graphics.drawable.ColorDrawable
</a><a href="#h36-0-6" id="h36-0-6" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h36-0-7" id="h36-0-7" class="i">+import android.graphics.drawable.ShapeDrawable
</a><a href="#h36-0-8" id="h36-0-8" class="i">+import android.graphics.drawable.StateListDrawable
</a><a href="#h36-0-9" id="h36-0-9" class="i">+import android.view.Gravity
</a><a href="#h36-0-10" id="h36-0-10" class="i">+import android.view.View
</a><a href="#h36-0-11" id="h36-0-11" class="i">+import android.widget.Switch
</a><a href="#h36-0-12" id="h36-0-12" class="i">+import android.widget.TextView
</a><a href="#h36-0-13" id="h36-0-13" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h36-0-14" id="h36-0-14" class="i">+
</a><a href="#h36-0-15" id="h36-0-15" class="i">+object ViewAppearanceHelper {
</a><a href="#h36-0-16" id="h36-0-16" class="i">+    @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;, &quot;DiscouragedApi&quot;,
</a><a href="#h36-0-17" id="h36-0-17" class="i">+        &quot;ClickableViewAccessibility&quot;
</a><a href="#h36-0-18" id="h36-0-18" class="i">+    )
</a><a href="#h36-0-19" id="h36-0-19" class="i">+    private var sigColorTextPrimary: Int = 0
</a><a href="#h36-0-20" id="h36-0-20" class="i">+    private var sigColorBackgroundSurface: Int = 0
</a><a href="#h36-0-21" id="h36-0-21" class="i">+
</a><a href="#h36-0-22" id="h36-0-22" class="i">+    private fun createRoundedBackground(color: Int, hasRadius: Boolean): Drawable {
</a><a href="#h36-0-23" id="h36-0-23" class="i">+        if (!hasRadius) return ColorDrawable(color)
</a><a href="#h36-0-24" id="h36-0-24" class="i">+        //FIXME: hardcoded radius
</a><a href="#h36-0-25" id="h36-0-25" class="i">+        return ShapeDrawable().apply {
</a><a href="#h36-0-26" id="h36-0-26" class="i">+            paint.color = color
</a><a href="#h36-0-27" id="h36-0-27" class="i">+            shape = android.graphics.drawable.shapes.RoundRectShape(
</a><a href="#h36-0-28" id="h36-0-28" class="i">+                floatArrayOf(20f, 20f, 20f, 20f, 20f, 20f, 20f, 20f),
</a><a href="#h36-0-29" id="h36-0-29" class="i">+                null,
</a><a href="#h36-0-30" id="h36-0-30" class="i">+                null
</a><a href="#h36-0-31" id="h36-0-31" class="i">+            )
</a><a href="#h36-0-32" id="h36-0-32" class="i">+        }
</a><a href="#h36-0-33" id="h36-0-33" class="i">+    }
</a><a href="#h36-0-34" id="h36-0-34" class="i">+
</a><a href="#h36-0-35" id="h36-0-35" class="i">+    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h36-0-36" id="h36-0-36" class="i">+    fun applyTheme(component: View, componentWidth: Int? = null, hasRadius: Boolean = false) {
</a><a href="#h36-0-37" id="h36-0-37" class="i">+        val resources = component.context.resources
</a><a href="#h36-0-38" id="h36-0-38" class="i">+        if (sigColorBackgroundSurface == 0 || sigColorTextPrimary == 0) {
</a><a href="#h36-0-39" id="h36-0-39" class="i">+            with(component.context.theme) {
</a><a href="#h36-0-40" id="h36-0-40" class="i">+                sigColorTextPrimary = obtainStyledAttributes(
</a><a href="#h36-0-41" id="h36-0-41" class="i">+                    intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h36-0-42" id="h36-0-42" class="i">+                ).getColor(0, 0)
</a><a href="#h36-0-43" id="h36-0-43" class="i">+
</a><a href="#h36-0-44" id="h36-0-44" class="i">+                sigColorBackgroundSurface = obtainStyledAttributes(
</a><a href="#h36-0-45" id="h36-0-45" class="i">+                    intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h36-0-46" id="h36-0-46" class="i">+                ).getColor(0, 0)
</a><a href="#h36-0-47" id="h36-0-47" class="i">+            }
</a><a href="#h36-0-48" id="h36-0-48" class="i">+        }
</a><a href="#h36-0-49" id="h36-0-49" class="i">+
</a><a href="#h36-0-50" id="h36-0-50" class="i">+        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;, &quot;com.snapchat.android&quot;)
</a><a href="#h36-0-51" id="h36-0-51" class="i">+        val scalingFactor = resources.displayMetrics.densityDpi.toDouble() / 400
</a><a href="#h36-0-52" id="h36-0-52" class="i">+
</a><a href="#h36-0-53" id="h36-0-53" class="i">+        with(component) {
</a><a href="#h36-0-54" id="h36-0-54" class="i">+            if (this is TextView) {
</a><a href="#h36-0-55" id="h36-0-55" class="i">+                setTextColor(sigColorTextPrimary)
</a><a href="#h36-0-56" id="h36-0-56" class="i">+                setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h36-0-57" id="h36-0-57" class="i">+                gravity = Gravity.CENTER_VERTICAL
</a><a href="#h36-0-58" id="h36-0-58" class="i">+                componentWidth?.let { width = it}
</a><a href="#h36-0-59" id="h36-0-59" class="i">+                height = (150 * scalingFactor).toInt()
</a><a href="#h36-0-60" id="h36-0-60" class="i">+                isAllCaps = false
</a><a href="#h36-0-61" id="h36-0-61" class="i">+                textSize = 16f
</a><a href="#h36-0-62" id="h36-0-62" class="i">+                typeface = resources.getFont(snapchatFontResId)
</a><a href="#h36-0-63" id="h36-0-63" class="i">+                outlineProvider = null
</a><a href="#h36-0-64" id="h36-0-64" class="i">+                setPadding((40 * scalingFactor).toInt(), 0, (40 * scalingFactor).toInt(), 0)
</a><a href="#h36-0-65" id="h36-0-65" class="i">+            }
</a><a href="#h36-0-66" id="h36-0-66" class="i">+            background = StateListDrawable().apply {
</a><a href="#h36-0-67" id="h36-0-67" class="i">+                addState(intArrayOf(), createRoundedBackground(color = sigColorBackgroundSurface, hasRadius))
</a><a href="#h36-0-68" id="h36-0-68" class="i">+                addState(intArrayOf(android.R.attr.state_pressed), createRoundedBackground(color = 0x5395026, hasRadius))
</a><a href="#h36-0-69" id="h36-0-69" class="i">+            }
</a><a href="#h36-0-70" id="h36-0-70" class="i">+        }
</a><a href="#h36-0-71" id="h36-0-71" class="i">+
</a><a href="#h36-0-72" id="h36-0-72" class="i">+        if (component is Switch) {
</a><a href="#h36-0-73" id="h36-0-73" class="i">+            with(resources) {
</a><a href="#h36-0-74" id="h36-0-74" class="i">+                component.switchMinWidth = getDimension(getIdentifier(&quot;v11_switch_min_width&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME)).toInt()
</a><a href="#h36-0-75" id="h36-0-75" class="i">+            }
</a><a href="#h36-0-76" id="h36-0-76" class="i">+            component.trackTintList = ColorStateList(
</a><a href="#h36-0-77" id="h36-0-77" class="i">+                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h36-0-78" id="h36-0-78" class="i">+                ), intArrayOf(
</a><a href="#h36-0-79" id="h36-0-79" class="i">+                    Color.parseColor(&quot;#1d1d1d&quot;),
</a><a href="#h36-0-80" id="h36-0-80" class="i">+                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h36-0-81" id="h36-0-81" class="i">+                )
</a><a href="#h36-0-82" id="h36-0-82" class="i">+            )
</a><a href="#h36-0-83" id="h36-0-83" class="i">+            component.thumbTintList = ColorStateList(
</a><a href="#h36-0-84" id="h36-0-84" class="i">+                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h36-0-85" id="h36-0-85" class="i">+                ), intArrayOf(
</a><a href="#h36-0-86" id="h36-0-86" class="i">+                    Color.parseColor(&quot;#F5F5F5&quot;),
</a><a href="#h36-0-87" id="h36-0-87" class="i">+                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h36-0-88" id="h36-0-88" class="i">+                )
</a><a href="#h36-0-89" id="h36-0-89" class="i">+            )
</a><a href="#h36-0-90" id="h36-0-90" class="i">+        }
</a><a href="#h36-0-91" id="h36-0-91" class="i">+    }
</a><a href="#h36-0-92" id="h36-0-92" class="i">+}
</a><b>diff --git a/<a id="h37" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,95 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h37-0-1" id="h37-0-1" class="i">+
</a><a href="#h37-0-2" id="h37-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h37-0-3" id="h37-0-3" class="i">+import android.os.SystemClock
</a><a href="#h37-0-4" id="h37-0-4" class="i">+import android.view.MotionEvent
</a><a href="#h37-0-5" id="h37-0-5" class="i">+import android.view.View
</a><a href="#h37-0-6" id="h37-0-6" class="i">+import android.view.ViewGroup
</a><a href="#h37-0-7" id="h37-0-7" class="i">+import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h37-0-8" id="h37-0-8" class="i">+import android.widget.Button
</a><a href="#h37-0-9" id="h37-0-9" class="i">+import me.rhunk.snapenhance.Constants.VIEW_INJECTED_CODE
</a><a href="#h37-0-10" id="h37-0-10" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h37-0-11" id="h37-0-11" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h37-0-12" id="h37-0-12" class="i">+import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h37-0-13" id="h37-0-13" class="i">+import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a><a href="#h37-0-14" id="h37-0-14" class="i">+import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h37-0-15" id="h37-0-15" class="i">+import me.rhunk.snapenhance.ui.menu.ViewAppearanceHelper
</a><a href="#h37-0-16" id="h37-0-16" class="i">+
</a><a href="#h37-0-17" id="h37-0-17" class="i">+
</a><a href="#h37-0-18" id="h37-0-18" class="i">+class ChatActionMenu : AbstractMenu() {
</a><a href="#h37-0-19" id="h37-0-19" class="i">+    private fun wasInjectedView(view: View): Boolean {
</a><a href="#h37-0-20" id="h37-0-20" class="i">+        if (view.getTag(VIEW_INJECTED_CODE) != null) return true
</a><a href="#h37-0-21" id="h37-0-21" class="i">+        view.setTag(VIEW_INJECTED_CODE, true)
</a><a href="#h37-0-22" id="h37-0-22" class="i">+        return false
</a><a href="#h37-0-23" id="h37-0-23" class="i">+    }
</a><a href="#h37-0-24" id="h37-0-24" class="i">+
</a><a href="#h37-0-25" id="h37-0-25" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h37-0-26" id="h37-0-26" class="i">+    fun inject(viewGroup: ViewGroup) {
</a><a href="#h37-0-27" id="h37-0-27" class="i">+        val parent = viewGroup.parent.parent as ViewGroup
</a><a href="#h37-0-28" id="h37-0-28" class="i">+        if (wasInjectedView(parent)) return
</a><a href="#h37-0-29" id="h37-0-29" class="i">+        //close the action menu using a touch event
</a><a href="#h37-0-30" id="h37-0-30" class="i">+        val closeActionMenu = {
</a><a href="#h37-0-31" id="h37-0-31" class="i">+            viewGroup.dispatchTouchEvent(
</a><a href="#h37-0-32" id="h37-0-32" class="i">+                MotionEvent.obtain(
</a><a href="#h37-0-33" id="h37-0-33" class="i">+                    SystemClock.uptimeMillis(),
</a><a href="#h37-0-34" id="h37-0-34" class="i">+                    SystemClock.uptimeMillis(),
</a><a href="#h37-0-35" id="h37-0-35" class="i">+                    MotionEvent.ACTION_DOWN,
</a><a href="#h37-0-36" id="h37-0-36" class="i">+                    0f,
</a><a href="#h37-0-37" id="h37-0-37" class="i">+                    0f,
</a><a href="#h37-0-38" id="h37-0-38" class="i">+                    0
</a><a href="#h37-0-39" id="h37-0-39" class="i">+                )
</a><a href="#h37-0-40" id="h37-0-40" class="i">+            )
</a><a href="#h37-0-41" id="h37-0-41" class="i">+        }
</a><a href="#h37-0-42" id="h37-0-42" class="i">+
</a><a href="#h37-0-43" id="h37-0-43" class="i">+        val injectButton = { button: Button -&gt;
</a><a href="#h37-0-44" id="h37-0-44" class="i">+            ViewAppearanceHelper.applyTheme(button, parent.width, hasRadius = true)
</a><a href="#h37-0-45" id="h37-0-45" class="i">+
</a><a href="#h37-0-46" id="h37-0-46" class="i">+            with(button) {
</a><a href="#h37-0-47" id="h37-0-47" class="i">+                layoutParams = MarginLayoutParams(
</a><a href="#h37-0-48" id="h37-0-48" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h37-0-49" id="h37-0-49" class="i">+                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h37-0-50" id="h37-0-50" class="i">+                ).apply {
</a><a href="#h37-0-51" id="h37-0-51" class="i">+                    setMargins(40, 0, 40, 15)
</a><a href="#h37-0-52" id="h37-0-52" class="i">+                }
</a><a href="#h37-0-53" id="h37-0-53" class="i">+                parent.addView(this)
</a><a href="#h37-0-54" id="h37-0-54" class="i">+            }
</a><a href="#h37-0-55" id="h37-0-55" class="i">+        }
</a><a href="#h37-0-56" id="h37-0-56" class="i">+
</a><a href="#h37-0-57" id="h37-0-57" class="i">+        if (context.config.bool(ConfigProperty.CHAT_DOWNLOAD_CONTEXT_MENU)) {
</a><a href="#h37-0-58" id="h37-0-58" class="i">+            injectButton(Button(viewGroup.context).apply {
</a><a href="#h37-0-59" id="h37-0-59" class="i">+                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.preview_button&quot;)
</a><a href="#h37-0-60" id="h37-0-60" class="i">+                setOnClickListener {
</a><a href="#h37-0-61" id="h37-0-61" class="i">+                    closeActionMenu()
</a><a href="#h37-0-62" id="h37-0-62" class="i">+                    this@ChatActionMenu.context.executeAsync { this@ChatActionMenu.context.feature(MediaDownloader::class).onMessageActionMenu(true) }
</a><a href="#h37-0-63" id="h37-0-63" class="i">+                }
</a><a href="#h37-0-64" id="h37-0-64" class="i">+            })
</a><a href="#h37-0-65" id="h37-0-65" class="i">+
</a><a href="#h37-0-66" id="h37-0-66" class="i">+            injectButton(Button(viewGroup.context).apply {
</a><a href="#h37-0-67" id="h37-0-67" class="i">+                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.download_button&quot;)
</a><a href="#h37-0-68" id="h37-0-68" class="i">+                setOnClickListener {
</a><a href="#h37-0-69" id="h37-0-69" class="i">+                    closeActionMenu()
</a><a href="#h37-0-70" id="h37-0-70" class="i">+                    this@ChatActionMenu.context.executeAsync {
</a><a href="#h37-0-71" id="h37-0-71" class="i">+                        this@ChatActionMenu.context.feature(
</a><a href="#h37-0-72" id="h37-0-72" class="i">+                            MediaDownloader::class
</a><a href="#h37-0-73" id="h37-0-73" class="i">+                        ).onMessageActionMenu(false)
</a><a href="#h37-0-74" id="h37-0-74" class="i">+                    }
</a><a href="#h37-0-75" id="h37-0-75" class="i">+                }
</a><a href="#h37-0-76" id="h37-0-76" class="i">+            })
</a><a href="#h37-0-77" id="h37-0-77" class="i">+        }
</a><a href="#h37-0-78" id="h37-0-78" class="i">+
</a><a href="#h37-0-79" id="h37-0-79" class="i">+        //delete logged message button
</a><a href="#h37-0-80" id="h37-0-80" class="i">+        if (context.config.bool(ConfigProperty.MESSAGE_LOGGER)) {
</a><a href="#h37-0-81" id="h37-0-81" class="i">+            injectButton(Button(viewGroup.context).apply {
</a><a href="#h37-0-82" id="h37-0-82" class="i">+                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.delete_logged_message_button&quot;)
</a><a href="#h37-0-83" id="h37-0-83" class="i">+                setOnClickListener {
</a><a href="#h37-0-84" id="h37-0-84" class="i">+                    closeActionMenu()
</a><a href="#h37-0-85" id="h37-0-85" class="i">+                    this@ChatActionMenu.context.executeAsync {
</a><a href="#h37-0-86" id="h37-0-86" class="i">+                        with(this@ChatActionMenu.context.feature(Messaging::class)) {
</a><a href="#h37-0-87" id="h37-0-87" class="i">+                            context.feature(MessageLogger::class).deleteMessage(openedConversationUUID.toString(), lastFocusedMessageId)
</a><a href="#h37-0-88" id="h37-0-88" class="i">+                        }
</a><a href="#h37-0-89" id="h37-0-89" class="i">+                    }
</a><a href="#h37-0-90" id="h37-0-90" class="i">+                }
</a><a href="#h37-0-91" id="h37-0-91" class="i">+            })
</a><a href="#h37-0-92" id="h37-0-92" class="i">+        }
</a><a href="#h37-0-93" id="h37-0-93" class="i">+    }
</a><a href="#h37-0-94" id="h37-0-94" class="i">+}
</a><b>diff --git a/<a id="h38" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,375 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h38-0-1" id="h38-0-1" class="i">+
</a><a href="#h38-0-2" id="h38-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h38-0-3" id="h38-0-3" class="i">+import android.app.AlertDialog
</a><a href="#h38-0-4" id="h38-0-4" class="i">+import android.content.Context
</a><a href="#h38-0-5" id="h38-0-5" class="i">+import android.content.DialogInterface
</a><a href="#h38-0-6" id="h38-0-6" class="i">+import android.content.res.Resources
</a><a href="#h38-0-7" id="h38-0-7" class="i">+import android.graphics.Bitmap
</a><a href="#h38-0-8" id="h38-0-8" class="i">+import android.graphics.BitmapFactory
</a><a href="#h38-0-9" id="h38-0-9" class="i">+import android.graphics.Canvas
</a><a href="#h38-0-10" id="h38-0-10" class="i">+import android.graphics.Color
</a><a href="#h38-0-11" id="h38-0-11" class="i">+import android.graphics.Paint
</a><a href="#h38-0-12" id="h38-0-12" class="i">+import android.graphics.drawable.BitmapDrawable
</a><a href="#h38-0-13" id="h38-0-13" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h38-0-14" id="h38-0-14" class="i">+import android.view.Gravity
</a><a href="#h38-0-15" id="h38-0-15" class="i">+import android.view.MotionEvent
</a><a href="#h38-0-16" id="h38-0-16" class="i">+import android.view.View
</a><a href="#h38-0-17" id="h38-0-17" class="i">+import android.view.ViewGroup
</a><a href="#h38-0-18" id="h38-0-18" class="i">+import android.widget.Button
</a><a href="#h38-0-19" id="h38-0-19" class="i">+import android.widget.CompoundButton
</a><a href="#h38-0-20" id="h38-0-20" class="i">+import android.widget.LinearLayout
</a><a href="#h38-0-21" id="h38-0-21" class="i">+import android.widget.Switch
</a><a href="#h38-0-22" id="h38-0-22" class="i">+import android.widget.Toast
</a><a href="#h38-0-23" id="h38-0-23" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h38-0-24" id="h38-0-24" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h38-0-25" id="h38-0-25" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h38-0-26" id="h38-0-26" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.FriendActionButton
</a><a href="#h38-0-27" id="h38-0-27" class="i">+import me.rhunk.snapenhance.database.objects.ConversationMessage
</a><a href="#h38-0-28" id="h38-0-28" class="i">+import me.rhunk.snapenhance.database.objects.FriendInfo
</a><a href="#h38-0-29" id="h38-0-29" class="i">+import me.rhunk.snapenhance.database.objects.UserConversationLink
</a><a href="#h38-0-30" id="h38-0-30" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h38-0-31" id="h38-0-31" class="i">+import me.rhunk.snapenhance.features.impl.downloader.AntiAutoDownload
</a><a href="#h38-0-32" id="h38-0-32" class="i">+import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a><a href="#h38-0-33" id="h38-0-33" class="i">+import me.rhunk.snapenhance.features.impl.tweaks.AntiAutoSave
</a><a href="#h38-0-34" id="h38-0-34" class="i">+import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h38-0-35" id="h38-0-35" class="i">+import me.rhunk.snapenhance.ui.menu.ViewAppearanceHelper
</a><a href="#h38-0-36" id="h38-0-36" class="i">+import me.rhunk.snapenhance.util.snap.BitmojiSelfie
</a><a href="#h38-0-37" id="h38-0-37" class="i">+import java.net.HttpURLConnection
</a><a href="#h38-0-38" id="h38-0-38" class="i">+import java.net.URL
</a><a href="#h38-0-39" id="h38-0-39" class="i">+import java.text.DateFormat
</a><a href="#h38-0-40" id="h38-0-40" class="i">+import java.text.SimpleDateFormat
</a><a href="#h38-0-41" id="h38-0-41" class="i">+import java.util.Calendar
</a><a href="#h38-0-42" id="h38-0-42" class="i">+import java.util.Date
</a><a href="#h38-0-43" id="h38-0-43" class="i">+import java.util.Locale
</a><a href="#h38-0-44" id="h38-0-44" class="i">+
</a><a href="#h38-0-45" id="h38-0-45" class="i">+class FriendFeedInfoMenu : AbstractMenu() {
</a><a href="#h38-0-46" id="h38-0-46" class="i">+    private fun getImageDrawable(url: String): Drawable {
</a><a href="#h38-0-47" id="h38-0-47" class="i">+        val connection = URL(url).openConnection() as HttpURLConnection
</a><a href="#h38-0-48" id="h38-0-48" class="i">+        connection.connect()
</a><a href="#h38-0-49" id="h38-0-49" class="i">+        val input = connection.inputStream
</a><a href="#h38-0-50" id="h38-0-50" class="i">+        return BitmapDrawable(Resources.getSystem(), BitmapFactory.decodeStream(input))
</a><a href="#h38-0-51" id="h38-0-51" class="i">+    }
</a><a href="#h38-0-52" id="h38-0-52" class="i">+
</a><a href="#h38-0-53" id="h38-0-53" class="i">+    private fun formatDate(timestamp: Long): String? {
</a><a href="#h38-0-54" id="h38-0-54" class="i">+        return SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(timestamp))
</a><a href="#h38-0-55" id="h38-0-55" class="i">+    }
</a><a href="#h38-0-56" id="h38-0-56" class="i">+
</a><a href="#h38-0-57" id="h38-0-57" class="i">+    private fun showProfileInfo(profile: FriendInfo) {
</a><a href="#h38-0-58" id="h38-0-58" class="i">+        var icon: Drawable? = null
</a><a href="#h38-0-59" id="h38-0-59" class="i">+        try {
</a><a href="#h38-0-60" id="h38-0-60" class="i">+            if (profile.bitmojiSelfieId != null &amp;&amp; profile.bitmojiAvatarId != null) {
</a><a href="#h38-0-61" id="h38-0-61" class="i">+                icon = getImageDrawable(
</a><a href="#h38-0-62" id="h38-0-62" class="i">+                    BitmojiSelfie.getBitmojiSelfie(
</a><a href="#h38-0-63" id="h38-0-63" class="i">+                        profile.bitmojiSelfieId.toString(),
</a><a href="#h38-0-64" id="h38-0-64" class="i">+                        profile.bitmojiAvatarId.toString(),
</a><a href="#h38-0-65" id="h38-0-65" class="i">+                        BitmojiSelfie.BitmojiSelfieType.THREE_D
</a><a href="#h38-0-66" id="h38-0-66" class="i">+                    )
</a><a href="#h38-0-67" id="h38-0-67" class="i">+                )
</a><a href="#h38-0-68" id="h38-0-68" class="i">+            }
</a><a href="#h38-0-69" id="h38-0-69" class="i">+        } catch (e: Throwable) {
</a><a href="#h38-0-70" id="h38-0-70" class="i">+            Logger.xposedLog(e)
</a><a href="#h38-0-71" id="h38-0-71" class="i">+        }
</a><a href="#h38-0-72" id="h38-0-72" class="i">+        val finalIcon = icon
</a><a href="#h38-0-73" id="h38-0-73" class="i">+        context.runOnUiThread {
</a><a href="#h38-0-74" id="h38-0-74" class="i">+            val addedTimestamp: Long = profile.addedTimestamp.coerceAtLeast(profile.reverseAddedTimestamp)
</a><a href="#h38-0-75" id="h38-0-75" class="i">+            val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h38-0-76" id="h38-0-76" class="i">+            builder.setIcon(finalIcon)
</a><a href="#h38-0-77" id="h38-0-77" class="i">+            builder.setTitle(profile.displayName ?: profile.username)
</a><a href="#h38-0-78" id="h38-0-78" class="i">+
</a><a href="#h38-0-79" id="h38-0-79" class="i">+            val birthday = Calendar.getInstance()
</a><a href="#h38-0-80" id="h38-0-80" class="i">+            birthday[Calendar.MONTH] = (profile.birthday shr 32).toInt() - 1
</a><a href="#h38-0-81" id="h38-0-81" class="i">+            val message: String = &quot;&quot;&quot;
</a><a href="#h38-0-82" id="h38-0-82" class="i">+                ${context.translation.get(&quot;profile_info.username&quot;)}: ${profile.username}
</a><a href="#h38-0-83" id="h38-0-83" class="i">+                ${context.translation.get(&quot;profile_info.display_name&quot;)}: ${profile.displayName}
</a><a href="#h38-0-84" id="h38-0-84" class="i">+                ${context.translation.get(&quot;profile_info.added_date&quot;)}: ${formatDate(addedTimestamp)}
</a><a href="#h38-0-85" id="h38-0-85" class="i">+                ${birthday.getDisplayName(
</a><a href="#h38-0-86" id="h38-0-86" class="i">+                    Calendar.MONTH,
</a><a href="#h38-0-87" id="h38-0-87" class="i">+                    Calendar.LONG,
</a><a href="#h38-0-88" id="h38-0-88" class="i">+                    context.translation.locale
</a><a href="#h38-0-89" id="h38-0-89" class="i">+                )?.let {
</a><a href="#h38-0-90" id="h38-0-90" class="i">+                    context.translation.get(&quot;profile_info.birthday&quot;)
</a><a href="#h38-0-91" id="h38-0-91" class="i">+                        .replace(&quot;{month}&quot;, it)
</a><a href="#h38-0-92" id="h38-0-92" class="i">+                        .replace(&quot;{day}&quot;, profile.birthday.toInt().toString())
</a><a href="#h38-0-93" id="h38-0-93" class="i">+                }
</a><a href="#h38-0-94" id="h38-0-94" class="i">+            }
</a><a href="#h38-0-95" id="h38-0-95" class="i">+            &quot;&quot;&quot;.trimIndent()
</a><a href="#h38-0-96" id="h38-0-96" class="i">+            builder.setMessage(message)
</a><a href="#h38-0-97" id="h38-0-97" class="i">+            builder.setPositiveButton(
</a><a href="#h38-0-98" id="h38-0-98" class="i">+                &quot;OK&quot;
</a><a href="#h38-0-99" id="h38-0-99" class="i">+            ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h38-0-100" id="h38-0-100" class="i">+            builder.show()
</a><a href="#h38-0-101" id="h38-0-101" class="i">+        }
</a><a href="#h38-0-102" id="h38-0-102" class="i">+    }
</a><a href="#h38-0-103" id="h38-0-103" class="i">+
</a><a href="#h38-0-104" id="h38-0-104" class="i">+    private fun showPreview(userId: String?, conversationId: String, androidCtx: Context?) {
</a><a href="#h38-0-105" id="h38-0-105" class="i">+        //query message
</a><a href="#h38-0-106" id="h38-0-106" class="i">+        val messages: List&lt;ConversationMessage&gt;? = context.database.getMessagesFromConversationId(
</a><a href="#h38-0-107" id="h38-0-107" class="i">+            conversationId,
</a><a href="#h38-0-108" id="h38-0-108" class="i">+            context.config.int(ConfigProperty.MESSAGE_PREVIEW_LENGTH)
</a><a href="#h38-0-109" id="h38-0-109" class="i">+        )?.reversed()
</a><a href="#h38-0-110" id="h38-0-110" class="i">+
</a><a href="#h38-0-111" id="h38-0-111" class="i">+        if (messages.isNullOrEmpty()) {
</a><a href="#h38-0-112" id="h38-0-112" class="i">+            Toast.makeText(androidCtx, &quot;No messages found&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h38-0-113" id="h38-0-113" class="i">+            return
</a><a href="#h38-0-114" id="h38-0-114" class="i">+        }
</a><a href="#h38-0-115" id="h38-0-115" class="i">+        val participants: Map&lt;String, FriendInfo&gt; = context.database.getConversationParticipants(conversationId)!!
</a><a href="#h38-0-116" id="h38-0-116" class="i">+            .map { context.database.getFriendInfo(it)!! }
</a><a href="#h38-0-117" id="h38-0-117" class="i">+            .associateBy { it.userId!! }
</a><a href="#h38-0-118" id="h38-0-118" class="i">+        
</a><a href="#h38-0-119" id="h38-0-119" class="i">+        val messageBuilder = StringBuilder()
</a><a href="#h38-0-120" id="h38-0-120" class="i">+
</a><a href="#h38-0-121" id="h38-0-121" class="i">+        messages.forEach{ message: ConversationMessage -&gt;
</a><a href="#h38-0-122" id="h38-0-122" class="i">+            val sender: FriendInfo? = participants[message.sender_id]
</a><a href="#h38-0-123" id="h38-0-123" class="i">+
</a><a href="#h38-0-124" id="h38-0-124" class="i">+            var messageString: String = message.getMessageAsString() ?: ContentType.fromId(message.content_type).name
</a><a href="#h38-0-125" id="h38-0-125" class="i">+
</a><a href="#h38-0-126" id="h38-0-126" class="i">+            if (message.content_type == ContentType.SNAP.id) {
</a><a href="#h38-0-127" id="h38-0-127" class="i">+                val readTimeStamp: Long = message.read_timestamp
</a><a href="#h38-0-128" id="h38-0-128" class="i">+                messageString = &quot;\uD83D\uDFE5&quot; //red square
</a><a href="#h38-0-129" id="h38-0-129" class="i">+                if (readTimeStamp &gt; 0) {
</a><a href="#h38-0-130" id="h38-0-130" class="i">+                    messageString += &quot; \uD83D\uDC40 &quot; //eyes
</a><a href="#h38-0-131" id="h38-0-131" class="i">+                    messageString += DateFormat.getDateTimeInstance(
</a><a href="#h38-0-132" id="h38-0-132" class="i">+                        DateFormat.SHORT,
</a><a href="#h38-0-133" id="h38-0-133" class="i">+                        DateFormat.SHORT
</a><a href="#h38-0-134" id="h38-0-134" class="i">+                    ).format(Date(readTimeStamp))
</a><a href="#h38-0-135" id="h38-0-135" class="i">+                }
</a><a href="#h38-0-136" id="h38-0-136" class="i">+            }
</a><a href="#h38-0-137" id="h38-0-137" class="i">+
</a><a href="#h38-0-138" id="h38-0-138" class="i">+            var displayUsername = sender?.displayName ?: sender?.usernameForSorting?: context.translation.get(&quot;conversation_preview.unknown_user&quot;)
</a><a href="#h38-0-139" id="h38-0-139" class="i">+
</a><a href="#h38-0-140" id="h38-0-140" class="i">+            if (displayUsername.length &gt; 12) {
</a><a href="#h38-0-141" id="h38-0-141" class="i">+                displayUsername = displayUsername.substring(0, 13) + &quot;... &quot;
</a><a href="#h38-0-142" id="h38-0-142" class="i">+            }
</a><a href="#h38-0-143" id="h38-0-143" class="i">+
</a><a href="#h38-0-144" id="h38-0-144" class="i">+            messageBuilder.append(displayUsername).append(&quot;: &quot;).append(messageString).append(&quot;\n&quot;)
</a><a href="#h38-0-145" id="h38-0-145" class="i">+        }
</a><a href="#h38-0-146" id="h38-0-146" class="i">+
</a><a href="#h38-0-147" id="h38-0-147" class="i">+        val targetPerson: FriendInfo? =
</a><a href="#h38-0-148" id="h38-0-148" class="i">+            if (userId == null) null else participants[userId]
</a><a href="#h38-0-149" id="h38-0-149" class="i">+
</a><a href="#h38-0-150" id="h38-0-150" class="i">+        targetPerson?.streakExpirationTimestamp?.takeIf { it &gt; 0 }?.let {
</a><a href="#h38-0-151" id="h38-0-151" class="i">+            val timeSecondDiff = ((it - System.currentTimeMillis()) / 1000 / 60).toInt()
</a><a href="#h38-0-152" id="h38-0-152" class="i">+            messageBuilder.append(&quot;\n\n&quot;)
</a><a href="#h38-0-153" id="h38-0-153" class="i">+                .append(&quot;\uD83D\uDD25 &quot;) //fire emoji
</a><a href="#h38-0-154" id="h38-0-154" class="i">+                .append(context.translation.get(&quot;conversation_preview.streak_expiration&quot;).format(
</a><a href="#h38-0-155" id="h38-0-155" class="i">+                    timeSecondDiff / 60 / 24,
</a><a href="#h38-0-156" id="h38-0-156" class="i">+                    timeSecondDiff / 60 % 24,
</a><a href="#h38-0-157" id="h38-0-157" class="i">+                    timeSecondDiff % 60
</a><a href="#h38-0-158" id="h38-0-158" class="i">+                ))
</a><a href="#h38-0-159" id="h38-0-159" class="i">+        }
</a><a href="#h38-0-160" id="h38-0-160" class="i">+
</a><a href="#h38-0-161" id="h38-0-161" class="i">+        //alert dialog
</a><a href="#h38-0-162" id="h38-0-162" class="i">+        val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h38-0-163" id="h38-0-163" class="i">+        builder.setTitle(context.translation.get(&quot;conversation_preview.title&quot;))
</a><a href="#h38-0-164" id="h38-0-164" class="i">+        builder.setMessage(messageBuilder.toString())
</a><a href="#h38-0-165" id="h38-0-165" class="i">+        builder.setPositiveButton(
</a><a href="#h38-0-166" id="h38-0-166" class="i">+            &quot;OK&quot;
</a><a href="#h38-0-167" id="h38-0-167" class="i">+        ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h38-0-168" id="h38-0-168" class="i">+        targetPerson?.let {
</a><a href="#h38-0-169" id="h38-0-169" class="i">+            builder.setNegativeButton(context.translation.get(&quot;modal_option.profile_info&quot;)) {_, _ -&gt;
</a><a href="#h38-0-170" id="h38-0-170" class="i">+                context.executeAsync {
</a><a href="#h38-0-171" id="h38-0-171" class="i">+                    showProfileInfo(it)
</a><a href="#h38-0-172" id="h38-0-172" class="i">+                }
</a><a href="#h38-0-173" id="h38-0-173" class="i">+            }
</a><a href="#h38-0-174" id="h38-0-174" class="i">+        }
</a><a href="#h38-0-175" id="h38-0-175" class="i">+        builder.show()
</a><a href="#h38-0-176" id="h38-0-176" class="i">+    }
</a><a href="#h38-0-177" id="h38-0-177" class="i">+
</a><a href="#h38-0-178" id="h38-0-178" class="i">+    private fun createEmojiDrawable(text: String, width: Int, height: Int, textSize: Float, disabled: Boolean = false): Drawable {
</a><a href="#h38-0-179" id="h38-0-179" class="i">+        val bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888)
</a><a href="#h38-0-180" id="h38-0-180" class="i">+        val canvas = Canvas(bitmap)
</a><a href="#h38-0-181" id="h38-0-181" class="i">+        val paint = Paint()
</a><a href="#h38-0-182" id="h38-0-182" class="i">+        paint.textSize = textSize
</a><a href="#h38-0-183" id="h38-0-183" class="i">+        paint.color = Color.BLACK
</a><a href="#h38-0-184" id="h38-0-184" class="i">+        paint.textAlign = Paint.Align.CENTER
</a><a href="#h38-0-185" id="h38-0-185" class="i">+        canvas.drawText(text, width / 2f, height.toFloat() - paint.descent(), paint)
</a><a href="#h38-0-186" id="h38-0-186" class="i">+        if (disabled) {
</a><a href="#h38-0-187" id="h38-0-187" class="i">+            paint.color = Color.RED
</a><a href="#h38-0-188" id="h38-0-188" class="i">+            paint.strokeWidth = 5f
</a><a href="#h38-0-189" id="h38-0-189" class="i">+            canvas.drawLine(0f, 0f, width.toFloat(), height.toFloat(), paint)
</a><a href="#h38-0-190" id="h38-0-190" class="i">+        }
</a><a href="#h38-0-191" id="h38-0-191" class="i">+        return BitmapDrawable(context.resources, bitmap)
</a><a href="#h38-0-192" id="h38-0-192" class="i">+    }
</a><a href="#h38-0-193" id="h38-0-193" class="i">+
</a><a href="#h38-0-194" id="h38-0-194" class="i">+    private fun getCurrentConversationId(): Pair&lt;String, String?&gt; {
</a><a href="#h38-0-195" id="h38-0-195" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h38-0-196" id="h38-0-196" class="i">+        val focusedConversationTargetUser: String? = messaging.lastFetchConversationUserUUID?.toString()
</a><a href="#h38-0-197" id="h38-0-197" class="i">+
</a><a href="#h38-0-198" id="h38-0-198" class="i">+        val conversationId = if (messaging.lastFetchConversationUUID == null &amp;&amp; focusedConversationTargetUser != null) {
</a><a href="#h38-0-199" id="h38-0-199" class="i">+            val conversation: UserConversationLink = context.database.getDMConversationIdFromUserId(focusedConversationTargetUser) ?: throw IllegalStateException(&quot;No conversation found&quot;)
</a><a href="#h38-0-200" id="h38-0-200" class="i">+            conversation.client_conversation_id!!.trim().lowercase()
</a><a href="#h38-0-201" id="h38-0-201" class="i">+        } else {
</a><a href="#h38-0-202" id="h38-0-202" class="i">+            messaging.lastFetchConversationUUID.toString()
</a><a href="#h38-0-203" id="h38-0-203" class="i">+        }
</a><a href="#h38-0-204" id="h38-0-204" class="i">+
</a><a href="#h38-0-205" id="h38-0-205" class="i">+        return Pair(conversationId, focusedConversationTargetUser)
</a><a href="#h38-0-206" id="h38-0-206" class="i">+    }
</a><a href="#h38-0-207" id="h38-0-207" class="i">+
</a><a href="#h38-0-208" id="h38-0-208" class="i">+    private fun createToggleFeature(viewConsumer: ((View) -&gt; Unit), text: String, isChecked: () -&gt; Boolean, toggle: (Boolean) -&gt; Unit) {
</a><a href="#h38-0-209" id="h38-0-209" class="i">+        val switch = Switch(context.androidContext)
</a><a href="#h38-0-210" id="h38-0-210" class="i">+        switch.text = context.translation.get(text)
</a><a href="#h38-0-211" id="h38-0-211" class="i">+        switch.isChecked = isChecked()
</a><a href="#h38-0-212" id="h38-0-212" class="i">+        ViewAppearanceHelper.applyTheme(switch)
</a><a href="#h38-0-213" id="h38-0-213" class="i">+        switch.setOnCheckedChangeListener { _: CompoundButton?, checked: Boolean -&gt;
</a><a href="#h38-0-214" id="h38-0-214" class="i">+            toggle(checked)
</a><a href="#h38-0-215" id="h38-0-215" class="i">+        }
</a><a href="#h38-0-216" id="h38-0-216" class="i">+        viewConsumer(switch)
</a><a href="#h38-0-217" id="h38-0-217" class="i">+    }
</a><a href="#h38-0-218" id="h38-0-218" class="i">+
</a><a href="#h38-0-219" id="h38-0-219" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;, &quot;UseSwitchCompatOrMaterialCode&quot;, &quot;DefaultLocale&quot;, &quot;InflateParams&quot;,
</a><a href="#h38-0-220" id="h38-0-220" class="i">+        &quot;DiscouragedApi&quot;, &quot;ClickableViewAccessibility&quot;
</a><a href="#h38-0-221" id="h38-0-221" class="i">+    )
</a><a href="#h38-0-222" id="h38-0-222" class="i">+    fun inject(viewModel: View, viewConsumer: ((View) -&gt; Unit)) {
</a><a href="#h38-0-223" id="h38-0-223" class="i">+        val modContext = context
</a><a href="#h38-0-224" id="h38-0-224" class="i">+
</a><a href="#h38-0-225" id="h38-0-225" class="i">+        val friendFeedMenuOptions = context.config.options(ConfigProperty.FRIEND_FEED_MENU_BUTTONS)
</a><a href="#h38-0-226" id="h38-0-226" class="i">+        if (friendFeedMenuOptions.none { it.value }) return
</a><a href="#h38-0-227" id="h38-0-227" class="i">+
</a><a href="#h38-0-228" id="h38-0-228" class="i">+        val (conversationId, targetUser) = getCurrentConversationId()
</a><a href="#h38-0-229" id="h38-0-229" class="i">+
</a><a href="#h38-0-230" id="h38-0-230" class="i">+        if (!context.config.bool(ConfigProperty.ENABLE_FRIEND_FEED_MENU_BAR)) {
</a><a href="#h38-0-231" id="h38-0-231" class="i">+            //preview button
</a><a href="#h38-0-232" id="h38-0-232" class="i">+            val previewButton = Button(viewModel.context).apply {
</a><a href="#h38-0-233" id="h38-0-233" class="i">+                text = modContext.translation.get(&quot;friend_menu_option.preview&quot;)
</a><a href="#h38-0-234" id="h38-0-234" class="i">+                ViewAppearanceHelper.applyTheme(this, viewModel.width)
</a><a href="#h38-0-235" id="h38-0-235" class="i">+                setOnClickListener {
</a><a href="#h38-0-236" id="h38-0-236" class="i">+                    showPreview(
</a><a href="#h38-0-237" id="h38-0-237" class="i">+                        targetUser,
</a><a href="#h38-0-238" id="h38-0-238" class="i">+                        conversationId,
</a><a href="#h38-0-239" id="h38-0-239" class="i">+                        context
</a><a href="#h38-0-240" id="h38-0-240" class="i">+                    )
</a><a href="#h38-0-241" id="h38-0-241" class="i">+                }
</a><a href="#h38-0-242" id="h38-0-242" class="i">+            }
</a><a href="#h38-0-243" id="h38-0-243" class="i">+
</a><a href="#h38-0-244" id="h38-0-244" class="i">+            //stealth switch
</a><a href="#h38-0-245" id="h38-0-245" class="i">+            val stealthSwitch = Switch(viewModel.context).apply {
</a><a href="#h38-0-246" id="h38-0-246" class="i">+                text = modContext.translation.get(&quot;friend_menu_option.stealth_mode&quot;)
</a><a href="#h38-0-247" id="h38-0-247" class="i">+                isChecked = modContext.feature(StealthMode::class).isStealth(conversationId)
</a><a href="#h38-0-248" id="h38-0-248" class="i">+                ViewAppearanceHelper.applyTheme(this)
</a><a href="#h38-0-249" id="h38-0-249" class="i">+                setOnCheckedChangeListener { _: CompoundButton?, isChecked: Boolean -&gt;
</a><a href="#h38-0-250" id="h38-0-250" class="i">+                    modContext.feature(StealthMode::class).setStealth(
</a><a href="#h38-0-251" id="h38-0-251" class="i">+                        conversationId,
</a><a href="#h38-0-252" id="h38-0-252" class="i">+                        isChecked
</a><a href="#h38-0-253" id="h38-0-253" class="i">+                    )
</a><a href="#h38-0-254" id="h38-0-254" class="i">+                }
</a><a href="#h38-0-255" id="h38-0-255" class="i">+            }
</a><a href="#h38-0-256" id="h38-0-256" class="i">+
</a><a href="#h38-0-257" id="h38-0-257" class="i">+            if (friendFeedMenuOptions[&quot;anti_auto_save&quot;] == true) {
</a><a href="#h38-0-258" id="h38-0-258" class="i">+                createToggleFeature(viewConsumer,
</a><a href="#h38-0-259" id="h38-0-259" class="i">+                    &quot;friend_menu_option.anti_auto_save&quot;,
</a><a href="#h38-0-260" id="h38-0-260" class="i">+                    { context.feature(AntiAutoSave::class).isConversationIgnored(conversationId) },
</a><a href="#h38-0-261" id="h38-0-261" class="i">+                    { context.feature(AntiAutoSave::class).setConversationIgnored(conversationId, it) }
</a><a href="#h38-0-262" id="h38-0-262" class="i">+                )
</a><a href="#h38-0-263" id="h38-0-263" class="i">+            }
</a><a href="#h38-0-264" id="h38-0-264" class="i">+
</a><a href="#h38-0-265" id="h38-0-265" class="i">+            run {
</a><a href="#h38-0-266" id="h38-0-266" class="i">+                val userId = context.database.getFriendFeedInfoByConversationId(conversationId)?.friendUserId ?: return@run
</a><a href="#h38-0-267" id="h38-0-267" class="i">+                if (friendFeedMenuOptions[&quot;auto_download_blacklist&quot;] == true) {
</a><a href="#h38-0-268" id="h38-0-268" class="i">+                    createToggleFeature(viewConsumer,
</a><a href="#h38-0-269" id="h38-0-269" class="i">+                        &quot;friend_menu_option.auto_download_blacklist&quot;,
</a><a href="#h38-0-270" id="h38-0-270" class="i">+                        { context.feature(AntiAutoDownload::class).isUserIgnored(userId) },
</a><a href="#h38-0-271" id="h38-0-271" class="i">+                        { context.feature(AntiAutoDownload::class).setUserIgnored(userId, it) }
</a><a href="#h38-0-272" id="h38-0-272" class="i">+                    )
</a><a href="#h38-0-273" id="h38-0-273" class="i">+                }
</a><a href="#h38-0-274" id="h38-0-274" class="i">+            }
</a><a href="#h38-0-275" id="h38-0-275" class="i">+
</a><a href="#h38-0-276" id="h38-0-276" class="i">+            if (friendFeedMenuOptions[&quot;stealth_mode&quot;] == true) {
</a><a href="#h38-0-277" id="h38-0-277" class="i">+                viewConsumer(stealthSwitch)
</a><a href="#h38-0-278" id="h38-0-278" class="i">+            }
</a><a href="#h38-0-279" id="h38-0-279" class="i">+            if (friendFeedMenuOptions[&quot;conversation_info&quot;] == true) {
</a><a href="#h38-0-280" id="h38-0-280" class="i">+                viewConsumer(previewButton)
</a><a href="#h38-0-281" id="h38-0-281" class="i">+            }
</a><a href="#h38-0-282" id="h38-0-282" class="i">+            return
</a><a href="#h38-0-283" id="h38-0-283" class="i">+        }
</a><a href="#h38-0-284" id="h38-0-284" class="i">+
</a><a href="#h38-0-285" id="h38-0-285" class="i">+        val menuButtonBar = LinearLayout(viewModel.context).apply {
</a><a href="#h38-0-286" id="h38-0-286" class="i">+            layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT)
</a><a href="#h38-0-287" id="h38-0-287" class="i">+            orientation = LinearLayout.HORIZONTAL
</a><a href="#h38-0-288" id="h38-0-288" class="i">+            gravity = Gravity.CENTER
</a><a href="#h38-0-289" id="h38-0-289" class="i">+        }
</a><a href="#h38-0-290" id="h38-0-290" class="i">+
</a><a href="#h38-0-291" id="h38-0-291" class="i">+        fun createActionButton(icon: String, isDisabled: Boolean? = null, onClick: (Boolean) -&gt; Unit) {
</a><a href="#h38-0-292" id="h38-0-292" class="i">+            //FIXME: hardcoded values
</a><a href="#h38-0-293" id="h38-0-293" class="i">+            menuButtonBar.addView(LinearLayout(viewModel.context).apply {
</a><a href="#h38-0-294" id="h38-0-294" class="i">+                layoutParams = LinearLayout.LayoutParams(0, ViewGroup.LayoutParams.MATCH_PARENT, 1f)
</a><a href="#h38-0-295" id="h38-0-295" class="i">+                gravity = Gravity.CENTER
</a><a href="#h38-0-296" id="h38-0-296" class="i">+                isClickable = false
</a><a href="#h38-0-297" id="h38-0-297" class="i">+
</a><a href="#h38-0-298" id="h38-0-298" class="i">+                var isLineThrough = isDisabled ?: false
</a><a href="#h38-0-299" id="h38-0-299" class="i">+                FriendActionButton.new(viewModel.context).apply {
</a><a href="#h38-0-300" id="h38-0-300" class="i">+                    fun setLineThrough(value: Boolean) {
</a><a href="#h38-0-301" id="h38-0-301" class="i">+                        setIconDrawable(createEmojiDrawable(icon, 60, 60, 50f, if (isDisabled == null) false else value))
</a><a href="#h38-0-302" id="h38-0-302" class="i">+                    }
</a><a href="#h38-0-303" id="h38-0-303" class="i">+                    setLineThrough(isLineThrough)
</a><a href="#h38-0-304" id="h38-0-304" class="i">+                    (instanceNonNull() as View).apply {
</a><a href="#h38-0-305" id="h38-0-305" class="i">+                        layoutParams = LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h38-0-306" id="h38-0-306" class="i">+                            setMargins(0, 40, 0, 40)
</a><a href="#h38-0-307" id="h38-0-307" class="i">+                        }
</a><a href="#h38-0-308" id="h38-0-308" class="i">+                        setOnTouchListener { _, event -&gt;
</a><a href="#h38-0-309" id="h38-0-309" class="i">+                            if (event.action == MotionEvent.ACTION_UP) {
</a><a href="#h38-0-310" id="h38-0-310" class="i">+                                isLineThrough = !isLineThrough
</a><a href="#h38-0-311" id="h38-0-311" class="i">+                                onClick(isLineThrough)
</a><a href="#h38-0-312" id="h38-0-312" class="i">+                                setLineThrough(isLineThrough)
</a><a href="#h38-0-313" id="h38-0-313" class="i">+                            }
</a><a href="#h38-0-314" id="h38-0-314" class="i">+                            false
</a><a href="#h38-0-315" id="h38-0-315" class="i">+                        }
</a><a href="#h38-0-316" id="h38-0-316" class="i">+                    }
</a><a href="#h38-0-317" id="h38-0-317" class="i">+
</a><a href="#h38-0-318" id="h38-0-318" class="i">+                }.also { addView(it.instanceNonNull() as View) }
</a><a href="#h38-0-319" id="h38-0-319" class="i">+
</a><a href="#h38-0-320" id="h38-0-320" class="i">+            })
</a><a href="#h38-0-321" id="h38-0-321" class="i">+        }
</a><a href="#h38-0-322" id="h38-0-322" class="i">+
</a><a href="#h38-0-323" id="h38-0-323" class="i">+        if (friendFeedMenuOptions[&quot;auto_download_blacklist&quot;] == true) {
</a><a href="#h38-0-324" id="h38-0-324" class="i">+            run {
</a><a href="#h38-0-325" id="h38-0-325" class="i">+                val userId =
</a><a href="#h38-0-326" id="h38-0-326" class="i">+                    context.database.getFriendFeedInfoByConversationId(conversationId)?.friendUserId
</a><a href="#h38-0-327" id="h38-0-327" class="i">+                        ?: return@run
</a><a href="#h38-0-328" id="h38-0-328" class="i">+                createActionButton(
</a><a href="#h38-0-329" id="h38-0-329" class="i">+                    &quot;\u2B07\uFE0F&quot;,
</a><a href="#h38-0-330" id="h38-0-330" class="i">+                    isDisabled = !context.feature(AntiAutoDownload::class).isUserIgnored(userId)
</a><a href="#h38-0-331" id="h38-0-331" class="i">+                ) {
</a><a href="#h38-0-332" id="h38-0-332" class="i">+                    context.feature(AntiAutoDownload::class).setUserIgnored(userId, !it)
</a><a href="#h38-0-333" id="h38-0-333" class="i">+                }
</a><a href="#h38-0-334" id="h38-0-334" class="i">+            }
</a><a href="#h38-0-335" id="h38-0-335" class="i">+        }
</a><a href="#h38-0-336" id="h38-0-336" class="i">+
</a><a href="#h38-0-337" id="h38-0-337" class="i">+        if (friendFeedMenuOptions[&quot;anti_auto_save&quot;] == true) {
</a><a href="#h38-0-338" id="h38-0-338" class="i">+            //diskette
</a><a href="#h38-0-339" id="h38-0-339" class="i">+            createActionButton(&quot;\uD83D\uDCAC&quot;,
</a><a href="#h38-0-340" id="h38-0-340" class="i">+                isDisabled = !context.feature(AntiAutoSave::class)
</a><a href="#h38-0-341" id="h38-0-341" class="i">+                    .isConversationIgnored(conversationId)
</a><a href="#h38-0-342" id="h38-0-342" class="i">+            ) {
</a><a href="#h38-0-343" id="h38-0-343" class="i">+                context.feature(AntiAutoSave::class).setConversationIgnored(conversationId, !it)
</a><a href="#h38-0-344" id="h38-0-344" class="i">+            }
</a><a href="#h38-0-345" id="h38-0-345" class="i">+        }
</a><a href="#h38-0-346" id="h38-0-346" class="i">+
</a><a href="#h38-0-347" id="h38-0-347" class="i">+
</a><a href="#h38-0-348" id="h38-0-348" class="i">+        if (friendFeedMenuOptions[&quot;stealth_mode&quot;] == true) {
</a><a href="#h38-0-349" id="h38-0-349" class="i">+            //eyes
</a><a href="#h38-0-350" id="h38-0-350" class="i">+            createActionButton(
</a><a href="#h38-0-351" id="h38-0-351" class="i">+                &quot;\uD83D\uDC7B&quot;,
</a><a href="#h38-0-352" id="h38-0-352" class="i">+                isDisabled = !context.feature(StealthMode::class).isStealth(conversationId)
</a><a href="#h38-0-353" id="h38-0-353" class="i">+            ) { isChecked -&gt;
</a><a href="#h38-0-354" id="h38-0-354" class="i">+                context.feature(StealthMode::class).setStealth(
</a><a href="#h38-0-355" id="h38-0-355" class="i">+                    conversationId,
</a><a href="#h38-0-356" id="h38-0-356" class="i">+                    !isChecked
</a><a href="#h38-0-357" id="h38-0-357" class="i">+                )
</a><a href="#h38-0-358" id="h38-0-358" class="i">+            }
</a><a href="#h38-0-359" id="h38-0-359" class="i">+        }
</a><a href="#h38-0-360" id="h38-0-360" class="i">+
</a><a href="#h38-0-361" id="h38-0-361" class="i">+        if (friendFeedMenuOptions[&quot;conversation_info&quot;] == true) {
</a><a href="#h38-0-362" id="h38-0-362" class="i">+            //user
</a><a href="#h38-0-363" id="h38-0-363" class="i">+            createActionButton(&quot;\uD83D\uDC64&quot;) {
</a><a href="#h38-0-364" id="h38-0-364" class="i">+                showPreview(
</a><a href="#h38-0-365" id="h38-0-365" class="i">+                    targetUser,
</a><a href="#h38-0-366" id="h38-0-366" class="i">+                    conversationId,
</a><a href="#h38-0-367" id="h38-0-367" class="i">+                    viewModel.context
</a><a href="#h38-0-368" id="h38-0-368" class="i">+                )
</a><a href="#h38-0-369" id="h38-0-369" class="i">+            }
</a><a href="#h38-0-370" id="h38-0-370" class="i">+        }
</a><a href="#h38-0-371" id="h38-0-371" class="i">+
</a><a href="#h38-0-372" id="h38-0-372" class="i">+        viewConsumer(menuButtonBar)
</a><a href="#h38-0-373" id="h38-0-373" class="i">+    }
</a><a href="#h38-0-374" id="h38-0-374" class="i">+}</a><a href="#h38-0-375" id="h38-0-375" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h39" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -0,0 +1,134 @@
</a><a href="#h39-0-0" id="h39-0-0" class="i">+package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h39-0-1" id="h39-0-1" class="i">+
</a><a href="#h39-0-2" id="h39-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h39-0-3" id="h39-0-3" class="i">+import android.view.Gravity
</a><a href="#h39-0-4" id="h39-0-4" class="i">+import android.view.View
</a><a href="#h39-0-5" id="h39-0-5" class="i">+import android.view.ViewGroup
</a><a href="#h39-0-6" id="h39-0-6" class="i">+import android.widget.FrameLayout
</a><a href="#h39-0-7" id="h39-0-7" class="i">+import android.widget.LinearLayout
</a><a href="#h39-0-8" id="h39-0-8" class="i">+import de.robv.android.xposed.XC_MethodHook.Unhook
</a><a href="#h39-0-9" id="h39-0-9" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h39-0-10" id="h39-0-10" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h39-0-11" id="h39-0-11" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h39-0-12" id="h39-0-12" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h39-0-13" id="h39-0-13" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h39-0-14" id="h39-0-14" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h39-0-15" id="h39-0-15" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h39-0-16" id="h39-0-16" class="i">+import java.lang.reflect.Modifier
</a><a href="#h39-0-17" id="h39-0-17" class="i">+
</a><a href="#h39-0-18" id="h39-0-18" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h39-0-19" id="h39-0-19" class="i">+class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h39-0-20" id="h39-0-20" class="i">+    private val friendFeedInfoMenu = FriendFeedInfoMenu()
</a><a href="#h39-0-21" id="h39-0-21" class="i">+    private val operaContextActionMenu = OperaContextActionMenu()
</a><a href="#h39-0-22" id="h39-0-22" class="i">+    private val chatActionMenu = ChatActionMenu()
</a><a href="#h39-0-23" id="h39-0-23" class="i">+    private val settingMenu = SettingsMenu()
</a><a href="#h39-0-24" id="h39-0-24" class="i">+
</a><a href="#h39-0-25" id="h39-0-25" class="i">+    private val newChatString by lazy {
</a><a href="#h39-0-26" id="h39-0-26" class="i">+        context.resources.getString(context.resources.getIdentifier(&quot;new_chat&quot;, &quot;string&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h39-0-27" id="h39-0-27" class="i">+    }
</a><a href="#h39-0-28" id="h39-0-28" class="i">+
</a><a href="#h39-0-29" id="h39-0-29" class="i">+    private val fetchConversationHooks = mutableSetOf&lt;Unhook&gt;()
</a><a href="#h39-0-30" id="h39-0-30" class="i">+
</a><a href="#h39-0-31" id="h39-0-31" class="i">+    private fun unhookFetchConversation() {
</a><a href="#h39-0-32" id="h39-0-32" class="i">+        fetchConversationHooks.let {
</a><a href="#h39-0-33" id="h39-0-33" class="i">+            it.removeIf { hook -&gt; hook.unhook() ; true}
</a><a href="#h39-0-34" id="h39-0-34" class="i">+        }
</a><a href="#h39-0-35" id="h39-0-35" class="i">+    }
</a><a href="#h39-0-36" id="h39-0-36" class="i">+
</a><a href="#h39-0-37" id="h39-0-37" class="i">+    @SuppressLint(&quot;ResourceType&quot;)
</a><a href="#h39-0-38" id="h39-0-38" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h39-0-39" id="h39-0-39" class="i">+        friendFeedInfoMenu.context = context
</a><a href="#h39-0-40" id="h39-0-40" class="i">+        operaContextActionMenu.context = context
</a><a href="#h39-0-41" id="h39-0-41" class="i">+        chatActionMenu.context = context
</a><a href="#h39-0-42" id="h39-0-42" class="i">+        settingMenu.context = context
</a><a href="#h39-0-43" id="h39-0-43" class="i">+
</a><a href="#h39-0-44" id="h39-0-44" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h39-0-45" id="h39-0-45" class="i">+
</a><a href="#h39-0-46" id="h39-0-46" class="i">+        val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h39-0-47" id="h39-0-47" class="i">+        val actionSheetContainer = context.resources.getIdentifier(&quot;action_sheet_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h39-0-48" id="h39-0-48" class="i">+        val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h39-0-49" id="h39-0-49" class="i">+
</a><a href="#h39-0-50" id="h39-0-50" class="i">+        val addViewMethod = ViewGroup::class.java.getMethod(
</a><a href="#h39-0-51" id="h39-0-51" class="i">+            &quot;addView&quot;,
</a><a href="#h39-0-52" id="h39-0-52" class="i">+            View::class.java,
</a><a href="#h39-0-53" id="h39-0-53" class="i">+            Int::class.javaPrimitiveType,
</a><a href="#h39-0-54" id="h39-0-54" class="i">+            ViewGroup.LayoutParams::class.java
</a><a href="#h39-0-55" id="h39-0-55" class="i">+        )
</a><a href="#h39-0-56" id="h39-0-56" class="i">+
</a><a href="#h39-0-57" id="h39-0-57" class="i">+        Hooker.hook(addViewMethod, HookStage.BEFORE) { param -&gt;
</a><a href="#h39-0-58" id="h39-0-58" class="i">+            val viewGroup: ViewGroup = param.thisObject()
</a><a href="#h39-0-59" id="h39-0-59" class="i">+            val originalAddView: (View) -&gt; Unit = {
</a><a href="#h39-0-60" id="h39-0-60" class="i">+                param.invokeOriginal(arrayOf(it, -1,
</a><a href="#h39-0-61" id="h39-0-61" class="i">+                    FrameLayout.LayoutParams(
</a><a href="#h39-0-62" id="h39-0-62" class="i">+                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h39-0-63" id="h39-0-63" class="i">+                        ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h39-0-64" id="h39-0-64" class="i">+                    ))
</a><a href="#h39-0-65" id="h39-0-65" class="i">+                )
</a><a href="#h39-0-66" id="h39-0-66" class="i">+            }
</a><a href="#h39-0-67" id="h39-0-67" class="i">+
</a><a href="#h39-0-68" id="h39-0-68" class="i">+            val childView: View = param.arg(0)
</a><a href="#h39-0-69" id="h39-0-69" class="i">+            operaContextActionMenu.inject(viewGroup, childView)
</a><a href="#h39-0-70" id="h39-0-70" class="i">+
</a><a href="#h39-0-71" id="h39-0-71" class="i">+            //download in chat snaps and notes from the chat action menu
</a><a href="#h39-0-72" id="h39-0-72" class="i">+            if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;)) {
</a><a href="#h39-0-73" id="h39-0-73" class="i">+                if (viewGroup.parent == null || viewGroup.parent.parent == null) return@hook
</a><a href="#h39-0-74" id="h39-0-74" class="i">+                chatActionMenu.inject(viewGroup)
</a><a href="#h39-0-75" id="h39-0-75" class="i">+                return@hook
</a><a href="#h39-0-76" id="h39-0-76" class="i">+            }
</a><a href="#h39-0-77" id="h39-0-77" class="i">+
</a><a href="#h39-0-78" id="h39-0-78" class="i">+            //TODO: inject in group chat menus
</a><a href="#h39-0-79" id="h39-0-79" class="i">+            if (viewGroup.id == actionSheetContainer &amp;&amp; childView.id == actionMenu) {
</a><a href="#h39-0-80" id="h39-0-80" class="i">+                val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h39-0-81" id="h39-0-81" class="i">+                    orientation = LinearLayout.VERTICAL
</a><a href="#h39-0-82" id="h39-0-82" class="i">+                    gravity = Gravity.BOTTOM
</a><a href="#h39-0-83" id="h39-0-83" class="i">+                    layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h39-0-84" id="h39-0-84" class="i">+                    addView(childView)
</a><a href="#h39-0-85" id="h39-0-85" class="i">+                }
</a><a href="#h39-0-86" id="h39-0-86" class="i">+
</a><a href="#h39-0-87" id="h39-0-87" class="i">+                fun injectView() {
</a><a href="#h39-0-88" id="h39-0-88" class="i">+                    val viewList = mutableListOf&lt;View&gt;()
</a><a href="#h39-0-89" id="h39-0-89" class="i">+                    friendFeedInfoMenu.inject(injectedLayout) { view -&gt;
</a><a href="#h39-0-90" id="h39-0-90" class="i">+                        view.layoutParams = LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h39-0-91" id="h39-0-91" class="i">+                            setMargins(0, 10, 0, 10)
</a><a href="#h39-0-92" id="h39-0-92" class="i">+                        }
</a><a href="#h39-0-93" id="h39-0-93" class="i">+                        viewList.add(view)
</a><a href="#h39-0-94" id="h39-0-94" class="i">+                    }
</a><a href="#h39-0-95" id="h39-0-95" class="i">+                    viewList.reversed().forEach { injectedLayout.addView(it, 0) }
</a><a href="#h39-0-96" id="h39-0-96" class="i">+                }
</a><a href="#h39-0-97" id="h39-0-97" class="i">+
</a><a href="#h39-0-98" id="h39-0-98" class="i">+                param.setArg(0, injectedLayout)
</a><a href="#h39-0-99" id="h39-0-99" class="i">+            }
</a><a href="#h39-0-100" id="h39-0-100" class="i">+
</a><a href="#h39-0-101" id="h39-0-101" class="i">+            if (viewGroup is LinearLayout &amp;&amp; viewGroup.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h39-0-102" id="h39-0-102" class="i">+                val itemStringInterface by lazy {
</a><a href="#h39-0-103" id="h39-0-103" class="i">+                    childView.javaClass.declaredFields.filter {
</a><a href="#h39-0-104" id="h39-0-104" class="i">+                        !it.type.isPrimitive &amp;&amp; Modifier.isAbstract(it.type.modifiers)
</a><a href="#h39-0-105" id="h39-0-105" class="i">+                    }.map {
</a><a href="#h39-0-106" id="h39-0-106" class="i">+                        runCatching {
</a><a href="#h39-0-107" id="h39-0-107" class="i">+                            it.isAccessible = true
</a><a href="#h39-0-108" id="h39-0-108" class="i">+                            it[childView]
</a><a href="#h39-0-109" id="h39-0-109" class="i">+                        }.getOrNull()
</a><a href="#h39-0-110" id="h39-0-110" class="i">+                    }.firstOrNull()
</a><a href="#h39-0-111" id="h39-0-111" class="i">+                }
</a><a href="#h39-0-112" id="h39-0-112" class="i">+
</a><a href="#h39-0-113" id="h39-0-113" class="i">+                //the 3 dot button shows a menu which contains the first item as a Plain object
</a><a href="#h39-0-114" id="h39-0-114" class="i">+                if (viewGroup.getChildCount() == 0 &amp;&amp; itemStringInterface != null &amp;&amp; itemStringInterface.toString().startsWith(&quot;Plain(primaryText=$newChatString&quot;)) {
</a><a href="#h39-0-115" id="h39-0-115" class="i">+                    settingMenu.inject(viewGroup, originalAddView)
</a><a href="#h39-0-116" id="h39-0-116" class="i">+                    viewGroup.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h39-0-117" id="h39-0-117" class="i">+                        override fun onViewAttachedToWindow(v: View) {}
</a><a href="#h39-0-118" id="h39-0-118" class="i">+                        override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h39-0-119" id="h39-0-119" class="i">+                            context.config.writeConfig()
</a><a href="#h39-0-120" id="h39-0-120" class="i">+                        }
</a><a href="#h39-0-121" id="h39-0-121" class="i">+                    })
</a><a href="#h39-0-122" id="h39-0-122" class="i">+                    return@hook
</a><a href="#h39-0-123" id="h39-0-123" class="i">+                }
</a><a href="#h39-0-124" id="h39-0-124" class="i">+                if (messaging.lastFetchConversationUUID == null || messaging.lastFetchConversationUserUUID == null) return@hook
</a><a href="#h39-0-125" id="h39-0-125" class="i">+
</a><a href="#h39-0-126" id="h39-0-126" class="i">+                //filter by the slot index
</a><a href="#h39-0-127" id="h39-0-127" class="i">+                if (viewGroup.getChildCount() != context.config.int(ConfigProperty.MENU_SLOT_ID)) return@hook
</a><a href="#h39-0-128" id="h39-0-128" class="i">+                friendFeedInfoMenu.inject(viewGroup, originalAddView)
</a><a href="#h39-0-129" id="h39-0-129" class="i">+            }
</a><a href="#h39-0-130" id="h39-0-130" class="i">+        }
</a><a href="#h39-0-131" id="h39-0-131" class="i">+    }
</a><a href="#h39-0-132" id="h39-0-132" class="i">+
</a><a href="#h39-0-133" id="h39-0-133" class="i">+}</a><a href="#h39-0-134" id="h39-0-134" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h40" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -0,0 +1,82 @@
</a><a href="#h40-0-0" id="h40-0-0" class="i">+package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h40-0-1" id="h40-0-1" class="i">+
</a><a href="#h40-0-2" id="h40-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h40-0-3" id="h40-0-3" class="i">+import android.view.Gravity
</a><a href="#h40-0-4" id="h40-0-4" class="i">+import android.view.View
</a><a href="#h40-0-5" id="h40-0-5" class="i">+import android.view.ViewGroup
</a><a href="#h40-0-6" id="h40-0-6" class="i">+import android.widget.Button
</a><a href="#h40-0-7" id="h40-0-7" class="i">+import android.widget.LinearLayout
</a><a href="#h40-0-8" id="h40-0-8" class="i">+import android.widget.ScrollView
</a><a href="#h40-0-9" id="h40-0-9" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h40-0-10" id="h40-0-10" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h40-0-11" id="h40-0-11" class="i">+import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h40-0-12" id="h40-0-12" class="i">+import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h40-0-13" id="h40-0-13" class="i">+import me.rhunk.snapenhance.ui.menu.ViewAppearanceHelper.applyTheme
</a><a href="#h40-0-14" id="h40-0-14" class="i">+
</a><a href="#h40-0-15" id="h40-0-15" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h40-0-16" id="h40-0-16" class="i">+class OperaContextActionMenu : AbstractMenu() {
</a><a href="#h40-0-17" id="h40-0-17" class="i">+    private val contextCardsScrollView by lazy {
</a><a href="#h40-0-18" id="h40-0-18" class="i">+        context.resources.getIdentifier(&quot;context_cards_scroll_view&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h40-0-19" id="h40-0-19" class="i">+    }
</a><a href="#h40-0-20" id="h40-0-20" class="i">+
</a><a href="#h40-0-21" id="h40-0-21" class="i">+    /*
</a><a href="#h40-0-22" id="h40-0-22" class="i">+    LinearLayout :
</a><a href="#h40-0-23" id="h40-0-23" class="i">+        - LinearLayout:
</a><a href="#h40-0-24" id="h40-0-24" class="i">+            - SnapFontTextView
</a><a href="#h40-0-25" id="h40-0-25" class="i">+            - ImageView
</a><a href="#h40-0-26" id="h40-0-26" class="i">+        - LinearLayout:
</a><a href="#h40-0-27" id="h40-0-27" class="i">+            - SnapFontTextView
</a><a href="#h40-0-28" id="h40-0-28" class="i">+            - ImageView
</a><a href="#h40-0-29" id="h40-0-29" class="i">+        - LinearLayout:
</a><a href="#h40-0-30" id="h40-0-30" class="i">+            - SnapFontTextView
</a><a href="#h40-0-31" id="h40-0-31" class="i">+            - ImageView
</a><a href="#h40-0-32" id="h40-0-32" class="i">+     */
</a><a href="#h40-0-33" id="h40-0-33" class="i">+    private fun isViewGroupButtonMenuContainer(viewGroup: ViewGroup): Boolean {
</a><a href="#h40-0-34" id="h40-0-34" class="i">+        if (viewGroup !is LinearLayout) return false
</a><a href="#h40-0-35" id="h40-0-35" class="i">+        val children = ArrayList&lt;View&gt;()
</a><a href="#h40-0-36" id="h40-0-36" class="i">+        for (i in 0 until viewGroup.getChildCount())
</a><a href="#h40-0-37" id="h40-0-37" class="i">+            children.add(viewGroup.getChildAt(i))
</a><a href="#h40-0-38" id="h40-0-38" class="i">+        return if (children.any { view: View? -&gt; view !is LinearLayout })
</a><a href="#h40-0-39" id="h40-0-39" class="i">+            false
</a><a href="#h40-0-40" id="h40-0-40" class="i">+        else children.map { view: View -&gt; view as LinearLayout }
</a><a href="#h40-0-41" id="h40-0-41" class="i">+            .any { linearLayout: LinearLayout -&gt;
</a><a href="#h40-0-42" id="h40-0-42" class="i">+                val viewChildren = ArrayList&lt;View&gt;()
</a><a href="#h40-0-43" id="h40-0-43" class="i">+                for (i in 0 until linearLayout.childCount) viewChildren.add(
</a><a href="#h40-0-44" id="h40-0-44" class="i">+                    linearLayout.getChildAt(
</a><a href="#h40-0-45" id="h40-0-45" class="i">+                        i
</a><a href="#h40-0-46" id="h40-0-46" class="i">+                    )
</a><a href="#h40-0-47" id="h40-0-47" class="i">+                )
</a><a href="#h40-0-48" id="h40-0-48" class="i">+                viewChildren.any { viewChild: View -&gt;
</a><a href="#h40-0-49" id="h40-0-49" class="i">+                    viewChild.javaClass.name.endsWith(&quot;SnapFontTextView&quot;)
</a><a href="#h40-0-50" id="h40-0-50" class="i">+                }
</a><a href="#h40-0-51" id="h40-0-51" class="i">+            }
</a><a href="#h40-0-52" id="h40-0-52" class="i">+    }
</a><a href="#h40-0-53" id="h40-0-53" class="i">+
</a><a href="#h40-0-54" id="h40-0-54" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h40-0-55" id="h40-0-55" class="i">+    fun inject(viewGroup: ViewGroup, childView: View) {
</a><a href="#h40-0-56" id="h40-0-56" class="i">+        try {
</a><a href="#h40-0-57" id="h40-0-57" class="i">+            if (viewGroup.parent !is ScrollView) return
</a><a href="#h40-0-58" id="h40-0-58" class="i">+            val parent = viewGroup.parent as ScrollView
</a><a href="#h40-0-59" id="h40-0-59" class="i">+            if (parent.id != contextCardsScrollView) return
</a><a href="#h40-0-60" id="h40-0-60" class="i">+            if (childView !is LinearLayout) return
</a><a href="#h40-0-61" id="h40-0-61" class="i">+            if (!isViewGroupButtonMenuContainer(childView as ViewGroup)) return
</a><a href="#h40-0-62" id="h40-0-62" class="i">+
</a><a href="#h40-0-63" id="h40-0-63" class="i">+            val linearLayout = LinearLayout(childView.getContext())
</a><a href="#h40-0-64" id="h40-0-64" class="i">+            linearLayout.orientation = LinearLayout.VERTICAL
</a><a href="#h40-0-65" id="h40-0-65" class="i">+            linearLayout.gravity = Gravity.CENTER
</a><a href="#h40-0-66" id="h40-0-66" class="i">+            linearLayout.layoutParams =
</a><a href="#h40-0-67" id="h40-0-67" class="i">+                LinearLayout.LayoutParams(
</a><a href="#h40-0-68" id="h40-0-68" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h40-0-69" id="h40-0-69" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h40-0-70" id="h40-0-70" class="i">+                )
</a><a href="#h40-0-71" id="h40-0-71" class="i">+            val button = Button(childView.getContext())
</a><a href="#h40-0-72" id="h40-0-72" class="i">+            button.text = context.translation.get(&quot;opera_context_menu.download&quot;)
</a><a href="#h40-0-73" id="h40-0-73" class="i">+            button.setOnClickListener { context.feature(MediaDownloader::class).downloadLastOperaMediaAsync() }
</a><a href="#h40-0-74" id="h40-0-74" class="i">+            applyTheme(button)
</a><a href="#h40-0-75" id="h40-0-75" class="i">+            linearLayout.addView(button)
</a><a href="#h40-0-76" id="h40-0-76" class="i">+            (childView as ViewGroup).addView(linearLayout, 0)
</a><a href="#h40-0-77" id="h40-0-77" class="i">+        } catch (e: Throwable) {
</a><a href="#h40-0-78" id="h40-0-78" class="i">+            Logger.xposedLog(e)
</a><a href="#h40-0-79" id="h40-0-79" class="i">+        }
</a><a href="#h40-0-80" id="h40-0-80" class="i">+    }
</a><a href="#h40-0-81" id="h40-0-81" class="i">+}
</a><b>diff --git a/<a id="h41" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -0,0 +1,242 @@
</a><a href="#h41-0-0" id="h41-0-0" class="i">+package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h41-0-1" id="h41-0-1" class="i">+
</a><a href="#h41-0-2" id="h41-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h41-0-3" id="h41-0-3" class="i">+import android.app.AlertDialog
</a><a href="#h41-0-4" id="h41-0-4" class="i">+import android.graphics.Color
</a><a href="#h41-0-5" id="h41-0-5" class="i">+import android.graphics.Typeface
</a><a href="#h41-0-6" id="h41-0-6" class="i">+import android.text.InputType
</a><a href="#h41-0-7" id="h41-0-7" class="i">+import android.view.View
</a><a href="#h41-0-8" id="h41-0-8" class="i">+import android.widget.Button
</a><a href="#h41-0-9" id="h41-0-9" class="i">+import android.widget.EditText
</a><a href="#h41-0-10" id="h41-0-10" class="i">+import android.widget.LinearLayout
</a><a href="#h41-0-11" id="h41-0-11" class="i">+import android.widget.Switch
</a><a href="#h41-0-12" id="h41-0-12" class="i">+import android.widget.TextView
</a><a href="#h41-0-13" id="h41-0-13" class="i">+import me.rhunk.snapenhance.BuildConfig
</a><a href="#h41-0-14" id="h41-0-14" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h41-0-15" id="h41-0-15" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h41-0-16" id="h41-0-16" class="i">+import me.rhunk.snapenhance.config.impl.ConfigIntegerValue
</a><a href="#h41-0-17" id="h41-0-17" class="i">+import me.rhunk.snapenhance.config.impl.ConfigStateListValue
</a><a href="#h41-0-18" id="h41-0-18" class="i">+import me.rhunk.snapenhance.config.impl.ConfigStateSelection
</a><a href="#h41-0-19" id="h41-0-19" class="i">+import me.rhunk.snapenhance.config.impl.ConfigStateValue
</a><a href="#h41-0-20" id="h41-0-20" class="i">+import me.rhunk.snapenhance.config.impl.ConfigStringValue
</a><a href="#h41-0-21" id="h41-0-21" class="i">+import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h41-0-22" id="h41-0-22" class="i">+import me.rhunk.snapenhance.ui.menu.ViewAppearanceHelper
</a><a href="#h41-0-23" id="h41-0-23" class="i">+
</a><a href="#h41-0-24" id="h41-0-24" class="i">+class SettingsMenu : AbstractMenu() {
</a><a href="#h41-0-25" id="h41-0-25" class="i">+    @SuppressLint(&quot;ClickableViewAccessibility&quot;)
</a><a href="#h41-0-26" id="h41-0-26" class="i">+    private fun createCategoryTitle(key: String): TextView {
</a><a href="#h41-0-27" id="h41-0-27" class="i">+        val categoryText = TextView(context.androidContext)
</a><a href="#h41-0-28" id="h41-0-28" class="i">+        categoryText.text = context.translation.get(key)
</a><a href="#h41-0-29" id="h41-0-29" class="i">+        ViewAppearanceHelper.applyTheme(categoryText)
</a><a href="#h41-0-30" id="h41-0-30" class="i">+        categoryText.textSize = 20f
</a><a href="#h41-0-31" id="h41-0-31" class="i">+        categoryText.typeface = categoryText.typeface?.let { Typeface.create(it, Typeface.BOLD) }
</a><a href="#h41-0-32" id="h41-0-32" class="i">+        categoryText.setOnTouchListener { _, _ -&gt; true }
</a><a href="#h41-0-33" id="h41-0-33" class="i">+        return categoryText
</a><a href="#h41-0-34" id="h41-0-34" class="i">+    }
</a><a href="#h41-0-35" id="h41-0-35" class="i">+
</a><a href="#h41-0-36" id="h41-0-36" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h41-0-37" id="h41-0-37" class="i">+    private fun createPropertyView(property: ConfigProperty): View {
</a><a href="#h41-0-38" id="h41-0-38" class="i">+        val propertyName = context.translation.get(property.nameKey)
</a><a href="#h41-0-39" id="h41-0-39" class="i">+        val updateButtonText: (TextView, String) -&gt; Unit = { textView, text -&gt;
</a><a href="#h41-0-40" id="h41-0-40" class="i">+            textView.text = &quot;$propertyName${if (text.isEmpty()) &quot;&quot; else &quot;: $text&quot;}&quot;
</a><a href="#h41-0-41" id="h41-0-41" class="i">+        }
</a><a href="#h41-0-42" id="h41-0-42" class="i">+
</a><a href="#h41-0-43" id="h41-0-43" class="i">+        val updateLocalizedText: (TextView, String) -&gt; Unit = { textView, value -&gt;
</a><a href="#h41-0-44" id="h41-0-44" class="i">+            updateButtonText(textView, value.let {
</a><a href="#h41-0-45" id="h41-0-45" class="i">+                if (it.isEmpty()) {
</a><a href="#h41-0-46" id="h41-0-46" class="i">+                    &quot;(empty)&quot;
</a><a href="#h41-0-47" id="h41-0-47" class="i">+                }
</a><a href="#h41-0-48" id="h41-0-48" class="i">+                else {
</a><a href="#h41-0-49" id="h41-0-49" class="i">+                    if (property.disableValueLocalization) {
</a><a href="#h41-0-50" id="h41-0-50" class="i">+                        it
</a><a href="#h41-0-51" id="h41-0-51" class="i">+                    } else {
</a><a href="#h41-0-52" id="h41-0-52" class="i">+                        context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it)
</a><a href="#h41-0-53" id="h41-0-53" class="i">+                    }
</a><a href="#h41-0-54" id="h41-0-54" class="i">+                }
</a><a href="#h41-0-55" id="h41-0-55" class="i">+            })
</a><a href="#h41-0-56" id="h41-0-56" class="i">+        }
</a><a href="#h41-0-57" id="h41-0-57" class="i">+
</a><a href="#h41-0-58" id="h41-0-58" class="i">+        val textEditor: ((String) -&gt; Unit) -&gt; Unit = { updateValue -&gt;
</a><a href="#h41-0-59" id="h41-0-59" class="i">+            val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h41-0-60" id="h41-0-60" class="i">+            builder.setTitle(propertyName)
</a><a href="#h41-0-61" id="h41-0-61" class="i">+
</a><a href="#h41-0-62" id="h41-0-62" class="i">+            val input = EditText(context.androidContext)
</a><a href="#h41-0-63" id="h41-0-63" class="i">+            input.inputType = InputType.TYPE_CLASS_TEXT
</a><a href="#h41-0-64" id="h41-0-64" class="i">+            input.setText(property.valueContainer.value().toString())
</a><a href="#h41-0-65" id="h41-0-65" class="i">+
</a><a href="#h41-0-66" id="h41-0-66" class="i">+            builder.setView(input)
</a><a href="#h41-0-67" id="h41-0-67" class="i">+            builder.setPositiveButton(&quot;OK&quot;) { _, _ -&gt;
</a><a href="#h41-0-68" id="h41-0-68" class="i">+                updateValue(input.text.toString())
</a><a href="#h41-0-69" id="h41-0-69" class="i">+            }
</a><a href="#h41-0-70" id="h41-0-70" class="i">+
</a><a href="#h41-0-71" id="h41-0-71" class="i">+            builder.setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.cancel() }
</a><a href="#h41-0-72" id="h41-0-72" class="i">+            builder.show()
</a><a href="#h41-0-73" id="h41-0-73" class="i">+        }
</a><a href="#h41-0-74" id="h41-0-74" class="i">+
</a><a href="#h41-0-75" id="h41-0-75" class="i">+        val resultView: View = when (property.valueContainer) {
</a><a href="#h41-0-76" id="h41-0-76" class="i">+            is ConfigStringValue -&gt; {
</a><a href="#h41-0-77" id="h41-0-77" class="i">+                val textView = TextView(context.androidContext)
</a><a href="#h41-0-78" id="h41-0-78" class="i">+                updateButtonText(textView, property.valueContainer.let {
</a><a href="#h41-0-79" id="h41-0-79" class="i">+                    if (it.isHidden) it.hiddenValue()
</a><a href="#h41-0-80" id="h41-0-80" class="i">+                    else it.value()
</a><a href="#h41-0-81" id="h41-0-81" class="i">+                })
</a><a href="#h41-0-82" id="h41-0-82" class="i">+                ViewAppearanceHelper.applyTheme(textView)
</a><a href="#h41-0-83" id="h41-0-83" class="i">+                textView.setOnClickListener {
</a><a href="#h41-0-84" id="h41-0-84" class="i">+                    textEditor { value -&gt;
</a><a href="#h41-0-85" id="h41-0-85" class="i">+                        property.valueContainer.writeFrom(value)
</a><a href="#h41-0-86" id="h41-0-86" class="i">+                        updateButtonText(textView, property.valueContainer.let {
</a><a href="#h41-0-87" id="h41-0-87" class="i">+                            if (it.isHidden) it.hiddenValue()
</a><a href="#h41-0-88" id="h41-0-88" class="i">+                            else it.value()
</a><a href="#h41-0-89" id="h41-0-89" class="i">+                        })
</a><a href="#h41-0-90" id="h41-0-90" class="i">+                    }
</a><a href="#h41-0-91" id="h41-0-91" class="i">+                }
</a><a href="#h41-0-92" id="h41-0-92" class="i">+                textView
</a><a href="#h41-0-93" id="h41-0-93" class="i">+            }
</a><a href="#h41-0-94" id="h41-0-94" class="i">+            is ConfigIntegerValue -&gt; {
</a><a href="#h41-0-95" id="h41-0-95" class="i">+                val button = Button(context.androidContext)
</a><a href="#h41-0-96" id="h41-0-96" class="i">+                updateButtonText(button, property.valueContainer.value().toString())
</a><a href="#h41-0-97" id="h41-0-97" class="i">+                button.setOnClickListener {
</a><a href="#h41-0-98" id="h41-0-98" class="i">+                    textEditor { value -&gt;
</a><a href="#h41-0-99" id="h41-0-99" class="i">+                        runCatching {
</a><a href="#h41-0-100" id="h41-0-100" class="i">+                            property.valueContainer.writeFrom(value)
</a><a href="#h41-0-101" id="h41-0-101" class="i">+                            updateButtonText(button, value)
</a><a href="#h41-0-102" id="h41-0-102" class="i">+                        }.onFailure {
</a><a href="#h41-0-103" id="h41-0-103" class="i">+                            context.shortToast(&quot;Invalid value&quot;)
</a><a href="#h41-0-104" id="h41-0-104" class="i">+                        }
</a><a href="#h41-0-105" id="h41-0-105" class="i">+                    }
</a><a href="#h41-0-106" id="h41-0-106" class="i">+                }
</a><a href="#h41-0-107" id="h41-0-107" class="i">+                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h41-0-108" id="h41-0-108" class="i">+                button
</a><a href="#h41-0-109" id="h41-0-109" class="i">+            }
</a><a href="#h41-0-110" id="h41-0-110" class="i">+            is ConfigStateValue -&gt; {
</a><a href="#h41-0-111" id="h41-0-111" class="i">+                val switch = Switch(context.androidContext)
</a><a href="#h41-0-112" id="h41-0-112" class="i">+                switch.text = propertyName
</a><a href="#h41-0-113" id="h41-0-113" class="i">+                switch.isChecked = property.valueContainer.value()
</a><a href="#h41-0-114" id="h41-0-114" class="i">+                switch.setOnCheckedChangeListener { _, isChecked -&gt;
</a><a href="#h41-0-115" id="h41-0-115" class="i">+                    property.valueContainer.writeFrom(isChecked.toString())
</a><a href="#h41-0-116" id="h41-0-116" class="i">+                }
</a><a href="#h41-0-117" id="h41-0-117" class="i">+                ViewAppearanceHelper.applyTheme(switch)
</a><a href="#h41-0-118" id="h41-0-118" class="i">+                switch
</a><a href="#h41-0-119" id="h41-0-119" class="i">+            }
</a><a href="#h41-0-120" id="h41-0-120" class="i">+            is ConfigStateSelection -&gt; {
</a><a href="#h41-0-121" id="h41-0-121" class="i">+                val button = Button(context.androidContext)
</a><a href="#h41-0-122" id="h41-0-122" class="i">+                updateLocalizedText(button, property.valueContainer.value())
</a><a href="#h41-0-123" id="h41-0-123" class="i">+
</a><a href="#h41-0-124" id="h41-0-124" class="i">+                button.setOnClickListener {_ -&gt;
</a><a href="#h41-0-125" id="h41-0-125" class="i">+                    val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h41-0-126" id="h41-0-126" class="i">+                    builder.setTitle(propertyName)
</a><a href="#h41-0-127" id="h41-0-127" class="i">+
</a><a href="#h41-0-128" id="h41-0-128" class="i">+                    builder.setSingleChoiceItems(
</a><a href="#h41-0-129" id="h41-0-129" class="i">+                        property.valueContainer.keys().toTypedArray().map {
</a><a href="#h41-0-130" id="h41-0-130" class="i">+                            if (property.disableValueLocalization) it
</a><a href="#h41-0-131" id="h41-0-131" class="i">+                            else context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it)
</a><a href="#h41-0-132" id="h41-0-132" class="i">+                        }.toTypedArray(),
</a><a href="#h41-0-133" id="h41-0-133" class="i">+                        property.valueContainer.keys().indexOf(property.valueContainer.value())
</a><a href="#h41-0-134" id="h41-0-134" class="i">+                    ) { _, which -&gt;
</a><a href="#h41-0-135" id="h41-0-135" class="i">+                        property.valueContainer.writeFrom(property.valueContainer.keys()[which])
</a><a href="#h41-0-136" id="h41-0-136" class="i">+                    }
</a><a href="#h41-0-137" id="h41-0-137" class="i">+
</a><a href="#h41-0-138" id="h41-0-138" class="i">+                    builder.setPositiveButton(&quot;OK&quot;) { _, _ -&gt;
</a><a href="#h41-0-139" id="h41-0-139" class="i">+                        updateLocalizedText(button, property.valueContainer.value())
</a><a href="#h41-0-140" id="h41-0-140" class="i">+                    }
</a><a href="#h41-0-141" id="h41-0-141" class="i">+
</a><a href="#h41-0-142" id="h41-0-142" class="i">+                    builder.show()
</a><a href="#h41-0-143" id="h41-0-143" class="i">+                }
</a><a href="#h41-0-144" id="h41-0-144" class="i">+                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h41-0-145" id="h41-0-145" class="i">+                button
</a><a href="#h41-0-146" id="h41-0-146" class="i">+            }
</a><a href="#h41-0-147" id="h41-0-147" class="i">+            is ConfigStateListValue -&gt; {
</a><a href="#h41-0-148" id="h41-0-148" class="i">+                val button = Button(context.androidContext)
</a><a href="#h41-0-149" id="h41-0-149" class="i">+                updateButtonText(button, &quot;(${property.valueContainer.value().count { it.value }})&quot;)
</a><a href="#h41-0-150" id="h41-0-150" class="i">+
</a><a href="#h41-0-151" id="h41-0-151" class="i">+                button.setOnClickListener {_ -&gt;
</a><a href="#h41-0-152" id="h41-0-152" class="i">+                    val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h41-0-153" id="h41-0-153" class="i">+                    builder.setTitle(propertyName)
</a><a href="#h41-0-154" id="h41-0-154" class="i">+
</a><a href="#h41-0-155" id="h41-0-155" class="i">+                    val sortedStates = property.valueContainer.value().toSortedMap()
</a><a href="#h41-0-156" id="h41-0-156" class="i">+
</a><a href="#h41-0-157" id="h41-0-157" class="i">+                    builder.setMultiChoiceItems(
</a><a href="#h41-0-158" id="h41-0-158" class="i">+                        sortedStates.toSortedMap().map {
</a><a href="#h41-0-159" id="h41-0-159" class="i">+                            if (property.disableValueLocalization) it.key
</a><a href="#h41-0-160" id="h41-0-160" class="i">+                            else context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it.key)
</a><a href="#h41-0-161" id="h41-0-161" class="i">+                        }.toTypedArray(),
</a><a href="#h41-0-162" id="h41-0-162" class="i">+                        sortedStates.map { it.value }.toBooleanArray()
</a><a href="#h41-0-163" id="h41-0-163" class="i">+                    ) { _, which, isChecked -&gt;
</a><a href="#h41-0-164" id="h41-0-164" class="i">+                        sortedStates.keys.toList()[which].let { key -&gt;
</a><a href="#h41-0-165" id="h41-0-165" class="i">+                            property.valueContainer.setKey(key, isChecked)
</a><a href="#h41-0-166" id="h41-0-166" class="i">+                        }
</a><a href="#h41-0-167" id="h41-0-167" class="i">+                    }
</a><a href="#h41-0-168" id="h41-0-168" class="i">+
</a><a href="#h41-0-169" id="h41-0-169" class="i">+                    builder.setPositiveButton(&quot;OK&quot;) { _, _ -&gt;
</a><a href="#h41-0-170" id="h41-0-170" class="i">+                        updateButtonText(button, &quot;(${property.valueContainer.value().count { it.value }})&quot;)
</a><a href="#h41-0-171" id="h41-0-171" class="i">+                    }
</a><a href="#h41-0-172" id="h41-0-172" class="i">+
</a><a href="#h41-0-173" id="h41-0-173" class="i">+                    builder.show()
</a><a href="#h41-0-174" id="h41-0-174" class="i">+                }
</a><a href="#h41-0-175" id="h41-0-175" class="i">+                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h41-0-176" id="h41-0-176" class="i">+                button
</a><a href="#h41-0-177" id="h41-0-177" class="i">+            }
</a><a href="#h41-0-178" id="h41-0-178" class="i">+            else -&gt; {
</a><a href="#h41-0-179" id="h41-0-179" class="i">+                TextView(context.androidContext)
</a><a href="#h41-0-180" id="h41-0-180" class="i">+            }
</a><a href="#h41-0-181" id="h41-0-181" class="i">+        }
</a><a href="#h41-0-182" id="h41-0-182" class="i">+        return resultView
</a><a href="#h41-0-183" id="h41-0-183" class="i">+    }
</a><a href="#h41-0-184" id="h41-0-184" class="i">+
</a><a href="#h41-0-185" id="h41-0-185" class="i">+    private fun newSeparator(thickness: Int, color: Int = Color.BLACK): View {
</a><a href="#h41-0-186" id="h41-0-186" class="i">+        return LinearLayout(context.mainActivity).apply {
</a><a href="#h41-0-187" id="h41-0-187" class="i">+            setPadding(0, 0, 0, thickness)
</a><a href="#h41-0-188" id="h41-0-188" class="i">+            setBackgroundColor(color)
</a><a href="#h41-0-189" id="h41-0-189" class="i">+        }
</a><a href="#h41-0-190" id="h41-0-190" class="i">+    }
</a><a href="#h41-0-191" id="h41-0-191" class="i">+
</a><a href="#h41-0-192" id="h41-0-192" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h41-0-193" id="h41-0-193" class="i">+    @Suppress(&quot;deprecation&quot;)
</a><a href="#h41-0-194" id="h41-0-194" class="i">+    fun inject(viewModel: View, addView: (View) -&gt; Unit) {
</a><a href="#h41-0-195" id="h41-0-195" class="i">+        val packageInfo = viewModel.context.packageManager.getPackageInfo(Constants.SNAPCHAT_PACKAGE_NAME, 0)
</a><a href="#h41-0-196" id="h41-0-196" class="i">+        val versionTextBuilder = StringBuilder()
</a><a href="#h41-0-197" id="h41-0-197" class="i">+        versionTextBuilder.append(&quot;SnapEnhance &quot;).append(BuildConfig.VERSION_NAME)
</a><a href="#h41-0-198" id="h41-0-198" class="i">+            .append(&quot; by rhunk&quot;)
</a><a href="#h41-0-199" id="h41-0-199" class="i">+        if (BuildConfig.DEBUG) {
</a><a href="#h41-0-200" id="h41-0-200" class="i">+            versionTextBuilder.append(&quot;\n&quot;).append(&quot;Snapchat &quot;).append(packageInfo.versionName)
</a><a href="#h41-0-201" id="h41-0-201" class="i">+                .append(&quot; (&quot;).append(packageInfo.longVersionCode).append(&quot;)&quot;)
</a><a href="#h41-0-202" id="h41-0-202" class="i">+        }
</a><a href="#h41-0-203" id="h41-0-203" class="i">+        val titleText = TextView(viewModel.context)
</a><a href="#h41-0-204" id="h41-0-204" class="i">+        titleText.text = versionTextBuilder.toString()
</a><a href="#h41-0-205" id="h41-0-205" class="i">+        ViewAppearanceHelper.applyTheme(titleText)
</a><a href="#h41-0-206" id="h41-0-206" class="i">+        titleText.textSize = 18f
</a><a href="#h41-0-207" id="h41-0-207" class="i">+        titleText.minHeight = 80 * versionTextBuilder.chars().filter { ch: Int -&gt; ch == &#39;\n&#39;.code }
</a><a href="#h41-0-208" id="h41-0-208" class="i">+                .count().coerceAtLeast(2).toInt()
</a><a href="#h41-0-209" id="h41-0-209" class="i">+        addView(titleText)
</a><a href="#h41-0-210" id="h41-0-210" class="i">+
</a><a href="#h41-0-211" id="h41-0-211" class="i">+        val actions = context.actionManager.getActions().map {
</a><a href="#h41-0-212" id="h41-0-212" class="i">+            Pair(it) {
</a><a href="#h41-0-213" id="h41-0-213" class="i">+                val button = Button(viewModel.context)
</a><a href="#h41-0-214" id="h41-0-214" class="i">+                button.text = context.translation.get(it.nameKey)
</a><a href="#h41-0-215" id="h41-0-215" class="i">+                button.setOnClickListener { _ -&gt;
</a><a href="#h41-0-216" id="h41-0-216" class="i">+                    it.run()
</a><a href="#h41-0-217" id="h41-0-217" class="i">+                }
</a><a href="#h41-0-218" id="h41-0-218" class="i">+                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h41-0-219" id="h41-0-219" class="i">+                button
</a><a href="#h41-0-220" id="h41-0-220" class="i">+            }
</a><a href="#h41-0-221" id="h41-0-221" class="i">+        }
</a><a href="#h41-0-222" id="h41-0-222" class="i">+
</a><a href="#h41-0-223" id="h41-0-223" class="i">+        context.config.entries().groupBy {
</a><a href="#h41-0-224" id="h41-0-224" class="i">+            it.key.category
</a><a href="#h41-0-225" id="h41-0-225" class="i">+        }.forEach { (category, value) -&gt;
</a><a href="#h41-0-226" id="h41-0-226" class="i">+            addView(createCategoryTitle(category.key))
</a><a href="#h41-0-227" id="h41-0-227" class="i">+            value.filter { it.key.shouldAppearInSettings }.forEach { (property, _) -&gt;
</a><a href="#h41-0-228" id="h41-0-228" class="i">+                addView(createPropertyView(property))
</a><a href="#h41-0-229" id="h41-0-229" class="i">+                actions.find { pair -&gt; pair.first.dependsOnProperty == property}?.let { pair -&gt;
</a><a href="#h41-0-230" id="h41-0-230" class="i">+                    addView(pair.second())
</a><a href="#h41-0-231" id="h41-0-231" class="i">+                }
</a><a href="#h41-0-232" id="h41-0-232" class="i">+            }
</a><a href="#h41-0-233" id="h41-0-233" class="i">+        }
</a><a href="#h41-0-234" id="h41-0-234" class="i">+
</a><a href="#h41-0-235" id="h41-0-235" class="i">+        actions.filter { it.first.dependsOnProperty == null }.forEach {
</a><a href="#h41-0-236" id="h41-0-236" class="i">+            addView(it.second())
</a><a href="#h41-0-237" id="h41-0-237" class="i">+        }
</a><a href="#h41-0-238" id="h41-0-238" class="i">+
</a><a href="#h41-0-239" id="h41-0-239" class="i">+        addView(newSeparator(3, Color.parseColor(&quot;#f5f5f5&quot;)))
</a><a href="#h41-0-240" id="h41-0-240" class="i">+    }
</a><a href="#h41-0-241" id="h41-0-241" class="i">+}</a><a href="#h41-0-242" id="h41-0-242" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h42" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -1,67 +0,0 @@
</a><a href="#h42-0-0" id="h42-0-0" class="d">-package me.rhunk.snapenhance.util
</a><a href="#h42-0-1" id="h42-0-1" class="d">-
</a><a href="#h42-0-2" id="h42-0-2" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h42-0-3" id="h42-0-3" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h42-0-4" id="h42-0-4" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h42-0-5" id="h42-0-5" class="d">-import java.io.InputStream
</a><a href="#h42-0-6" id="h42-0-6" class="d">-import java.util.Base64
</a><a href="#h42-0-7" id="h42-0-7" class="d">-import javax.crypto.Cipher
</a><a href="#h42-0-8" id="h42-0-8" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h42-0-9" id="h42-0-9" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h42-0-10" id="h42-0-10" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h42-0-11" id="h42-0-11" class="d">-
</a><a href="#h42-0-12" id="h42-0-12" class="d">-object EncryptionUtils {
</a><a href="#h42-0-13" id="h42-0-13" class="d">-    fun decryptInputStreamFromArroyo(
</a><a href="#h42-0-14" id="h42-0-14" class="d">-        inputStream: InputStream,
</a><a href="#h42-0-15" id="h42-0-15" class="d">-        contentType: ContentType,
</a><a href="#h42-0-16" id="h42-0-16" class="d">-        messageProto: ProtoReader
</a><a href="#h42-0-17" id="h42-0-17" class="d">-    ): InputStream {
</a><a href="#h42-0-18" id="h42-0-18" class="d">-        var resultInputStream = inputStream
</a><a href="#h42-0-19" id="h42-0-19" class="d">-        val encryptionProtoPath: IntArray = when (contentType) {
</a><a href="#h42-0-20" id="h42-0-20" class="d">-            ContentType.NOTE -&gt; Constants.ARROYO_NOTE_ENCRYPTION_PROTO_PATH
</a><a href="#h42-0-21" id="h42-0-21" class="d">-            ContentType.SNAP -&gt; Constants.ARROYO_SNAP_ENCRYPTION_PROTO_PATH
</a><a href="#h42-0-22" id="h42-0-22" class="d">-            ContentType.EXTERNAL_MEDIA -&gt; Constants.ARROYO_EXTERNAL_MEDIA_ENCRYPTION_PROTO_PATH
</a><a href="#h42-0-23" id="h42-0-23" class="d">-            else -&gt; throw IllegalArgumentException(&quot;Invalid content type: $contentType&quot;)
</a><a href="#h42-0-24" id="h42-0-24" class="d">-        }
</a><a href="#h42-0-25" id="h42-0-25" class="d">-
</a><a href="#h42-0-26" id="h42-0-26" class="d">-        //decrypt the content if needed
</a><a href="#h42-0-27" id="h42-0-27" class="d">-        messageProto.readPath(*encryptionProtoPath)?.let {
</a><a href="#h42-0-28" id="h42-0-28" class="d">-            val encryptionProtoIndex: Int = if (it.exists(Constants.ARROYO_ENCRYPTION_PROTO_INDEX_V2)) {
</a><a href="#h42-0-29" id="h42-0-29" class="d">-                Constants.ARROYO_ENCRYPTION_PROTO_INDEX_V2
</a><a href="#h42-0-30" id="h42-0-30" class="d">-            } else if (it.exists(Constants.ARROYO_ENCRYPTION_PROTO_INDEX)) {
</a><a href="#h42-0-31" id="h42-0-31" class="d">-                Constants.ARROYO_ENCRYPTION_PROTO_INDEX
</a><a href="#h42-0-32" id="h42-0-32" class="d">-            } else {
</a><a href="#h42-0-33" id="h42-0-33" class="d">-                return resultInputStream
</a><a href="#h42-0-34" id="h42-0-34" class="d">-            }
</a><a href="#h42-0-35" id="h42-0-35" class="d">-            resultInputStream = decryptInputStream(
</a><a href="#h42-0-36" id="h42-0-36" class="d">-                resultInputStream,
</a><a href="#h42-0-37" id="h42-0-37" class="d">-                encryptionProtoIndex == Constants.ARROYO_ENCRYPTION_PROTO_INDEX_V2,
</a><a href="#h42-0-38" id="h42-0-38" class="d">-                it,
</a><a href="#h42-0-39" id="h42-0-39" class="d">-                encryptionProtoIndex
</a><a href="#h42-0-40" id="h42-0-40" class="d">-            )
</a><a href="#h42-0-41" id="h42-0-41" class="d">-        }
</a><a href="#h42-0-42" id="h42-0-42" class="d">-        return resultInputStream
</a><a href="#h42-0-43" id="h42-0-43" class="d">-    }
</a><a href="#h42-0-44" id="h42-0-44" class="d">-
</a><a href="#h42-0-45" id="h42-0-45" class="d">-    fun decryptInputStream(
</a><a href="#h42-0-46" id="h42-0-46" class="d">-        inputStream: InputStream,
</a><a href="#h42-0-47" id="h42-0-47" class="d">-        base64Encryption: Boolean,
</a><a href="#h42-0-48" id="h42-0-48" class="d">-        mediaInfoProto: ProtoReader,
</a><a href="#h42-0-49" id="h42-0-49" class="d">-        encryptionProtoIndex: Int
</a><a href="#h42-0-50" id="h42-0-50" class="d">-    ): InputStream {
</a><a href="#h42-0-51" id="h42-0-51" class="d">-        val mediaEncryption = mediaInfoProto.readPath(encryptionProtoIndex)!!
</a><a href="#h42-0-52" id="h42-0-52" class="d">-        var key: ByteArray = mediaEncryption.getByteArray(1)!!
</a><a href="#h42-0-53" id="h42-0-53" class="d">-        var iv: ByteArray = mediaEncryption.getByteArray(2)!!
</a><a href="#h42-0-54" id="h42-0-54" class="d">-
</a><a href="#h42-0-55" id="h42-0-55" class="d">-        //audio note and external medias have their key and iv encoded in base64
</a><a href="#h42-0-56" id="h42-0-56" class="d">-        if (base64Encryption) {
</a><a href="#h42-0-57" id="h42-0-57" class="d">-            val decoder = Base64.getMimeDecoder()
</a><a href="#h42-0-58" id="h42-0-58" class="d">-            key = decoder.decode(key)
</a><a href="#h42-0-59" id="h42-0-59" class="d">-            iv = decoder.decode(iv)
</a><a href="#h42-0-60" id="h42-0-60" class="d">-        }
</a><a href="#h42-0-61" id="h42-0-61" class="d">-
</a><a href="#h42-0-62" id="h42-0-62" class="d">-        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h42-0-63" id="h42-0-63" class="d">-        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h42-0-64" id="h42-0-64" class="d">-        return CipherInputStream(inputStream, cipher)
</a><a href="#h42-0-65" id="h42-0-65" class="d">-    }
</a><a href="#h42-0-66" id="h42-0-66" class="d">-}
</a><b>diff --git a/<a id="h43" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/MediaDownloaderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/MediaDownloaderHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/MediaDownloaderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/MediaDownloaderHelper.kt</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -1,117 +0,0 @@
</a><a href="#h43-0-0" id="h43-0-0" class="d">-package me.rhunk.snapenhance.util
</a><a href="#h43-0-1" id="h43-0-1" class="d">-
</a><a href="#h43-0-2" id="h43-0-2" class="d">-import com.arthenica.ffmpegkit.FFmpegKit
</a><a href="#h43-0-3" id="h43-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h43-0-4" id="h43-0-4" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h43-0-5" id="h43-0-5" class="d">-import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h43-0-6" id="h43-0-6" class="d">-import java.io.ByteArrayInputStream
</a><a href="#h43-0-7" id="h43-0-7" class="d">-import java.io.File
</a><a href="#h43-0-8" id="h43-0-8" class="d">-import java.io.FileInputStream
</a><a href="#h43-0-9" id="h43-0-9" class="d">-import java.io.FileNotFoundException
</a><a href="#h43-0-10" id="h43-0-10" class="d">-import java.io.FileOutputStream
</a><a href="#h43-0-11" id="h43-0-11" class="d">-import java.io.InputStream
</a><a href="#h43-0-12" id="h43-0-12" class="d">-import java.util.zip.ZipInputStream
</a><a href="#h43-0-13" id="h43-0-13" class="d">-
</a><a href="#h43-0-14" id="h43-0-14" class="d">-enum class MediaType {
</a><a href="#h43-0-15" id="h43-0-15" class="d">-    ORIGINAL, OVERLAY
</a><a href="#h43-0-16" id="h43-0-16" class="d">-}
</a><a href="#h43-0-17" id="h43-0-17" class="d">-object MediaDownloaderHelper {
</a><a href="#h43-0-18" id="h43-0-18" class="d">-    fun downloadMediaFromReference(mediaReference: ByteArray, mergeOverlay: Boolean, isPreviewMode: Boolean, decryptionCallback: (InputStream) -&gt; InputStream): Map&lt;MediaType, ByteArray&gt; {
</a><a href="#h43-0-19" id="h43-0-19" class="d">-        val inputStream: InputStream = RemoteMediaResolver.downloadBoltMedia(mediaReference) ?: throw FileNotFoundException(&quot;Unable to get media key. Check the logs for more info&quot;)
</a><a href="#h43-0-20" id="h43-0-20" class="d">-        val content = decryptionCallback(inputStream).readBytes()
</a><a href="#h43-0-21" id="h43-0-21" class="d">-        val fileType = FileType.fromByteArray(content)
</a><a href="#h43-0-22" id="h43-0-22" class="d">-        val isZipFile = fileType == FileType.ZIP
</a><a href="#h43-0-23" id="h43-0-23" class="d">-
</a><a href="#h43-0-24" id="h43-0-24" class="d">-        //videos with overlay are packed in a zip file
</a><a href="#h43-0-25" id="h43-0-25" class="d">-        //there are 2 files in the zip file, the video (webm) and the overlay (png)
</a><a href="#h43-0-26" id="h43-0-26" class="d">-        if (isZipFile) {
</a><a href="#h43-0-27" id="h43-0-27" class="d">-            var videoData: ByteArray? = null
</a><a href="#h43-0-28" id="h43-0-28" class="d">-            var overlayData: ByteArray? = null
</a><a href="#h43-0-29" id="h43-0-29" class="d">-            val zipInputStream = ZipInputStream(ByteArrayInputStream(content))
</a><a href="#h43-0-30" id="h43-0-30" class="d">-            while (zipInputStream.nextEntry != null) {
</a><a href="#h43-0-31" id="h43-0-31" class="d">-                val zipEntryData: ByteArray = zipInputStream.readBytes()
</a><a href="#h43-0-32" id="h43-0-32" class="d">-                val entryFileType = FileType.fromByteArray(zipEntryData)
</a><a href="#h43-0-33" id="h43-0-33" class="d">-                if (entryFileType.isVideo) {
</a><a href="#h43-0-34" id="h43-0-34" class="d">-                    videoData = zipEntryData
</a><a href="#h43-0-35" id="h43-0-35" class="d">-                } else if (entryFileType.isImage) {
</a><a href="#h43-0-36" id="h43-0-36" class="d">-                    overlayData = zipEntryData
</a><a href="#h43-0-37" id="h43-0-37" class="d">-                }
</a><a href="#h43-0-38" id="h43-0-38" class="d">-            }
</a><a href="#h43-0-39" id="h43-0-39" class="d">-            videoData ?: throw FileNotFoundException(&quot;Unable to find video file in zip file&quot;)
</a><a href="#h43-0-40" id="h43-0-40" class="d">-            overlayData ?: throw FileNotFoundException(&quot;Unable to find overlay file in zip file&quot;)
</a><a href="#h43-0-41" id="h43-0-41" class="d">-            if (mergeOverlay) {
</a><a href="#h43-0-42" id="h43-0-42" class="d">-                val mergedVideo = mergeOverlay(videoData, overlayData, isPreviewMode)
</a><a href="#h43-0-43" id="h43-0-43" class="d">-                return mapOf(MediaType.ORIGINAL to mergedVideo)
</a><a href="#h43-0-44" id="h43-0-44" class="d">-            }
</a><a href="#h43-0-45" id="h43-0-45" class="d">-            return mapOf(MediaType.ORIGINAL to videoData, MediaType.OVERLAY to overlayData)
</a><a href="#h43-0-46" id="h43-0-46" class="d">-        }
</a><a href="#h43-0-47" id="h43-0-47" class="d">-
</a><a href="#h43-0-48" id="h43-0-48" class="d">-        return mapOf(MediaType.ORIGINAL to content)
</a><a href="#h43-0-49" id="h43-0-49" class="d">-    }
</a><a href="#h43-0-50" id="h43-0-50" class="d">-
</a><a href="#h43-0-51" id="h43-0-51" class="d">-    fun downloadDashChapter(playlistXmlData: String, startTime: Long, duration: Long?): ByteArray {
</a><a href="#h43-0-52" id="h43-0-52" class="d">-        val outputFile = File.createTempFile(&quot;output&quot;, &quot;.mp4&quot;)
</a><a href="#h43-0-53" id="h43-0-53" class="d">-        val playlistFile = File.createTempFile(&quot;playlist&quot;, &quot;.mpd&quot;).also {
</a><a href="#h43-0-54" id="h43-0-54" class="d">-            with(FileOutputStream(it)) {
</a><a href="#h43-0-55" id="h43-0-55" class="d">-                write(playlistXmlData.toByteArray(Charsets.UTF_8))
</a><a href="#h43-0-56" id="h43-0-56" class="d">-                close()
</a><a href="#h43-0-57" id="h43-0-57" class="d">-            }
</a><a href="#h43-0-58" id="h43-0-58" class="d">-        }
</a><a href="#h43-0-59" id="h43-0-59" class="d">-
</a><a href="#h43-0-60" id="h43-0-60" class="d">-        val ffmpegSession = FFmpegKit.execute(
</a><a href="#h43-0-61" id="h43-0-61" class="d">-            &quot;-y -i &quot; +
</a><a href="#h43-0-62" id="h43-0-62" class="d">-                    playlistFile.absolutePath +
</a><a href="#h43-0-63" id="h43-0-63" class="d">-                    &quot; -ss &#39;${startTime}ms&#39;&quot; +
</a><a href="#h43-0-64" id="h43-0-64" class="d">-                    (if (duration != null) &quot; -t &#39;${duration}ms&#39;&quot; else &quot;&quot;) +
</a><a href="#h43-0-65" id="h43-0-65" class="d">-                    &quot; -c:v libx264 -threads 6 -q:v 13 &quot; + outputFile.absolutePath
</a><a href="#h43-0-66" id="h43-0-66" class="d">-        )
</a><a href="#h43-0-67" id="h43-0-67" class="d">-
</a><a href="#h43-0-68" id="h43-0-68" class="d">-        playlistFile.delete()
</a><a href="#h43-0-69" id="h43-0-69" class="d">-        if (!ffmpegSession.returnCode.isValueSuccess) {
</a><a href="#h43-0-70" id="h43-0-70" class="d">-            throw Exception(ffmpegSession.output)
</a><a href="#h43-0-71" id="h43-0-71" class="d">-        }
</a><a href="#h43-0-72" id="h43-0-72" class="d">-        val outputData = FileInputStream(outputFile).readBytes()
</a><a href="#h43-0-73" id="h43-0-73" class="d">-        outputFile.delete()
</a><a href="#h43-0-74" id="h43-0-74" class="d">-        return outputData
</a><a href="#h43-0-75" id="h43-0-75" class="d">-    }
</a><a href="#h43-0-76" id="h43-0-76" class="d">-
</a><a href="#h43-0-77" id="h43-0-77" class="d">-    fun mergeOverlay(original: ByteArray, overlay: ByteArray, isPreviewMode: Boolean): ByteArray {
</a><a href="#h43-0-78" id="h43-0-78" class="d">-        val originalFileType = FileType.fromByteArray(original)
</a><a href="#h43-0-79" id="h43-0-79" class="d">-        val overlayFileType = FileType.fromByteArray(overlay)
</a><a href="#h43-0-80" id="h43-0-80" class="d">-        //merge files
</a><a href="#h43-0-81" id="h43-0-81" class="d">-        val mergedFile = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + originalFileType.fileExtension)
</a><a href="#h43-0-82" id="h43-0-82" class="d">-        val tempVideoFile = File.createTempFile(&quot;original&quot;, &quot;.&quot; + originalFileType.fileExtension).also {
</a><a href="#h43-0-83" id="h43-0-83" class="d">-            with(FileOutputStream(it)) {
</a><a href="#h43-0-84" id="h43-0-84" class="d">-                write(original)
</a><a href="#h43-0-85" id="h43-0-85" class="d">-                close()
</a><a href="#h43-0-86" id="h43-0-86" class="d">-            }
</a><a href="#h43-0-87" id="h43-0-87" class="d">-        }
</a><a href="#h43-0-88" id="h43-0-88" class="d">-        val tempOverlayFile = File.createTempFile(&quot;overlay&quot;, &quot;.&quot; + overlayFileType.fileExtension).also {
</a><a href="#h43-0-89" id="h43-0-89" class="d">-            with(FileOutputStream(it)) {
</a><a href="#h43-0-90" id="h43-0-90" class="d">-                write(overlay)
</a><a href="#h43-0-91" id="h43-0-91" class="d">-                close()
</a><a href="#h43-0-92" id="h43-0-92" class="d">-            }
</a><a href="#h43-0-93" id="h43-0-93" class="d">-        }
</a><a href="#h43-0-94" id="h43-0-94" class="d">-
</a><a href="#h43-0-95" id="h43-0-95" class="d">-        //TODO: improve ffmpeg speed
</a><a href="#h43-0-96" id="h43-0-96" class="d">-        val fFmpegSession = FFmpegKit.execute(
</a><a href="#h43-0-97" id="h43-0-97" class="d">-            &quot;-y -i &quot; +
</a><a href="#h43-0-98" id="h43-0-98" class="d">-                    tempVideoFile.absolutePath +
</a><a href="#h43-0-99" id="h43-0-99" class="d">-                    &quot; -i &quot; +
</a><a href="#h43-0-100" id="h43-0-100" class="d">-                    tempOverlayFile.absolutePath +
</a><a href="#h43-0-101" id="h43-0-101" class="d">-                    &quot; -filter_complex \&quot;[0]scale2ref[img][vid];[img]setsar=1[img];[vid]nullsink; [img][1]overlay=(W-w)/2:(H-h)/2,scale=2*trunc(iw*sar/2):2*trunc(ih/2)\&quot; -c:v libx264 -q:v 13 -c:a copy &quot; +
</a><a href="#h43-0-102" id="h43-0-102" class="d">-                    &quot;  -threads 6 ${(if (isPreviewMode) &quot;-frames:v 1&quot; else &quot;&quot;)} &quot; +
</a><a href="#h43-0-103" id="h43-0-103" class="d">-                    mergedFile.absolutePath
</a><a href="#h43-0-104" id="h43-0-104" class="d">-        )
</a><a href="#h43-0-105" id="h43-0-105" class="d">-        tempVideoFile.delete()
</a><a href="#h43-0-106" id="h43-0-106" class="d">-        tempOverlayFile.delete()
</a><a href="#h43-0-107" id="h43-0-107" class="d">-        if (fFmpegSession.returnCode.value != 0) {
</a><a href="#h43-0-108" id="h43-0-108" class="d">-            mergedFile.delete()
</a><a href="#h43-0-109" id="h43-0-109" class="d">-            Logger.xposedLog(fFmpegSession.output)
</a><a href="#h43-0-110" id="h43-0-110" class="d">-            throw IllegalStateException(&quot;Failed to merge video and overlay. See logs for more details.&quot;)
</a><a href="#h43-0-111" id="h43-0-111" class="d">-        }
</a><a href="#h43-0-112" id="h43-0-112" class="d">-        val mergedFileData: ByteArray = FileInputStream(mergedFile).readBytes()
</a><a href="#h43-0-113" id="h43-0-113" class="d">-        mergedFile.delete()
</a><a href="#h43-0-114" id="h43-0-114" class="d">-        return mergedFileData
</a><a href="#h43-0-115" id="h43-0-115" class="d">-    }
</a><a href="#h43-0-116" id="h43-0-116" class="d">-}</a><a href="#h43-0-117" id="h43-0-117" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h44" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -1,41 +0,0 @@
</a><a href="#h44-0-0" id="h44-0-0" class="d">-package me.rhunk.snapenhance.util
</a><a href="#h44-0-1" id="h44-0-1" class="d">-
</a><a href="#h44-0-2" id="h44-0-2" class="d">-import android.graphics.Bitmap
</a><a href="#h44-0-3" id="h44-0-3" class="d">-import android.graphics.BitmapFactory
</a><a href="#h44-0-4" id="h44-0-4" class="d">-import android.media.MediaDataSource
</a><a href="#h44-0-5" id="h44-0-5" class="d">-import android.media.MediaMetadataRetriever
</a><a href="#h44-0-6" id="h44-0-6" class="d">-
</a><a href="#h44-0-7" id="h44-0-7" class="d">-object PreviewUtils {
</a><a href="#h44-0-8" id="h44-0-8" class="d">-    fun createPreview(data: ByteArray, isVideo: Boolean): Bitmap? {
</a><a href="#h44-0-9" id="h44-0-9" class="d">-        if (!isVideo) {
</a><a href="#h44-0-10" id="h44-0-10" class="d">-            return BitmapFactory.decodeByteArray(data, 0, data.size)
</a><a href="#h44-0-11" id="h44-0-11" class="d">-        }
</a><a href="#h44-0-12" id="h44-0-12" class="d">-        val retriever = MediaMetadataRetriever()
</a><a href="#h44-0-13" id="h44-0-13" class="d">-        retriever.setDataSource(object : MediaDataSource() {
</a><a href="#h44-0-14" id="h44-0-14" class="d">-            override fun readAt(
</a><a href="#h44-0-15" id="h44-0-15" class="d">-                position: Long,
</a><a href="#h44-0-16" id="h44-0-16" class="d">-                buffer: ByteArray,
</a><a href="#h44-0-17" id="h44-0-17" class="d">-                offset: Int,
</a><a href="#h44-0-18" id="h44-0-18" class="d">-                size: Int
</a><a href="#h44-0-19" id="h44-0-19" class="d">-            ): Int {
</a><a href="#h44-0-20" id="h44-0-20" class="d">-                var newSize = size
</a><a href="#h44-0-21" id="h44-0-21" class="d">-                val length = data.size
</a><a href="#h44-0-22" id="h44-0-22" class="d">-                if (position &gt;= length) {
</a><a href="#h44-0-23" id="h44-0-23" class="d">-                    return -1
</a><a href="#h44-0-24" id="h44-0-24" class="d">-                }
</a><a href="#h44-0-25" id="h44-0-25" class="d">-                if (position + newSize &gt; length) {
</a><a href="#h44-0-26" id="h44-0-26" class="d">-                    newSize = length - position.toInt()
</a><a href="#h44-0-27" id="h44-0-27" class="d">-                }
</a><a href="#h44-0-28" id="h44-0-28" class="d">-                System.arraycopy(data, position.toInt(), buffer, offset, newSize)
</a><a href="#h44-0-29" id="h44-0-29" class="d">-                return newSize
</a><a href="#h44-0-30" id="h44-0-30" class="d">-            }
</a><a href="#h44-0-31" id="h44-0-31" class="d">-
</a><a href="#h44-0-32" id="h44-0-32" class="d">-            override fun getSize(): Long {
</a><a href="#h44-0-33" id="h44-0-33" class="d">-                return data.size.toLong()
</a><a href="#h44-0-34" id="h44-0-34" class="d">-            }
</a><a href="#h44-0-35" id="h44-0-35" class="d">-
</a><a href="#h44-0-36" id="h44-0-36" class="d">-            override fun close() {}
</a><a href="#h44-0-37" id="h44-0-37" class="d">-        })
</a><a href="#h44-0-38" id="h44-0-38" class="d">-        return retriever.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h44-0-39" id="h44-0-39" class="d">-    }
</a><a href="#h44-0-40" id="h44-0-40" class="d">-}
</a><b>diff --git a/<a id="h45" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h45-0-0" id="h45-0-0" class="i">+package me.rhunk.snapenhance.util
</a><a href="#h45-0-1" id="h45-0-1" class="i">+
</a><a href="#h45-0-2" id="h45-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h45-0-3" id="h45-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h45-0-4" id="h45-0-4" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h45-0-5" id="h45-0-5" class="i">+
</a><a href="#h45-0-6" id="h45-0-6" class="i">+object SQLiteDatabaseHelper {
</a><a href="#h45-0-7" id="h45-0-7" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h45-0-8" id="h45-0-8" class="i">+    fun createTablesFromSchema(sqLiteDatabase: SQLiteDatabase, databaseSchema: Map&lt;String, List&lt;String&gt;&gt;) {
</a><a href="#h45-0-9" id="h45-0-9" class="i">+        databaseSchema.forEach { (tableName, columns) -&gt;
</a><a href="#h45-0-10" id="h45-0-10" class="i">+            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h45-0-11" id="h45-0-11" class="i">+
</a><a href="#h45-0-12" id="h45-0-12" class="i">+            val cursor = sqLiteDatabase.rawQuery(&quot;PRAGMA table_info($tableName)&quot;, null)
</a><a href="#h45-0-13" id="h45-0-13" class="i">+            val existingColumns = mutableListOf&lt;String&gt;()
</a><a href="#h45-0-14" id="h45-0-14" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h45-0-15" id="h45-0-15" class="i">+                existingColumns.add(cursor.getString(cursor.getColumnIndex(&quot;name&quot;)) + &quot; &quot; + cursor.getString(cursor.getColumnIndex(&quot;type&quot;)))
</a><a href="#h45-0-16" id="h45-0-16" class="i">+            }
</a><a href="#h45-0-17" id="h45-0-17" class="i">+            cursor.close()
</a><a href="#h45-0-18" id="h45-0-18" class="i">+
</a><a href="#h45-0-19" id="h45-0-19" class="i">+            val newColumns = columns.filter {
</a><a href="#h45-0-20" id="h45-0-20" class="i">+                existingColumns.none { existingColumn -&gt; it.startsWith(existingColumn) }
</a><a href="#h45-0-21" id="h45-0-21" class="i">+            }
</a><a href="#h45-0-22" id="h45-0-22" class="i">+
</a><a href="#h45-0-23" id="h45-0-23" class="i">+            if (newColumns.isEmpty()) return@forEach
</a><a href="#h45-0-24" id="h45-0-24" class="i">+
</a><a href="#h45-0-25" id="h45-0-25" class="i">+            Logger.log(&quot;Schema for table $tableName has changed&quot;)
</a><a href="#h45-0-26" id="h45-0-26" class="i">+            sqLiteDatabase.execSQL(&quot;DROP TABLE $tableName&quot;)
</a><a href="#h45-0-27" id="h45-0-27" class="i">+            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h45-0-28" id="h45-0-28" class="i">+        }
</a><a href="#h45-0-29" id="h45-0-29" class="i">+    }
</a><a href="#h45-0-30" id="h45-0-30" class="i">+}</a><a href="#h45-0-31" id="h45-0-31" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h46" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -2,9 +2,8 @@ package me.rhunk.snapenhance.util.download
</a> 
 import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.Logger.debug
<a href="#h46-0-3" id="h46-0-3" class="d">-import me.rhunk.snapenhance.ModContext
</a> import java.io.BufferedReader
<a href="#h46-0-5" id="h46-0-5" class="d">-import java.io.File
</a><a href="#h46-0-6" id="h46-0-6" class="i">+import java.io.InputStream
</a> import java.io.InputStreamReader
 import java.io.PrintWriter
 import java.net.ServerSocket
<a href="#h46-1" id="h46-1" class="h">@@ -13,38 +12,23 @@ import java.util.Locale
</a> import java.util.StringTokenizer
 import java.util.concurrent.ConcurrentHashMap
 import java.util.concurrent.ThreadLocalRandom
<a href="#h46-1-3" id="h46-1-3" class="d">-import java.util.function.Consumer
</a> 
<a href="#h46-1-5" id="h46-1-5" class="d">-class DownloadServer(
</a><a href="#h46-1-6" id="h46-1-6" class="d">-    private val context: ModContext
</a><a href="#h46-1-7" id="h46-1-7" class="d">-) {
</a><a href="#h46-1-8" id="h46-1-8" class="i">+class DownloadServer {
</a>     private val port = ThreadLocalRandom.current().nextInt(10000, 65535)
 
<a href="#h46-1-11" id="h46-1-11" class="d">-    private val cachedData = ConcurrentHashMap&lt;String, ByteArray&gt;()
</a><a href="#h46-1-12" id="h46-1-12" class="i">+    private val cachedData = ConcurrentHashMap&lt;String, InputStream&gt;()
</a>     private var serverSocket: ServerSocket? = null
 
<a href="#h46-1-15" id="h46-1-15" class="d">-    fun startFileDownload(destination: File, content: ByteArray, callback: Consumer&lt;Boolean&gt;) {
</a><a href="#h46-1-16" id="h46-1-16" class="d">-        val httpKey = java.lang.Long.toHexString(System.nanoTime())
</a><a href="#h46-1-17" id="h46-1-17" class="d">-        ensureServerStarted {
</a><a href="#h46-1-18" id="h46-1-18" class="d">-            putDownloadableContent(httpKey, content)
</a><a href="#h46-1-19" id="h46-1-19" class="d">-            val url = &quot;http://127.0.0.1:$port/$httpKey&quot;
</a><a href="#h46-1-20" id="h46-1-20" class="d">-            context.executeAsync {
</a><a href="#h46-1-21" id="h46-1-21" class="d">-                val result: Boolean = context.bridgeClient.downloadContent(url, destination.absolutePath)
</a><a href="#h46-1-22" id="h46-1-22" class="d">-                callback.accept(result)
</a><a href="#h46-1-23" id="h46-1-23" class="d">-            }
</a><a href="#h46-1-24" id="h46-1-24" class="d">-        }
</a><a href="#h46-1-25" id="h46-1-25" class="d">-    }
</a><a href="#h46-1-26" id="h46-1-26" class="d">-
</a><a href="#h46-1-27" id="h46-1-27" class="d">-    private fun ensureServerStarted(callback: Runnable) {
</a><a href="#h46-1-28" id="h46-1-28" class="i">+    fun ensureServerStarted(callback: DownloadServer.() -&gt; Unit) {
</a>         if (serverSocket != null &amp;&amp; !serverSocket!!.isClosed) {
<a href="#h46-1-30" id="h46-1-30" class="d">-            callback.run()
</a><a href="#h46-1-31" id="h46-1-31" class="i">+            callback(this)
</a>             return
         }
         Thread {
             try {
                 debug(&quot;started web server on 127.0.0.1:$port&quot;)
                 serverSocket = ServerSocket(port)
<a href="#h46-1-38" id="h46-1-38" class="d">-                callback.run()
</a><a href="#h46-1-39" id="h46-1-39" class="i">+                callback(this)
</a>                 while (!serverSocket!!.isClosed) {
                     try {
                         val socket = serverSocket!!.accept()
<a href="#h46-2" id="h46-2" class="h">@@ -59,8 +43,10 @@ class DownloadServer(
</a>         }.start()
     }
 
<a href="#h46-2-3" id="h46-2-3" class="d">-    fun putDownloadableContent(key: String, data: ByteArray) {
</a><a href="#h46-2-4" id="h46-2-4" class="d">-        cachedData[key] = data
</a><a href="#h46-2-5" id="h46-2-5" class="i">+    fun putDownloadableContent(inputStream: InputStream): String {
</a><a href="#h46-2-6" id="h46-2-6" class="i">+        val key = System.nanoTime().toString(16)
</a><a href="#h46-2-7" id="h46-2-7" class="i">+        cachedData[key] = inputStream
</a><a href="#h46-2-8" id="h46-2-8" class="i">+        return &quot;http://127.0.0.1:$port/$key&quot;
</a>     }
 
     private fun handleRequest(socket: Socket) {
<a href="#h46-3" id="h46-3" class="h">@@ -68,49 +54,58 @@ class DownloadServer(
</a>         val outputStream = socket.getOutputStream()
         val writer = PrintWriter(outputStream)
         val line = reader.readLine() ?: return
<a href="#h46-3-3" id="h46-3-3" class="d">-        val close = Runnable {
</a><a href="#h46-3-4" id="h46-3-4" class="d">-            try {
</a><a href="#h46-3-5" id="h46-3-5" class="i">+        fun close() {
</a><a href="#h46-3-6" id="h46-3-6" class="i">+            runCatching {
</a>                 reader.close()
                 writer.close()
                 outputStream.close()
                 socket.close()
<a href="#h46-3-11" id="h46-3-11" class="d">-            } catch (e: Throwable) {
</a><a href="#h46-3-12" id="h46-3-12" class="d">-                Logger.xposedLog(e)
</a><a href="#h46-3-13" id="h46-3-13" class="i">+            }.onFailure {
</a><a href="#h46-3-14" id="h46-3-14" class="i">+                Logger.error(&quot;failed to close socket&quot;, it)
</a>             }
         }
         val parse = StringTokenizer(line)
         val method = parse.nextToken().uppercase(Locale.getDefault())
         var fileRequested = parse.nextToken().lowercase(Locale.getDefault())
         if (method != &quot;GET&quot;) {
<a href="#h46-3-21" id="h46-3-21" class="d">-            writer.println(&quot;HTTP/1.1 501 Not Implemented&quot;)
</a><a href="#h46-3-22" id="h46-3-22" class="d">-            writer.println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h46-3-23" id="h46-3-23" class="d">-            writer.println(&quot;Content-length: &quot; + 0)
</a><a href="#h46-3-24" id="h46-3-24" class="d">-            writer.println()
</a><a href="#h46-3-25" id="h46-3-25" class="d">-            writer.flush()
</a><a href="#h46-3-26" id="h46-3-26" class="d">-            close.run()
</a><a href="#h46-3-27" id="h46-3-27" class="i">+            with(writer) {
</a><a href="#h46-3-28" id="h46-3-28" class="i">+                println(&quot;HTTP/1.1 501 Not Implemented&quot;)
</a><a href="#h46-3-29" id="h46-3-29" class="i">+                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h46-3-30" id="h46-3-30" class="i">+                println(&quot;Content-length: &quot; + 0)
</a><a href="#h46-3-31" id="h46-3-31" class="i">+                println()
</a><a href="#h46-3-32" id="h46-3-32" class="i">+                flush()
</a><a href="#h46-3-33" id="h46-3-33" class="i">+            }
</a><a href="#h46-3-34" id="h46-3-34" class="i">+            close()
</a>             return
         }
         if (fileRequested.startsWith(&quot;/&quot;)) {
             fileRequested = fileRequested.substring(1)
         }
         if (!cachedData.containsKey(fileRequested)) {
<a href="#h46-3-41" id="h46-3-41" class="d">-            writer.println(&quot;HTTP/1.1 404 Not Found&quot;)
</a><a href="#h46-3-42" id="h46-3-42" class="d">-            writer.println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h46-3-43" id="h46-3-43" class="d">-            writer.println(&quot;Content-length: &quot; + 0)
</a><a href="#h46-3-44" id="h46-3-44" class="d">-            writer.println()
</a><a href="#h46-3-45" id="h46-3-45" class="d">-            writer.flush()
</a><a href="#h46-3-46" id="h46-3-46" class="d">-            close.run()
</a><a href="#h46-3-47" id="h46-3-47" class="i">+            with(writer) {
</a><a href="#h46-3-48" id="h46-3-48" class="i">+                println(&quot;HTTP/1.1 404 Not Found&quot;)
</a><a href="#h46-3-49" id="h46-3-49" class="i">+                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h46-3-50" id="h46-3-50" class="i">+                println(&quot;Content-length: &quot; + 0)
</a><a href="#h46-3-51" id="h46-3-51" class="i">+                println()
</a><a href="#h46-3-52" id="h46-3-52" class="i">+                flush()
</a><a href="#h46-3-53" id="h46-3-53" class="i">+            }
</a><a href="#h46-3-54" id="h46-3-54" class="i">+            close()
</a>             return
         }
<a href="#h46-3-57" id="h46-3-57" class="d">-        val data = cachedData[fileRequested]!!
</a><a href="#h46-3-58" id="h46-3-58" class="d">-        writer.println(&quot;HTTP/1.1 200 OK&quot;)
</a><a href="#h46-3-59" id="h46-3-59" class="d">-        writer.println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h46-3-60" id="h46-3-60" class="d">-        writer.println(&quot;Content-length: &quot; + data.size)
</a><a href="#h46-3-61" id="h46-3-61" class="d">-        writer.println()
</a><a href="#h46-3-62" id="h46-3-62" class="d">-        writer.flush()
</a><a href="#h46-3-63" id="h46-3-63" class="d">-        outputStream.write(data, 0, data.size)
</a><a href="#h46-3-64" id="h46-3-64" class="i">+        val requestedData = cachedData[fileRequested]!!
</a><a href="#h46-3-65" id="h46-3-65" class="i">+        with(writer) {
</a><a href="#h46-3-66" id="h46-3-66" class="i">+            println(&quot;HTTP/1.1 200 OK&quot;)
</a><a href="#h46-3-67" id="h46-3-67" class="i">+            println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h46-3-68" id="h46-3-68" class="i">+            println()
</a><a href="#h46-3-69" id="h46-3-69" class="i">+            flush()
</a><a href="#h46-3-70" id="h46-3-70" class="i">+        }
</a><a href="#h46-3-71" id="h46-3-71" class="i">+        val buffer = ByteArray(1024)
</a><a href="#h46-3-72" id="h46-3-72" class="i">+        var bytesRead: Int
</a><a href="#h46-3-73" id="h46-3-73" class="i">+        while (requestedData.read(buffer).also { bytesRead = it } != -1) {
</a><a href="#h46-3-74" id="h46-3-74" class="i">+            outputStream.write(buffer, 0, bytesRead)
</a><a href="#h46-3-75" id="h46-3-75" class="i">+        }
</a>         outputStream.flush()
<a href="#h46-3-77" id="h46-3-77" class="d">-        close.run()
</a>         cachedData.remove(fileRequested)
<a href="#h46-3-79" id="h46-3-79" class="i">+        close()
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h47" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h47-0-0" id="h47-0-0" class="i">+package me.rhunk.snapenhance.util.snap
</a><a href="#h47-0-1" id="h47-0-1" class="i">+
</a><a href="#h47-0-2" id="h47-0-2" class="i">+object BitmojiSelfie {
</a><a href="#h47-0-3" id="h47-0-3" class="i">+    enum class BitmojiSelfieType {
</a><a href="#h47-0-4" id="h47-0-4" class="i">+        STANDARD,
</a><a href="#h47-0-5" id="h47-0-5" class="i">+        THREE_D
</a><a href="#h47-0-6" id="h47-0-6" class="i">+    }
</a><a href="#h47-0-7" id="h47-0-7" class="i">+
</a><a href="#h47-0-8" id="h47-0-8" class="i">+    fun getBitmojiSelfie(selfieId: String, avatarId: String, type: BitmojiSelfieType): String {
</a><a href="#h47-0-9" id="h47-0-9" class="i">+        return when (type) {
</a><a href="#h47-0-10" id="h47-0-10" class="i">+            BitmojiSelfieType.STANDARD -&gt; &quot;https://sdk.bitmoji.com/render/panel/$selfieId-$avatarId-v1.webp?transparent=1&quot;
</a><a href="#h47-0-11" id="h47-0-11" class="i">+            BitmojiSelfieType.THREE_D -&gt; &quot;https://images.bitmoji.com/3d/render/$selfieId-$avatarId-v1.webp?trim=circle&quot;
</a><a href="#h47-0-12" id="h47-0-12" class="i">+        }
</a><a href="#h47-0-13" id="h47-0-13" class="i">+    }
</a><a href="#h47-0-14" id="h47-0-14" class="i">+}</a><a href="#h47-0-15" id="h47-0-15" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h48" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -0,0 +1,53 @@
</a><a href="#h48-0-0" id="h48-0-0" class="i">+package me.rhunk.snapenhance.util.snap
</a><a href="#h48-0-1" id="h48-0-1" class="i">+
</a><a href="#h48-0-2" id="h48-0-2" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h48-0-3" id="h48-0-3" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h48-0-4" id="h48-0-4" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h48-0-5" id="h48-0-5" class="i">+import java.io.InputStream
</a><a href="#h48-0-6" id="h48-0-6" class="i">+import java.util.Base64
</a><a href="#h48-0-7" id="h48-0-7" class="i">+import javax.crypto.Cipher
</a><a href="#h48-0-8" id="h48-0-8" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h48-0-9" id="h48-0-9" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h48-0-10" id="h48-0-10" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h48-0-11" id="h48-0-11" class="i">+
</a><a href="#h48-0-12" id="h48-0-12" class="i">+object EncryptionHelper {
</a><a href="#h48-0-13" id="h48-0-13" class="i">+    fun getEncryptionKeys(contentType: ContentType, messageProto: ProtoReader, isArroyo: Boolean): Pair&lt;ByteArray, ByteArray&gt;? {
</a><a href="#h48-0-14" id="h48-0-14" class="i">+        val messageMediaInfo =
</a><a href="#h48-0-15" id="h48-0-15" class="i">+            MediaDownloaderHelper.getMessageMediaInfo(messageProto, contentType, isArroyo)
</a><a href="#h48-0-16" id="h48-0-16" class="i">+
</a><a href="#h48-0-17" id="h48-0-17" class="i">+        return messageMediaInfo?.let {  mediaEncryption -&gt;
</a><a href="#h48-0-18" id="h48-0-18" class="i">+            val encryptionProtoIndex: Int = if (mediaEncryption.exists(Constants.ENCRYPTION_PROTO_INDEX_V2)) {
</a><a href="#h48-0-19" id="h48-0-19" class="i">+                Constants.ENCRYPTION_PROTO_INDEX_V2
</a><a href="#h48-0-20" id="h48-0-20" class="i">+            } else {
</a><a href="#h48-0-21" id="h48-0-21" class="i">+                Constants.ENCRYPTION_PROTO_INDEX
</a><a href="#h48-0-22" id="h48-0-22" class="i">+            }
</a><a href="#h48-0-23" id="h48-0-23" class="i">+
</a><a href="#h48-0-24" id="h48-0-24" class="i">+            val encryptionProto = mediaEncryption.readPath(encryptionProtoIndex) ?: return null
</a><a href="#h48-0-25" id="h48-0-25" class="i">+            var key: ByteArray = encryptionProto.getByteArray(1)!!
</a><a href="#h48-0-26" id="h48-0-26" class="i">+            var iv: ByteArray = encryptionProto.getByteArray(2)!!
</a><a href="#h48-0-27" id="h48-0-27" class="i">+
</a><a href="#h48-0-28" id="h48-0-28" class="i">+            if (encryptionProtoIndex == Constants.ENCRYPTION_PROTO_INDEX_V2) {
</a><a href="#h48-0-29" id="h48-0-29" class="i">+                val decoder = Base64.getMimeDecoder()
</a><a href="#h48-0-30" id="h48-0-30" class="i">+                key = decoder.decode(key)
</a><a href="#h48-0-31" id="h48-0-31" class="i">+                iv = decoder.decode(iv)
</a><a href="#h48-0-32" id="h48-0-32" class="i">+            }
</a><a href="#h48-0-33" id="h48-0-33" class="i">+
</a><a href="#h48-0-34" id="h48-0-34" class="i">+            return Pair(key, iv)
</a><a href="#h48-0-35" id="h48-0-35" class="i">+        }
</a><a href="#h48-0-36" id="h48-0-36" class="i">+    }
</a><a href="#h48-0-37" id="h48-0-37" class="i">+
</a><a href="#h48-0-38" id="h48-0-38" class="i">+    fun decryptInputStream(
</a><a href="#h48-0-39" id="h48-0-39" class="i">+        inputStream: InputStream,
</a><a href="#h48-0-40" id="h48-0-40" class="i">+        contentType: ContentType,
</a><a href="#h48-0-41" id="h48-0-41" class="i">+        messageProto: ProtoReader,
</a><a href="#h48-0-42" id="h48-0-42" class="i">+        isArroyo: Boolean
</a><a href="#h48-0-43" id="h48-0-43" class="i">+    ): InputStream {
</a><a href="#h48-0-44" id="h48-0-44" class="i">+        val encryptionKeys = getEncryptionKeys(contentType, messageProto, isArroyo) ?: throw Exception(&quot;Failed to get encryption keys&quot;)
</a><a href="#h48-0-45" id="h48-0-45" class="i">+
</a><a href="#h48-0-46" id="h48-0-46" class="i">+        Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;).apply {
</a><a href="#h48-0-47" id="h48-0-47" class="i">+            init(Cipher.DECRYPT_MODE, SecretKeySpec(encryptionKeys.first, &quot;AES&quot;), IvParameterSpec(encryptionKeys.second))
</a><a href="#h48-0-48" id="h48-0-48" class="i">+        }.let { cipher -&gt;
</a><a href="#h48-0-49" id="h48-0-49" class="i">+            return CipherInputStream(inputStream, cipher)
</a><a href="#h48-0-50" id="h48-0-50" class="i">+        }
</a><a href="#h48-0-51" id="h48-0-51" class="i">+    }
</a><a href="#h48-0-52" id="h48-0-52" class="i">+}
</a><b>diff --git a/<a id="h49" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -0,0 +1,100 @@
</a><a href="#h49-0-0" id="h49-0-0" class="i">+package me.rhunk.snapenhance.util.snap
</a><a href="#h49-0-1" id="h49-0-1" class="i">+
</a><a href="#h49-0-2" id="h49-0-2" class="i">+import com.arthenica.ffmpegkit.FFmpegKit
</a><a href="#h49-0-3" id="h49-0-3" class="i">+import com.arthenica.ffmpegkit.FFmpegSession
</a><a href="#h49-0-4" id="h49-0-4" class="i">+import kotlinx.coroutines.suspendCancellableCoroutine
</a><a href="#h49-0-5" id="h49-0-5" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h49-0-6" id="h49-0-6" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h49-0-7" id="h49-0-7" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h49-0-8" id="h49-0-8" class="i">+import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h49-0-9" id="h49-0-9" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h49-0-10" id="h49-0-10" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h49-0-11" id="h49-0-11" class="i">+import java.io.File
</a><a href="#h49-0-12" id="h49-0-12" class="i">+import java.io.FileNotFoundException
</a><a href="#h49-0-13" id="h49-0-13" class="i">+import java.io.InputStream
</a><a href="#h49-0-14" id="h49-0-14" class="i">+import java.util.concurrent.Executors
</a><a href="#h49-0-15" id="h49-0-15" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h49-0-16" id="h49-0-16" class="i">+
</a><a href="#h49-0-17" id="h49-0-17" class="i">+enum class MediaType {
</a><a href="#h49-0-18" id="h49-0-18" class="i">+    ORIGINAL, OVERLAY
</a><a href="#h49-0-19" id="h49-0-19" class="i">+}
</a><a href="#h49-0-20" id="h49-0-20" class="i">+
</a><a href="#h49-0-21" id="h49-0-21" class="i">+object MediaDownloaderHelper {
</a><a href="#h49-0-22" id="h49-0-22" class="i">+    fun getMessageMediaInfo(protoReader: ProtoReader, contentType: ContentType, isArroyo: Boolean): ProtoReader? {
</a><a href="#h49-0-23" id="h49-0-23" class="i">+        val messageContainerPath = if (isArroyo) protoReader.readPath(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH)!! else protoReader
</a><a href="#h49-0-24" id="h49-0-24" class="i">+        val mediaContainerPath = if (contentType == ContentType.NOTE) intArrayOf(6, 1, 1) else intArrayOf(5, 1, 1)
</a><a href="#h49-0-25" id="h49-0-25" class="i">+
</a><a href="#h49-0-26" id="h49-0-26" class="i">+        return when (contentType) {
</a><a href="#h49-0-27" id="h49-0-27" class="i">+            ContentType.NOTE -&gt; messageContainerPath.readPath(*mediaContainerPath)
</a><a href="#h49-0-28" id="h49-0-28" class="i">+            ContentType.SNAP -&gt; messageContainerPath.readPath(*(intArrayOf(11) + mediaContainerPath))
</a><a href="#h49-0-29" id="h49-0-29" class="i">+            ContentType.EXTERNAL_MEDIA -&gt; messageContainerPath.readPath(*(intArrayOf(3, 3) + mediaContainerPath))
</a><a href="#h49-0-30" id="h49-0-30" class="i">+            else -&gt; throw IllegalArgumentException(&quot;Invalid content type: $contentType&quot;)
</a><a href="#h49-0-31" id="h49-0-31" class="i">+        }
</a><a href="#h49-0-32" id="h49-0-32" class="i">+    }
</a><a href="#h49-0-33" id="h49-0-33" class="i">+
</a><a href="#h49-0-34" id="h49-0-34" class="i">+    fun downloadMediaFromReference(mediaReference: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream): Map&lt;MediaType, ByteArray&gt; {
</a><a href="#h49-0-35" id="h49-0-35" class="i">+        val inputStream: InputStream = RemoteMediaResolver.downloadBoltMedia(mediaReference) ?: throw FileNotFoundException(&quot;Unable to get media key. Check the logs for more info&quot;)
</a><a href="#h49-0-36" id="h49-0-36" class="i">+        val content = decryptionCallback(inputStream).readBytes()
</a><a href="#h49-0-37" id="h49-0-37" class="i">+        val fileType = FileType.fromByteArray(content)
</a><a href="#h49-0-38" id="h49-0-38" class="i">+        val isZipFile = fileType == FileType.ZIP
</a><a href="#h49-0-39" id="h49-0-39" class="i">+
</a><a href="#h49-0-40" id="h49-0-40" class="i">+        //videos with overlay are packed in a zip file
</a><a href="#h49-0-41" id="h49-0-41" class="i">+        //there are 2 files in the zip file, the video (webm) and the overlay (png)
</a><a href="#h49-0-42" id="h49-0-42" class="i">+        if (isZipFile) {
</a><a href="#h49-0-43" id="h49-0-43" class="i">+            var videoData: ByteArray? = null
</a><a href="#h49-0-44" id="h49-0-44" class="i">+            var overlayData: ByteArray? = null
</a><a href="#h49-0-45" id="h49-0-45" class="i">+            val zipInputStream = ZipInputStream(ByteArrayInputStream(content))
</a><a href="#h49-0-46" id="h49-0-46" class="i">+            while (zipInputStream.nextEntry != null) {
</a><a href="#h49-0-47" id="h49-0-47" class="i">+                val zipEntryData: ByteArray = zipInputStream.readBytes()
</a><a href="#h49-0-48" id="h49-0-48" class="i">+                val entryFileType = FileType.fromByteArray(zipEntryData)
</a><a href="#h49-0-49" id="h49-0-49" class="i">+                if (entryFileType.isVideo) {
</a><a href="#h49-0-50" id="h49-0-50" class="i">+                    videoData = zipEntryData
</a><a href="#h49-0-51" id="h49-0-51" class="i">+                } else if (entryFileType.isImage) {
</a><a href="#h49-0-52" id="h49-0-52" class="i">+                    overlayData = zipEntryData
</a><a href="#h49-0-53" id="h49-0-53" class="i">+                }
</a><a href="#h49-0-54" id="h49-0-54" class="i">+            }
</a><a href="#h49-0-55" id="h49-0-55" class="i">+            videoData ?: throw FileNotFoundException(&quot;Unable to find video file in zip file&quot;)
</a><a href="#h49-0-56" id="h49-0-56" class="i">+            overlayData ?: throw FileNotFoundException(&quot;Unable to find overlay file in zip file&quot;)
</a><a href="#h49-0-57" id="h49-0-57" class="i">+            return mapOf(MediaType.ORIGINAL to videoData, MediaType.OVERLAY to overlayData)
</a><a href="#h49-0-58" id="h49-0-58" class="i">+        }
</a><a href="#h49-0-59" id="h49-0-59" class="i">+
</a><a href="#h49-0-60" id="h49-0-60" class="i">+        return mapOf(MediaType.ORIGINAL to content)
</a><a href="#h49-0-61" id="h49-0-61" class="i">+    }
</a><a href="#h49-0-62" id="h49-0-62" class="i">+
</a><a href="#h49-0-63" id="h49-0-63" class="i">+
</a><a href="#h49-0-64" id="h49-0-64" class="i">+    private suspend fun runFFmpegAsync(vararg args: String) = suspendCancellableCoroutine&lt;FFmpegSession&gt; {
</a><a href="#h49-0-65" id="h49-0-65" class="i">+        FFmpegKit.executeAsync(args.joinToString(&quot; &quot;), { session -&gt;
</a><a href="#h49-0-66" id="h49-0-66" class="i">+            it.resumeWith(
</a><a href="#h49-0-67" id="h49-0-67" class="i">+                if (session.returnCode.isValueSuccess) {
</a><a href="#h49-0-68" id="h49-0-68" class="i">+                    Result.success(session)
</a><a href="#h49-0-69" id="h49-0-69" class="i">+                } else {
</a><a href="#h49-0-70" id="h49-0-70" class="i">+                    Result.failure(Exception(session.output))
</a><a href="#h49-0-71" id="h49-0-71" class="i">+                }
</a><a href="#h49-0-72" id="h49-0-72" class="i">+            )
</a><a href="#h49-0-73" id="h49-0-73" class="i">+        },
</a><a href="#h49-0-74" id="h49-0-74" class="i">+            Executors.newSingleThreadExecutor())
</a><a href="#h49-0-75" id="h49-0-75" class="i">+    }
</a><a href="#h49-0-76" id="h49-0-76" class="i">+
</a><a href="#h49-0-77" id="h49-0-77" class="i">+    suspend fun downloadDashChapterFile(
</a><a href="#h49-0-78" id="h49-0-78" class="i">+        dashPlaylist: File,
</a><a href="#h49-0-79" id="h49-0-79" class="i">+        output: File,
</a><a href="#h49-0-80" id="h49-0-80" class="i">+        startTime: Long,
</a><a href="#h49-0-81" id="h49-0-81" class="i">+        duration: Long?) {
</a><a href="#h49-0-82" id="h49-0-82" class="i">+        runFFmpegAsync(
</a><a href="#h49-0-83" id="h49-0-83" class="i">+            &quot;-y&quot;, &quot;-i&quot;, dashPlaylist.absolutePath, &quot;-ss&quot;, &quot;&#39;${startTime}ms&#39;&quot;, *(if (duration != null) arrayOf(&quot;-t&quot;, &quot;&#39;${duration}ms&#39;&quot;) else arrayOf()),
</a><a href="#h49-0-84" id="h49-0-84" class="i">+            &quot;-c:v&quot;, &quot;libx264&quot;, &quot;-threads&quot;, &quot;6&quot;, &quot;-q:v&quot;, &quot;13&quot;, output.absolutePath
</a><a href="#h49-0-85" id="h49-0-85" class="i">+        )
</a><a href="#h49-0-86" id="h49-0-86" class="i">+    }
</a><a href="#h49-0-87" id="h49-0-87" class="i">+
</a><a href="#h49-0-88" id="h49-0-88" class="i">+    suspend fun mergeOverlayFile(
</a><a href="#h49-0-89" id="h49-0-89" class="i">+        media: File,
</a><a href="#h49-0-90" id="h49-0-90" class="i">+        overlay: File,
</a><a href="#h49-0-91" id="h49-0-91" class="i">+        output: File
</a><a href="#h49-0-92" id="h49-0-92" class="i">+    ) {
</a><a href="#h49-0-93" id="h49-0-93" class="i">+        runFFmpegAsync(
</a><a href="#h49-0-94" id="h49-0-94" class="i">+            &quot;-y&quot;, &quot;-i&quot;, media.absolutePath, &quot;-i&quot;, overlay.absolutePath,
</a><a href="#h49-0-95" id="h49-0-95" class="i">+            &quot;-filter_complex&quot;, &quot;\&quot;[0]scale2ref[img][vid];[img]setsar=1[img];[vid]nullsink;[img][1]overlay=(W-w)/2:(H-h)/2,scale=2*trunc(iw*sar/2):2*trunc(ih/2)\&quot;&quot;,
</a><a href="#h49-0-96" id="h49-0-96" class="i">+            &quot;-c:v&quot;, &quot;libx264&quot;, &quot;-b:v&quot;, &quot;5M&quot;, &quot;-c:a&quot;, &quot;copy&quot;, &quot;-threads&quot;, &quot;6&quot;, output.absolutePath
</a><a href="#h49-0-97" id="h49-0-97" class="i">+        )
</a><a href="#h49-0-98" id="h49-0-98" class="i">+    }
</a><a href="#h49-0-99" id="h49-0-99" class="i">+}</a><a href="#h49-0-100" id="h49-0-100" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h50" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -0,0 +1,92 @@
</a><a href="#h50-0-0" id="h50-0-0" class="i">+package me.rhunk.snapenhance.util.snap
</a><a href="#h50-0-1" id="h50-0-1" class="i">+
</a><a href="#h50-0-2" id="h50-0-2" class="i">+import android.graphics.Bitmap
</a><a href="#h50-0-3" id="h50-0-3" class="i">+import android.graphics.BitmapFactory
</a><a href="#h50-0-4" id="h50-0-4" class="i">+import android.graphics.Canvas
</a><a href="#h50-0-5" id="h50-0-5" class="i">+import android.graphics.Matrix
</a><a href="#h50-0-6" id="h50-0-6" class="i">+import android.media.MediaDataSource
</a><a href="#h50-0-7" id="h50-0-7" class="i">+import android.media.MediaMetadataRetriever
</a><a href="#h50-0-8" id="h50-0-8" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h50-0-9" id="h50-0-9" class="i">+import java.io.File
</a><a href="#h50-0-10" id="h50-0-10" class="i">+import kotlin.math.roundToInt
</a><a href="#h50-0-11" id="h50-0-11" class="i">+
</a><a href="#h50-0-12" id="h50-0-12" class="i">+object PreviewUtils {
</a><a href="#h50-0-13" id="h50-0-13" class="i">+    fun createPreview(data: ByteArray, isVideo: Boolean): Bitmap? {
</a><a href="#h50-0-14" id="h50-0-14" class="i">+        if (!isVideo) {
</a><a href="#h50-0-15" id="h50-0-15" class="i">+            return BitmapFactory.decodeByteArray(data, 0, data.size)
</a><a href="#h50-0-16" id="h50-0-16" class="i">+        }
</a><a href="#h50-0-17" id="h50-0-17" class="i">+        return MediaMetadataRetriever().apply {
</a><a href="#h50-0-18" id="h50-0-18" class="i">+            setDataSource(object : MediaDataSource() {
</a><a href="#h50-0-19" id="h50-0-19" class="i">+                override fun readAt(
</a><a href="#h50-0-20" id="h50-0-20" class="i">+                    position: Long,
</a><a href="#h50-0-21" id="h50-0-21" class="i">+                    buffer: ByteArray,
</a><a href="#h50-0-22" id="h50-0-22" class="i">+                    offset: Int,
</a><a href="#h50-0-23" id="h50-0-23" class="i">+                    size: Int
</a><a href="#h50-0-24" id="h50-0-24" class="i">+                ): Int {
</a><a href="#h50-0-25" id="h50-0-25" class="i">+                    var newSize = size
</a><a href="#h50-0-26" id="h50-0-26" class="i">+                    val length = data.size
</a><a href="#h50-0-27" id="h50-0-27" class="i">+                    if (position &gt;= length) {
</a><a href="#h50-0-28" id="h50-0-28" class="i">+                        return -1
</a><a href="#h50-0-29" id="h50-0-29" class="i">+                    }
</a><a href="#h50-0-30" id="h50-0-30" class="i">+                    if (position + newSize &gt; length) {
</a><a href="#h50-0-31" id="h50-0-31" class="i">+                        newSize = length - position.toInt()
</a><a href="#h50-0-32" id="h50-0-32" class="i">+                    }
</a><a href="#h50-0-33" id="h50-0-33" class="i">+                    System.arraycopy(data, position.toInt(), buffer, offset, newSize)
</a><a href="#h50-0-34" id="h50-0-34" class="i">+                    return newSize
</a><a href="#h50-0-35" id="h50-0-35" class="i">+                }
</a><a href="#h50-0-36" id="h50-0-36" class="i">+
</a><a href="#h50-0-37" id="h50-0-37" class="i">+                override fun getSize(): Long {
</a><a href="#h50-0-38" id="h50-0-38" class="i">+                    return data.size.toLong()
</a><a href="#h50-0-39" id="h50-0-39" class="i">+                }
</a><a href="#h50-0-40" id="h50-0-40" class="i">+                override fun close() {}
</a><a href="#h50-0-41" id="h50-0-41" class="i">+            })
</a><a href="#h50-0-42" id="h50-0-42" class="i">+        }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h50-0-43" id="h50-0-43" class="i">+    }
</a><a href="#h50-0-44" id="h50-0-44" class="i">+
</a><a href="#h50-0-45" id="h50-0-45" class="i">+    fun createPreviewFromFile(file: File, scaleFactor: Float): Bitmap? {
</a><a href="#h50-0-46" id="h50-0-46" class="i">+        return if (FileType.fromFile(file).isVideo) {
</a><a href="#h50-0-47" id="h50-0-47" class="i">+            MediaMetadataRetriever().apply {
</a><a href="#h50-0-48" id="h50-0-48" class="i">+                setDataSource(file.absolutePath)
</a><a href="#h50-0-49" id="h50-0-49" class="i">+            }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)?.let {
</a><a href="#h50-0-50" id="h50-0-50" class="i">+                resizeBitmap(it, (it.width * scaleFactor).toInt(), (it.height * scaleFactor).toInt())
</a><a href="#h50-0-51" id="h50-0-51" class="i">+            }
</a><a href="#h50-0-52" id="h50-0-52" class="i">+        } else {
</a><a href="#h50-0-53" id="h50-0-53" class="i">+            BitmapFactory.decodeFile(file.absolutePath, BitmapFactory.Options().apply {
</a><a href="#h50-0-54" id="h50-0-54" class="i">+                inSampleSize = (1 / scaleFactor).roundToInt()
</a><a href="#h50-0-55" id="h50-0-55" class="i">+            })
</a><a href="#h50-0-56" id="h50-0-56" class="i">+        }
</a><a href="#h50-0-57" id="h50-0-57" class="i">+    }
</a><a href="#h50-0-58" id="h50-0-58" class="i">+
</a><a href="#h50-0-59" id="h50-0-59" class="i">+    private fun resizeBitmap(bitmap: Bitmap, outWidth: Int, outHeight: Int): Bitmap? {
</a><a href="#h50-0-60" id="h50-0-60" class="i">+        val scaleWidth = outWidth.toFloat() / bitmap.width
</a><a href="#h50-0-61" id="h50-0-61" class="i">+        val scaleHeight = outHeight.toFloat() / bitmap.height
</a><a href="#h50-0-62" id="h50-0-62" class="i">+        val matrix = Matrix()
</a><a href="#h50-0-63" id="h50-0-63" class="i">+        matrix.postScale(scaleWidth, scaleHeight)
</a><a href="#h50-0-64" id="h50-0-64" class="i">+        val resizedBitmap = Bitmap.createBitmap(bitmap, 0, 0, bitmap.width, bitmap.height, matrix, false)
</a><a href="#h50-0-65" id="h50-0-65" class="i">+        bitmap.recycle()
</a><a href="#h50-0-66" id="h50-0-66" class="i">+        return resizedBitmap
</a><a href="#h50-0-67" id="h50-0-67" class="i">+    }
</a><a href="#h50-0-68" id="h50-0-68" class="i">+
</a><a href="#h50-0-69" id="h50-0-69" class="i">+    fun mergeBitmapOverlay(originalMedia: Bitmap, overlayLayer: Bitmap): Bitmap {
</a><a href="#h50-0-70" id="h50-0-70" class="i">+        val biggestBitmap = if (originalMedia.width * originalMedia.height &gt; overlayLayer.width * overlayLayer.height) originalMedia else overlayLayer
</a><a href="#h50-0-71" id="h50-0-71" class="i">+        val smallestBitmap = if (biggestBitmap == originalMedia) overlayLayer else originalMedia
</a><a href="#h50-0-72" id="h50-0-72" class="i">+
</a><a href="#h50-0-73" id="h50-0-73" class="i">+        val mergedBitmap = Bitmap.createBitmap(biggestBitmap.width, biggestBitmap.height, biggestBitmap.config)
</a><a href="#h50-0-74" id="h50-0-74" class="i">+
</a><a href="#h50-0-75" id="h50-0-75" class="i">+        with(Canvas(mergedBitmap)) {
</a><a href="#h50-0-76" id="h50-0-76" class="i">+            val scaleMatrix = Matrix().apply {
</a><a href="#h50-0-77" id="h50-0-77" class="i">+                postScale(biggestBitmap.width.toFloat() / smallestBitmap.width.toFloat(), biggestBitmap.height.toFloat() / smallestBitmap.height.toFloat())
</a><a href="#h50-0-78" id="h50-0-78" class="i">+            }
</a><a href="#h50-0-79" id="h50-0-79" class="i">+
</a><a href="#h50-0-80" id="h50-0-80" class="i">+            if (biggestBitmap == originalMedia) {
</a><a href="#h50-0-81" id="h50-0-81" class="i">+                drawBitmap(originalMedia, 0f, 0f, null)
</a><a href="#h50-0-82" id="h50-0-82" class="i">+                drawBitmap(overlayLayer, scaleMatrix, null)
</a><a href="#h50-0-83" id="h50-0-83" class="i">+            } else {
</a><a href="#h50-0-84" id="h50-0-84" class="i">+                drawBitmap(originalMedia, scaleMatrix, null)
</a><a href="#h50-0-85" id="h50-0-85" class="i">+                drawBitmap(overlayLayer, 0f, 0f, null)
</a><a href="#h50-0-86" id="h50-0-86" class="i">+            }
</a><a href="#h50-0-87" id="h50-0-87" class="i">+        }
</a><a href="#h50-0-88" id="h50-0-88" class="i">+
</a><a href="#h50-0-89" id="h50-0-89" class="i">+        return mergedBitmap
</a><a href="#h50-0-90" id="h50-0-90" class="i">+    }
</a><a href="#h50-0-91" id="h50-0-91" class="i">+}
</a><b>diff --git a/<a id="h51" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -1,2 +0,0 @@
</a><a href="#h51-0-0" id="h51-0-0" class="d">-package me.rhunk.snapenhance.util.snap
</a><a href="#h51-0-1" id="h51-0-1" class="d">-
</a><b>diff --git a/<a id="h52" href="../file/app/src/main/res/drawable/action_button_cancel.xml.html">app/src/main/res/drawable/action_button_cancel.xml</a> b/<a href="../file/app/src/main/res/drawable/action_button_cancel.xml.html">app/src/main/res/drawable/action_button_cancel.xml</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -0,0 +1,4 @@
</a><a href="#h52-0-0" id="h52-0-0" class="i">+&lt;shape android:shape=&quot;rectangle&quot; xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
</a><a href="#h52-0-1" id="h52-0-1" class="i">+    &lt;solid android:color=&quot;@color/errorColor&quot; /&gt;
</a><a href="#h52-0-2" id="h52-0-2" class="i">+    &lt;corners android:radius=&quot;10000dp&quot; /&gt;
</a><a href="#h52-0-3" id="h52-0-3" class="i">+&lt;/shape&gt;</a><a href="#h52-0-4" id="h52-0-4" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h53" href="../file/app/src/main/res/drawable/action_button_success.xml.html">app/src/main/res/drawable/action_button_success.xml</a> b/<a href="../file/app/src/main/res/drawable/action_button_success.xml.html">app/src/main/res/drawable/action_button_success.xml</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h53-0-0" id="h53-0-0" class="i">+&lt;shape android:shape=&quot;rectangle&quot;
</a><a href="#h53-0-1" id="h53-0-1" class="i">+    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
</a><a href="#h53-0-2" id="h53-0-2" class="i">+    &lt;solid android:color=&quot;@color/secondaryBackground&quot; /&gt;
</a><a href="#h53-0-3" id="h53-0-3" class="i">+    &lt;corners android:radius=&quot;10000dp&quot; /&gt;
</a><a href="#h53-0-4" id="h53-0-4" class="i">+    &lt;stroke
</a><a href="#h53-0-5" id="h53-0-5" class="i">+        android:width=&quot;2dp&quot;
</a><a href="#h53-0-6" id="h53-0-6" class="i">+        android:color=&quot;@color/successColor&quot; /&gt;
</a><a href="#h53-0-7" id="h53-0-7" class="i">+&lt;/shape&gt;</a><a href="#h53-0-8" id="h53-0-8" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h54" href="../file/app/src/main/res/drawable/download_manager_item_background.xml.html">app/src/main/res/drawable/download_manager_item_background.xml</a> b/<a href="../file/app/src/main/res/drawable/download_manager_item_background.xml.html">app/src/main/res/drawable/download_manager_item_background.xml</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -0,0 +1,5 @@
</a><a href="#h54-0-0" id="h54-0-0" class="i">+&lt;shape xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h54-0-1" id="h54-0-1" class="i">+    android:shape=&quot;rectangle&quot;&gt;
</a><a href="#h54-0-2" id="h54-0-2" class="i">+    &lt;solid android:color=&quot;@color/secondaryBackground&quot; /&gt;
</a><a href="#h54-0-3" id="h54-0-3" class="i">+    &lt;corners android:radius=&quot;@dimen/download_manager_item_preview_radius&quot; /&gt;
</a><a href="#h54-0-4" id="h54-0-4" class="i">+&lt;/shape&gt;</a><a href="#h54-0-5" id="h54-0-5" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h55" href="../file/app/src/main/res/font/avenir_next_medium.ttf.html">app/src/main/res/font/avenir_next_medium.ttf</a> b/<a href="../file/app/src/main/res/font/avenir_next_medium.ttf.html">app/src/main/res/font/avenir_next_medium.ttf</a></b>
<b>diff --git a/<a id="h56" href="../file/app/src/main/res/layout/download_manager_activity.xml.html">app/src/main/res/layout/download_manager_activity.xml</a> b/<a href="../file/app/src/main/res/layout/download_manager_activity.xml.html">app/src/main/res/layout/download_manager_activity.xml</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -0,0 +1,60 @@
</a><a href="#h56-0-0" id="h56-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h56-0-1" id="h56-0-1" class="i">+&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h56-0-2" id="h56-0-2" class="i">+    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h56-0-3" id="h56-0-3" class="i">+    android:id=&quot;@+id/download_manager_activity&quot;
</a><a href="#h56-0-4" id="h56-0-4" class="i">+    android:layout_width=&quot;match_parent&quot;
</a><a href="#h56-0-5" id="h56-0-5" class="i">+    android:layout_height=&quot;match_parent&quot;
</a><a href="#h56-0-6" id="h56-0-6" class="i">+    android:background=&quot;@color/primaryBackground&quot;
</a><a href="#h56-0-7" id="h56-0-7" class="i">+    android:orientation=&quot;vertical&quot;&gt;
</a><a href="#h56-0-8" id="h56-0-8" class="i">+
</a><a href="#h56-0-9" id="h56-0-9" class="i">+    &lt;LinearLayout
</a><a href="#h56-0-10" id="h56-0-10" class="i">+        android:layout_width=&quot;match_parent&quot;
</a><a href="#h56-0-11" id="h56-0-11" class="i">+        android:layout_height=&quot;50dp&quot;
</a><a href="#h56-0-12" id="h56-0-12" class="i">+        android:background=&quot;@color/secondaryBackground&quot;
</a><a href="#h56-0-13" id="h56-0-13" class="i">+        android:gravity=&quot;center_vertical&quot;
</a><a href="#h56-0-14" id="h56-0-14" class="i">+        android:orientation=&quot;horizontal&quot;
</a><a href="#h56-0-15" id="h56-0-15" class="i">+        android:layoutDirection=&quot;rtl&quot;&gt;
</a><a href="#h56-0-16" id="h56-0-16" class="i">+
</a><a href="#h56-0-17" id="h56-0-17" class="i">+        &lt;RelativeLayout
</a><a href="#h56-0-18" id="h56-0-18" class="i">+            android:layout_width=&quot;match_parent&quot;
</a><a href="#h56-0-19" id="h56-0-19" class="i">+            android:layout_height=&quot;wrap_content&quot;
</a><a href="#h56-0-20" id="h56-0-20" class="i">+            android:gravity=&quot;right&quot;
</a><a href="#h56-0-21" id="h56-0-21" class="i">+            android:padding=&quot;10dp&quot;
</a><a href="#h56-0-22" id="h56-0-22" class="i">+            tools:ignore=&quot;RtlHardcoded&quot;&gt;
</a><a href="#h56-0-23" id="h56-0-23" class="i">+            &lt;Button
</a><a href="#h56-0-24" id="h56-0-24" class="i">+                android:id=&quot;@+id/remove_all_button&quot;
</a><a href="#h56-0-25" id="h56-0-25" class="i">+                android:layout_width=&quot;wrap_content&quot;
</a><a href="#h56-0-26" id="h56-0-26" class="i">+                android:layout_height=&quot;35dp&quot;
</a><a href="#h56-0-27" id="h56-0-27" class="i">+                android:background=&quot;@drawable/action_button_cancel&quot;
</a><a href="#h56-0-28" id="h56-0-28" class="i">+                android:padding=&quot;5dp&quot;
</a><a href="#h56-0-29" id="h56-0-29" class="i">+                android:text=&quot;Remove All&quot;
</a><a href="#h56-0-30" id="h56-0-30" class="i">+                android:textColor=&quot;@color/darkText&quot; /&gt;
</a><a href="#h56-0-31" id="h56-0-31" class="i">+        &lt;/RelativeLayout&gt;
</a><a href="#h56-0-32" id="h56-0-32" class="i">+
</a><a href="#h56-0-33" id="h56-0-33" class="i">+    &lt;/LinearLayout&gt;
</a><a href="#h56-0-34" id="h56-0-34" class="i">+
</a><a href="#h56-0-35" id="h56-0-35" class="i">+    &lt;RelativeLayout
</a><a href="#h56-0-36" id="h56-0-36" class="i">+        android:layout_width=&quot;match_parent&quot;
</a><a href="#h56-0-37" id="h56-0-37" class="i">+        android:layout_height=&quot;match_parent&quot;
</a><a href="#h56-0-38" id="h56-0-38" class="i">+        android:orientation=&quot;vertical&quot;&gt;
</a><a href="#h56-0-39" id="h56-0-39" class="i">+
</a><a href="#h56-0-40" id="h56-0-40" class="i">+        &lt;androidx.recyclerview.widget.RecyclerView
</a><a href="#h56-0-41" id="h56-0-41" class="i">+            android:id=&quot;@+id/download_list&quot;
</a><a href="#h56-0-42" id="h56-0-42" class="i">+            android:layout_width=&quot;match_parent&quot;
</a><a href="#h56-0-43" id="h56-0-43" class="i">+            android:layout_height=&quot;match_parent&quot;&gt;
</a><a href="#h56-0-44" id="h56-0-44" class="i">+
</a><a href="#h56-0-45" id="h56-0-45" class="i">+        &lt;/androidx.recyclerview.widget.RecyclerView&gt;
</a><a href="#h56-0-46" id="h56-0-46" class="i">+
</a><a href="#h56-0-47" id="h56-0-47" class="i">+        &lt;TextView
</a><a href="#h56-0-48" id="h56-0-48" class="i">+            android:id=&quot;@+id/no_download_title&quot;
</a><a href="#h56-0-49" id="h56-0-49" class="i">+            android:layout_width=&quot;match_parent&quot;
</a><a href="#h56-0-50" id="h56-0-50" class="i">+            android:layout_height=&quot;wrap_content&quot;
</a><a href="#h56-0-51" id="h56-0-51" class="i">+            android:foregroundGravity=&quot;clip_horizontal&quot;
</a><a href="#h56-0-52" id="h56-0-52" class="i">+            android:gravity=&quot;center&quot;
</a><a href="#h56-0-53" id="h56-0-53" class="i">+            android:paddingVertical=&quot;40dp&quot;
</a><a href="#h56-0-54" id="h56-0-54" class="i">+            android:text=&quot;No downloads&quot;
</a><a href="#h56-0-55" id="h56-0-55" class="i">+            android:textColor=&quot;@color/primaryText&quot; /&gt;
</a><a href="#h56-0-56" id="h56-0-56" class="i">+
</a><a href="#h56-0-57" id="h56-0-57" class="i">+    &lt;/RelativeLayout&gt;
</a><a href="#h56-0-58" id="h56-0-58" class="i">+
</a><a href="#h56-0-59" id="h56-0-59" class="i">+&lt;/LinearLayout&gt;</a><a href="#h56-0-60" id="h56-0-60" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h57" href="../file/app/src/main/res/layout/download_manager_item.xml.html">app/src/main/res/layout/download_manager_item.xml</a> b/<a href="../file/app/src/main/res/layout/download_manager_item.xml.html">app/src/main/res/layout/download_manager_item.xml</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -0,0 +1,70 @@
</a><a href="#h57-0-0" id="h57-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h57-0-1" id="h57-0-1" class="i">+&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h57-0-2" id="h57-0-2" class="i">+    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h57-0-3" id="h57-0-3" class="i">+    android:layout_width=&quot;match_parent&quot;
</a><a href="#h57-0-4" id="h57-0-4" class="i">+    android:layout_height=&quot;100dp&quot;
</a><a href="#h57-0-5" id="h57-0-5" class="i">+    android:layout_margin=&quot;5dp&quot;
</a><a href="#h57-0-6" id="h57-0-6" class="i">+    android:layout_marginBottom=&quot;10dp&quot;
</a><a href="#h57-0-7" id="h57-0-7" class="i">+    android:background=&quot;@drawable/download_manager_item_background&quot;
</a><a href="#h57-0-8" id="h57-0-8" class="i">+    android:gravity=&quot;center_vertical&quot;
</a><a href="#h57-0-9" id="h57-0-9" class="i">+    android:orientation=&quot;horizontal&quot;
</a><a href="#h57-0-10" id="h57-0-10" class="i">+    android:padding=&quot;5dp&quot;&gt;
</a><a href="#h57-0-11" id="h57-0-11" class="i">+
</a><a href="#h57-0-12" id="h57-0-12" class="i">+    &lt;RelativeLayout
</a><a href="#h57-0-13" id="h57-0-13" class="i">+        android:layout_width=&quot;0dp&quot;
</a><a href="#h57-0-14" id="h57-0-14" class="i">+        android:layout_height=&quot;wrap_content&quot;
</a><a href="#h57-0-15" id="h57-0-15" class="i">+        android:layout_weight=&quot;1&quot;&gt;
</a><a href="#h57-0-16" id="h57-0-16" class="i">+        &lt;LinearLayout
</a><a href="#h57-0-17" id="h57-0-17" class="i">+            android:layout_width=&quot;wrap_content&quot;
</a><a href="#h57-0-18" id="h57-0-18" class="i">+            android:layout_height=&quot;wrap_content&quot;
</a><a href="#h57-0-19" id="h57-0-19" class="i">+            android:background=&quot;@drawable/download_manager_item_background&quot;
</a><a href="#h57-0-20" id="h57-0-20" class="i">+            android:orientation=&quot;horizontal&quot;
</a><a href="#h57-0-21" id="h57-0-21" class="i">+            android:padding=&quot;5dp&quot;
</a><a href="#h57-0-22" id="h57-0-22" class="i">+            tools:ignore=&quot;UselessParent&quot;&gt;
</a><a href="#h57-0-23" id="h57-0-23" class="i">+            &lt;ImageView
</a><a href="#h57-0-24" id="h57-0-24" class="i">+                android:id=&quot;@+id/bitmoji_icon&quot;
</a><a href="#h57-0-25" id="h57-0-25" class="i">+                android:layout_width=&quot;45dp&quot;
</a><a href="#h57-0-26" id="h57-0-26" class="i">+                android:layout_height=&quot;45dp&quot;
</a><a href="#h57-0-27" id="h57-0-27" class="i">+                android:layout_margin=&quot;5dp&quot;
</a><a href="#h57-0-28" id="h57-0-28" class="i">+                tools:ignore=&quot;ContentDescription&quot; /&gt;
</a><a href="#h57-0-29" id="h57-0-29" class="i">+            &lt;LinearLayout
</a><a href="#h57-0-30" id="h57-0-30" class="i">+                android:layout_width=&quot;wrap_content&quot;
</a><a href="#h57-0-31" id="h57-0-31" class="i">+                android:layout_height=&quot;match_parent&quot;
</a><a href="#h57-0-32" id="h57-0-32" class="i">+                android:padding=&quot;5dp&quot;
</a><a href="#h57-0-33" id="h57-0-33" class="i">+                android:orientation=&quot;vertical&quot;&gt;
</a><a href="#h57-0-34" id="h57-0-34" class="i">+                &lt;TextView
</a><a href="#h57-0-35" id="h57-0-35" class="i">+                    android:id=&quot;@+id/item_title&quot;
</a><a href="#h57-0-36" id="h57-0-36" class="i">+                    android:layout_width=&quot;wrap_content&quot;
</a><a href="#h57-0-37" id="h57-0-37" class="i">+                    android:layout_height=&quot;wrap_content&quot;
</a><a href="#h57-0-38" id="h57-0-38" class="i">+                    android:textColor=&quot;@color/primaryText&quot;
</a><a href="#h57-0-39" id="h57-0-39" class="i">+                    android:textSize=&quot;17sp&quot;
</a><a href="#h57-0-40" id="h57-0-40" class="i">+                    android:textStyle=&quot;bold&quot; /&gt;
</a><a href="#h57-0-41" id="h57-0-41" class="i">+
</a><a href="#h57-0-42" id="h57-0-42" class="i">+                &lt;TextView
</a><a href="#h57-0-43" id="h57-0-43" class="i">+                    android:id=&quot;@+id/item_subtitle&quot;
</a><a href="#h57-0-44" id="h57-0-44" class="i">+                    android:layout_width=&quot;wrap_content&quot;
</a><a href="#h57-0-45" id="h57-0-45" class="i">+                    android:layout_height=&quot;wrap_content&quot;
</a><a href="#h57-0-46" id="h57-0-46" class="i">+                    android:textSize=&quot;14sp&quot;
</a><a href="#h57-0-47" id="h57-0-47" class="i">+                    android:textColor=&quot;@color/secondaryText&quot; /&gt;
</a><a href="#h57-0-48" id="h57-0-48" class="i">+            &lt;/LinearLayout&gt;
</a><a href="#h57-0-49" id="h57-0-49" class="i">+        &lt;/LinearLayout&gt;
</a><a href="#h57-0-50" id="h57-0-50" class="i">+    &lt;/RelativeLayout&gt;
</a><a href="#h57-0-51" id="h57-0-51" class="i">+
</a><a href="#h57-0-52" id="h57-0-52" class="i">+
</a><a href="#h57-0-53" id="h57-0-53" class="i">+    &lt;TextView
</a><a href="#h57-0-54" id="h57-0-54" class="i">+        android:id=&quot;@+id/item_status&quot;
</a><a href="#h57-0-55" id="h57-0-55" class="i">+        android:layout_width=&quot;wrap_content&quot;
</a><a href="#h57-0-56" id="h57-0-56" class="i">+        android:layout_height=&quot;wrap_content&quot;
</a><a href="#h57-0-57" id="h57-0-57" class="i">+        android:layout_marginEnd=&quot;10dp&quot;
</a><a href="#h57-0-58" id="h57-0-58" class="i">+        android:textColor=&quot;@color/primaryText&quot; /&gt;
</a><a href="#h57-0-59" id="h57-0-59" class="i">+
</a><a href="#h57-0-60" id="h57-0-60" class="i">+    &lt;Button
</a><a href="#h57-0-61" id="h57-0-61" class="i">+        android:id=&quot;@+id/item_action_button&quot;
</a><a href="#h57-0-62" id="h57-0-62" class="i">+        android:layout_width=&quot;wrap_content&quot;
</a><a href="#h57-0-63" id="h57-0-63" class="i">+        android:layout_height=&quot;35dp&quot;
</a><a href="#h57-0-64" id="h57-0-64" class="i">+        android:background=&quot;@drawable/action_button_cancel&quot;
</a><a href="#h57-0-65" id="h57-0-65" class="i">+        android:padding=&quot;5dp&quot;
</a><a href="#h57-0-66" id="h57-0-66" class="i">+        android:text=&quot;Cancel&quot;
</a><a href="#h57-0-67" id="h57-0-67" class="i">+        android:textColor=&quot;@color/darkText&quot;
</a><a href="#h57-0-68" id="h57-0-68" class="i">+        tools:ignore=&quot;ButtonOrder,HardcodedText&quot; /&gt;
</a><a href="#h57-0-69" id="h57-0-69" class="i">+&lt;/LinearLayout&gt;</a><a href="#h57-0-70" id="h57-0-70" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h58" href="../file/app/src/main/res/values/colors.xml.html">app/src/main/res/values/colors.xml</a> b/<a href="../file/app/src/main/res/values/colors.xml.html">app/src/main/res/values/colors.xml</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h58-0-0" id="h58-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h58-0-1" id="h58-0-1" class="i">+&lt;resources&gt;
</a><a href="#h58-0-2" id="h58-0-2" class="i">+    &lt;color name=&quot;actionBarColor&quot;&gt;#0B0B0B&lt;/color&gt;
</a><a href="#h58-0-3" id="h58-0-3" class="i">+    &lt;color name=&quot;primaryBackground&quot;&gt;#121212&lt;/color&gt;
</a><a href="#h58-0-4" id="h58-0-4" class="i">+    &lt;color name=&quot;secondaryBackground&quot;&gt;#1E1E1E&lt;/color&gt;
</a><a href="#h58-0-5" id="h58-0-5" class="i">+    &lt;color name=&quot;tertiaryBackground&quot;&gt;#2B2B2B&lt;/color&gt;
</a><a href="#h58-0-6" id="h58-0-6" class="i">+    &lt;color name=&quot;darkText&quot;&gt;#2B2B2B&lt;/color&gt;
</a><a href="#h58-0-7" id="h58-0-7" class="i">+    &lt;color name=&quot;primaryText&quot;&gt;#DEDEDE&lt;/color&gt;
</a><a href="#h58-0-8" id="h58-0-8" class="i">+    &lt;color name=&quot;secondaryText&quot;&gt;#999999&lt;/color&gt;
</a><a href="#h58-0-9" id="h58-0-9" class="i">+    &lt;color name=&quot;errorColor&quot;&gt;#DF4C5C&lt;/color&gt;
</a><a href="#h58-0-10" id="h58-0-10" class="i">+    &lt;color name=&quot;successColor&quot;&gt;#4FABF8&lt;/color&gt;
</a><a href="#h58-0-11" id="h58-0-11" class="i">+&lt;/resources&gt;</a><a href="#h58-0-12" id="h58-0-12" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h59" href="../file/app/src/main/res/values/dimens.xml.html">app/src/main/res/values/dimens.xml</a> b/<a href="../file/app/src/main/res/values/dimens.xml.html">app/src/main/res/values/dimens.xml</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -0,0 +1,4 @@
</a><a href="#h59-0-0" id="h59-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h59-0-1" id="h59-0-1" class="i">+&lt;resources&gt;
</a><a href="#h59-0-2" id="h59-0-2" class="i">+    &lt;dimen name=&quot;download_manager_item_preview_radius&quot;&gt;10dp&lt;/dimen&gt;
</a><a href="#h59-0-3" id="h59-0-3" class="i">+&lt;/resources&gt;</a><a href="#h59-0-4" id="h59-0-4" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h60" href="../file/app/src/main/res/values/themes.xml.html">app/src/main/res/values/themes.xml</a> b/<a href="../file/app/src/main/res/values/themes.xml.html">app/src/main/res/values/themes.xml</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h60-0-0" id="h60-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
</a><a href="#h60-0-1" id="h60-0-1" class="i">+&lt;resources&gt;
</a><a href="#h60-0-2" id="h60-0-2" class="i">+    &lt;style name=&quot;AppTheme&quot;&gt;
</a><a href="#h60-0-3" id="h60-0-3" class="i">+        &lt;item name=&quot;android:fontFamily&quot;&gt;@font/avenir_next_medium&lt;/item&gt;
</a><a href="#h60-0-4" id="h60-0-4" class="i">+    &lt;/style&gt;
</a><a href="#h60-0-5" id="h60-0-5" class="i">+&lt;/resources&gt;</a><a href="#h60-0-6" id="h60-0-6" class="i">+
\ No newline at end of file
</a></pre>
</div>
</body>
</html>
