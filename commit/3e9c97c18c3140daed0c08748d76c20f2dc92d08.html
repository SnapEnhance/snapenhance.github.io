<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(manager): conversation preview (wip) - add messaging bridge - refactor export chat messages - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3e9c97c18c3140daed0c08748d76c20f2dc92d08.html">3e9c97c18c3140daed0c08748d76c20f2dc92d08</a>
<b>parent</b> <a href="../commit/2b0e4ad09ae0d954f781ba0e00ad5e658f638560.html">2b0e4ad09ae0d954f781ba0e00ad5e658f638560</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat, 14 Oct 2023 18:56:16 +0200

feat(manager): conversation preview (wip)
- add messaging bridge
- refactor export chat messages

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt</a></td><td> | </td><td class="num">192</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></td><td> | </td><td class="num">129</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/MessagingBridge.aidl</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/types/Message.aidl</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">43</td><td><span class="i"></span><span class="d">-------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/CoreMessagingBridge.kt</a></td><td> | </td><td class="num">146</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>13 files changed, 490 insertions(+), 80 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -48,7 +48,7 @@ class RemoteSideContext(
</a>     val coroutineScope = CoroutineScope(Dispatchers.IO)
 
     private var _activity: WeakReference&lt;ComponentActivity&gt;? = null
<a href="#h0-0-3" id="h0-0-3" class="d">-    lateinit var bridgeService: BridgeService
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    var bridgeService: BridgeService? = null
</a> 
     var activity: ComponentActivity?
         get() = _activity?.get()
<a href="#h0-1" id="h0-1" class="h">@@ -158,11 +158,13 @@ class RemoteSideContext(
</a>         log.debug(message.toString())
     }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+    fun hasMessagingBridge() = bridgeService != null &amp;&amp; bridgeService?.messagingBridge != null
</a><a href="#h0-1-4" id="h0-1-4" class="i">+
</a>     fun checkForRequirements(overrideRequirements: Int? = null): Boolean {
         var requirements = overrideRequirements ?: 0
 
         if(BuildConfig.DEBUG) {
<a href="#h0-1-9" id="h0-1-9" class="d">-            var unixTime = System.currentTimeMillis() / 1000 //unix time in seconds cuz cool
</a><a href="#h0-1-10" id="h0-1-10" class="i">+            val unixTime = System.currentTimeMillis() / 1000 //unix time in seconds cuz cool
</a>             if(BuildConfig.BUILD_DATE + 604800 &lt; unixTime.toInt()) {
                 Toast.makeText(androidContext, &quot;This SnapEnhance build has expired.&quot;, Toast.LENGTH_LONG).show();
                 throw RuntimeException(&quot;This build has expired. This crash is intentional.&quot;)
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -5,6 +5,7 @@ import android.content.Intent
</a> import android.os.IBinder
 import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.SharedContextHolder
<a href="#h1-0-3" id="h1-0-3" class="i">+import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
</a> import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
 import me.rhunk.snapenhance.common.bridge.types.FileActionType
 import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
<a href="#h1-1" id="h1-1" class="h">@@ -22,6 +23,11 @@ class BridgeService : Service() {
</a>     private lateinit var messageLoggerWrapper: MessageLoggerWrapper
     private lateinit var remoteSideContext: RemoteSideContext
     lateinit var syncCallback: SyncCallback
<a href="#h1-1-3" id="h1-1-3" class="i">+    var messagingBridge: MessagingBridge? = null
</a><a href="#h1-1-4" id="h1-1-4" class="i">+
</a><a href="#h1-1-5" id="h1-1-5" class="i">+    override fun onDestroy() {
</a><a href="#h1-1-6" id="h1-1-6" class="i">+        remoteSideContext.bridgeService = null
</a><a href="#h1-1-7" id="h1-1-7" class="i">+    }
</a> 
     override fun onBind(intent: Intent): IBinder? {
         remoteSideContext = SharedContextHolder.remote(this).apply {
<a href="#h1-2" id="h1-2" class="h">@@ -177,6 +183,9 @@ class BridgeService : Service() {
</a> 
         override fun getE2eeInterface() = remoteSideContext.e2eeImplementation
         override fun getMessageLogger() = messageLoggerWrapper
<a href="#h1-2-3" id="h1-2-3" class="i">+        override fun registerMessagingBridge(bridge: MessagingBridge) {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+            messagingBridge = bridge
</a><a href="#h1-2-5" id="h1-2-5" class="i">+        }
</a> 
         override fun openSettingsOverlay() {
             runCatching {
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -220,7 +220,7 @@ class AddFriendDialog(
</a>                             getCurrentState = { context.modDatabase.getGroupInfo(group.conversationId) != null }
                         ) { state -&gt;
                             if (state) {
<a href="#h2-0-3" id="h2-0-3" class="d">-                                context.bridgeService.triggerScopeSync(SocialScope.GROUP, group.conversationId)
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                                context.bridgeService?.triggerScopeSync(SocialScope.GROUP, group.conversationId)
</a>                             } else {
                                 context.modDatabase.deleteGroup(group.conversationId)
                             }
<a href="#h2-1" id="h2-1" class="h">@@ -247,7 +247,7 @@ class AddFriendDialog(
</a>                             getCurrentState = { context.modDatabase.getFriendInfo(friend.userId) != null }
                         ) { state -&gt;
                             if (state) {
<a href="#h2-1-3" id="h2-1-3" class="d">-                                context.bridgeService.triggerScopeSync(SocialScope.FRIEND, friend.userId)
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                                context.bridgeService?.triggerScopeSync(SocialScope.FRIEND, friend.userId)
</a>                             } else {
                                 context.modDatabase.deleteFriend(friend.userId)
                             }
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,191 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.sections.social
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h3-0-3" id="h3-0-3" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import androidx.compose.foundation.lazy.LazyListState
</a><a href="#h3-0-5" id="h3-0-5" class="i">+import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h3-0-6" id="h3-0-6" class="i">+import androidx.compose.material3.Card
</a><a href="#h3-0-7" id="h3-0-7" class="i">+import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h3-0-8" id="h3-0-8" class="i">+import androidx.compose.material3.MaterialTheme
</a><a href="#h3-0-9" id="h3-0-9" class="i">+import androidx.compose.material3.Text
</a><a href="#h3-0-10" id="h3-0-10" class="i">+import androidx.compose.runtime.*
</a><a href="#h3-0-11" id="h3-0-11" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h3-0-12" id="h3-0-12" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h3-0-13" id="h3-0-13" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h3-0-14" id="h3-0-14" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h3-0-15" id="h3-0-15" class="i">+import kotlinx.coroutines.delay
</a><a href="#h3-0-16" id="h3-0-16" class="i">+import kotlinx.coroutines.launch
</a><a href="#h3-0-17" id="h3-0-17" class="i">+import kotlinx.coroutines.withTimeout
</a><a href="#h3-0-18" id="h3-0-18" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h3-0-19" id="h3-0-19" class="i">+import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
</a><a href="#h3-0-20" id="h3-0-20" class="i">+import me.rhunk.snapenhance.bridge.snapclient.types.Message
</a><a href="#h3-0-21" id="h3-0-21" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h3-0-22" id="h3-0-22" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h3-0-23" id="h3-0-23" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h3-0-24" id="h3-0-24" class="i">+import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h3-0-25" id="h3-0-25" class="i">+
</a><a href="#h3-0-26" id="h3-0-26" class="i">+class MessagingPreview(
</a><a href="#h3-0-27" id="h3-0-27" class="i">+    private val context: RemoteSideContext,
</a><a href="#h3-0-28" id="h3-0-28" class="i">+    private val scope: SocialScope,
</a><a href="#h3-0-29" id="h3-0-29" class="i">+    private val scopeId: String
</a><a href="#h3-0-30" id="h3-0-30" class="i">+) {
</a><a href="#h3-0-31" id="h3-0-31" class="i">+    private lateinit var coroutineScope: CoroutineScope
</a><a href="#h3-0-32" id="h3-0-32" class="i">+    private lateinit var messagingBridge: MessagingBridge
</a><a href="#h3-0-33" id="h3-0-33" class="i">+    private lateinit var previewScrollState: LazyListState
</a><a href="#h3-0-34" id="h3-0-34" class="i">+    private var conversationId: String? = null
</a><a href="#h3-0-35" id="h3-0-35" class="i">+    private val messages = sortedMapOf&lt;Long, Message&gt;()
</a><a href="#h3-0-36" id="h3-0-36" class="i">+    private var messageSize by mutableIntStateOf(0)
</a><a href="#h3-0-37" id="h3-0-37" class="i">+    private var lastMessageId = Long.MAX_VALUE
</a><a href="#h3-0-38" id="h3-0-38" class="i">+
</a><a href="#h3-0-39" id="h3-0-39" class="i">+    @Composable
</a><a href="#h3-0-40" id="h3-0-40" class="i">+    private fun ConversationPreview() {
</a><a href="#h3-0-41" id="h3-0-41" class="i">+        LazyColumn(
</a><a href="#h3-0-42" id="h3-0-42" class="i">+            modifier = Modifier
</a><a href="#h3-0-43" id="h3-0-43" class="i">+                .fillMaxSize(),
</a><a href="#h3-0-44" id="h3-0-44" class="i">+            state = previewScrollState,
</a><a href="#h3-0-45" id="h3-0-45" class="i">+        ) {
</a><a href="#h3-0-46" id="h3-0-46" class="i">+            item {
</a><a href="#h3-0-47" id="h3-0-47" class="i">+                if (messages.isEmpty()) {
</a><a href="#h3-0-48" id="h3-0-48" class="i">+                    Row(
</a><a href="#h3-0-49" id="h3-0-49" class="i">+                        modifier = Modifier
</a><a href="#h3-0-50" id="h3-0-50" class="i">+                            .fillMaxWidth()
</a><a href="#h3-0-51" id="h3-0-51" class="i">+                            .padding(40.dp),
</a><a href="#h3-0-52" id="h3-0-52" class="i">+                        horizontalArrangement = Arrangement.Center
</a><a href="#h3-0-53" id="h3-0-53" class="i">+                    ) {
</a><a href="#h3-0-54" id="h3-0-54" class="i">+                        Text(&quot;No messages&quot;)
</a><a href="#h3-0-55" id="h3-0-55" class="i">+                    }
</a><a href="#h3-0-56" id="h3-0-56" class="i">+                }
</a><a href="#h3-0-57" id="h3-0-57" class="i">+                Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h3-0-58" id="h3-0-58" class="i">+
</a><a href="#h3-0-59" id="h3-0-59" class="i">+                LaunchedEffect(Unit) {
</a><a href="#h3-0-60" id="h3-0-60" class="i">+                    if (messages.size &gt; 0) {
</a><a href="#h3-0-61" id="h3-0-61" class="i">+                        fetchNewMessages()
</a><a href="#h3-0-62" id="h3-0-62" class="i">+                    }
</a><a href="#h3-0-63" id="h3-0-63" class="i">+                }
</a><a href="#h3-0-64" id="h3-0-64" class="i">+            }
</a><a href="#h3-0-65" id="h3-0-65" class="i">+            items(messageSize) {index -&gt;
</a><a href="#h3-0-66" id="h3-0-66" class="i">+                val messageReader = ProtoReader(messages.entries.elementAt(index).value.content)
</a><a href="#h3-0-67" id="h3-0-67" class="i">+                val contentType = ContentType.fromMessageContainer(messageReader)
</a><a href="#h3-0-68" id="h3-0-68" class="i">+
</a><a href="#h3-0-69" id="h3-0-69" class="i">+                Card(
</a><a href="#h3-0-70" id="h3-0-70" class="i">+                    modifier = Modifier
</a><a href="#h3-0-71" id="h3-0-71" class="i">+                        .padding(5.dp)
</a><a href="#h3-0-72" id="h3-0-72" class="i">+                ) {
</a><a href="#h3-0-73" id="h3-0-73" class="i">+                    Row(
</a><a href="#h3-0-74" id="h3-0-74" class="i">+                        modifier = Modifier
</a><a href="#h3-0-75" id="h3-0-75" class="i">+                            .padding(5.dp)
</a><a href="#h3-0-76" id="h3-0-76" class="i">+                    ) {
</a><a href="#h3-0-77" id="h3-0-77" class="i">+
</a><a href="#h3-0-78" id="h3-0-78" class="i">+                        Text(&quot;[$contentType] ${messageReader.getString(2, 1) ?: &quot;&quot;}&quot;)
</a><a href="#h3-0-79" id="h3-0-79" class="i">+                    }
</a><a href="#h3-0-80" id="h3-0-80" class="i">+                }
</a><a href="#h3-0-81" id="h3-0-81" class="i">+            }
</a><a href="#h3-0-82" id="h3-0-82" class="i">+        }
</a><a href="#h3-0-83" id="h3-0-83" class="i">+    }
</a><a href="#h3-0-84" id="h3-0-84" class="i">+
</a><a href="#h3-0-85" id="h3-0-85" class="i">+    private fun fetchNewMessages() {
</a><a href="#h3-0-86" id="h3-0-86" class="i">+        coroutineScope.launch(Dispatchers.IO) cs@{
</a><a href="#h3-0-87" id="h3-0-87" class="i">+            runCatching {
</a><a href="#h3-0-88" id="h3-0-88" class="i">+                val queriedMessages = messagingBridge.fetchConversationWithMessagesPaginated(
</a><a href="#h3-0-89" id="h3-0-89" class="i">+                    conversationId!!,
</a><a href="#h3-0-90" id="h3-0-90" class="i">+                    100,
</a><a href="#h3-0-91" id="h3-0-91" class="i">+                    lastMessageId
</a><a href="#h3-0-92" id="h3-0-92" class="i">+                )
</a><a href="#h3-0-93" id="h3-0-93" class="i">+
</a><a href="#h3-0-94" id="h3-0-94" class="i">+                if (queriedMessages == null) {
</a><a href="#h3-0-95" id="h3-0-95" class="i">+                    context.shortToast(&quot;Failed to fetch messages&quot;)
</a><a href="#h3-0-96" id="h3-0-96" class="i">+                    return@cs
</a><a href="#h3-0-97" id="h3-0-97" class="i">+                }
</a><a href="#h3-0-98" id="h3-0-98" class="i">+
</a><a href="#h3-0-99" id="h3-0-99" class="i">+                coroutineScope.launch {
</a><a href="#h3-0-100" id="h3-0-100" class="i">+                    messages.putAll(queriedMessages.map { it.serverMessageId to it })
</a><a href="#h3-0-101" id="h3-0-101" class="i">+                    messageSize = messages.size
</a><a href="#h3-0-102" id="h3-0-102" class="i">+                    if (queriedMessages.isNotEmpty()) {
</a><a href="#h3-0-103" id="h3-0-103" class="i">+                        lastMessageId = queriedMessages.first().clientMessageId
</a><a href="#h3-0-104" id="h3-0-104" class="i">+                        previewScrollState.scrollToItem(queriedMessages.size - 1)
</a><a href="#h3-0-105" id="h3-0-105" class="i">+                    }
</a><a href="#h3-0-106" id="h3-0-106" class="i">+                }
</a><a href="#h3-0-107" id="h3-0-107" class="i">+            }.onFailure {
</a><a href="#h3-0-108" id="h3-0-108" class="i">+                context.shortToast(&quot;Failed to fetch messages: ${it.message}&quot;)
</a><a href="#h3-0-109" id="h3-0-109" class="i">+            }
</a><a href="#h3-0-110" id="h3-0-110" class="i">+            context.log.verbose(&quot;fetched ${messages.size} messages&quot;)
</a><a href="#h3-0-111" id="h3-0-111" class="i">+        }
</a><a href="#h3-0-112" id="h3-0-112" class="i">+    }
</a><a href="#h3-0-113" id="h3-0-113" class="i">+
</a><a href="#h3-0-114" id="h3-0-114" class="i">+    private fun onMessagingBridgeReady() {
</a><a href="#h3-0-115" id="h3-0-115" class="i">+        messagingBridge = context.bridgeService!!.messagingBridge!!
</a><a href="#h3-0-116" id="h3-0-116" class="i">+        conversationId = if (scope == SocialScope.FRIEND) messagingBridge.getOneToOneConversationId(scopeId) else scopeId
</a><a href="#h3-0-117" id="h3-0-117" class="i">+        if (conversationId == null) {
</a><a href="#h3-0-118" id="h3-0-118" class="i">+            context.longToast(&quot;Failed to fetch conversation id&quot;)
</a><a href="#h3-0-119" id="h3-0-119" class="i">+            return
</a><a href="#h3-0-120" id="h3-0-120" class="i">+        }
</a><a href="#h3-0-121" id="h3-0-121" class="i">+        fetchNewMessages()
</a><a href="#h3-0-122" id="h3-0-122" class="i">+    }
</a><a href="#h3-0-123" id="h3-0-123" class="i">+
</a><a href="#h3-0-124" id="h3-0-124" class="i">+    @Composable
</a><a href="#h3-0-125" id="h3-0-125" class="i">+    private fun LoadingRow() {
</a><a href="#h3-0-126" id="h3-0-126" class="i">+        Row(
</a><a href="#h3-0-127" id="h3-0-127" class="i">+            modifier = Modifier
</a><a href="#h3-0-128" id="h3-0-128" class="i">+                .fillMaxWidth()
</a><a href="#h3-0-129" id="h3-0-129" class="i">+                .padding(40.dp),
</a><a href="#h3-0-130" id="h3-0-130" class="i">+            horizontalArrangement = Arrangement.Center
</a><a href="#h3-0-131" id="h3-0-131" class="i">+        ) {
</a><a href="#h3-0-132" id="h3-0-132" class="i">+            CircularProgressIndicator(
</a><a href="#h3-0-133" id="h3-0-133" class="i">+                modifier = Modifier
</a><a href="#h3-0-134" id="h3-0-134" class="i">+                    .padding()
</a><a href="#h3-0-135" id="h3-0-135" class="i">+                    .size(30.dp),
</a><a href="#h3-0-136" id="h3-0-136" class="i">+                strokeWidth = 3.dp,
</a><a href="#h3-0-137" id="h3-0-137" class="i">+                color = MaterialTheme.colorScheme.primary
</a><a href="#h3-0-138" id="h3-0-138" class="i">+            )
</a><a href="#h3-0-139" id="h3-0-139" class="i">+        }
</a><a href="#h3-0-140" id="h3-0-140" class="i">+    }
</a><a href="#h3-0-141" id="h3-0-141" class="i">+
</a><a href="#h3-0-142" id="h3-0-142" class="i">+    @Composable
</a><a href="#h3-0-143" id="h3-0-143" class="i">+    fun Content() {
</a><a href="#h3-0-144" id="h3-0-144" class="i">+        previewScrollState = rememberLazyListState()
</a><a href="#h3-0-145" id="h3-0-145" class="i">+        coroutineScope = rememberCoroutineScope()
</a><a href="#h3-0-146" id="h3-0-146" class="i">+        var isBridgeConnected by remember { mutableStateOf(false) }
</a><a href="#h3-0-147" id="h3-0-147" class="i">+        var hasBridgeError by remember { mutableStateOf(false) }
</a><a href="#h3-0-148" id="h3-0-148" class="i">+
</a><a href="#h3-0-149" id="h3-0-149" class="i">+        Column(
</a><a href="#h3-0-150" id="h3-0-150" class="i">+            modifier = Modifier
</a><a href="#h3-0-151" id="h3-0-151" class="i">+                .fillMaxSize()
</a><a href="#h3-0-152" id="h3-0-152" class="i">+        ) {
</a><a href="#h3-0-153" id="h3-0-153" class="i">+            LaunchedEffect(Unit) {
</a><a href="#h3-0-154" id="h3-0-154" class="i">+                isBridgeConnected = context.hasMessagingBridge()
</a><a href="#h3-0-155" id="h3-0-155" class="i">+                if (isBridgeConnected) {
</a><a href="#h3-0-156" id="h3-0-156" class="i">+                    onMessagingBridgeReady()
</a><a href="#h3-0-157" id="h3-0-157" class="i">+                } else {
</a><a href="#h3-0-158" id="h3-0-158" class="i">+                    SnapWidgetBroadcastReceiverHelper.create(&quot;wakeup&quot;) {}.also {
</a><a href="#h3-0-159" id="h3-0-159" class="i">+                        context.androidContext.sendBroadcast(it)
</a><a href="#h3-0-160" id="h3-0-160" class="i">+                    }
</a><a href="#h3-0-161" id="h3-0-161" class="i">+                    coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h3-0-162" id="h3-0-162" class="i">+                        withTimeout(10000) {
</a><a href="#h3-0-163" id="h3-0-163" class="i">+                            while (!context.hasMessagingBridge()) {
</a><a href="#h3-0-164" id="h3-0-164" class="i">+                                delay(100)
</a><a href="#h3-0-165" id="h3-0-165" class="i">+                            }
</a><a href="#h3-0-166" id="h3-0-166" class="i">+                            isBridgeConnected = true
</a><a href="#h3-0-167" id="h3-0-167" class="i">+                            onMessagingBridgeReady()
</a><a href="#h3-0-168" id="h3-0-168" class="i">+                        }
</a><a href="#h3-0-169" id="h3-0-169" class="i">+                    }.invokeOnCompletion {
</a><a href="#h3-0-170" id="h3-0-170" class="i">+                        if (it != null) {
</a><a href="#h3-0-171" id="h3-0-171" class="i">+                            hasBridgeError = true
</a><a href="#h3-0-172" id="h3-0-172" class="i">+                        }
</a><a href="#h3-0-173" id="h3-0-173" class="i">+                    }
</a><a href="#h3-0-174" id="h3-0-174" class="i">+                }
</a><a href="#h3-0-175" id="h3-0-175" class="i">+            }
</a><a href="#h3-0-176" id="h3-0-176" class="i">+
</a><a href="#h3-0-177" id="h3-0-177" class="i">+            if (hasBridgeError) {
</a><a href="#h3-0-178" id="h3-0-178" class="i">+                Text(&quot;Failed to connect to Snapchat through bridge service&quot;)
</a><a href="#h3-0-179" id="h3-0-179" class="i">+            }
</a><a href="#h3-0-180" id="h3-0-180" class="i">+
</a><a href="#h3-0-181" id="h3-0-181" class="i">+            if (!isBridgeConnected &amp;&amp; !hasBridgeError) {
</a><a href="#h3-0-182" id="h3-0-182" class="i">+                LoadingRow()
</a><a href="#h3-0-183" id="h3-0-183" class="i">+            }
</a><a href="#h3-0-184" id="h3-0-184" class="i">+
</a><a href="#h3-0-185" id="h3-0-185" class="i">+            if (isBridgeConnected &amp;&amp; !hasBridgeError) {
</a><a href="#h3-0-186" id="h3-0-186" class="i">+                ConversationPreview()
</a><a href="#h3-0-187" id="h3-0-187" class="i">+            }
</a><a href="#h3-0-188" id="h3-0-188" class="i">+        }
</a><a href="#h3-0-189" id="h3-0-189" class="i">+    }
</a><a href="#h3-0-190" id="h3-0-190" class="i">+}</a><a href="#h3-0-191" id="h3-0-191" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -8,6 +8,7 @@ import androidx.compose.foundation.pager.HorizontalPager
</a> import androidx.compose.foundation.pager.rememberPagerState
 import androidx.compose.foundation.shape.RoundedCornerShape
 import androidx.compose.material.icons.Icons
<a href="#h4-0-3" id="h4-0-3" class="i">+import androidx.compose.material.icons.filled.RemoveRedEye
</a> import androidx.compose.material.icons.rounded.Add
 import androidx.compose.material.icons.rounded.DeleteForever
 import androidx.compose.material3.*
<a href="#h4-1" id="h4-1" class="h">@@ -42,8 +43,7 @@ class SocialSection : Section() {
</a> 
     companion object {
         const val MAIN_ROUTE = &quot;social_route&quot;
<a href="#h4-1-3" id="h4-1-3" class="d">-        const val FRIEND_INFO_ROUTE = &quot;friend_info/{id}&quot;
</a><a href="#h4-1-4" id="h4-1-4" class="d">-        const val GROUP_INFO_ROUTE = &quot;group_info/{id}&quot;
</a><a href="#h4-1-5" id="h4-1-5" class="i">+        const val MESSAGING_PREVIEW_ROUTE = &quot;messaging_preview/?id={id}&amp;scope={scope}&quot;
</a>     }
 
     private var currentScopeContent: ScopeContent? = null
<a href="#h4-2" id="h4-2" class="h">@@ -70,12 +70,26 @@ class SocialSection : Section() {
</a>                 composable(scope.tabRoute) {
                     val id = it.arguments?.getString(&quot;id&quot;) ?: return@composable
                     remember {
<a href="#h4-2-3" id="h4-2-3" class="d">-                        ScopeContent(context, this@SocialSection, navController, scope, id).also { tab -&gt;
</a><a href="#h4-2-4" id="h4-2-4" class="i">+                        ScopeContent(
</a><a href="#h4-2-5" id="h4-2-5" class="i">+                            context,
</a><a href="#h4-2-6" id="h4-2-6" class="i">+                            this@SocialSection,
</a><a href="#h4-2-7" id="h4-2-7" class="i">+                            navController,
</a><a href="#h4-2-8" id="h4-2-8" class="i">+                            scope,
</a><a href="#h4-2-9" id="h4-2-9" class="i">+                            id
</a><a href="#h4-2-10" id="h4-2-10" class="i">+                        ).also { tab -&gt;
</a>                             currentScopeContent = tab
                         }
                     }.Content()
                 }
             }
<a href="#h4-2-16" id="h4-2-16" class="i">+
</a><a href="#h4-2-17" id="h4-2-17" class="i">+            composable(MESSAGING_PREVIEW_ROUTE) {
</a><a href="#h4-2-18" id="h4-2-18" class="i">+                val id = it.arguments?.getString(&quot;id&quot;) ?: return@composable
</a><a href="#h4-2-19" id="h4-2-19" class="i">+                val scope = it.arguments?.getString(&quot;scope&quot;) ?: return@composable
</a><a href="#h4-2-20" id="h4-2-20" class="i">+                remember {
</a><a href="#h4-2-21" id="h4-2-21" class="i">+                    MessagingPreview(context, SocialScope.getByName(scope), id)
</a><a href="#h4-2-22" id="h4-2-22" class="i">+                }.Content()
</a><a href="#h4-2-23" id="h4-2-23" class="i">+            }
</a>         }
     }
 
<a href="#h4-3" id="h4-3" class="h">@@ -90,13 +104,15 @@ class SocialSection : Section() {
</a>                     remember { AlertDialogs(context.translation) }.ConfirmDialog(
                         title = &quot;Are you sure you want to delete this ${scopeContent.scope.key.lowercase()}?&quot;,
                         onDismiss = { deleteConfirmDialog = false },
<a href="#h4-3-3" id="h4-3-3" class="d">-                        onConfirm = { scopeContent.deleteScope(coroutineScope); deleteConfirmDialog = false }
</a><a href="#h4-3-4" id="h4-3-4" class="i">+                        onConfirm = {
</a><a href="#h4-3-5" id="h4-3-5" class="i">+                            scopeContent.deleteScope(coroutineScope); deleteConfirmDialog = false
</a><a href="#h4-3-6" id="h4-3-6" class="i">+                        }
</a>                     )
                 }
             }
         }
 
<a href="#h4-3-12" id="h4-3-12" class="d">-        if (currentRoute != MAIN_ROUTE) {
</a><a href="#h4-3-13" id="h4-3-13" class="i">+        if (currentRoute == SocialScope.FRIEND.tabRoute || currentRoute == SocialScope.GROUP.tabRoute) {
</a>             IconButton(
                 onClick = { deleteConfirmDialog = true },
             ) {
<a href="#h4-4" id="h4-4" class="h">@@ -128,7 +144,11 @@ class SocialSection : Section() {
</a> 
             if (listSize == 0) {
                 item {
<a href="#h4-4-3" id="h4-4-3" class="d">-                    Text(text = &quot;(empty)&quot;, modifier = Modifier.fillMaxWidth().padding(10.dp), textAlign = TextAlign.Center)
</a><a href="#h4-4-4" id="h4-4-4" class="i">+                    Text(
</a><a href="#h4-4-5" id="h4-4-5" class="i">+                        text = &quot;(empty)&quot;, modifier = Modifier
</a><a href="#h4-4-6" id="h4-4-6" class="i">+                            .fillMaxWidth()
</a><a href="#h4-4-7" id="h4-4-7" class="i">+                            .padding(10.dp), textAlign = TextAlign.Center
</a><a href="#h4-4-8" id="h4-4-8" class="i">+                    )
</a>                 }
             }
 
<a href="#h4-5" id="h4-5" class="h">@@ -149,31 +169,41 @@ class SocialSection : Section() {
</a>                             )
                         },
                 ) {
<a href="#h4-5-3" id="h4-5-3" class="d">-                    when (scope) {
</a><a href="#h4-5-4" id="h4-5-4" class="d">-                        SocialScope.GROUP -&gt; {
</a><a href="#h4-5-5" id="h4-5-5" class="d">-                            val group = groupList[index]
</a><a href="#h4-5-6" id="h4-5-6" class="d">-                            Column(
</a><a href="#h4-5-7" id="h4-5-7" class="d">-                                modifier = Modifier
</a><a href="#h4-5-8" id="h4-5-8" class="d">-                                    .padding(10.dp)
</a><a href="#h4-5-9" id="h4-5-9" class="d">-                                    .fillMaxSize(),
</a><a href="#h4-5-10" id="h4-5-10" class="d">-                                verticalArrangement = Arrangement.Center
</a><a href="#h4-5-11" id="h4-5-11" class="d">-                            ) {
</a><a href="#h4-5-12" id="h4-5-12" class="d">-                                Text(text = group.name, maxLines = 1, fontWeight = FontWeight.Bold)
</a><a href="#h4-5-13" id="h4-5-13" class="i">+                    Row(
</a><a href="#h4-5-14" id="h4-5-14" class="i">+                        modifier = Modifier
</a><a href="#h4-5-15" id="h4-5-15" class="i">+                            .padding(10.dp)
</a><a href="#h4-5-16" id="h4-5-16" class="i">+                            .fillMaxSize(),
</a><a href="#h4-5-17" id="h4-5-17" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-5-18" id="h4-5-18" class="i">+                    ) {
</a><a href="#h4-5-19" id="h4-5-19" class="i">+                        when (scope) {
</a><a href="#h4-5-20" id="h4-5-20" class="i">+                            SocialScope.GROUP -&gt; {
</a><a href="#h4-5-21" id="h4-5-21" class="i">+                                val group = groupList[index]
</a><a href="#h4-5-22" id="h4-5-22" class="i">+                                Column(
</a><a href="#h4-5-23" id="h4-5-23" class="i">+                                    modifier = Modifier
</a><a href="#h4-5-24" id="h4-5-24" class="i">+                                        .padding(10.dp)
</a><a href="#h4-5-25" id="h4-5-25" class="i">+                                        .fillMaxWidth()
</a><a href="#h4-5-26" id="h4-5-26" class="i">+                                        .weight(1f)
</a><a href="#h4-5-27" id="h4-5-27" class="i">+                                ) {
</a><a href="#h4-5-28" id="h4-5-28" class="i">+                                    Text(
</a><a href="#h4-5-29" id="h4-5-29" class="i">+                                        text = group.name,
</a><a href="#h4-5-30" id="h4-5-30" class="i">+                                        maxLines = 1,
</a><a href="#h4-5-31" id="h4-5-31" class="i">+                                        fontWeight = FontWeight.Bold
</a><a href="#h4-5-32" id="h4-5-32" class="i">+                                    )
</a><a href="#h4-5-33" id="h4-5-33" class="i">+                                }
</a>                             }
<a href="#h4-5-35" id="h4-5-35" class="d">-                        }
</a><a href="#h4-5-36" id="h4-5-36" class="d">-                        SocialScope.FRIEND -&gt; {
</a><a href="#h4-5-37" id="h4-5-37" class="d">-                            val friend = friendList[index]
</a><a href="#h4-5-38" id="h4-5-38" class="d">-                            val streaks = remember { context.modDatabase.getFriendStreaks(friend.userId) }
</a> 
<a href="#h4-5-40" id="h4-5-40" class="d">-                            Row(
</a><a href="#h4-5-41" id="h4-5-41" class="d">-                                modifier = Modifier
</a><a href="#h4-5-42" id="h4-5-42" class="d">-                                    .padding(10.dp)
</a><a href="#h4-5-43" id="h4-5-43" class="d">-                                    .fillMaxSize(),
</a><a href="#h4-5-44" id="h4-5-44" class="d">-                                verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-5-45" id="h4-5-45" class="d">-                            ) {
</a><a href="#h4-5-46" id="h4-5-46" class="i">+                            SocialScope.FRIEND -&gt; {
</a><a href="#h4-5-47" id="h4-5-47" class="i">+                                val friend = friendList[index]
</a><a href="#h4-5-48" id="h4-5-48" class="i">+                                val streaks =
</a><a href="#h4-5-49" id="h4-5-49" class="i">+                                    remember { context.modDatabase.getFriendStreaks(friend.userId) }
</a><a href="#h4-5-50" id="h4-5-50" class="i">+
</a>                                 BitmojiImage(
                                     context = context,
<a href="#h4-5-53" id="h4-5-53" class="d">-                                    url = BitmojiSelfie.getBitmojiSelfie(friend.selfieId, friend.bitmojiId, BitmojiSelfie.BitmojiSelfieType.THREE_D)
</a><a href="#h4-5-54" id="h4-5-54" class="i">+                                    url = BitmojiSelfie.getBitmojiSelfie(
</a><a href="#h4-5-55" id="h4-5-55" class="i">+                                        friend.selfieId,
</a><a href="#h4-5-56" id="h4-5-56" class="i">+                                        friend.bitmojiId,
</a><a href="#h4-5-57" id="h4-5-57" class="i">+                                        BitmojiSelfie.BitmojiSelfieType.THREE_D
</a><a href="#h4-5-58" id="h4-5-58" class="i">+                                    )
</a>                                 )
                                 Column(
                                     modifier = Modifier
<a href="#h4-6" id="h4-6" class="h">@@ -181,8 +211,17 @@ class SocialSection : Section() {
</a>                                         .fillMaxWidth()
                                         .weight(1f)
                                 ) {
<a href="#h4-6-3" id="h4-6-3" class="d">-                                    Text(text = friend.displayName ?: friend.mutableUsername, maxLines = 1, fontWeight = FontWeight.Bold)
</a><a href="#h4-6-4" id="h4-6-4" class="d">-                                    Text(text = friend.mutableUsername, maxLines = 1, fontSize = 12.sp, fontWeight = FontWeight.Light)
</a><a href="#h4-6-5" id="h4-6-5" class="i">+                                    Text(
</a><a href="#h4-6-6" id="h4-6-6" class="i">+                                        text = friend.displayName ?: friend.mutableUsername,
</a><a href="#h4-6-7" id="h4-6-7" class="i">+                                        maxLines = 1,
</a><a href="#h4-6-8" id="h4-6-8" class="i">+                                        fontWeight = FontWeight.Bold
</a><a href="#h4-6-9" id="h4-6-9" class="i">+                                    )
</a><a href="#h4-6-10" id="h4-6-10" class="i">+                                    Text(
</a><a href="#h4-6-11" id="h4-6-11" class="i">+                                        text = friend.mutableUsername,
</a><a href="#h4-6-12" id="h4-6-12" class="i">+                                        maxLines = 1,
</a><a href="#h4-6-13" id="h4-6-13" class="i">+                                        fontSize = 12.sp,
</a><a href="#h4-6-14" id="h4-6-14" class="i">+                                        fontWeight = FontWeight.Light
</a><a href="#h4-6-15" id="h4-6-15" class="i">+                                    )
</a>                                 }
                                 Row(
                                     verticalAlignment = Alignment.CenterVertically
<a href="#h4-7" id="h4-7" class="h">@@ -197,7 +236,11 @@ class SocialSection : Section() {
</a>                                             else MaterialTheme.colorScheme.primary
                                         )
                                         Text(
<a href="#h4-7-3" id="h4-7-3" class="d">-                                            text = context.translation.format(&quot;manager.sections.social.streaks_expiration_short&quot;, &quot;hours&quot; to ((streaks.expirationTimestamp - System.currentTimeMillis()) / 3600000).toInt().toString()),
</a><a href="#h4-7-4" id="h4-7-4" class="i">+                                            text = context.translation.format(
</a><a href="#h4-7-5" id="h4-7-5" class="i">+                                                &quot;manager.sections.social.streaks_expiration_short&quot;,
</a><a href="#h4-7-6" id="h4-7-6" class="i">+                                                &quot;hours&quot; to ((streaks.expirationTimestamp - System.currentTimeMillis()) / 3600000).toInt()
</a><a href="#h4-7-7" id="h4-7-7" class="i">+                                                    .toString()
</a><a href="#h4-7-8" id="h4-7-8" class="i">+                                            ),
</a>                                             maxLines = 1,
                                             fontWeight = FontWeight.Bold
                                         )
<a href="#h4-8" id="h4-8" class="h">@@ -205,6 +248,17 @@ class SocialSection : Section() {
</a>                                 }
                             }
                         }
<a href="#h4-8-3" id="h4-8-3" class="i">+
</a><a href="#h4-8-4" id="h4-8-4" class="i">+                        FilledIconButton(onClick = {
</a><a href="#h4-8-5" id="h4-8-5" class="i">+                            navController.navigate(
</a><a href="#h4-8-6" id="h4-8-6" class="i">+                                MESSAGING_PREVIEW_ROUTE.replace(&quot;{id}&quot;, id).replace(&quot;{scope}&quot;, scope.key)
</a><a href="#h4-8-7" id="h4-8-7" class="i">+                            )
</a><a href="#h4-8-8" id="h4-8-8" class="i">+                        }) {
</a><a href="#h4-8-9" id="h4-8-9" class="i">+                            Icon(
</a><a href="#h4-8-10" id="h4-8-10" class="i">+                                imageVector = Icons.Filled.RemoveRedEye,
</a><a href="#h4-8-11" id="h4-8-11" class="i">+                                contentDescription = null
</a><a href="#h4-8-12" id="h4-8-12" class="i">+                            )
</a><a href="#h4-8-13" id="h4-8-13" class="i">+                        }
</a>                     }
                 }
             }
<a href="#h4-9" id="h4-9" class="h">@@ -258,15 +312,24 @@ class SocialSection : Section() {
</a>                             selected = pagerState.currentPage == index,
                             onClick = {
                                 coroutineScope.launch {
<a href="#h4-9-3" id="h4-9-3" class="d">-                                    pagerState.animateScrollToPage( index )
</a><a href="#h4-9-4" id="h4-9-4" class="i">+                                    pagerState.animateScrollToPage(index)
</a>                                 }
                             },
<a href="#h4-9-7" id="h4-9-7" class="d">-                            text = { Text(text = title, maxLines = 2, overflow = TextOverflow.Ellipsis) }
</a><a href="#h4-9-8" id="h4-9-8" class="i">+                            text = {
</a><a href="#h4-9-9" id="h4-9-9" class="i">+                                Text(
</a><a href="#h4-9-10" id="h4-9-10" class="i">+                                    text = title,
</a><a href="#h4-9-11" id="h4-9-11" class="i">+                                    maxLines = 2,
</a><a href="#h4-9-12" id="h4-9-12" class="i">+                                    overflow = TextOverflow.Ellipsis
</a><a href="#h4-9-13" id="h4-9-13" class="i">+                                )
</a><a href="#h4-9-14" id="h4-9-14" class="i">+                            }
</a>                         )
                     }
                 }
 
<a href="#h4-9-19" id="h4-9-19" class="d">-                HorizontalPager(modifier = Modifier.padding(paddingValues), state = pagerState) { page -&gt;
</a><a href="#h4-9-20" id="h4-9-20" class="i">+                HorizontalPager(
</a><a href="#h4-9-21" id="h4-9-21" class="i">+                    modifier = Modifier.padding(paddingValues),
</a><a href="#h4-9-22" id="h4-9-22" class="i">+                    state = pagerState
</a><a href="#h4-9-23" id="h4-9-23" class="i">+                ) { page -&gt;
</a>                     when (page) {
                         0 -&gt; ScopeList(SocialScope.FRIEND)
                         1 -&gt; ScopeList(SocialScope.GROUP)
<b>diff --git a/<a id="h5" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -7,6 +7,7 @@ import me.rhunk.snapenhance.bridge.scripting.IScripting;
</a> import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface;
 import me.rhunk.snapenhance.bridge.MessageLoggerInterface;
 import me.rhunk.snapenhance.bridge.ConfigStateListener;
<a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge;
</a> 
 interface BridgeInterface {
     /**
<a href="#h5-1" id="h5-1" class="h">@@ -80,6 +81,8 @@ interface BridgeInterface {
</a> 
     MessageLoggerInterface getMessageLogger();
 
<a href="#h5-1-3" id="h5-1-3" class="i">+    void registerMessagingBridge(MessagingBridge bridge);
</a><a href="#h5-1-4" id="h5-1-4" class="i">+
</a>     void openSettingsOverlay();
 
     void closeSettingsOverlay();
<b>diff --git a/<a id="h6" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/MessagingBridge.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/MessagingBridge.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/MessagingBridge.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/MessagingBridge.aidl</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+package me.rhunk.snapenhance.bridge.snapclient;
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a><a href="#h6-0-2" id="h6-0-2" class="i">+import java.util.List;
</a><a href="#h6-0-3" id="h6-0-3" class="i">+import me.rhunk.snapenhance.bridge.snapclient.types.Message;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+
</a><a href="#h6-0-5" id="h6-0-5" class="i">+interface MessagingBridge {
</a><a href="#h6-0-6" id="h6-0-6" class="i">+    @nullable Message fetchMessage(String conversationId, String clientMessageId);
</a><a href="#h6-0-7" id="h6-0-7" class="i">+
</a><a href="#h6-0-8" id="h6-0-8" class="i">+    @nullable Message fetchMessageByServerId(String conversationId, String serverMessageId);
</a><a href="#h6-0-9" id="h6-0-9" class="i">+
</a><a href="#h6-0-10" id="h6-0-10" class="i">+    @nullable List&lt;Message&gt; fetchConversationWithMessagesPaginated(String conversationId, int limit, long beforeMessageId);
</a><a href="#h6-0-11" id="h6-0-11" class="i">+
</a><a href="#h6-0-12" id="h6-0-12" class="i">+    @nullable String updateMessage(String conversationId, String clientMessageId, String messageUpdate);
</a><a href="#h6-0-13" id="h6-0-13" class="i">+
</a><a href="#h6-0-14" id="h6-0-14" class="i">+    @nullable String getOneToOneConversationId(String userId);
</a><a href="#h6-0-15" id="h6-0-15" class="i">+}</a><a href="#h6-0-16" id="h6-0-16" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h7" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/types/Message.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/types/Message.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/types/Message.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/snapclient/types/Message.aidl</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+package me.rhunk.snapenhance.bridge.snapclient.types;
</a><a href="#h7-0-1" id="h7-0-1" class="i">+
</a><a href="#h7-0-2" id="h7-0-2" class="i">+parcelable Message {
</a><a href="#h7-0-3" id="h7-0-3" class="i">+    String conversationId;
</a><a href="#h7-0-4" id="h7-0-4" class="i">+    String senderId;
</a><a href="#h7-0-5" id="h7-0-5" class="i">+    int contentType;
</a><a href="#h7-0-6" id="h7-0-6" class="i">+    long clientMessageId;
</a><a href="#h7-0-7" id="h7-0-7" class="i">+    long serverMessageId;
</a><a href="#h7-0-8" id="h7-0-8" class="i">+    byte[] content;
</a><a href="#h7-0-9" id="h7-0-9" class="i">+    List&lt;String&gt; mediaReferences;
</a><a href="#h7-0-10" id="h7-0-10" class="i">+}</a><a href="#h7-0-11" id="h7-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -19,6 +19,7 @@ import me.rhunk.snapenhance.core.bridge.loadFromBridge
</a> import me.rhunk.snapenhance.core.data.SnapClassCache
 import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
<a href="#h8-0-3" id="h8-0-3" class="i">+import me.rhunk.snapenhance.core.messaging.CoreMessagingBridge
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import kotlin.system.measureTimeMillis
<a href="#h8-1" id="h8-1" class="h">@@ -116,6 +117,7 @@ class SnapEnhance {
</a>                     logCritical(null, throwable)
                 }
             }
<a href="#h8-1-3" id="h8-1-3" class="i">+            bridgeClient.registerMessagingBridge(CoreMessagingBridge(this))
</a> 
             reloadConfig()
             actionManager.init()
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -25,16 +25,7 @@ import java.io.File
</a> import kotlin.math.absoluteValue
 
 class ExportChatMessages : AbstractAction() {
<a href="#h9-0-3" id="h9-0-3" class="d">-    private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
</a><a href="#h9-0-4" id="h9-0-4" class="d">-
</a>     private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
<a href="#h9-0-6" id="h9-0-6" class="d">-
</a><a href="#h9-0-7" id="h9-0-7" class="d">-    private val enterConversationMethod by lazy {
</a><a href="#h9-0-8" id="h9-0-8" class="d">-        context.classCache.conversationManager.methods.first { it.name == &quot;enterConversation&quot; }
</a><a href="#h9-0-9" id="h9-0-9" class="d">-    }
</a><a href="#h9-0-10" id="h9-0-10" class="d">-    private val exitConversationMethod by lazy {
</a><a href="#h9-0-11" id="h9-0-11" class="d">-        context.classCache.conversationManager.methods.first { it.name == &quot;exitConversation&quot; }
</a><a href="#h9-0-12" id="h9-0-12" class="d">-    }
</a>     private val fetchConversationWithMessagesPaginatedMethod by lazy {
         context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessagesPaginated&quot; }
     }
<a href="#h9-1" id="h9-1" class="h">@@ -162,32 +153,6 @@ class ExportChatMessages : AbstractAction() {
</a>         }
     }
 
<a href="#h9-1-3" id="h9-1-3" class="d">-    private suspend fun conversationAction(isEntering: Boolean, conversationId: String, conversationType: String?) = suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h9-1-4" id="h9-1-4" class="d">-        val callback = CallbackBuilder(callbackClass)
</a><a href="#h9-1-5" id="h9-1-5" class="d">-            .override(&quot;onSuccess&quot;) { _ -&gt;
</a><a href="#h9-1-6" id="h9-1-6" class="d">-                continuation.resumeWith(Result.success(Unit))
</a><a href="#h9-1-7" id="h9-1-7" class="d">-            }
</a><a href="#h9-1-8" id="h9-1-8" class="d">-            .override(&quot;onError&quot;) {
</a><a href="#h9-1-9" id="h9-1-9" class="d">-                continuation.resumeWith(Result.failure(Exception(&quot;Failed to ${if (isEntering) &quot;enter&quot; else &quot;exit&quot;} conversation&quot;)))
</a><a href="#h9-1-10" id="h9-1-10" class="d">-            }.build()
</a><a href="#h9-1-11" id="h9-1-11" class="d">-
</a><a href="#h9-1-12" id="h9-1-12" class="d">-        if (isEntering) {
</a><a href="#h9-1-13" id="h9-1-13" class="d">-            enterConversationMethod.invoke(
</a><a href="#h9-1-14" id="h9-1-14" class="d">-                conversationManagerInstance,
</a><a href="#h9-1-15" id="h9-1-15" class="d">-                SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h9-1-16" id="h9-1-16" class="d">-                enterConversationMethod.parameterTypes[1].enumConstants.first { it.toString() == conversationType },
</a><a href="#h9-1-17" id="h9-1-17" class="d">-                callback
</a><a href="#h9-1-18" id="h9-1-18" class="d">-            )
</a><a href="#h9-1-19" id="h9-1-19" class="d">-        } else {
</a><a href="#h9-1-20" id="h9-1-20" class="d">-            exitConversationMethod.invoke(
</a><a href="#h9-1-21" id="h9-1-21" class="d">-                conversationManagerInstance,
</a><a href="#h9-1-22" id="h9-1-22" class="d">-                SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h9-1-23" id="h9-1-23" class="d">-                Long.MAX_VALUE,
</a><a href="#h9-1-24" id="h9-1-24" class="d">-                callback
</a><a href="#h9-1-25" id="h9-1-25" class="d">-            )
</a><a href="#h9-1-26" id="h9-1-26" class="d">-        }
</a><a href="#h9-1-27" id="h9-1-27" class="d">-    }
</a><a href="#h9-1-28" id="h9-1-28" class="d">-
</a>     private suspend fun fetchMessagesPaginated(conversationId: String, lastMessageId: Long, amount: Int) = suspendCancellableCoroutine { continuation -&gt;
         val callback = CallbackBuilder(fetchConversationWithMessagesCallbackClass)
             .override(&quot;onFetchConversationWithMessagesComplete&quot;) { param -&gt;
<a href="#h9-2" id="h9-2" class="h">@@ -213,10 +178,6 @@ class ExportChatMessages : AbstractAction() {
</a>         val conversationId = friendFeedEntry.key!!
         val conversationName = friendFeedEntry.feedDisplayName ?: friendFeedEntry.friendDisplayName!!.split(&quot;|&quot;).lastOrNull() ?: &quot;unknown&quot;
 
<a href="#h9-2-3" id="h9-2-3" class="d">-        runCatching {
</a><a href="#h9-2-4" id="h9-2-4" class="d">-            conversationAction(true, conversationId, if (friendFeedEntry.feedDisplayName != null) &quot;USERCREATEDGROUP&quot; else &quot;ONEONONE&quot;)
</a><a href="#h9-2-5" id="h9-2-5" class="d">-        }
</a><a href="#h9-2-6" id="h9-2-6" class="d">-
</a>         logDialog(context.translation.format(&quot;chat_export.exporting_message&quot;, &quot;conversation&quot; to conversationName))
 
         val foundMessages = fetchMessagesPaginated(conversationId, Long.MAX_VALUE, amount = 1).toMutableList()
<a href="#h9-3" id="h9-3" class="h">@@ -266,10 +227,6 @@ class ExportChatMessages : AbstractAction() {
</a>         logDialog(&quot;\n&quot; + context.translation.format(&quot;chat_export.exported_to&quot;,
             &quot;path&quot; to outputFile.absolutePath.toString()
         ) + &quot;\n&quot;)
<a href="#h9-3-3" id="h9-3-3" class="d">-
</a><a href="#h9-3-4" id="h9-3-4" class="d">-        runCatching {
</a><a href="#h9-3-5" id="h9-3-5" class="d">-            conversationAction(false, conversationId, null)
</a><a href="#h9-3-6" id="h9-3-6" class="d">-        }
</a>     }
 
     private fun exportChatForConversations(conversations: List&lt;FriendFeedEntry&gt;) {
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -16,6 +16,7 @@ import me.rhunk.snapenhance.bridge.DownloadCallback
</a> import me.rhunk.snapenhance.bridge.SyncCallback
 import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface
 import me.rhunk.snapenhance.bridge.scripting.IScripting
<a href="#h10-0-3" id="h10-0-3" class="i">+import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
</a> import me.rhunk.snapenhance.common.BuildConfig
 import me.rhunk.snapenhance.common.bridge.FileLoaderWrapper
 import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
<a href="#h10-1" id="h10-1" class="h">@@ -147,6 +148,8 @@ class BridgeClient(
</a> 
     fun getMessageLogger() = service.messageLogger
 
<a href="#h10-1-3" id="h10-1-3" class="i">+    fun registerMessagingBridge(bridge: MessagingBridge) = service.registerMessagingBridge(bridge)
</a><a href="#h10-1-4" id="h10-1-4" class="i">+
</a>     fun openSettingsOverlay() = service.openSettingsOverlay()
     fun closeSettingsOverlay() = service.closeSettingsOverlay()
 
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -60,6 +60,10 @@ object MessageDecoder {
</a>             .toList()
     }
 
<a href="#h11-0-3" id="h11-0-3" class="i">+    fun getEncodedMediaReferences(messageContent: MessageContent): List&lt;String&gt; {
</a><a href="#h11-0-4" id="h11-0-4" class="i">+        return getEncodedMediaReferences(gson.toJsonTree(messageContent.instanceNonNull()))
</a><a href="#h11-0-5" id="h11-0-5" class="i">+    }
</a><a href="#h11-0-6" id="h11-0-6" class="i">+
</a>     fun getMediaReferences(messageContent: JsonElement): List&lt;JsonElement&gt; {
         return messageContent.asJsonObject.getAsJsonArray(&quot;mRemoteMediaReferences&quot;)
             .asSequence()
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/CoreMessagingBridge.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/CoreMessagingBridge.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/CoreMessagingBridge.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/CoreMessagingBridge.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,145 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance.core.messaging
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import kotlinx.coroutines.suspendCancellableCoroutine
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
</a><a href="#h12-0-5" id="h12-0-5" class="i">+import me.rhunk.snapenhance.bridge.snapclient.types.Message
</a><a href="#h12-0-6" id="h12-0-6" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h12-0-7" id="h12-0-7" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
</a><a href="#h12-0-8" id="h12-0-8" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h12-0-9" id="h12-0-9" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h12-0-10" id="h12-0-10" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h12-0-11" id="h12-0-11" class="i">+
</a><a href="#h12-0-12" id="h12-0-12" class="i">+
</a><a href="#h12-0-13" id="h12-0-13" class="i">+fun me.rhunk.snapenhance.core.wrapper.impl.Message.toBridge(): Message {
</a><a href="#h12-0-14" id="h12-0-14" class="i">+    return Message().also { output -&gt;
</a><a href="#h12-0-15" id="h12-0-15" class="i">+        output.conversationId = this.messageDescriptor.conversationId.toString()
</a><a href="#h12-0-16" id="h12-0-16" class="i">+        output.senderId = this.senderId.toString()
</a><a href="#h12-0-17" id="h12-0-17" class="i">+        output.clientMessageId = this.messageDescriptor.messageId
</a><a href="#h12-0-18" id="h12-0-18" class="i">+        output.serverMessageId = this.orderKey
</a><a href="#h12-0-19" id="h12-0-19" class="i">+        output.contentType = this.messageContent.contentType?.id ?: -1
</a><a href="#h12-0-20" id="h12-0-20" class="i">+        output.content = this.messageContent.content
</a><a href="#h12-0-21" id="h12-0-21" class="i">+        output.mediaReferences = MessageDecoder.getEncodedMediaReferences(this.messageContent)
</a><a href="#h12-0-22" id="h12-0-22" class="i">+    }
</a><a href="#h12-0-23" id="h12-0-23" class="i">+}
</a><a href="#h12-0-24" id="h12-0-24" class="i">+
</a><a href="#h12-0-25" id="h12-0-25" class="i">+
</a><a href="#h12-0-26" id="h12-0-26" class="i">+class CoreMessagingBridge(
</a><a href="#h12-0-27" id="h12-0-27" class="i">+    private val context: ModContext
</a><a href="#h12-0-28" id="h12-0-28" class="i">+) : MessagingBridge.Stub() {
</a><a href="#h12-0-29" id="h12-0-29" class="i">+    private val conversationManager get() = context.feature(Messaging::class).conversationManager
</a><a href="#h12-0-30" id="h12-0-30" class="i">+
</a><a href="#h12-0-31" id="h12-0-31" class="i">+    override fun fetchMessage(conversationId: String, clientMessageId: String): Message? {
</a><a href="#h12-0-32" id="h12-0-32" class="i">+        return runBlocking {
</a><a href="#h12-0-33" id="h12-0-33" class="i">+            suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h12-0-34" id="h12-0-34" class="i">+                val callback = CallbackBuilder(
</a><a href="#h12-0-35" id="h12-0-35" class="i">+                    context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchMessageCallback&quot;)
</a><a href="#h12-0-36" id="h12-0-36" class="i">+                ).override(&quot;onFetchMessageComplete&quot;) { param -&gt;
</a><a href="#h12-0-37" id="h12-0-37" class="i">+                    val message = me.rhunk.snapenhance.core.wrapper.impl.Message(param.arg(1)).toBridge()
</a><a href="#h12-0-38" id="h12-0-38" class="i">+                    continuation.resumeWith(Result.success(message))
</a><a href="#h12-0-39" id="h12-0-39" class="i">+                }
</a><a href="#h12-0-40" id="h12-0-40" class="i">+                .override(&quot;onServerRequest&quot;, shouldUnhook = false) {}
</a><a href="#h12-0-41" id="h12-0-41" class="i">+                .override(&quot;onError&quot;) {
</a><a href="#h12-0-42" id="h12-0-42" class="i">+                    continuation.resumeWith(Result.success(null))
</a><a href="#h12-0-43" id="h12-0-43" class="i">+                }.build()
</a><a href="#h12-0-44" id="h12-0-44" class="i">+
</a><a href="#h12-0-45" id="h12-0-45" class="i">+                context.classCache.conversationManager.methods.first { it.name == &quot;fetchMessage&quot; }.invoke(
</a><a href="#h12-0-46" id="h12-0-46" class="i">+                    conversationManager,
</a><a href="#h12-0-47" id="h12-0-47" class="i">+                    SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h12-0-48" id="h12-0-48" class="i">+                    clientMessageId,
</a><a href="#h12-0-49" id="h12-0-49" class="i">+                    callback
</a><a href="#h12-0-50" id="h12-0-50" class="i">+                )
</a><a href="#h12-0-51" id="h12-0-51" class="i">+            }
</a><a href="#h12-0-52" id="h12-0-52" class="i">+        }
</a><a href="#h12-0-53" id="h12-0-53" class="i">+    }
</a><a href="#h12-0-54" id="h12-0-54" class="i">+
</a><a href="#h12-0-55" id="h12-0-55" class="i">+    override fun fetchMessageByServerId(
</a><a href="#h12-0-56" id="h12-0-56" class="i">+        conversationId: String,
</a><a href="#h12-0-57" id="h12-0-57" class="i">+        serverMessageId: String
</a><a href="#h12-0-58" id="h12-0-58" class="i">+    ): Message? {
</a><a href="#h12-0-59" id="h12-0-59" class="i">+        return runBlocking {
</a><a href="#h12-0-60" id="h12-0-60" class="i">+            suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h12-0-61" id="h12-0-61" class="i">+                val callback = CallbackBuilder(
</a><a href="#h12-0-62" id="h12-0-62" class="i">+                    context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchMessageCallback&quot;)
</a><a href="#h12-0-63" id="h12-0-63" class="i">+                ).override(&quot;onFetchMessageComplete&quot;) { param -&gt;
</a><a href="#h12-0-64" id="h12-0-64" class="i">+                    val message = me.rhunk.snapenhance.core.wrapper.impl.Message(param.arg(1)).toBridge()
</a><a href="#h12-0-65" id="h12-0-65" class="i">+                    continuation.resumeWith(Result.success(message))
</a><a href="#h12-0-66" id="h12-0-66" class="i">+                }
</a><a href="#h12-0-67" id="h12-0-67" class="i">+                .override(&quot;onServerRequest&quot;, shouldUnhook = false) {}
</a><a href="#h12-0-68" id="h12-0-68" class="i">+                .override(&quot;onError&quot;) {
</a><a href="#h12-0-69" id="h12-0-69" class="i">+                    continuation.resumeWith(Result.success(null))
</a><a href="#h12-0-70" id="h12-0-70" class="i">+                }.build()
</a><a href="#h12-0-71" id="h12-0-71" class="i">+
</a><a href="#h12-0-72" id="h12-0-72" class="i">+                val serverMessageIdentifier = context.androidContext.classLoader.loadClass(&quot;com.snapchat.client.messaging.ServerMessageIdentifier&quot;)
</a><a href="#h12-0-73" id="h12-0-73" class="i">+                    .getConstructor(context.classCache.snapUUID, Long::class.javaPrimitiveType)
</a><a href="#h12-0-74" id="h12-0-74" class="i">+                    .newInstance(SnapUUID.fromString(conversationId).instanceNonNull(), serverMessageId.toLong())
</a><a href="#h12-0-75" id="h12-0-75" class="i">+
</a><a href="#h12-0-76" id="h12-0-76" class="i">+                context.classCache.conversationManager.methods.first { it.name == &quot;fetchMessageByServerId&quot; }.invoke(
</a><a href="#h12-0-77" id="h12-0-77" class="i">+                    conversationManager,
</a><a href="#h12-0-78" id="h12-0-78" class="i">+                    serverMessageIdentifier,
</a><a href="#h12-0-79" id="h12-0-79" class="i">+                    callback
</a><a href="#h12-0-80" id="h12-0-80" class="i">+                )
</a><a href="#h12-0-81" id="h12-0-81" class="i">+            }
</a><a href="#h12-0-82" id="h12-0-82" class="i">+        }
</a><a href="#h12-0-83" id="h12-0-83" class="i">+    }
</a><a href="#h12-0-84" id="h12-0-84" class="i">+
</a><a href="#h12-0-85" id="h12-0-85" class="i">+    override fun fetchConversationWithMessagesPaginated(
</a><a href="#h12-0-86" id="h12-0-86" class="i">+        conversationId: String,
</a><a href="#h12-0-87" id="h12-0-87" class="i">+        limit: Int,
</a><a href="#h12-0-88" id="h12-0-88" class="i">+        beforeMessageId: Long
</a><a href="#h12-0-89" id="h12-0-89" class="i">+    ): List&lt;Message&gt;? {
</a><a href="#h12-0-90" id="h12-0-90" class="i">+        return runBlocking {
</a><a href="#h12-0-91" id="h12-0-91" class="i">+            suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h12-0-92" id="h12-0-92" class="i">+                val callback = CallbackBuilder(
</a><a href="#h12-0-93" id="h12-0-93" class="i">+                    context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;)
</a><a href="#h12-0-94" id="h12-0-94" class="i">+                ).override(&quot;onFetchConversationWithMessagesComplete&quot;) { param -&gt;
</a><a href="#h12-0-95" id="h12-0-95" class="i">+                    val messagesList = param.arg&lt;List&lt;*&gt;&gt;(1).map {
</a><a href="#h12-0-96" id="h12-0-96" class="i">+                        me.rhunk.snapenhance.core.wrapper.impl.Message(it).toBridge()
</a><a href="#h12-0-97" id="h12-0-97" class="i">+                    }
</a><a href="#h12-0-98" id="h12-0-98" class="i">+                    continuation.resumeWith(Result.success(messagesList))
</a><a href="#h12-0-99" id="h12-0-99" class="i">+                }
</a><a href="#h12-0-100" id="h12-0-100" class="i">+                .override(&quot;onServerRequest&quot;, shouldUnhook = false) {}
</a><a href="#h12-0-101" id="h12-0-101" class="i">+                .override(&quot;onError&quot;) {
</a><a href="#h12-0-102" id="h12-0-102" class="i">+                    continuation.resumeWith(Result.success(null))
</a><a href="#h12-0-103" id="h12-0-103" class="i">+                }.build()
</a><a href="#h12-0-104" id="h12-0-104" class="i">+
</a><a href="#h12-0-105" id="h12-0-105" class="i">+                context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessagesPaginated&quot; }.invoke(
</a><a href="#h12-0-106" id="h12-0-106" class="i">+                    conversationManager,
</a><a href="#h12-0-107" id="h12-0-107" class="i">+                    SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h12-0-108" id="h12-0-108" class="i">+                    beforeMessageId,
</a><a href="#h12-0-109" id="h12-0-109" class="i">+                    limit,
</a><a href="#h12-0-110" id="h12-0-110" class="i">+                    callback
</a><a href="#h12-0-111" id="h12-0-111" class="i">+                )
</a><a href="#h12-0-112" id="h12-0-112" class="i">+            }
</a><a href="#h12-0-113" id="h12-0-113" class="i">+        }
</a><a href="#h12-0-114" id="h12-0-114" class="i">+    }
</a><a href="#h12-0-115" id="h12-0-115" class="i">+
</a><a href="#h12-0-116" id="h12-0-116" class="i">+    override fun updateMessage(
</a><a href="#h12-0-117" id="h12-0-117" class="i">+        conversationId: String,
</a><a href="#h12-0-118" id="h12-0-118" class="i">+        clientMessageId: String,
</a><a href="#h12-0-119" id="h12-0-119" class="i">+        messageUpdate: String
</a><a href="#h12-0-120" id="h12-0-120" class="i">+    ): String? {
</a><a href="#h12-0-121" id="h12-0-121" class="i">+        return runBlocking {
</a><a href="#h12-0-122" id="h12-0-122" class="i">+            suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h12-0-123" id="h12-0-123" class="i">+                val callback = CallbackBuilder(
</a><a href="#h12-0-124" id="h12-0-124" class="i">+                    context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;)
</a><a href="#h12-0-125" id="h12-0-125" class="i">+                ).override(&quot;onSuccess&quot;) {
</a><a href="#h12-0-126" id="h12-0-126" class="i">+                    continuation.resumeWith(Result.success(null))
</a><a href="#h12-0-127" id="h12-0-127" class="i">+                }
</a><a href="#h12-0-128" id="h12-0-128" class="i">+                .override(&quot;onError&quot;) {
</a><a href="#h12-0-129" id="h12-0-129" class="i">+                    continuation.resumeWith(Result.success(it.arg&lt;Any&gt;(0).toString()))
</a><a href="#h12-0-130" id="h12-0-130" class="i">+                }.build()
</a><a href="#h12-0-131" id="h12-0-131" class="i">+
</a><a href="#h12-0-132" id="h12-0-132" class="i">+                context.classCache.conversationManager.methods.first { it.name == &quot;updateMessage&quot; }.invoke(
</a><a href="#h12-0-133" id="h12-0-133" class="i">+                    conversationManager,
</a><a href="#h12-0-134" id="h12-0-134" class="i">+                    SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h12-0-135" id="h12-0-135" class="i">+                    clientMessageId,
</a><a href="#h12-0-136" id="h12-0-136" class="i">+                    context.classCache.messageUpdateEnum.enumConstants.first { it.toString() == messageUpdate },
</a><a href="#h12-0-137" id="h12-0-137" class="i">+                    callback
</a><a href="#h12-0-138" id="h12-0-138" class="i">+                )
</a><a href="#h12-0-139" id="h12-0-139" class="i">+            }
</a><a href="#h12-0-140" id="h12-0-140" class="i">+        }
</a><a href="#h12-0-141" id="h12-0-141" class="i">+    }
</a><a href="#h12-0-142" id="h12-0-142" class="i">+
</a><a href="#h12-0-143" id="h12-0-143" class="i">+    override fun getOneToOneConversationId(userId: String) = context.database.getConversationLinkFromUserId(userId)?.clientConversationId
</a><a href="#h12-0-144" id="h12-0-144" class="i">+}</a><a href="#h12-0-145" id="h12-0-145" class="i">+
\ No newline at end of file
</a></pre>
</div>
</body>
</html>
