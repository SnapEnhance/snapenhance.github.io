<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(scripting): module updater - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/97aed78894b02f8c19354243d4cfe81d9e384126.html">97aed78894b02f8c19354243d4cfe81d9e384126</a>
<b>parent</b> <a href="../commit/adf2eff024dc0ba5e2bdaa847b52f16250aeb8f4.html">adf2eff024dc0ba5e2bdaa847b52f16250aeb8f4</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Wed, 22 May 2024 22:39:41 +0200

feat(scripting): module updater

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt</a></td><td> | </td><td class="num">69</td><td><span class="i">+++++++++</span><span class="d">------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">++</span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a></td><td> | </td><td class="num">52</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/OkHttp.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>8 files changed, 173 insertions(+), 151 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -13,12 +13,13 @@ import me.rhunk.snapenhance.common.scripting.bindings.BindingSide
</a> import me.rhunk.snapenhance.common.scripting.impl.ConfigInterface
 import me.rhunk.snapenhance.common.scripting.impl.ConfigTransactionType
 import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
<a href="#h0-0-3" id="h0-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.type.readModuleInfo
</a><a href="#h0-0-4" id="h0-0-4" class="i">+import me.rhunk.snapenhance.common.util.ktx.await
</a> import me.rhunk.snapenhance.core.util.ktx.toParcelFileDescriptor
 import me.rhunk.snapenhance.scripting.impl.IPCListeners
 import me.rhunk.snapenhance.scripting.impl.ManagerIPC
 import me.rhunk.snapenhance.scripting.impl.ManagerScriptConfig
 import me.rhunk.snapenhance.storage.isScriptEnabled
<a href="#h0-0-10" id="h0-0-10" class="d">-import me.rhunk.snapenhance.storage.syncScripts
</a> import okhttp3.OkHttpClient
 import okhttp3.Request
 import java.io.File
<a href="#h0-1" id="h0-1" class="h">@@ -56,23 +57,23 @@ class RemoteScriptManager(
</a>     private val cachedModuleInfo = mutableMapOf&lt;String, ModuleInfo&gt;()
     private val ipcListeners = IPCListeners()
 
<a href="#h0-1-3" id="h0-1-3" class="i">+    fun getSyncedModules(): List&lt;ModuleInfo&gt; {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        return cachedModuleInfo.values.toList()
</a><a href="#h0-1-5" id="h0-1-5" class="i">+    }
</a><a href="#h0-1-6" id="h0-1-6" class="i">+
</a>     fun sync() {
         cachedModuleInfo.clear()
         getScriptFileNames().forEach { name -&gt;
             runCatching {
                 getScriptInputStream(name) { stream -&gt;
<a href="#h0-1-12" id="h0-1-12" class="d">-                    stream?.use {
</a><a href="#h0-1-13" id="h0-1-13" class="d">-                        runtime.getModuleInfo(it).also { info -&gt;
</a><a href="#h0-1-14" id="h0-1-14" class="d">-                            cachedModuleInfo[name] = info
</a><a href="#h0-1-15" id="h0-1-15" class="d">-                        }
</a><a href="#h0-1-16" id="h0-1-16" class="i">+                    stream?.bufferedReader()?.readModuleInfo()?.also {
</a><a href="#h0-1-17" id="h0-1-17" class="i">+                        cachedModuleInfo[name] = it
</a>                     }
                 }
             }.onFailure {
                 context.log.error(&quot;Failed to load module info for $name&quot;, it)
             }
         }
<a href="#h0-1-24" id="h0-1-24" class="d">-
</a><a href="#h0-1-25" id="h0-1-25" class="d">-        context.database.syncScripts(cachedModuleInfo.values.toList())
</a>     }
 
     fun init() {
<a href="#h0-2" id="h0-2" class="h">@@ -133,7 +134,8 @@ class RemoteScriptManager(
</a>     }
 
     fun importFromUrl(
<a href="#h0-2-3" id="h0-2-3" class="d">-        url: String
</a><a href="#h0-2-4" id="h0-2-4" class="i">+        url: String,
</a><a href="#h0-2-5" id="h0-2-5" class="i">+        filepath: String? = null
</a>     ): ModuleInfo {
         val response = okHttpClient.newCall(Request.Builder().url(url).build()).execute()
         if (!response.isSuccessful) {
<a href="#h0-3" id="h0-3" class="h">@@ -142,14 +144,14 @@ class RemoteScriptManager(
</a>         response.body.byteStream().use { inputStream -&gt;
             val bufferedInputStream = inputStream.buffered()
             bufferedInputStream.mark(0)
<a href="#h0-3-3" id="h0-3-3" class="d">-            val moduleInfo = runtime.readModuleInfo(bufferedInputStream.bufferedReader())
</a><a href="#h0-3-4" id="h0-3-4" class="i">+            val moduleInfo = bufferedInputStream.bufferedReader().readModuleInfo()
</a>             bufferedInputStream.reset()
 
<a href="#h0-3-7" id="h0-3-7" class="d">-            val scriptPath = moduleInfo.name + &quot;.js&quot;
</a><a href="#h0-3-8" id="h0-3-8" class="i">+            val scriptPath = filepath ?: (moduleInfo.name + &quot;.js&quot;)
</a>             val scriptFile = getScriptsFolder()?.findFile(scriptPath) ?: getScriptsFolder()?.createFile(&quot;text/javascript&quot;, scriptPath)
                 ?: throw Exception(&quot;Failed to create script file&quot;)
 
<a href="#h0-3-12" id="h0-3-12" class="d">-            context.androidContext.contentResolver.openOutputStream(scriptFile.uri)?.use { output -&gt;
</a><a href="#h0-3-13" id="h0-3-13" class="i">+            context.androidContext.contentResolver.openOutputStream(scriptFile.uri, &quot;wt&quot;)?.use { output -&gt;
</a>                 bufferedInputStream.copyTo(output)
             }
 
<a href="#h0-4" id="h0-4" class="h">@@ -160,6 +162,26 @@ class RemoteScriptManager(
</a>         }
     }
 
<a href="#h0-4-3" id="h0-4-3" class="i">+    suspend fun checkForUpdate(inputModuleInfo: ModuleInfo): ModuleInfo? {
</a><a href="#h0-4-4" id="h0-4-4" class="i">+        return runCatching {
</a><a href="#h0-4-5" id="h0-4-5" class="i">+            context.log.verbose(&quot;checking for updates for ${inputModuleInfo.name} ${inputModuleInfo.updateUrl}&quot;)
</a><a href="#h0-4-6" id="h0-4-6" class="i">+            val response = okHttpClient.newCall(Request.Builder().url(inputModuleInfo.updateUrl ?: return@runCatching null).build()).await()
</a><a href="#h0-4-7" id="h0-4-7" class="i">+            if (!response.isSuccessful) {
</a><a href="#h0-4-8" id="h0-4-8" class="i">+                return@runCatching null
</a><a href="#h0-4-9" id="h0-4-9" class="i">+            }
</a><a href="#h0-4-10" id="h0-4-10" class="i">+            response.body.byteStream().use { inputStream -&gt;
</a><a href="#h0-4-11" id="h0-4-11" class="i">+                val reader = inputStream.buffered().bufferedReader()
</a><a href="#h0-4-12" id="h0-4-12" class="i">+                val moduleInfo = reader.readModuleInfo()
</a><a href="#h0-4-13" id="h0-4-13" class="i">+                moduleInfo.takeIf {
</a><a href="#h0-4-14" id="h0-4-14" class="i">+                   it.version != inputModuleInfo.version
</a><a href="#h0-4-15" id="h0-4-15" class="i">+                }
</a><a href="#h0-4-16" id="h0-4-16" class="i">+            }
</a><a href="#h0-4-17" id="h0-4-17" class="i">+       }.onFailure {
</a><a href="#h0-4-18" id="h0-4-18" class="i">+           context.log.error(&quot;Failed to check for updates&quot;, it)
</a><a href="#h0-4-19" id="h0-4-19" class="i">+       }.getOrNull()
</a><a href="#h0-4-20" id="h0-4-20" class="i">+    }
</a><a href="#h0-4-21" id="h0-4-21" class="i">+
</a><a href="#h0-4-22" id="h0-4-22" class="i">+
</a>     override fun getEnabledScripts(): List&lt;String&gt; {
         return runCatching {
             getScriptFileNames().filter {
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -56,14 +56,8 @@ class AppDatabase(
</a>                 &quot;expirationTimestamp BIGINT&quot;,
                 &quot;length INTEGER&quot;
             ),
<a href="#h1-0-3" id="h1-0-3" class="d">-            &quot;scripts&quot; to listOf(
</a><a href="#h1-0-4" id="h1-0-4" class="d">-                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h1-0-5" id="h1-0-5" class="d">-                &quot;name VARCHAR NOT NULL&quot;,
</a><a href="#h1-0-6" id="h1-0-6" class="d">-                &quot;version VARCHAR NOT NULL&quot;,
</a><a href="#h1-0-7" id="h1-0-7" class="d">-                &quot;displayName VARCHAR&quot;,
</a><a href="#h1-0-8" id="h1-0-8" class="d">-                &quot;description VARCHAR&quot;,
</a><a href="#h1-0-9" id="h1-0-9" class="d">-                &quot;author VARCHAR NOT NULL&quot;,
</a><a href="#h1-0-10" id="h1-0-10" class="d">-                &quot;enabled BOOLEAN&quot;
</a><a href="#h1-0-11" id="h1-0-11" class="i">+            &quot;enabled_scripts&quot; to listOf(
</a><a href="#h1-0-12" id="h1-0-12" class="i">+                &quot;name VARCHAR PRIMARY KEY&quot;,
</a>             ),
             &quot;tracker_rules&quot; to listOf(
                 &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -2,72 +2,22 @@ package me.rhunk.snapenhance.storage
</a> 
 import kotlinx.coroutines.asCoroutineDispatcher
 import kotlinx.coroutines.runBlocking
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h2-0-4" id="h2-0-4" class="d">-import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h2-0-5" id="h2-0-5" class="d">-import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a> 
 
<a href="#h2-0-8" id="h2-0-8" class="d">-fun AppDatabase.getScripts(): List&lt;ModuleInfo&gt; {
</a><a href="#h2-0-9" id="h2-0-9" class="d">-    return database.rawQuery(&quot;SELECT * FROM scripts ORDER BY id DESC&quot;, null).use { cursor -&gt;
</a><a href="#h2-0-10" id="h2-0-10" class="d">-        val scripts = mutableListOf&lt;ModuleInfo&gt;()
</a><a href="#h2-0-11" id="h2-0-11" class="d">-        while (cursor.moveToNext()) {
</a><a href="#h2-0-12" id="h2-0-12" class="d">-            scripts.add(
</a><a href="#h2-0-13" id="h2-0-13" class="d">-                ModuleInfo(
</a><a href="#h2-0-14" id="h2-0-14" class="d">-                    name = cursor.getStringOrNull(&quot;name&quot;)!!,
</a><a href="#h2-0-15" id="h2-0-15" class="d">-                    version = cursor.getStringOrNull(&quot;version&quot;)!!,
</a><a href="#h2-0-16" id="h2-0-16" class="d">-                    displayName = cursor.getStringOrNull(&quot;displayName&quot;),
</a><a href="#h2-0-17" id="h2-0-17" class="d">-                    description = cursor.getStringOrNull(&quot;description&quot;),
</a><a href="#h2-0-18" id="h2-0-18" class="d">-                    author = cursor.getStringOrNull(&quot;author&quot;),
</a><a href="#h2-0-19" id="h2-0-19" class="d">-                    grantedPermissions = emptyList()
</a><a href="#h2-0-20" id="h2-0-20" class="d">-                )
</a><a href="#h2-0-21" id="h2-0-21" class="d">-            )
</a><a href="#h2-0-22" id="h2-0-22" class="d">-        }
</a><a href="#h2-0-23" id="h2-0-23" class="d">-        scripts
</a><a href="#h2-0-24" id="h2-0-24" class="d">-    }
</a><a href="#h2-0-25" id="h2-0-25" class="d">-}
</a><a href="#h2-0-26" id="h2-0-26" class="d">-
</a> fun AppDatabase.setScriptEnabled(name: String, enabled: Boolean) {
     executeAsync {
<a href="#h2-0-29" id="h2-0-29" class="d">-        database.execSQL(&quot;UPDATE scripts SET enabled = ? WHERE name = ?&quot;, arrayOf(
</a><a href="#h2-0-30" id="h2-0-30" class="d">-            if (enabled) 1 else 0,
</a><a href="#h2-0-31" id="h2-0-31" class="d">-            name
</a><a href="#h2-0-32" id="h2-0-32" class="d">-        ))
</a><a href="#h2-0-33" id="h2-0-33" class="i">+        if (enabled) {
</a><a href="#h2-0-34" id="h2-0-34" class="i">+            database.execSQL(&quot;INSERT OR REPLACE INTO enabled_scripts (name) VALUES (?)&quot;, arrayOf(name))
</a><a href="#h2-0-35" id="h2-0-35" class="i">+        } else {
</a><a href="#h2-0-36" id="h2-0-36" class="i">+            database.execSQL(&quot;DELETE FROM enabled_scripts WHERE name = ?&quot;, arrayOf(name))
</a><a href="#h2-0-37" id="h2-0-37" class="i">+        }
</a>     }
 }
 
 fun AppDatabase.isScriptEnabled(name: String): Boolean {
<a href="#h2-0-42" id="h2-0-42" class="d">-    return database.rawQuery(&quot;SELECT enabled FROM scripts WHERE name = ?&quot;, arrayOf(name)).use { cursor -&gt;
</a><a href="#h2-0-43" id="h2-0-43" class="d">-        if (!cursor.moveToFirst()) return@use false
</a><a href="#h2-0-44" id="h2-0-44" class="d">-        cursor.getInteger(&quot;enabled&quot;) == 1
</a><a href="#h2-0-45" id="h2-0-45" class="d">-    }
</a><a href="#h2-0-46" id="h2-0-46" class="d">-}
</a><a href="#h2-0-47" id="h2-0-47" class="d">-
</a><a href="#h2-0-48" id="h2-0-48" class="d">-fun AppDatabase.syncScripts(availableScripts: List&lt;ModuleInfo&gt;) {
</a><a href="#h2-0-49" id="h2-0-49" class="d">-    runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h2-0-50" id="h2-0-50" class="d">-        val enabledScripts = getScripts()
</a><a href="#h2-0-51" id="h2-0-51" class="d">-        val enabledScriptPaths = enabledScripts.map { it.name }
</a><a href="#h2-0-52" id="h2-0-52" class="d">-        val availableScriptPaths = availableScripts.map { it.name }
</a><a href="#h2-0-53" id="h2-0-53" class="d">-
</a><a href="#h2-0-54" id="h2-0-54" class="d">-        enabledScripts.forEach { script -&gt;
</a><a href="#h2-0-55" id="h2-0-55" class="d">-            if (!availableScriptPaths.contains(script.name)) {
</a><a href="#h2-0-56" id="h2-0-56" class="d">-                database.execSQL(&quot;DELETE FROM scripts WHERE name = ?&quot;, arrayOf(script.name))
</a><a href="#h2-0-57" id="h2-0-57" class="d">-            }
</a><a href="#h2-0-58" id="h2-0-58" class="d">-        }
</a><a href="#h2-0-59" id="h2-0-59" class="d">-
</a><a href="#h2-0-60" id="h2-0-60" class="d">-        availableScripts.forEach { script -&gt;
</a><a href="#h2-0-61" id="h2-0-61" class="d">-            if (!enabledScriptPaths.contains(script.name) || script != enabledScripts.find { it.name == script.name }) {
</a><a href="#h2-0-62" id="h2-0-62" class="d">-                database.execSQL(
</a><a href="#h2-0-63" id="h2-0-63" class="d">-                    &quot;INSERT OR REPLACE INTO scripts (name, version, displayName, description, author, enabled) VALUES (?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h2-0-64" id="h2-0-64" class="d">-                    arrayOf(
</a><a href="#h2-0-65" id="h2-0-65" class="d">-                        script.name,
</a><a href="#h2-0-66" id="h2-0-66" class="d">-                        script.version,
</a><a href="#h2-0-67" id="h2-0-67" class="d">-                        script.displayName,
</a><a href="#h2-0-68" id="h2-0-68" class="d">-                        script.description,
</a><a href="#h2-0-69" id="h2-0-69" class="d">-                        script.author,
</a><a href="#h2-0-70" id="h2-0-70" class="d">-                        0
</a><a href="#h2-0-71" id="h2-0-71" class="d">-                    )
</a><a href="#h2-0-72" id="h2-0-72" class="d">-                )
</a><a href="#h2-0-73" id="h2-0-73" class="d">-            }
</a><a href="#h2-0-74" id="h2-0-74" class="i">+    return runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h2-0-75" id="h2-0-75" class="i">+        database.rawQuery(&quot;SELECT * FROM enabled_scripts WHERE name = ?&quot;, arrayOf(name)).use {
</a><a href="#h2-0-76" id="h2-0-76" class="i">+            it.moveToNext()
</a>         }
     }
<a href="#h2-0-79" id="h2-0-79" class="d">-}</a><a href="#h2-0-80" id="h2-0-80" class="d">-
\ No newline at end of file
</a><a href="#h2-0-81" id="h2-0-81" class="i">+}
</a><b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -23,6 +23,7 @@ import androidx.compose.ui.unit.sp
</a> import androidx.core.net.toUri
 import androidx.navigation.NavBackStackEntry
 import kotlinx.coroutines.Dispatchers
<a href="#h3-0-3" id="h3-0-3" class="i">+import kotlinx.coroutines.asCoroutineDispatcher
</a> import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
<a href="#h3-1" id="h3-1" class="h">@@ -32,7 +33,7 @@ import me.rhunk.snapenhance.common.scripting.ui.InterfaceManager
</a> import me.rhunk.snapenhance.common.scripting.ui.ScriptInterface
 import me.rhunk.snapenhance.common.ui.AsyncUpdateDispatcher
 import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
<a href="#h3-1-3" id="h3-1-3" class="d">-import me.rhunk.snapenhance.storage.getScripts
</a><a href="#h3-1-4" id="h3-1-4" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncUpdateDispatcher
</a> import me.rhunk.snapenhance.storage.isScriptEnabled
 import me.rhunk.snapenhance.storage.setScriptEnabled
 import me.rhunk.snapenhance.ui.manager.Routes
<a href="#h3-2" id="h3-2" class="h">@@ -142,6 +143,7 @@ class ScriptingRoot : Routes.Route() {
</a>     @Composable
     private fun ModuleActions(
         script: ModuleInfo,
<a href="#h3-2-3" id="h3-2-3" class="i">+        canUpdate: Boolean,
</a>         dismiss: () -&gt; Unit
     ) {
         Dialog(
<a href="#h3-3" id="h3-3" class="h">@@ -153,8 +155,28 @@ class ScriptingRoot : Routes.Route() {
</a>                     .padding(2.dp),
             ) {
                 val actions = remember {
<a href="#h3-3-3" id="h3-3-3" class="d">-                    mapOf&lt;Pair&lt;String, ImageVector&gt;, suspend () -&gt; Unit&gt;(
</a><a href="#h3-3-4" id="h3-3-4" class="d">-                        (&quot;Edit Module&quot; to Icons.Default.Edit) to {
</a><a href="#h3-3-5" id="h3-3-5" class="i">+                    mutableMapOf&lt;Pair&lt;String, ImageVector&gt;, suspend () -&gt; Unit&gt;().apply {
</a><a href="#h3-3-6" id="h3-3-6" class="i">+                        if (canUpdate) {
</a><a href="#h3-3-7" id="h3-3-7" class="i">+                            put(&quot;Update Module&quot; to Icons.Default.Download) {
</a><a href="#h3-3-8" id="h3-3-8" class="i">+                                dismiss()
</a><a href="#h3-3-9" id="h3-3-9" class="i">+                                context.shortToast(&quot;Updating script ${script.name}...&quot;)
</a><a href="#h3-3-10" id="h3-3-10" class="i">+                                runCatching {
</a><a href="#h3-3-11" id="h3-3-11" class="i">+                                    val modulePath = context.scriptManager.getModulePath(script.name) ?: throw Exception(&quot;Module not found&quot;)
</a><a href="#h3-3-12" id="h3-3-12" class="i">+                                    context.scriptManager.unloadScript(modulePath)
</a><a href="#h3-3-13" id="h3-3-13" class="i">+                                    val moduleInfo = context.scriptManager.importFromUrl(script.updateUrl!!, filepath = modulePath)
</a><a href="#h3-3-14" id="h3-3-14" class="i">+                                    context.shortToast(&quot;Updated ${script.name} to version ${moduleInfo.version}&quot;)
</a><a href="#h3-3-15" id="h3-3-15" class="i">+                                    context.database.setScriptEnabled(script.name, false)
</a><a href="#h3-3-16" id="h3-3-16" class="i">+                                    withContext(context.database.executor.asCoroutineDispatcher()) {
</a><a href="#h3-3-17" id="h3-3-17" class="i">+                                        reloadDispatcher.dispatch()
</a><a href="#h3-3-18" id="h3-3-18" class="i">+                                    }
</a><a href="#h3-3-19" id="h3-3-19" class="i">+                                }.onFailure {
</a><a href="#h3-3-20" id="h3-3-20" class="i">+                                    context.log.error(&quot;Failed to update module&quot;, it)
</a><a href="#h3-3-21" id="h3-3-21" class="i">+                                    context.shortToast(&quot;Failed to update module. Check logs for more details&quot;)
</a><a href="#h3-3-22" id="h3-3-22" class="i">+                                }
</a><a href="#h3-3-23" id="h3-3-23" class="i">+                            }
</a><a href="#h3-3-24" id="h3-3-24" class="i">+                        }
</a><a href="#h3-3-25" id="h3-3-25" class="i">+
</a><a href="#h3-3-26" id="h3-3-26" class="i">+                        put(&quot;Edit Module&quot; to Icons.Default.Edit) {
</a>                             runCatching {
                                 val modulePath = context.scriptManager.getModulePath(script.name)!!
                                 context.androidContext.startActivity(
<a href="#h3-4" id="h3-4" class="h">@@ -170,8 +192,8 @@ class ScriptingRoot : Routes.Route() {
</a>                                 context.log.error(&quot;Failed to open module file&quot;, it)
                                 context.shortToast(&quot;Failed to open module file. Check logs for more details&quot;)
                             }
<a href="#h3-4-3" id="h3-4-3" class="d">-                        },
</a><a href="#h3-4-4" id="h3-4-4" class="d">-                        (&quot;Clear Module Data&quot; to Icons.Default.Save) to {
</a><a href="#h3-4-5" id="h3-4-5" class="i">+                        }
</a><a href="#h3-4-6" id="h3-4-6" class="i">+                        put(&quot;Clear Module Data&quot; to Icons.Default.Save) {
</a>                             runCatching {
                                 context.scriptManager.getModuleDataFolder(script.name)
                                     .deleteRecursively()
<a href="#h3-5" id="h3-5" class="h">@@ -181,8 +203,8 @@ class ScriptingRoot : Routes.Route() {
</a>                                 context.log.error(&quot;Failed to clear module data&quot;, it)
                                 context.shortToast(&quot;Failed to clear module data. Check logs for more details&quot;)
                             }
<a href="#h3-5-3" id="h3-5-3" class="d">-                        },
</a><a href="#h3-5-4" id="h3-5-4" class="d">-                        (&quot;Delete Module&quot; to Icons.Default.DeleteOutline) to {
</a><a href="#h3-5-5" id="h3-5-5" class="i">+                        }
</a><a href="#h3-5-6" id="h3-5-6" class="i">+                        put(&quot;Delete Module&quot; to Icons.Default.DeleteOutline) {
</a>                             context.scriptManager.apply {
                                 runCatching {
                                     val modulePath = getModulePath(script.name)!!
<a href="#h3-6" id="h3-6" class="h">@@ -197,7 +219,7 @@ class ScriptingRoot : Routes.Route() {
</a>                                 }
                             }
                         }
<a href="#h3-6-3" id="h3-6-3" class="d">-                    )
</a><a href="#h3-6-4" id="h3-6-4" class="i">+                    }.toMap()
</a>                 }
 
                 LazyColumn(
<a href="#h3-7" id="h3-7" class="h">@@ -243,14 +265,26 @@ class ScriptingRoot : Routes.Route() {
</a> 
     @Composable
     fun ModuleItem(script: ModuleInfo) {
<a href="#h3-7-3" id="h3-7-3" class="d">-        var enabled by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h3-7-4" id="h3-7-4" class="i">+        var enabled by rememberAsyncMutableState(defaultValue = false, keys = arrayOf(script)) {
</a>             context.database.isScriptEnabled(script.name)
         }
<a href="#h3-7-7" id="h3-7-7" class="d">-        var openSettings by remember {
</a><a href="#h3-7-8" id="h3-7-8" class="d">-            mutableStateOf(false)
</a><a href="#h3-7-9" id="h3-7-9" class="i">+        var openSettings by remember(script) { mutableStateOf(false) }
</a><a href="#h3-7-10" id="h3-7-10" class="i">+        var openActions by remember { mutableStateOf(false) }
</a><a href="#h3-7-11" id="h3-7-11" class="i">+
</a><a href="#h3-7-12" id="h3-7-12" class="i">+        val dispatcher = rememberAsyncUpdateDispatcher()
</a><a href="#h3-7-13" id="h3-7-13" class="i">+        val reloadCallback = remember { suspend { dispatcher.dispatch() } }
</a><a href="#h3-7-14" id="h3-7-14" class="i">+        val latestUpdate by rememberAsyncMutableState(defaultValue = null, updateDispatcher = dispatcher, keys = arrayOf(script)) {
</a><a href="#h3-7-15" id="h3-7-15" class="i">+            context.scriptManager.checkForUpdate(script)
</a>         }
<a href="#h3-7-17" id="h3-7-17" class="d">-        var openActions by remember {
</a><a href="#h3-7-18" id="h3-7-18" class="d">-            mutableStateOf(false)
</a><a href="#h3-7-19" id="h3-7-19" class="i">+
</a><a href="#h3-7-20" id="h3-7-20" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h3-7-21" id="h3-7-21" class="i">+            reloadDispatcher.addCallback(reloadCallback)
</a><a href="#h3-7-22" id="h3-7-22" class="i">+        }
</a><a href="#h3-7-23" id="h3-7-23" class="i">+
</a><a href="#h3-7-24" id="h3-7-24" class="i">+        DisposableEffect(Unit) {
</a><a href="#h3-7-25" id="h3-7-25" class="i">+            onDispose {
</a><a href="#h3-7-26" id="h3-7-26" class="i">+                reloadDispatcher.removeCallback(reloadCallback)
</a><a href="#h3-7-27" id="h3-7-27" class="i">+            }
</a>         }
 
         Card(
<a href="#h3-8" id="h3-8" class="h">@@ -286,6 +320,9 @@ class ScriptingRoot : Routes.Route() {
</a>                 ) {
                     Text(text = script.displayName ?: script.name, fontSize = 20.sp)
                     Text(text = script.description ?: &quot;No description&quot;, fontSize = 14.sp)
<a href="#h3-8-3" id="h3-8-3" class="i">+                    latestUpdate?.let {
</a><a href="#h3-8-4" id="h3-8-4" class="i">+                        Text(text = &quot;Update available: ${it.version}&quot;, fontSize = 14.sp, fontStyle = FontStyle.Italic, color = MaterialTheme.colorScheme.onSurfaceVariant)
</a><a href="#h3-8-5" id="h3-8-5" class="i">+                    }
</a>                 }
                 IconButton(onClick = {
                     openActions = !openActions
<a href="#h3-9" id="h3-9" class="h">@@ -333,7 +370,10 @@ class ScriptingRoot : Routes.Route() {
</a>         }
 
         if (openActions) {
<a href="#h3-9-3" id="h3-9-3" class="d">-            ModuleActions(script) { openActions = false }
</a><a href="#h3-9-4" id="h3-9-4" class="i">+            ModuleActions(
</a><a href="#h3-9-5" id="h3-9-5" class="i">+                script = script,
</a><a href="#h3-9-6" id="h3-9-6" class="i">+                canUpdate = latestUpdate != null,
</a><a href="#h3-9-7" id="h3-9-7" class="i">+            ) { openActions = false }
</a>         }
     }
 
<a href="#h3-10" id="h3-10" class="h">@@ -416,7 +456,7 @@ class ScriptingRoot : Routes.Route() {
</a>             updateDispatcher = reloadDispatcher
         ) {
             context.scriptManager.sync()
<a href="#h3-10-3" id="h3-10-3" class="d">-            context.database.getScripts()
</a><a href="#h3-10-4" id="h3-10-4" class="i">+            context.scriptManager.getSyncedModules()
</a>         }
 
         val coroutineScope = rememberCoroutineScope()
<a href="#h3-11" id="h3-11" class="h">@@ -477,7 +517,7 @@ class ScriptingRoot : Routes.Route() {
</a>                         )
                     }
                 }
<a href="#h3-11-3" id="h3-11-3" class="d">-                items(scriptModules.size) { index -&gt;
</a><a href="#h3-11-4" id="h3-11-4" class="i">+                items(scriptModules.size, key = { scriptModules[it].hashCode() }) { index -&gt;
</a>                     ModuleItem(scriptModules[index])
                 }
                 item {
<b>diff --git a/<a id="h4" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -5,9 +5,8 @@ import android.os.ParcelFileDescriptor
</a> import me.rhunk.snapenhance.bridge.scripting.IScripting
 import me.rhunk.snapenhance.common.BuildConfig
 import me.rhunk.snapenhance.common.logger.AbstractLogger
<a href="#h4-0-3" id="h4-0-3" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.type.readModuleInfo
</a> import org.mozilla.javascript.ScriptableObject
<a href="#h4-0-6" id="h4-0-6" class="d">-import java.io.BufferedReader
</a> import java.io.InputStream
 
 open class ScriptRuntime(
<a href="#h4-1" id="h4-1" class="h">@@ -35,45 +34,6 @@ open class ScriptRuntime(
</a>         return modules.values.find { it.moduleInfo.name == name }
     }
 
<a href="#h4-1-3" id="h4-1-3" class="d">-    fun readModuleInfo(reader: BufferedReader): ModuleInfo {
</a><a href="#h4-1-4" id="h4-1-4" class="d">-        val header = reader.readLine()
</a><a href="#h4-1-5" id="h4-1-5" class="d">-        if (!header.startsWith(&quot;// ==SE_module==&quot;)) {
</a><a href="#h4-1-6" id="h4-1-6" class="d">-            throw Exception(&quot;Invalid module header&quot;)
</a><a href="#h4-1-7" id="h4-1-7" class="d">-        }
</a><a href="#h4-1-8" id="h4-1-8" class="d">-
</a><a href="#h4-1-9" id="h4-1-9" class="d">-        val properties = mutableMapOf&lt;String, String&gt;()
</a><a href="#h4-1-10" id="h4-1-10" class="d">-        while (true) {
</a><a href="#h4-1-11" id="h4-1-11" class="d">-            val line = reader.readLine()
</a><a href="#h4-1-12" id="h4-1-12" class="d">-            if (line.startsWith(&quot;// ==/SE_module==&quot;)) {
</a><a href="#h4-1-13" id="h4-1-13" class="d">-                break
</a><a href="#h4-1-14" id="h4-1-14" class="d">-            }
</a><a href="#h4-1-15" id="h4-1-15" class="d">-            val split = line.replaceFirst(&quot;//&quot;, &quot;&quot;).split(&quot;:&quot;)
</a><a href="#h4-1-16" id="h4-1-16" class="d">-            if (split.size != 2) {
</a><a href="#h4-1-17" id="h4-1-17" class="d">-                throw Exception(&quot;Invalid module property&quot;)
</a><a href="#h4-1-18" id="h4-1-18" class="d">-            }
</a><a href="#h4-1-19" id="h4-1-19" class="d">-            properties[split[0].trim()] = split[1].trim()
</a><a href="#h4-1-20" id="h4-1-20" class="d">-        }
</a><a href="#h4-1-21" id="h4-1-21" class="d">-
</a><a href="#h4-1-22" id="h4-1-22" class="d">-        return ModuleInfo(
</a><a href="#h4-1-23" id="h4-1-23" class="d">-            name = properties[&quot;name&quot;]?.also {
</a><a href="#h4-1-24" id="h4-1-24" class="d">-                if (!it.matches(Regex(&quot;[a-z_]+&quot;))) {
</a><a href="#h4-1-25" id="h4-1-25" class="d">-                    throw Exception(&quot;Invalid module name : Only lowercase letters and underscores are allowed&quot;)
</a><a href="#h4-1-26" id="h4-1-26" class="d">-                }
</a><a href="#h4-1-27" id="h4-1-27" class="d">-            } ?: throw Exception(&quot;Missing module name&quot;),
</a><a href="#h4-1-28" id="h4-1-28" class="d">-            version = properties[&quot;version&quot;] ?: throw Exception(&quot;Missing module version&quot;),
</a><a href="#h4-1-29" id="h4-1-29" class="d">-            displayName = properties[&quot;displayName&quot;],
</a><a href="#h4-1-30" id="h4-1-30" class="d">-            description = properties[&quot;description&quot;],
</a><a href="#h4-1-31" id="h4-1-31" class="d">-            author = properties[&quot;author&quot;],
</a><a href="#h4-1-32" id="h4-1-32" class="d">-            minSnapchatVersion = properties[&quot;minSnapchatVersion&quot;]?.toLongOrNull(),
</a><a href="#h4-1-33" id="h4-1-33" class="d">-            minSEVersion = properties[&quot;minSEVersion&quot;]?.toLongOrNull(),
</a><a href="#h4-1-34" id="h4-1-34" class="d">-            grantedPermissions = properties[&quot;permissions&quot;]?.split(&quot;,&quot;)?.map { it.trim() } ?: emptyList(),
</a><a href="#h4-1-35" id="h4-1-35" class="d">-        )
</a><a href="#h4-1-36" id="h4-1-36" class="d">-    }
</a><a href="#h4-1-37" id="h4-1-37" class="d">-
</a><a href="#h4-1-38" id="h4-1-38" class="d">-    fun getModuleInfo(inputStream: InputStream): ModuleInfo {
</a><a href="#h4-1-39" id="h4-1-39" class="d">-        return readModuleInfo(inputStream.bufferedReader())
</a><a href="#h4-1-40" id="h4-1-40" class="d">-    }
</a><a href="#h4-1-41" id="h4-1-41" class="d">-
</a>     fun removeModule(scriptPath: String) {
         modules.remove(scriptPath)
     }
<a href="#h4-2" id="h4-2" class="h">@@ -94,7 +54,7 @@ open class ScriptRuntime(
</a>     fun load(scriptPath: String, content: InputStream): JSModule {
         logger.info(&quot;Loading module $scriptPath&quot;)
         val bufferedReader = content.bufferedReader()
<a href="#h4-2-3" id="h4-2-3" class="d">-        val moduleInfo = readModuleInfo(bufferedReader)
</a><a href="#h4-2-4" id="h4-2-4" class="i">+        val moduleInfo = bufferedReader.readModuleInfo()
</a> 
         if (moduleInfo.minSEVersion != null &amp;&amp; moduleInfo.minSEVersion &gt; BuildConfig.VERSION_CODE) {
             throw Exception(&quot;Module requires a newer version of SnapEnhance (min version: ${moduleInfo.minSEVersion})&quot;)
<b>diff --git a/<a id="h5" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,28 +1,57 @@
</a> package me.rhunk.snapenhance.common.scripting.type
 
<a href="#h5-0-2" id="h5-0-2" class="i">+import java.io.BufferedReader
</a><a href="#h5-0-3" id="h5-0-3" class="i">+
</a> data class ModuleInfo(
     val name: String,
     val version: String,
     val displayName: String? = null,
     val description: String? = null,
<a href="#h5-0-9" id="h5-0-9" class="i">+    val updateUrl: String? = null,
</a>     val author: String? = null,
     val minSnapchatVersion: Long? = null,
     val minSEVersion: Long? = null,
     val grantedPermissions: List&lt;String&gt;,
 ) {
<a href="#h5-0-15" id="h5-0-15" class="d">-    override fun equals(other: Any?): Boolean {
</a><a href="#h5-0-16" id="h5-0-16" class="d">-        if (other !is ModuleInfo) return false
</a><a href="#h5-0-17" id="h5-0-17" class="d">-        if (other === this) return true
</a><a href="#h5-0-18" id="h5-0-18" class="d">-        return name == other.name &amp;&amp;
</a><a href="#h5-0-19" id="h5-0-19" class="d">-                version == other.version &amp;&amp;
</a><a href="#h5-0-20" id="h5-0-20" class="d">-                displayName == other.displayName &amp;&amp;
</a><a href="#h5-0-21" id="h5-0-21" class="d">-                description == other.description &amp;&amp;
</a><a href="#h5-0-22" id="h5-0-22" class="d">-                author == other.author
</a><a href="#h5-0-23" id="h5-0-23" class="d">-    }
</a><a href="#h5-0-24" id="h5-0-24" class="d">-
</a>     fun ensurePermissionGranted(permission: Permissions) {
         if (!grantedPermissions.contains(permission.key)) {
             throw AssertionError(&quot;Permission $permission is not granted&quot;)
         }
     }
<a href="#h5-0-30" id="h5-0-30" class="d">-}</a><a href="#h5-0-31" id="h5-0-31" class="d">-
\ No newline at end of file
</a><a href="#h5-0-32" id="h5-0-32" class="i">+}
</a><a href="#h5-0-33" id="h5-0-33" class="i">+
</a><a href="#h5-0-34" id="h5-0-34" class="i">+fun BufferedReader.readModuleInfo(): ModuleInfo {
</a><a href="#h5-0-35" id="h5-0-35" class="i">+    val header = readLine()
</a><a href="#h5-0-36" id="h5-0-36" class="i">+    if (!header.startsWith(&quot;// ==SE_module==&quot;)) {
</a><a href="#h5-0-37" id="h5-0-37" class="i">+        throw Exception(&quot;Invalid module header&quot;)
</a><a href="#h5-0-38" id="h5-0-38" class="i">+    }
</a><a href="#h5-0-39" id="h5-0-39" class="i">+
</a><a href="#h5-0-40" id="h5-0-40" class="i">+    val properties = mutableMapOf&lt;String, String&gt;()
</a><a href="#h5-0-41" id="h5-0-41" class="i">+    while (true) {
</a><a href="#h5-0-42" id="h5-0-42" class="i">+        val line = readLine()
</a><a href="#h5-0-43" id="h5-0-43" class="i">+        if (line.startsWith(&quot;// ==/SE_module==&quot;)) {
</a><a href="#h5-0-44" id="h5-0-44" class="i">+            break
</a><a href="#h5-0-45" id="h5-0-45" class="i">+        }
</a><a href="#h5-0-46" id="h5-0-46" class="i">+        val split = line.replaceFirst(&quot;//&quot;, &quot;&quot;).split(&quot;:&quot;, limit = 2)
</a><a href="#h5-0-47" id="h5-0-47" class="i">+        if (split.size != 2) {
</a><a href="#h5-0-48" id="h5-0-48" class="i">+            throw Exception(&quot;Invalid module property&quot;)
</a><a href="#h5-0-49" id="h5-0-49" class="i">+        }
</a><a href="#h5-0-50" id="h5-0-50" class="i">+        properties[split[0].trim()] = split[1].trim()
</a><a href="#h5-0-51" id="h5-0-51" class="i">+    }
</a><a href="#h5-0-52" id="h5-0-52" class="i">+
</a><a href="#h5-0-53" id="h5-0-53" class="i">+    return ModuleInfo(
</a><a href="#h5-0-54" id="h5-0-54" class="i">+        name = properties[&quot;name&quot;]?.also {
</a><a href="#h5-0-55" id="h5-0-55" class="i">+            if (!it.matches(Regex(&quot;[a-z_]+&quot;))) {
</a><a href="#h5-0-56" id="h5-0-56" class="i">+                throw Exception(&quot;Invalid module name : Only lowercase letters and underscores are allowed&quot;)
</a><a href="#h5-0-57" id="h5-0-57" class="i">+            }
</a><a href="#h5-0-58" id="h5-0-58" class="i">+        } ?: throw Exception(&quot;Missing module name&quot;),
</a><a href="#h5-0-59" id="h5-0-59" class="i">+        version = properties[&quot;version&quot;] ?: throw Exception(&quot;Missing module version&quot;),
</a><a href="#h5-0-60" id="h5-0-60" class="i">+        displayName = properties[&quot;displayName&quot;],
</a><a href="#h5-0-61" id="h5-0-61" class="i">+        description = properties[&quot;description&quot;],
</a><a href="#h5-0-62" id="h5-0-62" class="i">+        updateUrl = properties[&quot;updateUrl&quot;],
</a><a href="#h5-0-63" id="h5-0-63" class="i">+        author = properties[&quot;author&quot;],
</a><a href="#h5-0-64" id="h5-0-64" class="i">+        minSnapchatVersion = properties[&quot;minSnapchatVersion&quot;]?.toLongOrNull(),
</a><a href="#h5-0-65" id="h5-0-65" class="i">+        minSEVersion = properties[&quot;minSEVersion&quot;]?.toLongOrNull(),
</a><a href="#h5-0-66" id="h5-0-66" class="i">+        grantedPermissions = properties[&quot;permissions&quot;]?.split(&quot;,&quot;)?.map { it.trim() } ?: emptyList(),
</a><a href="#h5-0-67" id="h5-0-67" class="i">+    )
</a><a href="#h5-0-68" id="h5-0-68" class="i">+}
</a><b>diff --git a/<a id="h6" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -61,7 +61,7 @@ fun &lt;T&gt; rememberAsyncMutableState(
</a>     defaultValue: T,
     updateDispatcher: AsyncUpdateDispatcher? = null,
     keys: Array&lt;*&gt; = emptyArray&lt;Any&gt;(),
<a href="#h6-0-3" id="h6-0-3" class="d">-    getter: () -&gt; T,
</a><a href="#h6-0-4" id="h6-0-4" class="i">+    getter: suspend () -&gt; T,
</a> ): MutableState&lt;T&gt; {
     return rememberCommonState(
         initialState = { mutableStateOf(defaultValue) },
<a href="#h6-1" id="h6-1" class="h">@@ -82,7 +82,7 @@ fun &lt;T&gt; rememberAsyncMutableStateList(
</a>     defaultValue: List&lt;T&gt;,
     updateDispatcher: AsyncUpdateDispatcher? = null,
     keys: Array&lt;*&gt; = emptyArray&lt;Any&gt;(),
<a href="#h6-1-3" id="h6-1-3" class="d">-    getter: () -&gt; List&lt;T&gt;,
</a><a href="#h6-1-4" id="h6-1-4" class="i">+    getter: suspend () -&gt; List&lt;T&gt;,
</a> ): SnapshotStateList&lt;T&gt; {
     return rememberCommonState(
         initialState = { mutableStateListOf&lt;T&gt;().apply {
<b>diff --git a/<a id="h7" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/OkHttp.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/OkHttp.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/OkHttp.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/OkHttp.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+package me.rhunk.snapenhance.common.util.ktx
</a><a href="#h7-0-1" id="h7-0-1" class="i">+
</a><a href="#h7-0-2" id="h7-0-2" class="i">+import kotlinx.coroutines.CompletionHandler
</a><a href="#h7-0-3" id="h7-0-3" class="i">+import kotlinx.coroutines.suspendCancellableCoroutine
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import okhttp3.Call
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import okhttp3.Callback
</a><a href="#h7-0-6" id="h7-0-6" class="i">+import okhttp3.Response
</a><a href="#h7-0-7" id="h7-0-7" class="i">+import okio.IOException
</a><a href="#h7-0-8" id="h7-0-8" class="i">+import kotlin.coroutines.resumeWithException
</a><a href="#h7-0-9" id="h7-0-9" class="i">+
</a><a href="#h7-0-10" id="h7-0-10" class="i">+suspend inline fun Call.await(): Response {
</a><a href="#h7-0-11" id="h7-0-11" class="i">+    return suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h7-0-12" id="h7-0-12" class="i">+        val callback = object: CompletionHandler, Callback {
</a><a href="#h7-0-13" id="h7-0-13" class="i">+            override fun invoke(cause: Throwable?) {
</a><a href="#h7-0-14" id="h7-0-14" class="i">+                runCatching { cancel() }
</a><a href="#h7-0-15" id="h7-0-15" class="i">+            }
</a><a href="#h7-0-16" id="h7-0-16" class="i">+
</a><a href="#h7-0-17" id="h7-0-17" class="i">+            override fun onFailure(call: Call, e: IOException) {
</a><a href="#h7-0-18" id="h7-0-18" class="i">+                continuation.resumeWithException(e)
</a><a href="#h7-0-19" id="h7-0-19" class="i">+            }
</a><a href="#h7-0-20" id="h7-0-20" class="i">+
</a><a href="#h7-0-21" id="h7-0-21" class="i">+            override fun onResponse(call: Call, response: Response) {
</a><a href="#h7-0-22" id="h7-0-22" class="i">+                continuation.resumeWith(runCatching { response })
</a><a href="#h7-0-23" id="h7-0-23" class="i">+            }
</a><a href="#h7-0-24" id="h7-0-24" class="i">+        }
</a><a href="#h7-0-25" id="h7-0-25" class="i">+        enqueue(callback)
</a><a href="#h7-0-26" id="h7-0-26" class="i">+        continuation.invokeOnCancellation(callback)
</a><a href="#h7-0-27" id="h7-0-27" class="i">+    }
</a><a href="#h7-0-28" id="h7-0-28" class="i">+}
</a></pre>
</div>
</body>
</html>
